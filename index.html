<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aegis DM Toolkit</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, deleteDoc, getDoc, collection, query, onSnapshot, setLogLevel, addDoc, updateDoc, orderBy, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Expose necessary functions globally
        window.doc = doc;
        window.setDoc = setDoc;
        window.deleteDoc = deleteDoc;
        window.collection = collection;
        window.query = query;
        window.onSnapshot = onSnapshot;
        window.addDoc = addDoc;
        window.getDoc = getDoc;
        window.updateDoc = updateDoc;
        window.orderBy = orderBy;
        window.writeBatch = writeBatch;
        
        // Expose Auth functions
        window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.signOut = signOut;
        window.signInAnonymously = signInAnonymously;

        // Global Firebase variables
        window.db = null;
        window.auth = null;
        window.userId = null;
        window.isAuthReady = false;

        // --- CONFIGURATION ---
        const manualFirebaseConfig = {
            apiKey: "AIzaSyB6lyGYJzk70t1OJvzBn5uyJN_k2_5NKYg",
            authDomain: "aegisdmtoolkit.firebaseapp.com",
            projectId: "aegisdmtoolkit",
            storageBucket: "aegisdmtoolkit.firebasestorage.app",
            messagingSenderId: "654767294266",
            appId: "1:654767294266:web:fbee20be7d458fb7d6f203"
        };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const envFirebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        
        const firebaseConfig = (manualFirebaseConfig.apiKey && manualFirebaseConfig.apiKey !== "PASTE_YOUR_API_KEY_HERE") 
            ? manualFirebaseConfig 
            : envFirebaseConfig;

        if (firebaseConfig && Object.keys(firebaseConfig).length > 0) {
            setLogLevel('debug');
            const app = initializeApp(firebaseConfig);
            window.db = getFirestore(app);
            window.auth = getAuth(app);
            
            // Auth Listener
            onAuthStateChanged(window.auth, async (user) => {
                if (user) {
                    // --- LOGGED IN ---
                    window.userId = user.uid;
                    window.isAuthReady = true;
                    console.log("User authenticated:", window.userId);
                    
                    document.getElementById('auth-modal').classList.add('hidden');
                    
                    const userLabel = user.isAnonymous ? "Guest Mode" : user.email;
                    const profileEl = document.getElementById('user-profile-email');
                    if(profileEl) profileEl.textContent = userLabel;

                    if (window.setupNotesListener) window.setupNotesListener();
                    if (window.setupCombatDataListeners) window.setupCombatDataListeners();
                    if (window.setupStatblocksListener) window.setupStatblocksListener();
                } else {
                    // --- LOGGED OUT ---
                    window.userId = null;
                    window.isAuthReady = false;
                    document.getElementById('auth-modal').classList.remove('hidden');
                    if(window.clearUiData) window.clearUiData();
                }
            });
        } else {
            console.error("Firebase configuration not found.");
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f8fafc; }
        .tab-button.active { border-bottom: 3px solid #6366f1; color: #c7d2fe; }
        .sub-tab-button.active { border-bottom: 2px solid #34d399; color: #34d399; }
        .card { background-color: #1e293b; border: 1px solid #334155; }
        .input-style { background-color: #334155; border: 1px solid #475569; color: #f8fafc; }
        .glow-shadow { box-shadow: 0 0 10px rgba(99, 102, 241, 0.5); }
        .scrollable-content { max-height: 60vh; overflow-y: auto; }
        .scrollable-content::-webkit-scrollbar { width: 8px; }
        .scrollable-content::-webkit-scrollbar-track { background: #1e293b; }
        .scrollable-content::-webkit-scrollbar-thumb { background-color: #475569; border-radius: 20px; border: 2px solid #1e293b; }
        .loading-spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-top: 4px solid #fff; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .collapsible-header { cursor: pointer; display: flex; justify-content: space-between; align-items: center; padding: 10px; background-color: #334155; border-radius: 8px; }
        .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; padding: 0 10px; }
        .collapsible-content.expanded { max-height: 1000px; padding: 10px; }
        .arrow-icon { transition: transform 0.3s ease; }
        .expanded .arrow-icon { transform: rotate(90deg); }
    </style>
</head>
<body class="p-4 sm:p-8">
    <div class="max-w-4xl mx-auto">
        <!-- Header / User Profile -->
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-3xl font-bold text-indigo-400">üõ°Ô∏è Aegis DM Toolkit</h1>
            <div class="flex items-center space-x-3 text-sm">
                <span id="user-profile-email" class="text-gray-400 hidden sm:inline">...</span>
                <button onclick="handleLogout()" class="bg-red-900/50 hover:bg-red-800 text-red-200 px-3 py-1 rounded border border-red-700 transition">Logout</button>
            </div>
        </div>
        
        <!-- Tab Navigation -->
        <div class="flex border-b border-gray-600 mb-6">
            <button class="tab-button p-3 flex-1 text-sm font-semibold transition duration-300 active" onclick="switchTab('improv')">
                üîÆ Prep
            </button>
            <button class="tab-button p-3 flex-1 text-sm font-semibold text-gray-400 transition duration-300" onclick="switchTab('combat')">
                ‚öîÔ∏è Combat
            </button>
            <button class="tab-button p-3 flex-1 text-sm font-semibold text-gray-400 transition duration-300" onclick="switchTab('statblocks')">
                üëπ Stats
            </button>
            <button class="tab-button p-3 flex-1 text-sm font-semibold text-gray-400 transition duration-300" onclick="switchTab('monsters')">
                üê≤ Monsters
            </button>
            <button class="tab-button p-3 flex-1 text-sm font-semibold text-gray-400 transition duration-300" onclick="switchTab('notes')">
                üìú Notes
            </button>
        </div>

        <!-- Content Area -->
        <div id="content-area">
            <!-- 1. Prep & Improv Engine -->
            <div id="improv" class="tab-content">
                <!-- Structured Combat NPC Generator -->
                <div class="card p-4 rounded-lg shadow-xl mb-6">
                    <h2 class="text-xl font-semibold mb-4 text-green-300">Structured Combat NPC Stats</h2>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="npc-level" class="block text-xs font-medium text-gray-400 mb-1">Level or CR</label>
                            <input type="text" id="npc-level" value="3" placeholder="Level/CR" class="w-full p-2 rounded-lg input-style transition text-sm">
                        </div>
                        <div>
                            <label for="npc-type" class="block text-xs font-medium text-gray-400 mb-1">NPC Type</label>
                            <input type="text" id="npc-type" value="Shadow Rogue" placeholder="Type or Vibe" class="w-full p-2 rounded-lg input-style transition text-sm">
                        </div>
                    </div>
                    <button onclick="generateCombatNpc()" id="generate-combat-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded-lg transition duration-300 flex items-center justify-center">
                        <span id="generate-combat-text">Generate Combat Stats</span>
                        <div id="combat-loading-spinner" class="loading-spinner ml-2 hidden"></div>
                    </button>
                    <p id="combat-status-message" class="mt-2 text-sm text-center text-red-400 hidden"></p>
                </div>

                <!-- Free-Form Creative Generator -->
                <div class="card p-4 rounded-lg shadow-xl mb-6">
                    <h2 class="text-xl font-semibold mb-4 text-indigo-300">Creative Lore & Backstory</h2>
                    <textarea id="improv-prompt" rows="3" class="w-full p-3 rounded-lg input-style resize-none focus:ring-2 focus:ring-indigo-500" placeholder="e.g., A grumpy blacksmith who secretly loves romance novels."></textarea>
                    <button onclick="generateCreativeIdea()" id="generate-button" class="mt-4 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 rounded-lg transition duration-300 flex items-center justify-center">
                        <span id="generate-text">Generate Idea</span>
                        <div id="creative-loading-spinner" class="loading-spinner ml-2 hidden"></div>
                    </button>
                </div>

                <!-- Settlement Generator -->
                <div class="card p-4 rounded-lg shadow-xl mb-6">
                    <h2 class="text-xl font-semibold mb-4 text-teal-300">Settlement Generator</h2>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="settlement-type" class="block text-xs font-medium text-gray-400 mb-1">Settlement Type</label>
                            <select id="settlement-type" class="w-full p-2 rounded-lg input-style transition text-sm">
                                <option value="Village" selected>Village</option>
                                <option value="Town">Town</option>
                                <option value="City">City</option>
                            </select>
                        </div>
                        <div>
                            <label for="settlement-vibe" class="block text-xs font-medium text-gray-400 mb-1">Vibe</label>
                            <input type="text" id="settlement-vibe" value="haunted fishing village" class="w-full p-2 rounded-lg input-style transition text-sm">
                        </div>
                    </div>
                    <button onclick="generateSettlement()" id="generate-settlement-button" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 rounded-lg transition duration-300 flex items-center justify-center">
                        <span id="generate-settlement-text">Generate Settlement</span>
                        <div id="settlement-loading-spinner" class="loading-spinner ml-2 hidden"></div>
                    </button>
                </div>

                <div class="card p-4 rounded-lg shadow-xl">
                    <h2 class="text-xl font-semibold mb-4 text-indigo-300">Generated Result</h2>
                    <div id="ai-image-output" class="mb-4 hidden rounded-lg overflow-hidden shadow-lg">
                        <img id="generated-image" src="" class="w-full h-auto object-cover bg-gray-700/30 min-h-[150px]">
                        <p id="image-loading-status" class="text-center text-gray-400 p-3 bg-gray-800"></p>
                    </div>
                    <div id="ai-output" class="whitespace-pre-wrap min-h-[100px] bg-gray-700/30 p-3 rounded-lg text-gray-300">Results will appear here.</div>
                    <p id="npc-save-status" class="mt-2 text-sm text-center hidden"></p>
                    <div id="save-options-creative" class="mt-4 hidden">
                        <p class="text-sm text-center text-gray-400 mb-2">Save to Rulings & Notes:</p>
                        <div class="grid grid-cols-3 gap-2">
                            <button onclick="saveGeneratedContent('prepNotes')" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 rounded text-xs">To Notes</button>
                            <button onclick="saveGeneratedContent('enemyNotes')" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 rounded text-xs">To Enemies</button>
                            <button onclick="saveGeneratedContent('npcNotes')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded text-xs">To NPCs</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. Combat Tracker -->
            <div id="combat" class="tab-content hidden">
                <div class="card p-4 rounded-lg shadow-xl">
                    <h2 class="text-xl font-semibold mb-4 text-indigo-300">Initiative Tracker</h2>
                    <div class="flex flex-wrap gap-2 mb-4">
                        <input id="combatant-name" type="text" placeholder="Name" class="flex-1 min-w-[100px] p-2 rounded-lg input-style" />
                        <input id="combatant-init" type="number" placeholder="Init" class="w-24 p-2 rounded-lg input-style text-center text-sm" />
                        <input id="combatant-ac" type="number" placeholder="AC" class="w-16 p-2 rounded-lg input-style text-center text-sm" />
                        <input id="combatant-hp" type="number" placeholder="HP" class="w-16 p-2 rounded-lg input-style text-center text-sm" />
                        <button onclick="addCombatant()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold px-3 py-2 rounded-lg transition duration-300 text-sm">Add</button>
                    </div>

                    <div class="card p-4 rounded-lg shadow-inner mb-4 bg-gray-800/50">
                        <div class="flex items-center space-x-2">
                            <button onclick="rollD20()" id="d20-roll-button" class="w-1/3 bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded-lg text-sm">Roll D20</button>
                            <div id="last-roll-display" class="w-1/3 text-4xl font-extrabold text-center text-yellow-400 border-2 border-yellow-400 p-2 rounded-lg bg-gray-900/50 select-none">?</div>
                            <select id="combatant-selector" class="w-1/3 p-2 rounded-lg input-style text-sm"><option value="" disabled selected>Target</option></select>
                        </div>
                        <button onclick="assignInitiativeRoll()" id="assign-roll-button" class="mt-2 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg text-sm disabled:opacity-50" disabled>Assign Roll</button>
                        <p class="text-xs text-gray-400 mt-2 text-center">*Uses stored Initiative Modifier</p>
                    </div>

                    <div class="flex justify-between items-center mb-4">
                        <button onclick="sortInitiative()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-3 rounded-lg text-sm">Sort</button>
                        <button onclick="nextTurn()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-3 rounded-lg text-sm">Next Turn &raquo;</button>
                        <button onclick="clearCombat()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-3 rounded-lg text-sm">Clear All</button>
                    </div>
                    <div id="initiative-list" class="scrollable-content space-y-2"></div>
                </div>
            </div>

            <!-- 3. Statblocks Tab -->
            <div id="statblocks" class="tab-content hidden">
                <div class="card p-4 rounded-lg shadow-xl mb-6">
                    <h2 class="text-xl font-semibold mb-4 text-indigo-300">Save Statblock</h2>
                    <div class="grid grid-cols-2 gap-2 mb-4">
                        <input id="stat-name" type="text" placeholder="Name" class="col-span-2 p-2 rounded-lg input-style" />
                        <input id="stat-hp" type="number" placeholder="HP" class="p-2 rounded-lg input-style text-center text-sm" />
                        <input id="stat-ac" type="number" placeholder="AC" class="p-2 rounded-lg input-style text-center text-sm" />
                        <input id="stat-tohit" type="number" placeholder="To Hit" class="p-2 rounded-lg input-style text-center text-sm" />
                        <input id="stat-init-mod" type="number" placeholder="Init Mod" class="p-2 rounded-lg input-style text-center text-sm" />
                        <input id="stat-dmg" type="text" placeholder="Attack DMG" class="col-span-2 p-2 rounded-lg input-style" />
                    </div>
                    <button onclick="saveStatblock()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 rounded-lg">Save Statblock</button>
                    <p id="statblock-status" class="mt-2 text-sm text-center text-gray-400"></p>
                </div>

                <div class="card p-4 rounded-lg shadow-xl mb-6">
                    <h2 class="text-xl font-semibold mb-4 text-teal-300">Quick Dice</h2>
                    <div class="flex flex-wrap items-center gap-2 mb-4">
                        <input id="dice-num" type="number" value="1" class="w-16 p-2 rounded-lg input-style text-center text-sm" />
                        <span class="text-lg font-semibold text-gray-400">d</span>
                        <select id="dice-type" class="p-2 rounded-lg input-style text-sm">
                            <option value="4">4</option><option value="6">6</option><option value="8">8</option><option value="10">10</option><option value="12">12</option><option value="20" selected>20</option><option value="100">100</option>
                        </select>
                        <span class="text-lg font-semibold text-gray-400">+</span>
                        <input id="dice-mod" type="number" value="0" class="w-16 p-2 rounded-lg input-style text-center text-sm" />
                    </div>
                    <button onclick="rollCustomDice()" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 rounded-lg">Roll Dice</button>
                    <div id="dice-roll-result" class="mt-4 text-center text-xl font-bold text-yellow-300 bg-gray-700/50 p-3 rounded-lg">Result</div>
                    <p id="dice-roll-details" class="mt-2 text-center text-sm text-gray-400"></p>
                </div>

                <div class="card p-4 rounded-lg shadow-xl">
                    <h2 class="text-xl font-semibold mb-4 text-indigo-300">Library</h2>
                    <div id="statblocks-list" class="scrollable-content space-y-2"></div>
                </div>
            </div>

            <!-- 4. Monsters Tab -->
            <div id="monsters" class="tab-content hidden">
                <div class="card p-4 rounded-lg shadow-xl mb-6">
                    <h2 class="text-xl font-semibold mb-4 text-green-300">Monster Generator (AI)</h2>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <input type="text" id="monster-name" value="Cave Troll" placeholder="Name" class="w-full p-2 rounded-lg input-style">
                        <input type="text" id="monster-cr" value="4" placeholder="CR" class="w-full p-2 rounded-lg input-style">
                    </div>
                    <button onclick="generateMonsterStatblock()" id="generate-monster-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded-lg flex items-center justify-center">
                        <span id="generate-monster-text">Generate Monster</span>
                        <div id="monster-loading-spinner" class="loading-spinner ml-2 hidden"></div>
                    </button>
                    <p id="monster-status-message" class="mt-2 text-sm text-center text-red-400 hidden"></p>
                </div>

                <div class="card p-4 rounded-lg shadow-xl">
                    <h2 class="text-xl font-semibold mb-4 text-indigo-300">Generated Stat Block</h2>
                    <div id="monster-output" class="min-h-[100px] bg-gray-700/30 p-3 rounded-lg text-gray-300">Monster stat block will appear here.</div>
                    <p id="monster-save-status" class="mt-2 text-sm text-center hidden"></p>
                    <div id="save-options-monster" class="mt-4 hidden grid grid-cols-2 gap-2">
                        <button onclick="addMonsterToStatblocks()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 rounded-lg text-xs">To Statblocks</button>
                        <button onclick="saveMonsterToNotes()" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 rounded-lg text-xs">To Notes</button>
                    </div>
                </div>
            </div>

            <!-- 5. Rulings & Notes -->
            <div id="notes" class="tab-content hidden">
                <div class="card p-4 rounded-lg shadow-xl">
                    <h2 class="text-xl font-semibold mb-4 text-indigo-300">Rulings & Notes</h2>
                    <div class="flex border-b border-gray-700 mb-4 -mx-4 px-4">
                        <button class="sub-tab-button p-2 text-sm font-semibold transition active" data-subtab="prepNotes" onclick="switchSubTab('prepNotes')">General</button>
                        <button class="sub-tab-button p-2 text-sm font-semibold text-gray-400 transition" data-subtab="enemyNotes" onclick="switchSubTab('enemyNotes')">Enemies</button>
                        <button class="sub-tab-button p-2 text-sm font-semibold text-gray-400 transition" data-subtab="npcNotes" onclick="switchSubTab('npcNotes')">NPCs</button>
                    </div>
                    <div id="prepNotes-sub-content" class="sub-tab-content"><div id="prepNotes-list" class="scrollable-content space-y-3"></div></div>
                    <div id="enemyNotes-sub-content" class="sub-tab-content hidden"><div id="enemyNotes-list" class="scrollable-content space-y-3"></div></div>
                    <div id="npcNotes-sub-content" class="sub-tab-content hidden"><div id="npcNotes-list" class="scrollable-content space-y-3"></div></div>
                    <button onclick="addNewNote(currentSubTab)" class="mt-4 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 rounded-lg transition duration-300">+ Add Note</button>
                    <p id="notes-status" class="mt-2 text-sm text-center text-gray-400"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- AUTH MODAL -->
    <div id="auth-modal" class="fixed inset-0 z-50 bg-gray-900/95 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="card w-full max-w-md p-8 rounded-xl shadow-2xl border border-indigo-500/50">
            <h2 class="text-3xl font-bold text-center text-indigo-400 mb-2">Aegis Toolkit</h2>
            <p class="text-center text-gray-400 mb-6 text-sm">Login to sync data across devices.</p>
            <div id="auth-error" class="hidden bg-red-500/20 text-red-300 p-3 rounded mb-4 text-sm text-center"></div>
            <form onsubmit="handleLogin(event)" class="space-y-4">
                <div>
                    <label class="block text-xs font-medium text-gray-400 mb-1">Email</label>
                    <input type="email" id="login-email" class="w-full p-3 rounded bg-gray-800 border border-gray-700 text-white focus:border-indigo-500 outline-none">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-400 mb-1">Password</label>
                    <input type="password" id="login-password" class="w-full p-3 rounded bg-gray-800 border border-gray-700 text-white focus:border-indigo-500 outline-none">
                </div>
                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded transition">Log In</button>
            </form>
            <div class="mt-4 flex justify-between items-center text-xs text-gray-500">
                <button onclick="handleRegister()" class="hover:text-indigo-400 underline">Create Account</button>
                <button onclick="handleGuest()" class="hover:text-indigo-400 underline">Guest Mode</button>
            </div>
        </div>
    </div>

    <!-- EDIT MODALS -->
    <div id="edit-modal" class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4">
        <div class="card w-full max-w-lg p-6 rounded shadow-2xl">
            <h3 class="text-xl font-bold text-indigo-300 mb-4">Edit Note</h3>
            <input type="hidden" id="modal-note-id"><input type="hidden" id="modal-tab-name">
            <input type="text" id="modal-title" class="w-full p-3 rounded input-style mb-4">
            <textarea id="modal-content" rows="6" class="w-full p-3 rounded input-style mb-6"></textarea>
            <div class="flex justify-end space-x-3">
                <button onclick="closeEditModal()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded">Cancel</button>
                <button onclick="saveEditedNote()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Save</button>
            </div>
        </div>
    </div>

    <div id="edit-statblock-modal" class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4">
        <div class="card w-full max-w-lg p-6 rounded shadow-2xl">
            <h3 class="text-xl font-bold text-indigo-300 mb-4">Edit Statblock</h3>
            <input type="hidden" id="modal-statblock-id">
            <input type="text" id="modal-stat-name" placeholder="Name" class="w-full p-3 rounded input-style mb-4">
            <div class="grid grid-cols-2 gap-4 mb-4">
                <input type="number" id="modal-stat-hp" placeholder="HP" class="p-3 rounded input-style text-center">
                <input type="number" id="modal-stat-ac" placeholder="AC" class="p-3 rounded input-style text-center">
                <input type="number" id="modal-stat-tohit" placeholder="To Hit" class="p-3 rounded input-style text-center">
                <input type="number" id="modal-stat-init-mod" placeholder="Init" class="p-3 rounded input-style text-center">
            </div>
            <input type="text" id="modal-stat-dmg" placeholder="Damage" class="w-full p-3 rounded input-style mb-6">
            <div class="flex justify-end space-x-3">
                <button onclick="closeStatblockEditModal()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded">Cancel</button>
                <button onclick="saveEditedStatblock()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Save</button>
            </div>
        </div>
    </div>

    <script>
        // --- USER SPECIFIC PATHS ---
        function getUserDocRef() {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            return window.doc(window.db, 'artifacts', appId, 'users', window.userId, 'data', 'notes');
        }
        function getCombatantsCollectionRef() {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            return window.collection(window.db, 'artifacts', appId, 'users', window.userId, 'combatants');
        }
        function getCombatStateDocRef() {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            return window.doc(window.db, 'artifacts', appId, 'users', window.userId, 'data', 'combat_state');
        }
        function getStatblocksCollectionRef() {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            return window.collection(window.db, 'artifacts', appId, 'users', window.userId, 'statblocks');
        }

        // --- AUTH HANDLERS ---
        window.handleLogin = async function(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            try { await window.signInWithEmailAndPassword(window.auth, email, password); } 
            catch (error) { document.getElementById('auth-error').textContent = error.message; document.getElementById('auth-error').classList.remove('hidden'); }
        }
        window.handleRegister = async function() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            if (!email || !password) { document.getElementById('auth-error').textContent = "Enter email & password to register."; document.getElementById('auth-error').classList.remove('hidden'); return; }
            try { await window.createUserWithEmailAndPassword(window.auth, email, password); } 
            catch (error) { document.getElementById('auth-error').textContent = error.message; document.getElementById('auth-error').classList.remove('hidden'); }
        }
        window.handleGuest = async function() { try { await window.signInAnonymously(window.auth); } catch (error) { console.error(error); } }
        window.handleLogout = async function() { await window.signOut(window.auth); location.reload(); }
        function clearUiData() {
            ['initiative-list','statblocks-list','prepNotes-list','enemyNotes-list','npcNotes-list'].forEach(id => { const el = document.getElementById(id); if(el) el.innerHTML = ''; });
        }

        // --- APP STATE ---
        let currentTab = 'improv'; let currentSubTab = 'prepNotes'; let savedStatblocks = []; 
        let lastGeneratedNpc = null; let lastGeneratedMonster = null;
        let structuredNotes = { prepNotes: [], enemyNotes: [], npcNotes: [] };
        let combatants = []; let currentTurnIndex = -1; let lastRoll = 0;

        // --- NOTES ---
        function getFirestoreKey(tabName) { return `structured${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`; }
        window.saveStructuredNotes = async function(tabName, notesArray) {
            if (!window.isAuthReady || !window.db) return;
            const firestoreKey = getFirestoreKey(tabName); const data = {}; data[firestoreKey] = notesArray; data.lastSaved = new Date().toISOString();
            try { await window.setDoc(getUserDocRef(), data, { merge: true }); document.getElementById('notes-status').textContent = `${tabName} saved!`; } catch (e) { console.error(e); }
        }
        window.setupNotesListener = function() {
            if (!window.isAuthReady || !window.db) return;
            window.onSnapshot(getUserDocRef(), (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    structuredNotes.prepNotes = data[getFirestoreKey('prepNotes')] || [];
                    structuredNotes.enemyNotes = data[getFirestoreKey('enemyNotes')] || [];
                    structuredNotes.npcNotes = data[getFirestoreKey('npcNotes')] || [];
                    if (currentTab === 'notes') renderStructuredNotes(currentSubTab);
                }
            });
        }
        function renderStructuredNotes(tabName) {
            const notesArray = structuredNotes[tabName]; const listContainer = document.getElementById(`${tabName}-list`);
            if (!listContainer) return; listContainer.innerHTML = ''; 
            if (!notesArray || notesArray.length === 0) { listContainer.innerHTML = `<p class="text-center text-gray-500 pt-4 text-xs">No notes.</p>`; return; }
            notesArray.forEach(note => {
                const el = document.createElement('div'); el.className = 'note-item card p-0 rounded-lg shadow-md'; el.id = `note-${note.id}`;
                const header = document.createElement('div'); header.className = 'collapsible-header hover:bg-gray-600/50 transition'; header.onclick = () => toggleCollapse(note.id);
                header.innerHTML = `<span class="font-semibold text-base text-indigo-300 truncate">${note.title}</span><svg class="arrow-icon w-4 h-4 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>`;
                const content = document.createElement('div'); content.className = 'collapsible-content'; content.id = `content-${note.id}`;
                const isHtml = /<[a-z][\s\S]*>/i.test(note.content);
                let inner = isHtml ? `<div class="p-2 text-sm">${note.content}</div>` : `<div class="whitespace-pre-wrap text-sm text-gray-300 p-2 bg-gray-700/50">${note.content}</div>`;
                content.innerHTML = `${inner}<div class="flex justify-end space-x-2 p-2 border-t border-gray-700"><button onclick="editNote('${note.id}', '${tabName}')" class="text-blue-400 text-xs hover:underline">Edit</button><button onclick="deleteNote('${note.id}', '${tabName}')" class="text-red-400 text-xs hover:underline">Delete</button></div>`;
                el.appendChild(header); el.appendChild(content); listContainer.appendChild(el);
            });
        }
        window.toggleCollapse = function(id) { const c = document.getElementById(`content-${id}`); if(c) c.classList.toggle('expanded'); if(c.classList.contains('expanded')) c.style.maxHeight = c.scrollHeight+"px"; else c.style.maxHeight = null; }
        window.addNewNote = function(tab) { structuredNotes[tab].unshift({ id: crypto.randomUUID(), title: 'New Note', content: 'Edit me...', timestamp: new Date().toISOString() }); saveStructuredNotes(tab, structuredNotes[tab]); }
        window.deleteNote = function(id, tab) { structuredNotes[tab] = structuredNotes[tab].filter(n => n.id !== id); saveStructuredNotes(tab, structuredNotes[tab]); }
        window.editNote = function(id, tab) {
            const n = structuredNotes[tab].find(x => x.id === id); if(!n) return;
            document.getElementById('modal-note-id').value = n.id; document.getElementById('modal-tab-name').value = tab;
            document.getElementById('modal-title').value = n.title; document.getElementById('modal-content').value = n.content;
            document.getElementById('edit-modal').classList.remove('hidden');
        }
        window.closeEditModal = function() { document.getElementById('edit-modal').classList.add('hidden'); }
        window.saveEditedNote = function() {
            const id = document.getElementById('modal-note-id').value; const tab = document.getElementById('modal-tab-name').value;
            const idx = structuredNotes[tab].findIndex(n => n.id === id);
            if(idx!==-1) {
                structuredNotes[tab][idx].title = document.getElementById('modal-title').value || 'Untitled';
                structuredNotes[tab][idx].content = document.getElementById('modal-content').value;
                saveStructuredNotes(tab, structuredNotes[tab]);
            }
            document.getElementById('edit-modal').classList.add('hidden');
        }

        // --- COMBAT ---
        async function saveCombatStateToFirestore() { if (window.isAuthReady && window.db) try { await window.setDoc(getCombatStateDocRef(), { currentTurnIndex }); } catch (e) {} }
        window.setupCombatDataListeners = function() {
            if (!window.isAuthReady || !window.db) return;
            window.onSnapshot(window.query(getCombatantsCollectionRef()), (snap) => {
                const loaded = []; snap.forEach(doc => loaded.push({ id: doc.id, ...doc.data() }));
                loaded.sort((a, b) => (b.init || 0) - (a.init || 0)); combatants = loaded; renderCombatants();
            });
            window.onSnapshot(getCombatStateDocRef(), (doc) => { if (doc.exists()) currentTurnIndex = doc.data().currentTurnIndex ?? -1; renderCombatants(); });
        }
        window.renderCombatants = function() {
            const list = document.getElementById('initiative-list'); list.innerHTML = '';
            if(combatants.length === 0) { list.innerHTML = '<p class="text-center text-gray-500 pt-4 text-sm">Add combatants.</p>'; return; }
            combatants.forEach((c, i) => {
                const active = i === currentTurnIndex ? 'bg-indigo-700' : 'bg-gray-700';
                const el = document.createElement('div'); el.className = `flex items-center space-x-1 p-3 rounded-lg transition ${active}`;
                el.innerHTML = `<div class="text-lg font-bold w-6 text-center">${c.init}</div><div class="flex-1 min-w-[50px]"><div class="font-semibold text-sm truncate">${c.name}</div><div class="text-xs"><span class="${c.currentHp<=0?'text-red-400':'text-green-400'}">HP: ${c.currentHp}/${c.maxHp}</span> <span class="text-blue-300 ml-1">AC: ${c.ac}</span></div></div><div class="flex space-x-1 items-center"><input type="number" placeholder="#" id="dmg-${i}" class="w-10 p-1 rounded input-style text-center text-xs"><button onclick="applyHpChange(${i}, 'heal')" class="bg-green-600 hover:bg-green-700 text-white text-xs font-bold py-1 px-2 rounded">+</button><button onclick="applyHpChange(${i}, 'damage')" class="bg-red-500 hover:bg-red-600 text-white text-xs font-bold py-1 px-2 rounded">-</button></div><button onclick="removeCombatant(${i})" class="bg-gray-500 hover:bg-gray-600 text-white text-xs font-bold py-1 px-2 rounded ml-1">x</button>`;
                list.appendChild(el);
            });
            populateCombatantSelector();
        }
        window.applyHpChange = async function(index, type) {
            const val = parseInt(document.getElementById(`dmg-${index}`).value); if(isNaN(val)) return;
            const c = combatants[index]; let newHp = c.currentHp;
            if(type === 'damage') newHp -= val; else newHp += val;
            await window.updateDoc(window.doc(getCombatantsCollectionRef(), c.id), { currentHp: newHp });
            document.getElementById(`dmg-${index}`).value = '';
        }
        window.addCombatant = async function() {
            const name = document.getElementById('combatant-name').value;
            const hp = parseInt(document.getElementById('combatant-hp').value)||10;
            const ac = parseInt(document.getElementById('combatant-ac').value)||10;
            const init = parseInt(document.getElementById('combatant-init').value)||0;
            if(!name) return;
            try { await window.addDoc(getCombatantsCollectionRef(), { name, init, maxHp: hp, currentHp: hp, ac, initModifier: init }); } catch(e){}
            document.getElementById('combatant-name').value = '';
        }
        window.removeCombatant = async function(i) { await window.deleteDoc(window.doc(getCombatantsCollectionRef(), combatants[i].id)); }
        window.sortInitiative = function() { currentTurnIndex = 0; saveCombatStateToFirestore(); }
        window.nextTurn = function() { if(combatants.length) currentTurnIndex = (currentTurnIndex + 1) % combatants.length; saveCombatStateToFirestore(); }
        window.clearCombat = async function() { const batch = window.writeBatch(window.db); combatants.forEach(c => batch.delete(window.doc(getCombatantsCollectionRef(), c.id))); await batch.commit(); }
        window.rollD20 = function() { lastRoll = Math.floor(Math.random()*20)+1; document.getElementById('last-roll-display').textContent = lastRoll; document.getElementById('assign-roll-button').disabled = combatants.length === 0; }
        window.assignInitiativeRoll = async function() {
            const idx = document.getElementById('combatant-selector').value; if(!idx) return;
            const c = combatants[idx]; const newInit = lastRoll + (c.initModifier || 0);
            await window.updateDoc(window.doc(getCombatantsCollectionRef(), c.id), { init: newInit });
        }
        function populateCombatantSelector() {
            const sel = document.getElementById('combatant-selector'); sel.innerHTML = '<option value="" disabled selected>Target</option>';
            combatants.forEach((c, i) => { const opt = document.createElement('option'); opt.value = i; opt.textContent = c.name; sel.appendChild(opt); });
            document.getElementById('assign-roll-button').disabled = combatants.length === 0;
        }

        // --- STATBLOCKS ---
        window.setupStatblocksListener = function() {
            if (!window.isAuthReady || !window.db) return;
            window.onSnapshot(window.query(getStatblocksCollectionRef()), (snap) => {
                savedStatblocks = []; snap.forEach(doc => savedStatblocks.push({ id: doc.id, ...doc.data() }));
                savedStatblocks.sort((a, b) => a.name.localeCompare(b.name)); renderStatblocks();
            });
        }
        function renderStatblocks() {
            const list = document.getElementById('statblocks-list'); list.innerHTML = '';
            if (savedStatblocks.length === 0) { list.innerHTML = '<p class="text-center text-gray-500 pt-8">Empty.</p>'; return; }
            savedStatblocks.forEach(stat => {
                const el = document.createElement('div'); el.className = 'note-item card p-0 rounded-lg shadow-md'; const uid = `statblock-${stat.id}`; el.id = uid;
                const header = document.createElement('div'); header.className = 'collapsible-header hover:bg-gray-600/50 transition duration-150'; header.onclick = () => toggleCollapse(uid);
                header.innerHTML = `<span class="font-semibold text-lg text-indigo-300 truncate">${stat.name}</span><svg class="arrow-icon w-4 h-4 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>`;
                const content = document.createElement('div'); content.className = 'collapsible-content'; content.id = `content-${uid}`;
                content.innerHTML = `<div class="p-3"><div class="flex justify-end space-x-2 mb-2"><button onclick="editStatblock('${stat.id}')" class="bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold py-1 px-2 rounded">Edit</button><button onclick="deleteStatblock('${stat.id}')" class="bg-red-500 hover:bg-red-600 text-white text-xs font-bold py-1 px-2 rounded">Del</button></div><div class="grid grid-cols-2 text-sm gap-y-1 text-gray-300"><span class="font-semibold text-green-400">HP: ${stat.hp||0}</span><span class="font-semibold text-blue-400">AC: ${stat.ac||0}</span><span>Init: ${stat.initMod||0}</span><span>Hit: ${stat.toHit||0}</span><div class="col-span-2 text-yellow-400 text-xs mt-1"><span class="font-semibold">DMG:</span> ${stat.dmg}</div></div><button onclick="importToCombat('${stat.name}', ${stat.hp}, ${stat.initMod}, ${stat.ac})" class="mt-3 w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-1 rounded-lg text-sm">Add to Combat</button></div>`;
                el.appendChild(header); el.appendChild(content); list.appendChild(el);
            });
        }
        window.saveStatblock = async function() {
            if (!window.isAuthReady || !window.db) return;
            const name = document.getElementById('stat-name').value.trim(); if(!name) return;
            const data = { name, hp: parseInt(document.getElementById('stat-hp').value)||0, ac: parseInt(document.getElementById('stat-ac').value)||0, toHit: parseInt(document.getElementById('stat-tohit').value)||0, initMod: parseInt(document.getElementById('stat-init-mod').value)||0, dmg: document.getElementById('stat-dmg').value.trim(), timestamp: new Date().toISOString() };
            try { await window.addDoc(getStatblocksCollectionRef(), data); document.getElementById('statblock-status').textContent = "Saved!"; } catch (e){}
        }
        window.editStatblock = function(id) {
            const s = savedStatblocks.find(x => x.id === id); if(!s) return;
            document.getElementById('modal-statblock-id').value = s.id; document.getElementById('modal-stat-name').value = s.name;
            document.getElementById('modal-stat-hp').value = s.hp; document.getElementById('modal-stat-ac').value = s.ac;
            document.getElementById('modal-stat-tohit').value = s.toHit; document.getElementById('modal-stat-init-mod').value = s.initMod;
            document.getElementById('modal-stat-dmg').value = s.dmg; document.getElementById('edit-statblock-modal').classList.remove('hidden');
        }
        window.saveEditedStatblock = async function() {
            if (!window.isAuthReady || !window.db) return;
            const id = document.getElementById('modal-statblock-id').value;
            const data = { name: document.getElementById('modal-stat-name').value, hp: parseInt(document.getElementById('modal-stat-hp').value)||0, ac: parseInt(document.getElementById('modal-stat-ac').value)||0, toHit: parseInt(document.getElementById('modal-stat-tohit').value)||0, initMod: parseInt(document.getElementById('modal-stat-init-mod').value)||0, dmg: document.getElementById('modal-stat-dmg').value };
            try { await window.setDoc(window.doc(getStatblocksCollectionRef(), id), data, { merge: true }); closeStatblockEditModal(); } catch (e){}
        }
        window.closeStatblockEditModal = function() { document.getElementById('edit-statblock-modal').classList.add('hidden'); }
        window.deleteStatblock = async function(id) { if (window.isAuthReady && window.db) try { await window.deleteDoc(window.doc(getStatblocksCollectionRef(), id)); } catch (e){} }
        window.importToCombat = function(name, hp, initMod, ac) { document.getElementById('combatant-name').value = name; document.getElementById('combatant-hp').value = hp; document.getElementById('combatant-init').value = initMod; document.getElementById('combatant-ac').value = ac; switchTab('combat'); }
        window.rollCustomDice = function() {
            const n = parseInt(document.getElementById('dice-num').value)||1; const t = parseInt(document.getElementById('dice-type').value)||20; const m = parseInt(document.getElementById('dice-mod').value)||0;
            let s = 0; let r = []; for(let i=0;i<n;i++){ let x = Math.floor(Math.random()*t)+1; r.push(x); s+=x; }
            document.getElementById('dice-roll-result').textContent = `Total: ${s+m}`; document.getElementById('dice-roll-details').textContent = `Rolls: [${r.join(', ')}] ${m!==0 ? (m>0?'+'+m:m) : ''}`;
        }

        // --- AI ---
        const API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=';
        const IMAGE_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=`;
        const apiKey = ""; 

        async function fetchWithExponentialBackoff(url, payload) {
            const u = url.endsWith('?key=') ? url + apiKey : url;
            for(let i=0;i<3;i++) { try { const r = await fetch(u, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)}); if(r.ok) return r; await new Promise(res=>setTimeout(res, 1000*Math.pow(2,i))); } catch(e){ if(i===2) throw e; } }
        }

        // Monster Schema
        const monsterSchema = { type: "OBJECT", properties: { name: { type: "STRING" }, size: { type: "STRING" }, type: { type: "STRING" }, alignment: { type: "STRING" }, armor_class: { type: "INTEGER" }, ac_type: { type: "STRING" }, hit_points: { type: "INTEGER" }, hit_dice: { type: "STRING" }, speed: { type: "STRING" }, ability_scores: { type: "OBJECT", properties: { STR: { type: "INTEGER" }, DEX: { type: "INTEGER" }, CON: { type: "INTEGER" }, INT: { type: "INTEGER" }, WIS: { type: "INTEGER" }, CHA: { type: "INTEGER" } }, required: ["STR", "DEX", "CON", "INT", "WIS", "CHA"] }, saving_throws: { type: "ARRAY", items: { type: "STRING" } }, skills: { type: "ARRAY", items: { type: "STRING" } }, damage_vulnerabilities: { type: "ARRAY", items: { type: "STRING" } }, damage_resistances: { type: "ARRAY", items: { type: "STRING" } }, damage_immunities: { type: "ARRAY", items: { type: "STRING" } }, condition_immunities: { type: "ARRAY", items: { type: "STRING" } }, senses: { type: "STRING" }, languages: { type: "STRING" }, challenge_rating: { type: "STRING" }, xp: { type: "INTEGER" }, abilities: { type: "ARRAY", items: { type: "OBJECT", properties: { name: { type: "STRING" }, description: { type: "STRING" } }, required: ["name", "description"] } }, actions: { type: "ARRAY", items: { type: "OBJECT", properties: { name: { type: "STRING" }, description: { type: "STRING" } }, required: ["name", "description"] } }, legendary_actions: { type: "ARRAY", items: { type: "OBJECT", properties: { name: { type: "STRING" }, description: { type: "STRING" } }, required: ["name", "description"] } } }, required: ["name", "size", "type", "alignment", "armor_class", "hit_points", "hit_dice", "speed", "ability_scores", "senses", "languages", "challenge_rating", "xp", "actions"] };
        const combatSchema = { type: "OBJECT", properties: { name: { type: "STRING" }, level_or_cr: { type: "STRING" }, armor_class_ac: { type: "INTEGER" }, max_hit_points: { type: "INTEGER" }, initiative_bonus: { type: "INTEGER" }, main_attack: { type: "STRING" } }, required: ["name", "level_or_cr", "armor_class_ac", "max_hit_points", "initiative_bonus", "main_attack"] };

        window.generateCombatNpc = async function() {
            const level = document.getElementById('npc-level').value; const type = document.getElementById('npc-type').value;
            const btn = document.getElementById('generate-combat-button'); const out = document.getElementById('ai-output');
            btn.disabled = true; document.getElementById('combat-loading-spinner').classList.remove('hidden'); out.innerHTML = "Generating...";
            try {
                const res = await fetchWithExponentialBackoff(API_URL + apiKey, { contents: [{ parts: [{ text: `Generate D&D 5e NPC. Level: ${level}, Type: ${type}. Return JSON schema.` }] }], generationConfig: { responseMimeType: "application/json", responseSchema: combatSchema } });
                const data = await res.json(); const npc = JSON.parse(data.candidates[0].content.parts[0].text); lastGeneratedNpc = npc;
                out.innerHTML = `<div class="text-xl font-bold text-green-300">${npc.name}</div><div class="text-gray-300">Level/CR: ${npc.level_or_cr}</div><div class="grid grid-cols-2 gap-2 mt-2"><div class="p-2 bg-gray-700 rounded">AC: ${npc.armor_class_ac}</div><div class="p-2 bg-gray-700 rounded">HP: ${npc.max_hit_points}</div><div class="p-2 bg-gray-700 rounded col-span-2">Init: +${npc.initiative_bonus}</div><div class="p-2 bg-gray-700 rounded col-span-2">Attack: ${npc.main_attack}</div></div><button onclick="addNpcToStatblocks()" class="mt-3 w-full bg-indigo-600 py-2 rounded font-bold">Add to Statblocks</button>`;
            } catch(e) { out.textContent = "Error generating."; } finally { btn.disabled = false; document.getElementById('combat-loading-spinner').classList.add('hidden'); }
        }

        window.generateMonsterStatblock = async function() {
            const name = document.getElementById('monster-name').value; const cr = document.getElementById('monster-cr').value;
            const btn = document.getElementById('generate-monster-button'); const out = document.getElementById('monster-output');
            btn.disabled = true; document.getElementById('monster-loading-spinner').classList.remove('hidden'); out.innerHTML = "Generating...";
            try {
                const res = await fetchWithExponentialBackoff(API_URL + apiKey, { contents: [{ parts: [{ text: `Generate full D&D 5e monster: ${name}, CR ${cr}. Return JSON.` }] }], generationConfig: { responseMimeType: "application/json", responseSchema: monsterSchema } });
                const data = await res.json(); const stats = JSON.parse(data.candidates[0].content.parts[0].text); lastGeneratedMonster = stats;
                out.innerHTML = renderMonsterStatblock(stats); document.getElementById('save-options-monster').classList.remove('hidden');
            } catch(e) { out.textContent = "Error generating."; } finally { btn.disabled = false; document.getElementById('monster-loading-spinner').classList.add('hidden'); }
        }

        function renderMonsterStatblock(stats) {
            const mod = (s) => Math.floor((s-10)/2); const sign = (s) => mod(s)>=0?`+${mod(s)}`:mod(s);
            const list = (l) => (!l||!l.length)?'‚Äî':l.join(', ');
            const sect = (t, i) => (!i||!i.length)?'':`<h4 class="text-lg font-bold text-indigo-300 mt-2 border-b border-indigo-400">${t}</h4>${i.map(x=>`<p class="mt-1 text-sm"><strong class="text-white">${x.name}.</strong> <span class="text-gray-300">${x.description}</span></p>`).join('')}`;
            return `<div class="bg-gray-800 p-4 rounded border border-indigo-500"><h3 class="text-2xl font-bold text-indigo-300">${stats.name}</h3><p class="text-sm italic text-gray-400">${stats.size} ${stats.type}, ${stats.alignment}</p><div class="h-px bg-indigo-400 my-2"></div><p class="text-sm"><strong>AC:</strong> ${stats.armor_class} (${stats.ac_type||''})</p><p class="text-sm"><strong>HP:</strong> ${stats.hit_points} (${stats.hit_dice})</p><p class="text-sm"><strong>Speed:</strong> ${stats.speed}</p><div class="h-px bg-indigo-400 my-2"></div><div class="grid grid-cols-6 gap-2 text-center text-sm">${Object.entries(stats.ability_scores).map(([k,v])=>`<div><strong class="text-white">${k}</strong><div>${v} (${sign(v)})</div></div>`).join('')}</div><div class="h-px bg-indigo-400 my-2"></div><div class="text-sm space-y-1"><p><strong>Saves:</strong> ${list(stats.saving_throws)}</p><p><strong>Skills:</strong> ${list(stats.skills)}</p><p><strong>Senses:</strong> ${stats.senses}</p><p><strong>Lang:</strong> ${stats.languages}</p><p><strong>CR:</strong> ${stats.challenge_rating} (${stats.xp} XP)</p></div>${sect('Abilities', stats.abilities)}${sect('Actions', stats.actions)}${sect('Legendary', stats.legendary_actions)}</div>`;
        }

        window.generateSettlement = async function() {
            const type = document.getElementById('settlement-type').value; const vibe = document.getElementById('settlement-vibe').value;
            const btn = document.getElementById('generate-settlement-button'); const out = document.getElementById('ai-output');
            btn.disabled = true; document.getElementById('settlement-loading-spinner').classList.remove('hidden'); out.textContent = "Building world...";
            const imgOut = document.getElementById('generated-image'); imgOut.classList.add('hidden'); document.getElementById('image-loading-status').textContent = "Painting..."; document.getElementById('image-loading-status').classList.remove('hidden'); document.getElementById('ai-image-output').classList.remove('hidden');
            try {
                const textReq = fetchWithExponentialBackoff(API_URL + apiKey, { contents: [{ parts: [{ text: `Generate D&D settlement. Type: ${type}. Vibe: ${vibe}. Include Name, Lore, Locations, NPCs.` }] }], tools: [{google_search:{}}] });
                const imgReq = fetchWithExponentialBackoff(IMAGE_API_URL + apiKey, { instances: { prompt: `Fantasy concept art of a ${vibe} ${type}, top down, d&d style` }, parameters: { sampleCount: 1 } });
                const [textRes, imgRes] = await Promise.all([textReq, imgReq]);
                const tData = await textRes.json(); out.textContent = tData.candidates[0].content.parts[0].text; document.getElementById('save-options-creative').classList.remove('hidden');
                const iData = await imgRes.json(); if(iData.predictions) { imgOut.src = `data:image/png;base64,${iData.predictions[0].bytesBase64Encoded}`; imgOut.classList.remove('hidden'); document.getElementById('image-loading-status').classList.add('hidden'); }
            } catch(e) { out.textContent += " (Error)"; } finally { btn.disabled = false; document.getElementById('settlement-loading-spinner').classList.add('hidden'); }
        }

        window.generateCreativeIdea = async function() {
            const prompt = document.getElementById('improv-prompt').value; if(!prompt) return;
            const btn = document.getElementById('generate-button'); const out = document.getElementById('ai-output');
            btn.disabled = true; document.getElementById('creative-loading-spinner').classList.remove('hidden'); out.textContent = "Thinking...";
            try {
                const res = await fetchWithExponentialBackoff(API_URL + apiKey, { contents: [{ parts: [{ text: prompt }] }] });
                const data = await res.json(); out.textContent = data.candidates[0].content.parts[0].text; document.getElementById('save-options-creative').classList.remove('hidden');
            } catch(e) { out.textContent = "Error"; } finally { btn.disabled = false; document.getElementById('creative-loading-spinner').classList.add('hidden'); }
        }

        // --- HELPERS ---
        window.switchTab = function(tabId) {
            currentTab = tabId; document.querySelectorAll('.tab-content').forEach(e => e.classList.add('hidden')); document.getElementById(tabId).classList.remove('hidden');
            document.querySelectorAll('.tab-button').forEach(b => { b.classList.remove('active'); b.classList.add('text-gray-400'); });
            const map = { 'improv': 0, 'combat': 1, 'statblocks': 2, 'monsters': 3, 'notes': 4 };
            const btns = document.querySelectorAll('.tab-button'); if(btns[map[tabId]]) { btns[map[tabId]].classList.add('active'); btns[map[tabId]].classList.remove('text-gray-400'); }
            if (tabId === 'notes') switchSubTab(currentSubTab);
        }
        window.switchSubTab = function(tabId) {
            currentSubTab = tabId; document.querySelectorAll('.sub-tab-content').forEach(e => e.classList.add('hidden')); document.getElementById(`${tabId}-sub-content`).classList.remove('hidden');
            document.querySelectorAll('.sub-tab-button').forEach(b => { b.classList.remove('active', 'text-gray-400'); if(b.dataset.subtab === tabId) { b.classList.add('active'); b.classList.remove('text-gray-400'); } else b.classList.add('text-gray-400'); });
            renderStructuredNotes(currentSubTab);
        }
        window.saveGeneratedContent = async function(tab) {
            const content = document.getElementById('ai-output').textContent; if(!content) return;
            const title = content.split('\n')[0].substring(0, 30) || "AI Note";
            structuredNotes[tab].unshift({ id: crypto.randomUUID(), title, content, timestamp: new Date().toISOString() });
            await saveStructuredNotes(tab, structuredNotes[tab]); switchTab('notes'); switchSubTab(tab);
        }

        // --- UPDATED MONSTER SAVING FUNCTIONS WITH FEEDBACK ---
        window.addMonsterToStatblocks = async function () {
            const statusEl = document.getElementById('monster-save-status');
            statusEl.classList.add('hidden'); 
            
            if (!window.isAuthReady || !window.db) return alert("Login to save!");
            if (!lastGeneratedMonster) return alert("No monster generated.");

            statusEl.textContent = "Saving..."; statusEl.className = "mt-2 text-sm text-center text-yellow-400"; statusEl.classList.remove('hidden');

            const m = lastGeneratedMonster;
            let toHit = 0; let dmg = 'N/A';
            if (m.actions && m.actions.length > 0) {
                const hit = m.actions[0].description.match(/(\+|\-)\d+\s+to hit/); if(hit) toHit = parseInt(hit[0], 10);
                dmg = m.actions.map(a => `<span class='block mt-1'><strong>${a.name}:</strong> ${a.description}</span>`).join('');
            }
            const initMod = Math.floor(((m.ability_scores?.DEX || 10) - 10)/2);

            try { 
                await window.addDoc(getStatblocksCollectionRef(), { name: m.name, hp: m.hit_points, ac: m.armor_class, toHit, initMod, dmg, timestamp: new Date().toISOString() });
                statusEl.textContent = "Saved to Statblocks!"; statusEl.className = "mt-2 text-sm text-center text-green-400";
            } catch (e) { 
                console.error(e); 
                statusEl.textContent = "Error saving: " + e.message; statusEl.className = "mt-2 text-sm text-center text-red-400";
            }
        }

        window.saveMonsterToNotes = async function() {
            const statusEl = document.getElementById('monster-save-status');
            statusEl.classList.add('hidden');

            if (!window.isAuthReady || !window.db) return alert("Login to save!");
            if (!lastGeneratedMonster) return alert("No monster generated.");

            statusEl.textContent = "Saving..."; statusEl.className = "mt-2 text-sm text-center text-yellow-400"; statusEl.classList.remove('hidden');

            const content = document.getElementById('monster-output').innerHTML;
            structuredNotes['enemyNotes'].unshift({ id: crypto.randomUUID(), title: `${lastGeneratedMonster.name} (CR ${lastGeneratedMonster.challenge_rating})`, content, timestamp: new Date().toISOString() });
            
            try {
                await saveStructuredNotes('enemyNotes', structuredNotes['enemyNotes']);
                statusEl.textContent = "Saved to Enemy Notes!"; statusEl.className = "mt-2 text-sm text-center text-green-400";
            } catch(e) {
                console.error(e);
                statusEl.textContent = "Error saving: " + e.message; statusEl.className = "mt-2 text-sm text-center text-red-400";
            }
        }

        document.addEventListener('DOMContentLoaded', () => { switchTab(currentTab); });
    </script>
</body>
</html>

