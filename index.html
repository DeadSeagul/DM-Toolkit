<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aegis DM Toolkit</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, deleteDoc, getDoc, collection, query, onSnapshot, setLogLevel, addDoc, updateDoc, orderBy, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        window.doc = doc; window.setDoc = setDoc; window.deleteDoc = deleteDoc; window.collection = collection;
        window.query = query; window.onSnapshot = onSnapshot; window.addDoc = addDoc; window.getDoc = getDoc; 
        window.updateDoc = updateDoc; window.orderBy = orderBy; window.writeBatch = writeBatch; 

        window.GoogleAuthProvider = GoogleAuthProvider;
        window.signInWithPopup = signInWithPopup;
        window.signOut = signOut;

        // Add these missing wrapper functions
        window.loginWithGoogle = async () => {
            if (!window.auth) return;
            try {
                const provider = new GoogleAuthProvider();
                await signInWithPopup(window.auth, provider);
            } catch (error) {
                console.error("Login failed:", error);
                alert("Login failed: " + error.message);
            }
        };

        window.logoutUser = async () => {
            if (!window.auth) return;
            try {
                await signOut(window.auth);
            } catch (error) {
                console.error("Logout failed:", error);
            }
        };

        window.db = null; window.auth = null; window.userId = null; window.isAuthReady = false;

        const manualFirebaseConfig = {
            apiKey: "AIzaSyB6lyGYJzk70t1OJvzBn5uyJN_k2_5NKYg",
            authDomain: "aegisdmtoolkit.firebaseapp.com",
            projectId: "aegisdmtoolkit",
            storageBucket: "aegisdmtoolkit.firebasestorage.app",
            messagingSenderId: "654767294266",
            appId: "1:654767294266:web:fbee20be7d458fb7d6f203"
        };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const envFirebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const isManualConfig = (manualFirebaseConfig.apiKey && manualFirebaseConfig.apiKey !== "PASTE_YOUR_API_KEY_HERE");
        const firebaseConfig = isManualConfig ? manualFirebaseConfig : envFirebaseConfig;

        if (firebaseConfig && Object.keys(firebaseConfig).length > 0) {
            const app = initializeApp(firebaseConfig);
            window.db = getFirestore(app);
            window.auth = getAuth(app);
            
            onAuthStateChanged(window.auth, async (user) => {
                if (!user) {
                    try {
                        if (initialAuthToken && !isManualConfig) {
                            await signInWithCustomToken(window.auth, initialAuthToken);
                        } else {
                            await signInAnonymously(window.auth);
                        }
                    } catch (error) {
                        console.warn("Auth error, using anonymous:", error);
                        try { await signInAnonymously(window.auth); } catch(e) {}
                    }
                } else {
                    try { await user.getIdToken(true); } catch (e) {}
                    window.userId = user.uid;
                    window.isAuthReady = true;
                    updateLoginUI(user);
                    if (window.setupNotesListener) window.setupNotesListener();
                    if (window.setupCombatDataListeners) window.setupCombatDataListeners();
                    if (window.setupStatblocksListener) window.setupStatblocksListener();
                }
            });
        } else { console.error("Firebase config missing."); }

        function updateLoginUI(user) {
            const loginBtn = document.getElementById('login-btn');
            const userProfile = document.getElementById('user-profile');
            const userAvatar = document.getElementById('user-avatar');
            const userName = document.getElementById('user-name');
            if (user.isAnonymous) {
                if(loginBtn) loginBtn.classList.remove('hidden');
                if(userProfile) userProfile.classList.add('hidden');
            } else {
                if(loginBtn) loginBtn.classList.add('hidden');
                if(userProfile) userProfile.classList.remove('hidden');
                if(userAvatar) userAvatar.src = user.photoURL || 'https://via.placeholder.com/32';
                if(userName) userName.textContent = user.displayName || 'Adventurer';
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Libre+Baskerville:wght@400;700&display=swap');

        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f8fafc; }
        .tab-button.active { border-bottom: 3px solid #6366f1; color: #c7d2fe; }
        .sub-tab-button.active { border-bottom: 2px solid #34d399; color: #34d399; }
        .card { background-color: #1e293b; border: 1px solid #334155; }
        .input-style { background-color: #334155; border: 1px solid #475569; color: #f8fafc; }
        .glow-shadow { box-shadow: 0 0 10px rgba(99, 102, 241, 0.5); }
        .scrollable-content { max-height: 60vh; overflow-y: auto; }
        .scrollable-content::-webkit-scrollbar { width: 8px; }
        .scrollable-content::-webkit-scrollbar-track { background: #1e293b; }
        .scrollable-content::-webkit-scrollbar-thumb { background-color: #475569; border-radius: 20px; border: 2px solid #1e293b; }
        .loading-spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-top: 4px solid #fff; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .collapsible-header { cursor: pointer; display: flex; justify-content: space-between; align-items: center; padding: 10px; background-color: #334155; border-radius: 8px; }
        .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; padding: 0 10px; }
        .collapsible-content.expanded { max-height: 1000px; padding: 10px; }
        .arrow-icon { transition: transform 0.3s ease; }
        .expanded .arrow-icon { transform: rotate(90deg); }
        .sound-btn { transition: all 0.1s ease; }
        .sound-btn:active { transform: scale(0.95); }
        .sound-btn.active-loop { border-color: #34d399; background-color: #059669; box-shadow: 0 0 15px #34d399; animation: pulse-green 2s infinite; }
        @keyframes pulse-green { 0% { box-shadow: 0 0 0 0 rgba(52, 211, 153, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(52, 211, 153, 0); } 100% { box-shadow: 0 0 0 0 rgba(52, 211, 153, 0); } }
        /* Range Slider Style */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #34d399; cursor: pointer; margin-top: -6px; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #475569; border-radius: 2px; }
        
        /* D&D Statblock Styles */
        .dnd-statblock {
            background-color: #fdf1dc;
            color: #58180d;
            font-family: 'Libre Baskerville', serif;
            padding: 15px;
            border: 1px solid #d4b57e;
            box-shadow: 0 0 15px rgba(0,0,0,0.3);
            position: relative;
        }
        .dnd-statblock::before, .dnd-statblock::after {
            content: "";
            display: block;
            height: 4px;
            background: #e69a28;
            margin: 4px 0;
            border-radius: 2px;
        }
        .dnd-header {
            font-family: 'Libre Baskerville', serif;
            font-variant: small-caps;
            font-weight: 700;
            color: #58180d;
            font-size: 1.5em;
            line-height: 1.1;
        }
        .tapered-rule {
            display: block;
            height: 2px;
            background: #58180d;
            margin: 10px 0;
            border: none;
            background: linear-gradient(to right, transparent, #58180d, transparent);
        }
        .dnd-property-line {
            font-size: 0.9rem;
            line-height: 1.4;
            margin-bottom: 2px;
        }
        .dnd-property-line strong {
            color: #58180d;
        }
        .dnd-section-title {
            font-variant: small-caps;
            font-weight: bold;
            font-size: 1.2em;
            color: #58180d;
            border-bottom: 1px solid #7a200d;
            margin-top: 10px;
            margin-bottom: 5px;
        }
        .dnd-action-name {
            font-weight: bold;
            font-style: italic;
        }
    </style>
</head>
<body class="p-4 sm:p-8">
    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <div class="flex justify-between items-center mb-6 bg-gray-800 p-3 rounded-lg border border-gray-700 shadow-lg">
            <h1 class="text-2xl font-bold text-indigo-400 flex items-center gap-2"><span>üõ°Ô∏è</span> Aegis DM Toolkit</h1>
            <div class="flex items-center gap-3">
                <a href="https://ko-fi.com/aegisdmtool" target="_blank" class="bg-yellow-600/20 hover:bg-yellow-600/40 text-yellow-200 border border-yellow-600/50 text-xs font-bold py-2 px-3 rounded-lg transition duration-200 flex items-center gap-2 no-underline">
                    <span>‚òï</span> <span class="hidden sm:inline">Tip</span>
                </a>
                <div>
                    <button id="login-btn" onclick="loginWithGoogle()" class="hidden bg-white text-gray-900 hover:bg-gray-200 font-bold py-2 px-4 rounded-lg text-sm flex items-center gap-2 transition duration-200">
                        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M12.545,10.239v3.821h5.445c-0.712,2.315-2.647,3.972-5.445,3.972c-3.332,0-6.033-2.701-6.033-6.032s2.701-6.032,6.033-6.032c1.498,0,2.866,0.549,3.921,1.453l2.814-2.814C17.503,2.988,15.139,2,12.545,2C7.021,2,2.543,6.477,2.543,12s4.478,10,10.002,10c8.396,0,10.249-7.85,9.426-11.748L12.545,10.239z"/></svg>
                        Sign in with Google
                    </button>
                    <div id="user-profile" class="hidden flex items-center gap-3">
                        <div class="text-right hidden sm:block"><div id="user-name" class="text-sm font-semibold text-white">Adventurer</div><div class="text-xs text-green-400">Online & Saving</div></div>
                        <img id="user-avatar" src="" alt="User" class="w-9 h-9 rounded-full border-2 border-indigo-500">
                        <button onclick="logoutUser()" class="bg-red-900/50 hover:bg-red-800 text-red-200 p-2 rounded-lg text-xs border border-red-800 transition duration-200">Sign Out</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Nav -->
        <div class="flex border-b border-gray-600 mb-6 overflow-x-auto">
            <button class="tab-button p-3 flex-1 text-sm font-semibold transition duration-300 active min-w-[100px]" onclick="switchTab('improv')">üîÆ Prep</button>
            <button class="tab-button p-3 flex-1 text-sm font-semibold text-gray-400 transition duration-300 min-w-[100px]" onclick="switchTab('combat')">‚öîÔ∏è Combat</button>
            <button class="tab-button p-3 flex-1 text-sm font-semibold text-gray-400 transition duration-300 min-w-[100px]" onclick="switchTab('statblocks')">üëπ Stats</button>
            <button class="tab-button p-3 flex-1 text-sm font-semibold text-gray-400 transition duration-300 min-w-[100px]" onclick="switchTab('monsters')">üê≤ Monsters</button>
            <button class="tab-button p-3 flex-1 text-sm font-semibold text-gray-400 transition duration-300 min-w-[100px]" onclick="switchTab('loot')">üí∞ Loot</button>
            <button class="tab-button p-3 flex-1 text-sm font-semibold text-gray-400 transition duration-300 min-w-[100px]" onclick="switchTab('soundboard')">üîä Sound</button>
            <button class="tab-button p-3 flex-1 text-sm font-semibold text-gray-400 transition duration-300 min-w-[100px]" onclick="switchTab('notes')">üìú Notes</button>
        </div>

        <!-- Content -->
        <div id="content-area">
            <!-- Prep Tab -->
            <div id="improv" class="tab-content">
                <div class="card p-4 rounded-lg shadow-xl mb-6 border border-indigo-500/30">
                    <h2 class="text-xl font-semibold mb-2 text-indigo-300">üîë AI Configuration</h2>
                    <p class="text-xs text-gray-400 mb-3">Enter your Google Gemini API Key. Saved locally. Get API Key <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-indigo-400 hover:underline">Here</a>.</p>
                    <div class="flex gap-2">
                        <input type="password" id="user-api-key" placeholder="Paste API Key (AIza...)" class="flex-1 p-2 rounded-lg input-style text-sm">
                        <button onclick="saveApiKey()" class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg text-sm transition duration-200">Save</button>
                    </div>
                    <p id="api-key-status" class="mt-2 text-xs text-gray-500">Status: No key saved.</p>
                </div>

                <div class="card p-4 rounded-lg shadow-xl mb-6">
                    <h2 class="text-xl font-semibold mb-4 text-green-300">Combat NPC Stats</h2>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div><label class="block text-xs font-medium text-gray-400 mb-1">Level/CR</label><input type="text" id="npc-level" value="3" class="w-full p-2 rounded-lg input-style text-sm"></div>
                        <div><label class="block text-xs font-medium text-gray-400 mb-1">NPC Type</label><input type="text" id="npc-type" value="Shadow Rogue" class="w-full p-2 rounded-lg input-style text-sm"></div>
                    </div>
                    <button onclick="generateCombatNpc()" id="generate-combat-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded-lg flex items-center justify-center"><span id="generate-combat-text">Generate Stats</span><div id="combat-loading-spinner" class="loading-spinner ml-2 hidden"></div></button>
                    <p id="combat-status-message" class="mt-2 text-sm text-center text-red-400 hidden"></p>
                </div>
                <div class="card p-4 rounded-lg shadow-xl mb-6">
                    <h2 class="text-xl font-semibold mb-4 text-indigo-300">Creative Lore</h2>
                    <textarea id="improv-prompt" rows="3" class="w-full p-3 rounded-lg input-style resize-none" placeholder="Enter a prompt..."></textarea>
                    <button onclick="generateCreativeIdea()" id="generate-button" class="mt-4 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 rounded-lg flex items-center justify-center"><span id="generate-text">Generate Idea</span><div id="creative-loading-spinner" class="loading-spinner ml-2 hidden"></div></button>
                </div>
                <div class="card p-4 rounded-lg shadow-xl mb-6">
                    <h2 class="text-xl font-semibold mb-4 text-teal-300">Settlement Generator</h2>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div><label class="block text-xs font-medium text-gray-400 mb-1">Type</label><select id="settlement-type" class="w-full p-2 rounded-lg input-style text-sm"><option value="Village">Village</option><option value="Town">Town</option><option value="City">City</option></select></div>
                        <div><label class="block text-xs font-medium text-gray-400 mb-1">Vibe</label><input type="text" id="settlement-vibe" value="haunted fishing village" class="w-full p-2 rounded-lg input-style text-sm"></div>
                    </div>
                    <button onclick="generateSettlement()" id="generate-settlement-button" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 rounded-lg flex items-center justify-center"><span id="generate-settlement-text">Generate</span><div id="settlement-loading-spinner" class="loading-spinner ml-2 hidden"></div></button>
                </div>
                <div class="card p-4 rounded-lg shadow-xl">
                    <h2 class="text-xl font-semibold mb-4 text-indigo-300">Result</h2>
                    <div id="ai-image-output" class="mb-4 hidden rounded-lg overflow-hidden shadow-lg"><img id="generated-image" class="w-full h-auto object-cover bg-gray-700/30 min-h-[150px]"><p id="image-loading-status" class="text-center text-gray-400 p-3 bg-gray-800"></p></div>
                    <div id="ai-output" class="whitespace-pre-wrap min-h-[100px] bg-gray-700/30 p-3 rounded-lg text-gray-300">Results appear here.</div>
                    <p id="npc-save-status" class="mt-2 text-sm text-center hidden"></p>
                    <div id="save-options-creative" class="mt-4 hidden">
                        <p class="text-sm text-center text-gray-400 mb-2">Save to:</p>
                        <div class="grid grid-cols-3 gap-2"><button onclick="saveGeneratedContent('prepNotes')" class="save-notes-btn bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 rounded-lg text-xs">Notes</button><button onclick="saveGeneratedContent('enemyNotes')" class="save-notes-btn bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 rounded-lg text-xs">Enemies</button><button onclick="saveGeneratedContent('npcNotes')" class="save-notes-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg text-xs">NPCs</button></div>
                    </div>
                </div>
            </div>

            <!-- Combat Tab -->
            <div id="combat" class="tab-content hidden">
                <div class="card p-4 rounded-lg shadow-xl">
                    <h2 class="text-xl font-semibold mb-4 text-indigo-300">Tracker</h2>
                    <div class="flex justify-between items-center mb-2"><span id="db-status" class="text-xs px-2 py-1 rounded bg-gray-700 text-gray-400">Connecting...</span></div>
                    <div class="flex flex-wrap gap-2 mb-4">
                        <input id="combatant-name" type="text" placeholder="Name" class="flex-1 min-w-[100px] p-2 rounded-lg input-style">
                        <input id="combatant-init" type="number" placeholder="Init" class="w-20 p-2 rounded-lg input-style text-center text-sm">
                        <input id="combatant-ac" type="number" placeholder="AC" class="w-16 p-2 rounded-lg input-style text-center text-sm">
                        <input id="combatant-hp" type="number" placeholder="HP" class="w-16 p-2 rounded-lg input-style text-center text-sm">
                        <button onclick="addCombatant()" id="add-combatant-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold px-3 py-2 rounded-lg text-sm">Add</button>
                    </div>
                    <div class="card p-4 rounded-lg shadow-inner mb-4 bg-gray-800/50">
                        <h3 class="text-md font-semibold mb-2 text-indigo-400">Dice Roller</h3>
                        <div class="flex items-center space-x-2"><button onclick="rollD20()" class="w-1/3 bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded-lg text-sm">Roll D20</button><div id="last-roll-display" class="w-1/3 text-4xl font-extrabold text-center text-yellow-400 border-2 border-yellow-400 p-2 rounded-lg bg-gray-900/50 select-none">?</div><select id="combatant-selector" class="w-1/3 p-2 rounded-lg input-style text-sm"><option value="" disabled selected>Target</option></select></div>
                        <button onclick="assignInitiativeRoll()" id="assign-roll-button" class="mt-2 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg text-sm disabled:opacity-50" disabled>Assign Roll</button>
                    </div>
                    <div class="flex justify-between items-center mb-4">
                        <button onclick="sortInitiative()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-3 rounded-lg text-sm">Sort</button>
                        <button onclick="nextTurn()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-3 rounded-lg text-sm">Next &raquo;</button>
                        <button onclick="clearCombat()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-3 rounded-lg text-sm">Clear</button>
                    </div>
                    <div id="initiative-list" class="scrollable-content space-y-2"><p class="text-center text-gray-500 pt-8">List empty.</p></div>
                </div>
            </div>

            <!-- Statblocks Tab -->
            <div id="statblocks" class="tab-content hidden">
                <div class="card p-4 rounded-lg shadow-xl mb-6">
                    <h2 class="text-xl font-semibold mb-4 text-indigo-300">Save NPC</h2>
                    <div class="grid grid-cols-2 gap-2 mb-4">
                        <input id="stat-name" type="text" placeholder="Name" class="col-span-2 p-2 rounded-lg input-style">
                        <input id="stat-hp" type="number" placeholder="HP" class="p-2 rounded-lg input-style text-center text-sm">
                        <input id="stat-ac" type="number" placeholder="AC" class="p-2 rounded-lg input-style text-center text-sm">
                        <input id="stat-tohit" type="number" placeholder="Hit Mod" class="p-2 rounded-lg input-style text-center text-sm">
                        <input id="stat-init-mod" type="number" placeholder="Init Mod" class="p-2 rounded-lg input-style text-center text-sm">
                        <input id="stat-dmg" type="text" placeholder="Damage" class="col-span-2 p-2 rounded-lg input-style">
                    </div>
                    <button onclick="saveStatblock()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 rounded-lg">Save</button>
                    <p id="statblock-status" class="mt-2 text-sm text-center text-gray-400"></p>
                </div>
                <div class="card p-4 rounded-lg shadow-xl">
                    <h2 class="text-xl font-semibold mb-4 text-indigo-300">Saved</h2>
                    <div id="statblocks-list" class="scrollable-content space-y-2"><p class="text-center text-gray-500 pt-8">No stats saved.</p></div>
                </div>
            </div>

            <!-- Monsters Tab -->
            <div id="monsters" class="tab-content hidden">
                <div class="card p-4 rounded-lg shadow-xl mb-6">
                    <h2 class="text-xl font-semibold mb-4 text-green-300">Monster Generator</h2>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div><label class="block text-xs font-medium text-gray-400 mb-1">Name</label><input type="text" id="monster-name" value="Cave Troll" class="w-full p-2 rounded-lg input-style text-sm"></div>
                        <div><label class="block text-xs font-medium text-gray-400 mb-1">CR</label><input type="text" id="monster-cr" value="4" class="w-full p-2 rounded-lg input-style text-sm"></div>
                    </div>
                    <button onclick="generateMonsterStatblock()" id="generate-monster-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded-lg flex items-center justify-center"><span id="generate-monster-text">Generate</span><div id="monster-loading-spinner" class="loading-spinner ml-2 hidden"></div></button>
                    <p id="monster-status-message" class="mt-2 text-sm text-center text-red-400 hidden"></p>
                </div>
                <div class="card p-4 rounded-lg shadow-xl">
                    <h2 class="text-xl font-semibold mb-4 text-indigo-300">Result</h2>
                    <div id="monster-output" class="min-h-[100px] bg-gray-700/30 p-3 rounded-lg text-gray-300">Stat block will appear here.</div>
                    <p id="monster-save-status" class="mt-2 text-sm text-center hidden"></p>
                    <div id="save-options-monster" class="mt-4 hidden">
                        <div class="grid grid-cols-2 gap-2"><button onclick="addMonsterToStatblocks()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 rounded-lg text-xs">Save to Stats</button><button onclick="saveMonsterToNotes()" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 rounded-lg text-xs">Save to Notes</button></div>
                    </div>
                </div>
            </div>

            <!-- Loot Tab -->
            <div id="loot" class="tab-content hidden">
                <div class="card p-4 rounded-lg shadow-xl mb-6">
                    <h2 class="text-xl font-semibold mb-4 text-yellow-300">Loot Generator</h2>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div><label class="block text-xs font-medium text-gray-400 mb-1">Level/CR</label><input type="text" id="loot-level" value="3" class="w-full p-2 rounded-lg input-style text-sm"></div>
                        <div><label class="block text-xs font-medium text-gray-400 mb-1">Type</label><select id="loot-type" class="w-full p-2 rounded-lg input-style text-sm"><option value="Individual">Individual</option><option value="Hoard">Hoard</option><option value="Shop Inventory">Shop</option></select></div>
                    </div>
                    <button onclick="generateLoot()" id="generate-loot-button" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 rounded-lg flex items-center justify-center"><span id="generate-loot-text">Generate</span><div id="loot-loading-spinner" class="loading-spinner ml-2 hidden"></div></button>
                </div>
                <div class="card p-4 rounded-lg shadow-xl">
                    <h2 class="text-xl font-semibold mb-4 text-indigo-300">Result</h2>
                    <div id="loot-output" class="whitespace-pre-wrap min-h-[100px] bg-gray-700/30 p-3 rounded-lg text-gray-300">Loot appears here.</div>
                    <button onclick="saveGeneratedContent('lootNotes')" class="mt-4 w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 rounded-lg text-sm">Save to Loot Notes</button>
                </div>
            </div>

            <!-- Soundboard Tab -->
            <div id="soundboard" class="tab-content hidden">
                <div class="card p-4 rounded-lg shadow-xl mb-6">
                    <h2 class="text-xl font-semibold mb-4 text-pink-300">Synth Soundboard</h2>
                    
                    <!-- Volume Slider -->
                    <div class="mb-6 flex items-center gap-4 bg-gray-800 p-3 rounded-lg border border-gray-700">
                        <label for="master-volume" class="text-sm font-bold text-indigo-400">Master Volume:</label>
                        <input type="range" id="master-volume" min="0" max="1" step="0.01" value="0.5" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-green-400">
                    </div>

                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-4 mb-6">
                        <button onclick="playTone('success')" class="sound-btn bg-green-600 hover:bg-green-500 text-white font-bold py-4 rounded-lg shadow-lg border-b-4 border-green-800 flex flex-col items-center justify-center"><span class="text-2xl mb-1">‚ú®</span><span class="text-xs">Success</span></button>
                        <button onclick="playTone('critical')" class="sound-btn bg-green-700 hover:bg-green-600 text-white font-bold py-4 rounded-lg shadow-lg border-b-4 border-green-900 flex flex-col items-center justify-center"><span class="text-2xl mb-1">üéâ</span><span class="text-xs">Crit</span></button>
                        <button onclick="playTone('fail')" class="sound-btn bg-red-600 hover:bg-red-500 text-white font-bold py-4 rounded-lg shadow-lg border-b-4 border-red-800 flex flex-col items-center justify-center"><span class="text-2xl mb-1">‚ùå</span><span class="text-xs">Fail</span></button>
                        <button onclick="playTone('combat_start')" class="sound-btn bg-orange-600 hover:bg-orange-500 text-white font-bold py-4 rounded-lg shadow-lg border-b-4 border-orange-800 flex flex-col items-center justify-center"><span class="text-2xl mb-1">‚öîÔ∏è</span><span class="text-xs">Combat</span></button>
                        <button onclick="playTone('spell')" class="sound-btn bg-purple-600 hover:bg-purple-500 text-white font-bold py-4 rounded-lg shadow-lg border-b-4 border-purple-800 flex flex-col items-center justify-center"><span class="text-2xl mb-1">üîÆ</span><span class="text-xs">Spell</span></button>
                        <button onclick="playTone('mystery')" class="sound-btn bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-4 rounded-lg shadow-lg border-b-4 border-indigo-800 flex flex-col items-center justify-center"><span class="text-2xl mb-1">üëª</span><span class="text-xs">Mystery</span></button>
                        <button onclick="playTone('rest')" class="sound-btn bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-lg shadow-lg border-b-4 border-blue-800 flex flex-col items-center justify-center"><span class="text-2xl mb-1">üí§</span><span class="text-xs">Rest</span></button>
                        <button onclick="playTone('trap')" class="sound-btn bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-4 rounded-lg shadow-lg border-b-4 border-yellow-800 flex flex-col items-center justify-ÂØπÁùÄ">‚ö†Ô∏è<span class="text-xs">Trap</span></button>
                        <button onclick="playTone('boss')" class="sound-btn bg-gray-700 hover:bg-gray-600 text-white font-bold py-4 rounded-lg shadow-lg border-b-4 border-gray-900 flex flex-col items-center justify-center"><span class="text-2xl mb-1">üíÄ</span><span class="text-xs">Boss</span></button>
                    </div>
                    <h3 class="text-sm font-semibold text-gray-400 mb-2 uppercase tracking-wider border-t border-gray-700 pt-4">Ambience Loops</h3>
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                        <button onclick="toggleAmbience('village')" id="ambience-village" class="sound-btn bg-teal-800 hover:bg-teal-700 text-white font-bold py-3 rounded-lg shadow-md border border-teal-600 flex flex-col items-center justify-center"><span class="text-xl mb-1">üèòÔ∏è</span><span class="text-xs">Village</span></button>
                        <button onclick="toggleAmbience('city')" id="ambience-city" class="sound-btn bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 rounded-lg shadow-md border border-gray-500 flex flex-col items-center justify-center"><span class="text-xl mb-1">üè∞</span><span class="text-xs">City</span></button>
                        <button onclick="toggleAmbience('tavern')" id="ambience-tavern" class="sound-btn bg-yellow-900 hover:bg-yellow-800 text-white font-bold py-3 rounded-lg shadow-md border border-yellow-700 flex flex-col items-center justify-center"><span class="text-xl mb-1">üç∫</span><span class="text-xs">Tavern</span></button>
                        <button onclick="toggleAmbience('ocean')" id="ambience-ocean" class="sound-btn bg-blue-900 hover:bg-blue-800 text-white font-bold py-3 rounded-lg shadow-md border border-blue-700 flex flex-col items-center justify-center"><span class="text-xl mb-1">‚öì</span><span class="text-xs">Sea Shanty</span></button>
                        <button onclick="toggleAmbience('dungeon')" id="ambience-dungeon" class="sound-btn bg-purple-900 hover:bg-purple-800 text-white font-bold py-3 rounded-lg shadow-md border border-purple-700 flex flex-col items-center justify-center"><span class="text-xl mb-1">‚õìÔ∏è</span><span class="text-xs">Dungeon</span></button>
                        <button onclick="toggleAmbience('battle_minor')" id="ambience-battle_minor" class="sound-btn bg-red-900 hover:bg-red-800 text-white font-bold py-3 rounded-lg shadow-md border border-red-700 flex flex-col items-center justify-center"><span class="text-xl mb-1">üõ°Ô∏è</span><span class="text-xs">Minor Battle</span></button>
                        <button onclick="toggleAmbience('battle_major')" id="ambience-battle_major" class="sound-btn bg-gray-800 hover:bg-gray-700 text-white font-bold py-3 rounded-lg shadow-md border border-gray-600 flex flex-col items-center justify-center"><span class="text-xl mb-1">üî•</span><span class="text-xs">Major Battle</span></button>
                        <button onclick="toggleAmbience('sleep')" id="ambience-sleep" class="sound-btn bg-indigo-900 hover:bg-indigo-800 text-white font-bold py-3 rounded-lg shadow-md border border-indigo-700 flex flex-col items-center justify-center"><span class="text-xl mb-1">‚õ∫</span><span class="text-xs">Rest</span></button>
                    </div>
                    <div id="ambience-status" class="mt-2 text-center text-xs text-green-400 h-4"></div>
                </div>
            </div>

            <!-- Notes Tab -->
            <div id="notes" class="tab-content hidden">
                <div class="card p-4 rounded-lg shadow-xl">
                    <h2 class="text-xl font-semibold mb-4 text-indigo-300">Notes</h2>
                    <div class="flex border-b border-gray-700 mb-4 -mx-4 px-4 overflow-x-auto">
                        <button class="sub-tab-button p-2 text-sm font-semibold transition duration-300 active" data-subtab="prepNotes" onclick="switchSubTab('prepNotes')">üìú General</button>
                        <button class="sub-tab-button p-2 text-sm font-semibold text-gray-400 transition duration-300" data-subtab="enemyNotes" onclick="switchSubTab('enemyNotes')">üíÄ Enemies</button>
                        <button class="sub-tab-button p-2 text-sm font-semibold text-gray-400 transition duration-300" data-subtab="npcNotes" onclick="switchSubTab('npcNotes')">üë• NPCs</button>
                        <button class="sub-tab-button p-2 text-sm font-semibold text-gray-400 transition duration-300" data-subtab="lootNotes" onclick="switchSubTab('lootNotes')">üí∞ Loot</button>
                    </div>
                    <div id="prepNotes-sub-content" class="sub-tab-content"><div id="prepNotes-list" class="scrollable-content space-y-3"></div></div>
                    <div id="enemyNotes-sub-content" class="sub-tab-content hidden"><div id="enemyNotes-list" class="scrollable-content space-y-3"></div></div>
                    <div id="npcNotes-sub-content" class="sub-tab-content hidden"><div id="npcNotes-list" class="scrollable-content space-y-3"></div></div>
                    <div id="lootNotes-sub-content" class="sub-tab-content hidden"><div id="lootNotes-list" class="scrollable-content space-y-3"></div></div>
                    <button onclick="addNewNote(currentSubTab)" class="mt-4 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 rounded-lg transition duration-300">+ Add Manual Note</button>
                    <p id="notes-status" class="mt-2 text-sm text-center text-gray-400"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="edit-modal" class="hidden fixed inset-0 z-50 bg-black bg-opacity-75 flex items-center justify-center p-4">
        <div class="card w-full max-w-lg p-6 rounded-lg shadow-2xl">
            <h3 class="text-xl font-bold text-indigo-300 mb-4">Edit Note</h3>
            <input type="hidden" id="modal-note-id"><input type="hidden" id="modal-tab-name">
            <label class="block text-sm font-medium text-gray-400 mb-1">Title</label><input type="text" id="modal-title" class="w-full p-3 rounded-lg input-style mb-4">
            <label class="block text-sm font-medium text-gray-400 mb-1">Content</label><textarea id="modal-content" rows="6" class="w-full p-3 rounded-lg input-style mb-6 resize-none"></textarea>
            <div class="flex justify-end space-x-3"><button onclick="closeEditModal()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Cancel</button><button onclick="saveEditedNote()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Save</button></div>
        </div>
    </div>

    <div id="edit-statblock-modal" class="hidden fixed inset-0 z-50 bg-black bg-opacity-75 flex items-center justify-center p-4">
        <div class="card w-full max-w-lg p-6 rounded-lg shadow-2xl">
            <h3 class="text-xl font-bold text-indigo-300 mb-4">Edit Statblock</h3>
            <input type="hidden" id="modal-statblock-id">
            <label class="block text-sm font-medium text-gray-400 mb-1">Name</label><input type="text" id="modal-stat-name" class="w-full p-3 rounded-lg input-style mb-4">
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-sm font-medium text-gray-400 mb-1">HP</label><input type="number" id="modal-stat-hp" class="w-full p-3 rounded-lg input-style text-center text-sm mb-4"></div>
                <div><label class="block text-sm font-medium text-gray-400 mb-1">AC</label><input type="number" id="modal-stat-ac" class="w-full p-3 rounded-lg input-style text-center text-sm mb-4"></div>
                <div><label class="block text-sm font-medium text-gray-400 mb-1">To Hit</label><input type="number" id="modal-stat-tohit" class="w-full p-3 rounded-lg input-style text-center text-sm mb-4"></div>
                <div><label class="block text-sm font-medium text-gray-400 mb-1">Init</label><input type="number" id="modal-stat-init-mod" class="w-full p-3 rounded-lg input-style text-center text-sm mb-4"></div>
            </div>
            <label class="block text-sm font-medium text-gray-400 mb-1">Damage</label><input type="text" id="modal-stat-dmg" class="w-full p-3 rounded-lg input-style mb-6">
            <div class="flex justify-end space-x-3"><button onclick="closeStatblockEditModal()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Cancel</button><button onclick="saveEditedStatblock()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Save</button></div>
        </div>
    </div>

    <script>
        // --- Global State ---
        let currentTab = 'improv', currentSubTab = 'prepNotes', savedStatblocks = [], lastGeneratedNpc = null, lastGeneratedMonster = null, combatants = [], currentTurnIndex = -1, lastRoll = 0;
        let structuredNotes = { prepNotes: [], enemyNotes: [], npcNotes: [], lootNotes: [] };
        let userApiKey = localStorage.getItem('dm_toolkit_api_key') || "";

        // --- UI Helpers ---
        window.switchTab = function(tabId) {
            currentTab = tabId;
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(tabId).classList.remove('hidden');
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active', 'text-indigo-400', 'border-indigo-500');
                btn.classList.add('text-gray-400', 'border-transparent');
                // Match button text to tab ID (simple heuristic)
                const text = btn.textContent.toLowerCase();
                if (text.includes(tabId) || (tabId === 'improv' && text.includes('prep'))) {
                    btn.classList.add('active'); btn.classList.remove('text-gray-400');
                }
            });
            if (tabId === 'notes') switchSubTab(currentSubTab);
        };

        window.switchSubTab = function(tabId) {
            currentSubTab = tabId;
            document.querySelectorAll('.sub-tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`${tabId}-sub-content`).classList.remove('hidden');
            document.querySelectorAll('.sub-tab-button').forEach(btn => {
                btn.classList.remove('active', 'text-gray-400');
                if (btn.dataset.subtab === tabId) btn.classList.add('active');
                else btn.classList.add('text-gray-400');
            });
            renderStructuredNotes(currentSubTab);
        };

        window.updateApiKey = function(val) {
            userApiKey = val.trim();
            localStorage.setItem('dm_toolkit_api_key', userApiKey);
            const status = document.getElementById('api-key-status');
            if(userApiKey.length > 5) { status.textContent = "Key saved!"; status.className="mt-2 text-xs text-green-400"; }
            else { status.textContent = "Key empty"; status.className="mt-2 text-xs text-red-400"; }
        };

        window.saveApiKey = function() {
            // Wrapper to trigger visual feedback on save button click
            const val = document.getElementById('user-api-key').value;
            window.updateApiKey(val);
            // Replace alert with modal or inline message in a real app
            // alert("API Key Saved!"); 
            const status = document.getElementById('api-key-status');
            if (userApiKey.length > 5) {
                status.textContent = "API Key Saved!";
                status.className = "mt-2 text-xs text-green-400";
            } else {
                 status.textContent = "API Key Cleared/Empty.";
                 status.className = "mt-2 text-xs text-red-400";
            }
        };

        // --- Firebase Helpers ---
        // Access shared/public data for the current app
        const getCol = (name) => window.collection(window.db, 'artifacts', typeof __app_id!=='undefined'?__app_id:'default', 'public', 'data', name);
        const getDocRef = (col, id) => window.doc(window.db, 'artifacts', typeof __app_id!=='undefined'?__app_id:'default', 'public', 'data', col, id);
        const getSharedDoc = (name) => window.doc(window.db, 'artifacts', typeof __app_id!=='undefined'?__app_id:'default', 'public', 'data', 'dm_toolkit_data', name);

        window.saveStructuredNotes = async (tab, data) => {
            if(!window.isAuthReady) return;
            const field = `structured${tab.charAt(0).toUpperCase() + tab.slice(1)}`;
            try { await window.setDoc(getSharedDoc('shared_notes'), { [field]: data }, { merge: true }); } catch(e) { console.error(e); }
        };

        window.setupNotesListener = () => {
            if(!window.isAuthReady) return;
            window.onSnapshot(getSharedDoc('shared_notes'), (doc) => {
                if(doc.exists()) {
                    const d = doc.data();
                    structuredNotes.prepNotes = d.structuredPrepNotes || [];
                    structuredNotes.enemyNotes = d.structuredEnemyNotes || [];
                    structuredNotes.npcNotes = d.structuredNpcNotes || [];
                    structuredNotes.lootNotes = d.structuredLootNotes || [];
                    if(currentTab==='notes') renderStructuredNotes(currentSubTab);
                }
            });
        };

        function renderStructuredNotes(tab) {
            const list = document.getElementById(`${tab}-list`);
            if(!list) return;
            list.innerHTML = structuredNotes[tab].length ? '' : '<p class="text-center text-gray-500 pt-8">No notes.</p>';
            structuredNotes[tab].forEach(n => {
                const div = document.createElement('div'); div.className = 'note-item card p-0 rounded-lg shadow-md'; div.id = `note-${n.id}`;
                // Use innerHTML content as raw HTML, which is necessary if we save rich HTML blocks (like the statblocks)
                div.innerHTML = `<div class="collapsible-header hover:bg-gray-600/50 transition" onclick="toggleCollapse('${n.id}')"><span class="font-bold text-indigo-300 truncate">${n.title}</span><span class="text-gray-400">‚ñº</span></div>
                <div class="collapsible-content" id="content-${n.id}"><div class="p-3 whitespace-pre-wrap text-sm text-gray-300">${n.content}</div><div class="flex justify-end p-2 gap-2"><button onclick="editNote('${n.id}', '${tab}')" class="text-xs bg-blue-600 px-2 py-1 rounded">Edit</button><button onclick="deleteNote('${n.id}', '${tab}')" class="text-xs bg-red-600 px-2 py-1 rounded">Delete</button></div></div>`;
                list.appendChild(div);
            });
        }

        window.toggleCollapse = (id) => {
            const el = document.getElementById(`content-${id}`);
            if(el) { el.classList.toggle('expanded'); el.style.maxHeight = el.classList.contains('expanded') ? el.scrollHeight + "px" : null; }
        };

        window.addNewNote = (tab) => { structuredNotes[tab].unshift({ id: crypto.randomUUID(), title: 'New Note', content: 'Details...' }); window.saveStructuredNotes(tab, structuredNotes[tab]); };
        window.deleteNote = (id, tab) => { structuredNotes[tab] = structuredNotes[tab].filter(n => n.id !== id); window.saveStructuredNotes(tab, structuredNotes[tab]); };
        
        // Note: When loading content into the textarea, we use textContent to strip HTML, which is correct for manual editing.
        // For rendering, we use innerHTML (see renderStructuredNotes)
        window.editNote = (id, tab) => {
            const n = structuredNotes[tab].find(x => x.id === id);
            if(!n) return;
            document.getElementById('modal-note-id').value = id; document.getElementById('modal-tab-name').value = tab;
            document.getElementById('modal-title').value = n.title; 
            
            // To edit, we should only expose the plain text content. If the content contains rich HTML (like the D&D blocks), the user should use the monster tab for that structure.
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = n.content;
            document.getElementById('modal-content').value = tempDiv.textContent.trim(); 
            
            document.getElementById('edit-modal').classList.remove('hidden');
        };
        window.saveEditedNote = () => {
            const id = document.getElementById('modal-note-id').value, tab = document.getElementById('modal-tab-name').value;
            const idx = structuredNotes[tab].findIndex(x => x.id === id);
            if(idx > -1) {
                structuredNotes[tab][idx].title = document.getElementById('modal-title').value;
                structuredNotes[tab][idx].content = document.getElementById('modal-content').value;
                window.saveStructuredNotes(tab, structuredNotes[tab]);
            }
            document.getElementById('edit-modal').classList.add('hidden');
        };
        window.closeEditModal = () => document.getElementById('edit-modal').classList.add('hidden');

        // --- Combat Logic ---
        window.setupCombatDataListeners = () => {
            if(!window.isAuthReady) return;
            const status = document.getElementById('db-status');
            window.onSnapshot(window.query(getCol('shared_combatants')), (snap) => {
                combatants = []; snap.forEach(d => combatants.push({id: d.id, ...d.data()}));
                combatants.sort((a,b) => (b.init||0) - (a.init||0));
                renderCombatants();
                if(status) { status.textContent = "Connected"; status.className = "text-xs px-2 py-1 rounded bg-gray-700 text-green-400"; }
            });
            window.onSnapshot(getSharedDoc('shared_combat_state'), (doc) => {
                currentTurnIndex = doc.exists() ? (doc.data().currentTurnIndex || 0) : -1;
                renderCombatants();
            });
        };

        // Helper for Conditions
        const dndConditions = ['Blinded', 'Charmed', 'Deafened', 'Frightened', 'Grappled', 'Incapacitated', 'Invisible', 'Paralyzed', 'Petrified', 'Poisoned', 'Prone', 'Restrained', 'Stunned', 'Unconscious', 'Exhaustion', 'Concentrating'];

        window.addCondition = async (id, cond) => {
            if (!cond) return;
            const c = combatants.find(x => x.id === id);
            if (!c) return;
            const current = c.conditions || [];
            if (current.includes(cond)) return; // No duplicates
            
            // We read local, modify, then push to DB (simpler without needing new imports)
            const updated = [...current, cond];
            await window.updateDoc(getDocRef('shared_combatants', id), { conditions: updated });
        };

        window.removeCondition = async (id, cond) => {
            const c = combatants.find(x => x.id === id);
            if (!c) return;
            const current = c.conditions || [];
            const updated = current.filter(x => x !== cond);
            await window.updateDoc(getDocRef('shared_combatants', id), { conditions: updated });
        };

        function renderCombatants() {
            const list = document.getElementById('initiative-list');
            if(!list) return;
            list.innerHTML = combatants.length ? '' : '<p class="text-center text-gray-500 pt-8">No combatants.</p>';
            
            combatants.forEach((c, idx) => {
                const active = idx === currentTurnIndex ? 'bg-indigo-700 glow-shadow' : 'bg-gray-700';
                
                // Generate Condition Badges
                const activeConditions = c.conditions || [];
                const conditionBadges = activeConditions.map(cond => 
                    `<span onclick="removeCondition('${c.id}', '${cond}')" class="inline-block cursor-pointer bg-red-900/80 hover:bg-red-800 text-red-100 text-[10px] px-1.5 py-0.5 rounded border border-red-700 mr-1 mb-1 select-none" title="Remove ${cond}">${cond} &times;</span>`
                ).join('');

                // Generate Condition Options
                const conditionOptions = dndConditions.map(cond => `<option value="${cond}">${cond}</option>`).join('');

                const div = document.createElement('div'); 
                div.className = `flex items-start space-x-2 p-3 rounded-lg transition ${active}`;
                
                div.innerHTML = `
                    <div class="text-lg font-bold w-6 text-center text-white pt-1">${c.init}</div>
                    <div class="flex-1 min-w-0">
                        <div class="font-semibold text-sm text-white truncate">${c.name}</div>
                        <div class="text-xs text-gray-300">HP: ${c.currentHp}/${c.maxHp} | AC: ${c.ac}</div>
                        
                        <!-- Conditions Section -->
                        <div class="mt-2">
                            <div class="flex flex-wrap gap-1 mb-1">${conditionBadges}</div>
                            <select onchange="addCondition('${c.id}', this.value); this.value='';" class="bg-gray-800 text-[10px] text-gray-400 border border-gray-600 rounded px-1 py-0.5 focus:outline-none focus:border-indigo-500">
                                <option value="">+ Condition</option>
                                ${conditionOptions}
                            </select>
                        </div>
                    </div>
                    
                    <div class="flex flex-col items-end gap-2">
                        <div class="flex items-center gap-1">
                            <input type="number" id="dmg-${idx}" class="w-10 p-1 text-xs rounded text-black" placeholder="Amt">
                            <button onclick="modHp('${c.id}', ${idx}, 1)" class="bg-green-600 hover:bg-green-500 px-2 py-1 rounded text-xs font-bold">Heal</button>
                            <button onclick="modHp('${c.id}', ${idx}, -1)" class="bg-red-600 hover:bg-red-500 px-2 py-1 rounded text-xs font-bold">Dmg</button>
                        </div>
                        <button onclick="delCombatant('${c.id}')" class="text-gray-400 hover:text-red-400 text-xs underline">Remove</button>
                    </div>
                `;
                list.appendChild(div);
            });
            
            // Update Roller
            const sel = document.getElementById('combatant-selector');
            if(sel) { sel.innerHTML = '<option value="" disabled selected>Target</option>'; combatants.forEach((c,i) => sel.innerHTML += `<option value="${i}">${c.name}</option>`); }
            const btn = document.getElementById('assign-roll-button'); if(btn) btn.disabled = combatants.length === 0 || lastRoll === 0;
        }

        window.addCombatant = async () => {
            if(!window.isAuthReady) { console.error("Database not ready."); return; }
            const name = document.getElementById('combatant-name').value.trim();
            if(!name) return;
            const init = parseInt(document.getElementById('combatant-init').value)||0;
            const hp = parseInt(document.getElementById('combatant-hp').value)||0;
            const ac = parseInt(document.getElementById('combatant-ac').value)||0;
            await window.addDoc(getCol('shared_combatants'), { name, init, maxHp: hp, currentHp: hp, ac, initModifier: init });
            document.getElementById('combatant-name').value = '';
        };
        
        window.modHp = async (id, idx, mul) => {
            const val = parseInt(document.getElementById(`dmg-${idx}`).value);
            if(isNaN(val)) return;
            const c = combatants[idx];
            const newHp = Math.max(0, Math.min(c.maxHp, c.currentHp + (val * mul)));
            await window.updateDoc(getDocRef('shared_combatants', id), { currentHp: newHp });
            document.getElementById(`dmg-${idx}`).value = '';
        };

        window.delCombatant = async (id) => await window.deleteDoc(getDocRef('shared_combatants', id));
        window.clearCombat = async () => {
             const batch = window.writeBatch(window.db);
             combatants.forEach(c => batch.delete(getDocRef('shared_combatants', c.id)));
             batch.delete(getSharedDoc('shared_combat_state'));
             await batch.commit();
        };
        window.nextTurn = async () => {
             if(!combatants.length) return;
             const next = (currentTurnIndex + 1) % combatants.length;
             await window.setDoc(getSharedDoc('shared_combat_state'), { currentTurnIndex: next });
        };
        window.sortInitiative = async () => {
             await window.setDoc(getSharedDoc('shared_combat_state'), { currentTurnIndex: 0 });
        };
        
        // --- Dice Roller ---
        window.rollD20 = function() {
            lastRoll = Math.floor(Math.random() * 20) + 1;
            document.getElementById('last-roll-display').textContent = lastRoll;
            const btn = document.getElementById('assign-roll-button');
            if(btn) btn.disabled = combatants.length === 0 || lastRoll === 0;
        }
        
        window.assignInitiativeRoll = async function() {
            const selector = document.getElementById('combatant-selector');
            const selectedIndex = parseInt(selector.value, 10);
            if (isNaN(selectedIndex) || selectedIndex < 0 || lastRoll === 0) return;
            
            const c = combatants[selectedIndex];
            const modifier = c.initModifier || 0; 
            const newInitiative = lastRoll + modifier;
            
            try { 
                await window.updateDoc(getDocRef('shared_combatants', c.id), { init: newInitiative }); 
            } catch (error) { console.error(error); }
            
            lastRoll = 0;
            document.getElementById('last-roll-display').textContent = '?';
            selector.value = '';
            document.getElementById('assign-roll-button').disabled = true;
        }
        
        window.rollCustomDice = function() {
            // This function is present in the original code's outline but not fully connected in the HTML, 
            // but the logic is included for completeness if the user adds UI elements later.
            const numDiceInput = document.getElementById('dice-num');
            const diceTypeInput = document.getElementById('dice-type');
            const modInput = document.getElementById('dice-mod');
            const resultDisplay = document.getElementById('dice-roll-result');
            const detailsDisplay = document.getElementById('dice-roll-details');

            const numDice = parseInt(numDiceInput.value, 10) || 1;
            const diceType = parseInt(diceTypeInput.value, 10) || 20;
            const modifier = parseInt(modInput.value, 10) || 0;

            if (numDice <= 0) {
                resultDisplay.textContent = 'Error';
                detailsDisplay.textContent = 'Number of dice must be 1 or more.';
                return;
            }

            let totalRoll = 0;
            const rolls = [];
            for (let i = 0; i < numDice; i++) {
                const roll = Math.floor(Math.random() * diceType) + 1;
                rolls.push(roll);
                totalRoll += roll;
            }

            const finalTotal = totalRoll + modifier;
            const modString = modifier > 0 ? `+${modifier}` : (modifier < 0 ? `${modifier}` : '');

            resultDisplay.textContent = `Total: ${finalTotal}`;
            
            if (modifier !== 0) {
                detailsDisplay.textContent = `Rolls: [${rolls.join(', ')}] (Mod: ${modString})`;
            } else {
                detailsDisplay.textContent = `Rolls: [${rolls.join(', ')}]`;
            }
        }

        // --- Statblocks ---
        window.setupStatblocksListener = () => {
            if(!window.isAuthReady) return;
            window.onSnapshot(window.query(getCol('dm_toolkit_statblocks')), (snap) => {
                savedStatblocks = []; snap.forEach(d => savedStatblocks.push({id: d.id, ...d.data()}));
                savedStatblocks.sort((a,b) => a.name.localeCompare(b.name));
                renderStatblocks();
            });
        };
        function renderStatblocks() {
             const list = document.getElementById('statblocks-list'); if(!list) return;
             list.innerHTML = savedStatblocks.length ? '' : '<p class="text-center text-gray-500">No stats.</p>';
             savedStatblocks.forEach(s => {
                 const div = document.createElement('div'); div.className = 'card p-2 mb-2 bg-gray-800';
                 // Safe string escape for function call
                 const safeName = s.name.replace(/'/g, "\\'");
                 div.innerHTML = `<div class="flex justify-between font-bold text-indigo-300"><span>${s.name}</span><div class="gap-2 flex"><button onclick="editStatblock('${s.id}')" class="text-xs text-blue-400">Edit</button><button onclick="delStat('${s.id}')" class="text-xs text-red-400">Del</button></div></div>
                 <div class="text-xs text-gray-300 grid grid-cols-2 gap-1 mt-1"><span>HP: ${s.hp}</span><span>AC: ${s.ac}</span><span>Hit: ${s.toHit}</span><span>Init: ${s.initMod}</span></div>
                 <div class="text-xs text-yellow-500 mt-1 truncate">${s.dmg}</div>
                 <button onclick="importStat('${safeName}', ${s.hp}, ${s.initMod}, ${s.ac})" class="w-full bg-purple-900 text-xs rounded mt-2 py-1">Add to Tracker</button>`;
                 list.appendChild(div);
             });
        }
        window.saveStatblock = async () => {
             const name = document.getElementById('stat-name').value.trim(); if(!name) return;
             await window.addDoc(getCol('dm_toolkit_statblocks'), {
                 name, hp: parseInt(document.getElementById('stat-hp').value)||0,
                 ac: parseInt(document.getElementById('stat-ac').value)||0,
                 toHit: parseInt(document.getElementById('stat-tohit').value)||0,
                 initMod: parseInt(document.getElementById('stat-init-mod').value)||0,
                 dmg: document.getElementById('stat-dmg').value,
                 timestamp: new Date().toISOString()
             });
             document.getElementById('stat-name').value = '';
        };
        window.delStat = async (id) => await window.deleteDoc(getDocRef('dm_toolkit_statblocks', id));
        window.importStat = (n, h, i, a) => {
             document.getElementById('combatant-name').value = n; 
             document.getElementById('combatant-hp').value = h;
             document.getElementById('combatant-init').value = i; 
             document.getElementById('combatant-ac').value = a;
             switchTab('combat');
        };
        
        // Statblock Edit Modal Functions
        window.editStatblock = (id) => {
            const s = savedStatblocks.find(x => x.id === id);
            if (!s) return;
            document.getElementById('modal-statblock-id').value = id;
            document.getElementById('modal-stat-name').value = s.name;
            document.getElementById('modal-stat-hp').value = s.hp;
            document.getElementById('modal-stat-ac').value = s.ac;
            document.getElementById('modal-stat-tohit').value = s.toHit;
            document.getElementById('modal-stat-init-mod').value = s.initMod;
            document.getElementById('modal-stat-dmg').value = s.dmg;
            document.getElementById('edit-statblock-modal').classList.remove('hidden');
        };

        window.closeStatblockEditModal = () => document.getElementById('edit-statblock-modal').classList.add('hidden');

        window.saveEditedStatblock = async () => {
            const id = document.getElementById('modal-statblock-id').value;
            if (!id) return;
            
            try {
                await window.updateDoc(getDocRef('dm_toolkit_statblocks', id), {
                    name: document.getElementById('modal-stat-name').value.trim(),
                    hp: parseInt(document.getElementById('modal-stat-hp').value) || 0,
                    ac: parseInt(document.getElementById('modal-stat-ac').value) || 0,
                    toHit: parseInt(document.getElementById('modal-stat-tohit').value) || 0,
                    initMod: parseInt(document.getElementById('modal-stat-init-mod').value) || 0,
                    dmg: document.getElementById('modal-stat-dmg').value.trim(),
                });
                closeStatblockEditModal();
            } catch (error) {
                console.error("Error updating statblock:", error);
            }
        };


        // --- AI & API ---
        const API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent';
        const IMAGE_URL = 'https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict';
        
        const combatSchema = {
            type: "OBJECT",
            properties: {
                name: { "type": "STRING", "description": "A creative and appropriate name for the NPC." },
                level_or_cr: { "type": "STRING", "description": "The requested level or challenge rating." },
                armor_class_ac: { "type": "INTEGER", "description": "The NPC's calculated Armor Class (AC)." },
                max_hit_points: { "type": "INTEGER", "description": "The NPC's maximum Hit Points (HP)." },
                initiative_bonus: { "type": "INTEGER", "description": "The modifier (DEX bonus) added to the d20 roll for initiative." },
                main_attack: { "type": "STRING", "description": "The NPC's primary attack description including attack roll modifier and damage." }
            },
            required: ["name", "level_or_cr", "armor_class_ac", "max_hit_points", "initiative_bonus", "main_attack"]
        };

        const monsterSchema = {
            type: "OBJECT",
            properties: {
                name: { type: "STRING", description: "The monster's name." },
                size: { type: "STRING", description: "Size (e.g., Medium, Large)." },
                type: { type: "STRING", description: "Type (e.g., humanoid, beast, monstrosity)." },
                alignment: { type: "STRING", description: "Alignment (e.g., chaotic evil, unaligned)." },
                armor_class: { type: "INTEGER", description: "Armor Class (AC)." },
                ac_type: { type: "STRING", description: "Type of AC (e.g., 'natural armor', 'plate mail')." },
                hit_points: { type: "INTEGER", description: "Average Hit Points." },
                hit_dice: { type: "STRING", description: "Hit Dice formula (e.g., '10d8 + 40')." },
                speed: { type: "STRING", description: "All movement speeds (e.g., '30 ft., fly 60 ft.')." },
                ability_scores: {
                    type: "OBJECT",
                    properties: {
                        STR: { type: "INTEGER" },
                        DEX: { type: "INTEGER" },
                        CON: { type: "INTEGER" },
                        INT: { type: "INTEGER" },
                        WIS: { type: "INTEGER" },
                        CHA: { type: "INTEGER" }
                    },
                    required: ["STR", "DEX", "CON", "INT", "WIS", "CHA"]
                },
                saving_throws: { type: "ARRAY", items: { type: "STRING" } },
                skills: { type: "ARRAY", items: { type: "STRING" } },
                damage_vulnerabilities: { type: "ARRAY", items: { type: "STRING" } },
                damage_resistances: { type: "ARRAY", items: { type: "STRING" } },
                damage_immunities: { type: "ARRAY", items: { type: "STRING" } },
                condition_immunities: { type: "ARRAY", items: { type: "STRING" } },
                senses: { type: "STRING", description: "Senses (e.g., 'darkvision 60 ft., passive Perception 14')." },
                languages: { type: "STRING", description: "Languages known (e.g., 'Common, Giant')." },
                challenge_rating: { type: "STRING", description: "Challenge Rating (CR) (e.g., '5')." },
                xp: { type: "INTEGER", description: "Experience Points (XP) for the CR." },
                abilities: { 
                    type: "ARRAY", 
                    items: { 
                        type: "OBJECT", 
                        properties: { 
                            name: { type: "STRING" }, 
                            description: { type: "STRING" } 
                        },
                        required: ["name", "description"]
                    },
                    description: "Special abilities (e.g., 'Pack Tactics', 'Magic Resistance'). Keep descriptions extremely concise and mechanical. Do not include flavor text." 
                },
                actions: { 
                    type: "ARRAY", 
                    items: { 
                        type: "OBJECT", 
                        properties: { name: { type: "STRING" }, description: { type: "STRING" } },
                        required: ["name", "description"]
                    },
                    description: "Actions the monster can take. Keep descriptions extremely concise and mechanical (e.g. 'Melee Weapon Attack: +5 to hit, reach 5 ft., one target. Hit: 7 (1d8 + 3) slashing damage.'). Do not include flavor text." 
                },
                legendary_actions: { type: "ARRAY", items: { type: "OBJECT", properties: { name: { type: "STRING" }, description: { type: "STRING" } } } }
            },
            required: ["name", "size", "type", "alignment", "armor_class", "hit_points", "hit_dice", "speed", "ability_scores", "senses", "languages", "challenge_rating", "xp", "actions"]
        };

        async function callAI(url, payload) {
            // Fallback: Check the input field directly if the variable seems empty
            let key = userApiKey;
            if (!key || key === "") {
                const inputEl = document.getElementById('user-api-key');
                if (inputEl && inputEl.value) {
                    key = inputEl.value.trim();
                    // Update global state while we're at it
                    userApiKey = key;
                    localStorage.setItem('dm_toolkit_api_key', key);
                }
            }

            const checkKey = key || "PASTE_KEY";
            if(!checkKey || checkKey.includes("PASTE")) { 
                // Using console.error instead of alert as per general instruction
                console.error("Please paste your API Key in the Prep tab!"); 
                throw new Error("No Key: Please paste your API Key in the Prep tab to use AI features."); 
            }
            
            let res;
            // Exponential backoff retry logic (simplified)
            for (let i = 0; i < 3; i++) {
                try {
                    res = await fetch(`${url}?key=${key}`, { 
                        method: 'POST', 
                        headers: {'Content-Type': 'application/json'}, 
                        body: JSON.stringify(payload) 
                    });
                    
                    if (res.ok) return await res.json();
                    
                    // STOP RETRYING if the error is 400 (Bad Request / Invalid Key)
                    if (res.status === 400) {
                        const errText = await res.text();
                        console.error("API 400 Error:", errText);
                        alert("Invalid API Key. Please go to the 'Prep' tab and update your Google Gemini API Key.");
                        throw new Error("Invalid API Key (400). Check Prep tab.");
                    }

                    // If not OK, check if it's a rate limit error (429) or temporary (5xx)
                    if (res.status === 429 || res.status >= 500) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue; // Retry
                    }
                    throw new Error(`API returned status ${res.status}: ${await res.text()}`);

                } catch (error) {
                    if (i === 2 || error.message.includes("Invalid API Key")) throw error; // Re-throw immediately if invalid key
                    // If network error, still try to retry with backoff
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }
        
        window.generateCombatNpc = async () => {
            const btn = document.getElementById('generate-combat-button'); btn.disabled = true;
            const outputDiv = document.getElementById('ai-output');
            outputDiv.textContent = "Generating combat stats...";
            
            try {
                const txt = document.getElementById('npc-type').value; 
                const lvl = document.getElementById('npc-level').value;
                const prompt = `Generate a D&D 5e combat NPC (Level ${lvl}, ${txt}). Return strictly JSON matching the schema provided.`;
                
                const payload = { 
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: combatSchema
                    }
                };

                const data = await callAI(API_URL, payload);
                const stats = JSON.parse(data.candidates[0].content.parts[0].text);
                lastGeneratedNpc = stats;
                
                // Render Detailed UI
                outputDiv.innerHTML = `
                    <div class="text-2xl font-bold text-green-400 mb-2">${stats.name}</div>
                    <div class="text-gray-300 text-sm mb-4">Level/CR: <span class="font-medium text-white">${stats.level_or_cr}</span></div>
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <div class="p-3 bg-gray-700 rounded-lg border border-gray-600">
                            <div class="text-xs text-gray-400 uppercase">Armor Class</div>
                            <div class="font-bold text-2xl text-blue-300">${stats.armor_class_ac}</div>
                        </div>
                        <div class="p-3 bg-gray-700 rounded-lg border border-gray-600">
                            <div class="text-xs text-gray-400 uppercase">Hit Points</div>
                            <div class="font-bold text-2xl text-green-300">${stats.max_hit_points}</div>
                        </div>
                        <div class="p-3 bg-gray-700 rounded-lg col-span-2 border border-gray-600">
                             <div class="text-xs text-gray-400 uppercase">Initiative</div>
                             <div class="font-bold text-xl text-yellow-300">${stats.initiative_bonus >= 0 ? '+' : ''}${stats.initiative_bonus}</div>
                        </div>
                        <div class="p-3 bg-gray-700 rounded-lg col-span-2 border border-gray-600">
                             <div class="text-xs text-gray-400 uppercase">Main Attack</div>
                             <div class="font-medium text-white mt-1">${stats.main_attack}</div>
                        </div>
                    </div>
                    <button onclick="addNpcToStatblocks()" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 rounded-lg transition flex items-center justify-center gap-2">
                        <span>üíæ</span> Add to Statblocks
                    </button>
                    <div class="mt-4 pt-4 border-t border-gray-700 grid grid-cols-3 gap-2">
                             <button onclick="saveCombatNpcToNotes('prepNotes')" class="bg-gray-600 hover:bg-gray-500 py-1 rounded text-xs text-gray-200">Save Note</button>
                             <button onclick="saveCombatNpcToNotes('enemyNotes')" class="bg-yellow-800 hover:bg-yellow-700 py-1 rounded text-xs text-yellow-100">Save Enemy</button>
                             <button onclick="saveCombatNpcToNotes('npcNotes')" class="bg-blue-800 hover:bg-blue-700 py-1 rounded text-xs text-blue-100">Save NPC</button>
                    </div>
                `;
            } catch(e) { console.error(e); outputDiv.textContent = "Error: " + e.message; }
            finally {
                document.getElementById('combat-loading-spinner').classList.add('hidden');
                btn.disabled = false;
            }
        };

        window.addNpcToStatblocks = async function() {
            if (!window.isAuthReady) { console.error('Database not ready.'); return; }
            if (!lastGeneratedNpc) { console.error('No NPC generated yet.'); return; }

            const npc = lastGeneratedNpc;
            let toHit = 0;
            if (npc.main_attack) {
                const match = npc.main_attack.match(/(\+|\-)\d+/);
                if (match) toHit = parseInt(match[0], 10);
                else toHit = npc.initiative_bonus || 0;
            }

            try {
                await window.addDoc(getCol('dm_toolkit_statblocks'), {
                    name: npc.name,
                    hp: npc.max_hit_points,
                    ac: npc.armor_class_ac,
                    toHit: toHit,
                    initMod: npc.initiative_bonus,
                    dmg: npc.main_attack || "Attack",
                    timestamp: new Date().toISOString()
                });
                console.log(`${npc.name} added to Statblocks!`);
            } catch (error) {
                console.error("Error saving NPC:", error);
            }
        }

        window.addMonsterToStatblocks = async function() {
            if (!window.isAuthReady) { console.error('Database not ready.'); return; }
            if (!lastGeneratedMonster) { console.error('No Monster generated yet.'); return; }

            const m = lastGeneratedMonster;
            const dexScore = m.ability_scores?.DEX || 10;
            const initMod = Math.floor((dexScore - 10) / 2);

            let primaryAttack = "Slam";
            let toHit = 0;

            if (m.actions && m.actions.length > 0) {
                const attackAction = m.actions.find(a => a.description.toLowerCase().includes("to hit")) || m.actions[0];
                
                primaryAttack = attackAction.name;
                
                const hitMatch = attackAction.description.match(/\+(\d+)\s+to\s+hit/);
                if (hitMatch) {
                    toHit = parseInt(hitMatch[1], 10);
                }
                
                const dmgMatch = attackAction.description.match(/Hit:.*?(\d+\s*\(.*?\).*?damage)/i);
                if (dmgMatch) {
                    primaryAttack += `: ${dmgMatch[1]}`; 
                } else {
                    primaryAttack += " (See Notes)";
                }
            }

            try {
                await window.addDoc(getCol('dm_toolkit_statblocks'), {
                    name: m.name,
                    hp: m.hit_points,
                    ac: m.armor_class,
                    toHit: toHit,
                    initMod: initMod,
                    dmg: primaryAttack,
                    timestamp: new Date().toISOString()
                });
                console.log(`${m.name} added to Statblocks!`);
            } catch (error) {
                console.error("Error saving Monster:", error);
            }
        }

        window.saveMonsterToNotes = async function() {
            if (!window.isAuthReady) { console.error("Database not ready."); return; }
            if (!lastGeneratedMonster) { console.error("No Monster to save."); return; }
            
            const content = document.getElementById('monster-output').innerHTML;
            
            const newNote = {
                id: crypto.randomUUID(),
                title: `${lastGeneratedMonster.name} (CR ${lastGeneratedMonster.challenge_rating})`,
                content: content, // Save the rich HTML content
                timestamp: new Date().toISOString()
            };
            
            structuredNotes['enemyNotes'].unshift(newNote);
            await window.saveStructuredNotes('enemyNotes', structuredNotes['enemyNotes']);
            console.log("Saved to Enemy Notes!");
            
            window.switchTab('notes');
            window.switchSubTab('enemyNotes');
        }
        
        window.saveCombatNpcToNotes = async function(tab) {
            if (!window.isAuthReady) { console.error("Database not ready."); return; }
            if (!lastGeneratedNpc) { console.error("No NPC to save."); return; }
            
            const content = document.getElementById('ai-output').innerHTML;
            const newNote = {
                id: crypto.randomUUID(),
                title: `${lastGeneratedNpc.name} (CR ${lastGeneratedNpc.level_or_cr})`,
                content: content,
                timestamp: new Date().toISOString()
            };
            
            structuredNotes[tab].unshift(newNote);
            await window.saveStructuredNotes(tab, structuredNotes[tab]);
            console.log("Saved to " + tab + "!");
            
            window.switchTab('notes');
            window.switchSubTab(tab);
        }


        window.generateLoot = async () => {
             const btn = document.getElementById('generate-loot-button'); 
             const spinner = document.getElementById('loot-loading-spinner');
             const outputDiv = document.getElementById('loot-output');
             btn.disabled = true;
             spinner.classList.remove('hidden');
             outputDiv.textContent = "Generating loot list...";

             try {
                 const lvl = document.getElementById('loot-level').value; const type = document.getElementById('loot-type').value;
                 const prompt = `Generate D&D 5e loot for Level ${lvl} ${type} as a concise, formatted markdown list.`;
                 const data = await callAI(API_URL, { contents: [{ parts: [{ text: prompt }] }] });
                 outputDiv.innerText = data.candidates[0].content.parts[0].text;
             } catch(e) { outputDiv.innerText = "Error: " + e.message; }
             finally {
                 btn.disabled = false;
                 spinner.classList.add('hidden');
             }
        };
        
        // Other generators follow same pattern
        window.generateCreativeIdea = async () => {
             const btn = document.getElementById('generate-button');
             const spinner = document.getElementById('creative-loading-spinner');
             const outputDiv = document.getElementById('ai-output');
             btn.disabled = true;
             spinner.classList.remove('hidden');
             outputDiv.textContent = "Generating creative idea...";

             try {
                 const p = document.getElementById('improv-prompt').value;
                 const prompt = `Generate a creative D&D idea based on: "${p}". Start with a catchy title using markdown header format (e.g. ## The Whispering Stone). Then provide the details.`;
                 const data = await callAI(API_URL, { contents: [{ parts: [{ text: prompt }] }] });
                 outputDiv.innerHTML = data.candidates[0].content.parts[0].text.replace(/\n/g, '<br>'); // Preserve line breaks visually
                 document.getElementById('save-options-creative').classList.remove('hidden');
             } catch(e) { console.error(e); outputDiv.textContent = "Error: " + e.message; }
             finally {
                 btn.disabled = false;
                 spinner.classList.add('hidden');
             }
        };
        
        window.generateSettlement = async () => {
             const btn = document.getElementById('generate-settlement-button'); 
             const spinner = document.getElementById('settlement-loading-spinner');
             const outputDiv = document.getElementById('ai-output'); // Use outputDiv for text output
             btn.disabled = true;
             spinner.classList.remove('hidden');
             outputDiv.textContent = "Generating settlement details...";

             try {
                 const type = document.getElementById('settlement-type').value;
                 const vibe = document.getElementById('settlement-vibe').value;
                 const prompt = `Generate details for a D&D ${type}: ${vibe}. Include sections for Ruler/Leader, Key Locations, and Current Conflict/Quests. Use clear markdown headers.`;
                 const data = await callAI(API_URL, { contents: [{ parts: [{ text: prompt }] }] });
                 outputDiv.innerHTML = data.candidates[0].content.parts[0].text.replace(/\n/g, '<br>'); // Preserve line breaks visually
                 document.getElementById('save-options-creative').classList.remove('hidden'); // Show save buttons
             } catch(e) { outputDiv.textContent = "Error: " + e.message; }
             finally {
                 btn.disabled = false;
                 spinner.classList.add('hidden');
             }
        };

        window.generateMonsterStatblock = async () => {
             const btn = document.getElementById('generate-monster-button');
             const spinner = document.getElementById('monster-loading-spinner');
             const output = document.getElementById('monster-output');
             
             btn.disabled = true;
             spinner.classList.remove('hidden');
             output.textContent = "Generating monster stats..."; 
             
             try {
                 const name = document.getElementById('monster-name').value;
                 const cr = document.getElementById('monster-cr').value; 
                 const prompt = `You are an expert D&D 5e Monster Designer. Your task is to generate a complete and balanced monster stat block based on the user's provided name and Challenge Rating (CR). You MUST return the data exactly according to the JSON schema provided. 
 
 CRITICAL INSTRUCTION FOR ACTIONS & ABILITIES: Keep descriptions extremely concise and mechanical. 
 - For Abilities: "Magic Resistance. The monster has advantage on saving throws against spells and other magical effects." (Keep it that short).
 - For Multiattack: "Makes [number] attacks: [number] with [attack name] and [number] with [attack name]."
 - For Attacks: "Melee Weapon Attack: +[X] to hit, reach [X] ft., one target. Hit: [X] ([dice]) [type] damage." 
 - Do not include flavor text or lengthy descriptions of how the attack looks. Only the mechanics.`;
                 
                 const payload = { 
                     contents: [{ parts: [{ text: prompt + ` Generate a full monster stat block for a "${name}" with CR "${cr}"` }] }],
                     generationConfig: {
                         responseMimeType: "application/json",
                         responseSchema: monsterSchema
                     }
                 };
                 
                 const data = await callAI(API_URL, payload);
                 let json = data.candidates[0].content.parts[0].text.replace(/```json|```/g, '').trim();
                 const stats = JSON.parse(json);
                 lastGeneratedMonster = stats;
                 
                 const getMod = (score) => Math.floor((score - 10) / 2);
                 const formatMod = (score) => { const m = getMod(score); return m >= 0 ? `+${m}` : m; };
                 
                 // Render Monster Block with D&D Styling
                 output.innerHTML = `
                     <div class="dnd-statblock text-left">
                         <div class="dnd-header">${stats.name}</div>
                         <div class="italic text-black text-sm">${stats.size} ${stats.type}, ${stats.alignment}</div>
                         <div class="tapered-rule"></div>
                         <div class="text-sm text-red-900">
                             <p class="dnd-property-line"><strong>Armor Class</strong> ${stats.armor_class} (${stats.ac_type || ''})</p>
                             <p class="dnd-property-line"><strong>Hit Points</strong> ${stats.hit_points} (${stats.hit_dice})</p>
                             <p class="dnd-property-line"><strong>Speed</strong> ${stats.speed}</p>
                         </div>
                         <div class="tapered-rule"></div>
                         <div class="grid grid-cols-6 gap-1 text-center text-red-900 text-xs sm:text-sm">
                              <div><div class="font-bold">STR</div><div>${stats.ability_scores.STR} (${formatMod(stats.ability_scores.STR)})</div></div>
                              <div><div class="font-bold">DEX</div><div>${stats.ability_scores.DEX} (${formatMod(stats.ability_scores.DEX)})</div></div>
                              <div><div class="font-bold">CON</div><div>${stats.ability_scores.CON} (${formatMod(stats.ability_scores.CON)})</div></div>
                              <div><div class="font-bold">INT</div><div>${stats.ability_scores.INT} (${formatMod(stats.ability_scores.INT)})</div></div>
                              <div><div class="font-bold">WIS</div><div>${stats.ability_scores.WIS} (${formatMod(stats.ability_scores.WIS)})</div></div>
                              <div><div class="font-bold">CHA</div><div>${stats.ability_scores.CHA} (${formatMod(stats.ability_scores.CHA)})</div></div>
                         </div>
                         <div class="tapered-rule"></div>
                         <div class="text-sm text-red-900 space-y-1">
                             ${stats.saving_throws && stats.saving_throws.length ? `<p class="dnd-property-line"><strong>Saving Throws</strong> ${stats.saving_throws.join(', ')}</p>` : ''}
                             ${stats.skills && stats.skills.length ? `<p class="dnd-property-line"><strong>Skills</strong> ${stats.skills.join(', ')}</p>` : ''}
                             ${stats.damage_vulnerabilities && stats.damage_vulnerabilities.length ? `<p class="dnd-property-line"><strong>Damage Vulnerabilities</strong> ${stats.damage_vulnerabilities.join(', ')}</p>` : ''}
                             ${stats.damage_resistances && stats.damage_resistances.length ? `<p class="dnd-property-line"><strong>Damage Resistances</strong> ${stats.damage_resistances.join(', ')}</p>` : ''}
                             ${stats.damage_immunities && stats.damage_immunities.length ? `<p class="dnd-property-line"><strong>Damage Immunities</strong> ${stats.damage_immunities.join(', ')}</p>` : ''}
                             ${stats.condition_immunities && stats.condition_immunities.length ? `<p class="dnd-property-line"><strong>Condition Immunities</strong> ${stats.condition_immunities.join(', ')}</p>` : ''}
                             <p class="dnd-property-line"><strong>Senses</strong> ${stats.senses}</p>
                             <p class="dnd-property-line"><strong>Languages</strong> ${stats.languages}</p>
                             <p class="dnd-property-line"><strong>Challenge</strong> ${stats.challenge_rating} (${stats.xp} XP)</p>
                         </div>
                         <div class="tapered-rule"></div>
                         
                         <div class="text-sm text-black space-y-2 mt-2">
                             ${stats.abilities ? stats.abilities.map(a => `<div class="leading-snug"><strong class="italic text-red-900">${a.name}.</strong> ${a.description}</div>`).join('') : ''}
                         </div>

                         ${stats.actions && stats.actions.length ? `
                             <div class="dnd-section-title">Actions</div>
                             <div class="text-sm text-black space-y-2">
                                 ${stats.actions.map(a => `<div class="leading-snug"><strong class="dnd-action-name text-red-900">${a.name}.</strong> ${a.description}</div>`).join('')}
                             </div>
                         ` : ''}

                         ${stats.legendary_actions && stats.legendary_actions.length ? `
                             <div class="dnd-section-title">Legendary Actions</div>
                             <div class="text-sm text-black space-y-2">
                                 <p class="italic">The monster can take 3 legendary actions, choosing from the options below. Only one legendary action option can be used at a time and only at the end of another creature's turn. The monster regains spent legendary actions at the start of its turn.</p>
                                 ${stats.legendary_actions.map(a => `<div class="leading-snug"><strong class="dnd-action-name text-red-900">${a.name}.</strong> ${a.description}</div>`).join('')}
                             </div>
                         ` : ''}
                     </div>
                 `;
                 
                 document.getElementById('save-options-monster').classList.remove('hidden');
             } catch(e) { 
                 output.innerText = "Error generating: " + e.message; 
                 console.error(e); 
             } finally {
                 btn.disabled = false;
                 spinner.classList.add('hidden');
             }
        };
        
        // --- Helper Function for Title Generation ---
        function generateTitleFromContent(content) {
            // Check for Rich HTML Title (like the h1 in the DND statblock if used as content)
            const htmlTitleMatch = content.match(/<div class="dnd-header">(.*?)<\/div>/);
            if (htmlTitleMatch) {
                return htmlTitleMatch[1].trim();
            }

            // Create a temporary element to parse HTML structure safely
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            
            // Replace <br> tags with actual newlines so regex works
            tempDiv.querySelectorAll('br').forEach(br => br.replaceWith('\n'));
            tempDiv.querySelectorAll('div, p').forEach(block => block.after('\n')); // Ensure block elements break lines
            
            const textContent = tempDiv.textContent || "";

            // Try to find markdown header (# or ##) in the clean text
            const headerMatch = textContent.match(/^#+\s*(.*?)$/m);
            if (headerMatch) {
                return headerMatch[1].trim();
            }

            // Fallback: Use the first non-empty line
            const firstLine = textContent.split('\n').find(line => line.trim().length > 0) || "";
            const cleanLine = firstLine.replace(/^[#*>\s]+/, '').trim(); // Remove markdown chars
            
            const shortTitle = cleanLine.substring(0, 50);
            return (shortTitle + (cleanLine.length > 50 ? '...' : '')) || 'Untitled Generated Note';
        }
        
        window.saveGeneratedContent = async function(destinationTab) {
            const outputDiv = document.getElementById('ai-output');
            let contentToSave = outputDiv.innerHTML.trim();
            
            // If we are saving from the Loot tab, use the innerText from the loot output (markdown)
            if (currentTab === 'loot') {
                const lootDiv = document.getElementById('loot-output');
                if (lootDiv) {
                    contentToSave = lootDiv.innerText.trim(); // Save as plain text markdown
                }
            }

            if (!contentToSave || contentToSave === 'Results appear here.' || contentToSave === 'Loot appears here.' || contentToSave.startsWith('Error:')) {
                console.error('Nothing valid to save.');
                return;
            }

            if (!window.isAuthReady || !window.db) {
                console.error('Database not ready. Please wait for authentication.');
                return;
            }

            const title = generateTitleFromContent(contentToSave);

            const newNote = {
                id: crypto.randomUUID(),
                title: title,
                content: contentToSave, // Save the potentially rich HTML content
                timestamp: new Date().toISOString()
            };
            
            structuredNotes[destinationTab].unshift(newNote); // Add to beginning
            
            await window.saveStructuredNotes(destinationTab, structuredNotes[destinationTab]);

            window.switchTab('notes');
            window.switchSubTab(destinationTab);
        }


        // --- Soundboard ---
        const ac = new (window.AudioContext||window.webkitAudioContext)();
        
        // FIX: Mobile Audio Unlocker
        // Registers a one-time listener to wake up the audio context on the first touch/click
        const unlockMobileAudio = () => {
            if (ac.state === 'suspended') {
                ac.resume();
            }
            // Play a tiny silent buffer to force the audio thread to wake up on iOS/Android
            const buffer = ac.createBuffer(1, 1, 22050);
            const source = ac.createBufferSource();
            source.buffer = buffer;
            source.connect(ac.destination);
            source.start(0);
            
            // Remove listeners once unlocked
            document.removeEventListener('touchstart', unlockMobileAudio);
            document.removeEventListener('click', unlockMobileAudio);
        };
        document.addEventListener('touchstart', unlockMobileAudio);
        document.addEventListener('click', unlockMobileAudio);

        const masterGain = ac.createGain(); masterGain.connect(ac.destination); masterGain.gain.value = 0.5;
        let ambNodes = []; let ambType = null;
        const noiseBuf = ac.createBuffer(1, ac.sampleRate*2, ac.sampleRate);
        for(let i=0; i<noiseBuf.length; i++) noiseBuf.getChannelData(0)[i] = Math.random()*2-1;
        
        document.getElementById('master-volume').addEventListener('input', (e) => {
            masterGain.gain.setTargetAtTime(parseFloat(e.target.value), ac.currentTime, 0.01);
        });

        window.playTone = function(type) {
            if (ac.state === 'suspended') { ac.resume(); }
            const now = ac.currentTime;
            const osc = ac.createOscillator();
            const gain = ac.createGain();
            // ALL SOUNDS MUST CONNECT TO MASTERGAIN
            
            switch (type) {
                case 'success':
                    // Bright Major Triad Arpeggio
                    [523.25, 659.25, 783.99].forEach((freq, i) => {
                        const o = ac.createOscillator(); const g = ac.createGain();
                        o.type = 'triangle'; o.frequency.value = freq;
                        o.connect(g); g.connect(masterGain);
                        g.gain.setValueAtTime(0, now); g.gain.linearRampToValueAtTime(0.1, now + i*0.1 + 0.05); g.gain.exponentialRampToValueAtTime(0.001, now + 1.0);
                        o.start(now + i*0.1); o.stop(now + 1.0);
                    });
                    break;
                case 'critical':
                    // Victory Fanfare
                    [523.25, 1046.50, 1318.51].forEach((freq, i) => {
                        const o = ac.createOscillator(); const g = ac.createGain();
                        o.type = 'square'; o.frequency.value = freq;
                        o.connect(g); g.connect(masterGain);
                        g.gain.setValueAtTime(0, now); g.gain.linearRampToValueAtTime(0.1, now + 0.05); g.gain.exponentialRampToValueAtTime(0.001, now + 1.5);
                        o.start(now); o.stop(now + 1.5);
                    });
                    break;
                case 'fail':
                    // Sad "Womp Womp"
                    const o1 = ac.createOscillator(); const g1 = ac.createGain();
                    o1.type = 'sawtooth'; o1.frequency.setValueAtTime(196.00, now); o1.frequency.linearRampToValueAtTime(185.00, now + 0.4);
                    o1.connect(g1); g1.connect(masterGain); g1.gain.setValueAtTime(0.2, now); g1.gain.linearRampToValueAtTime(0, now + 0.4);
                    o1.start(now); o1.stop(now+0.4);
                    
                    const o2 = ac.createOscillator(); const g2 = ac.createGain();
                    o2.type = 'sawtooth'; o2.frequency.setValueAtTime(174.61, now + 0.45); o2.frequency.linearRampToValueAtTime(155.56, now + 1.0);
                    o2.connect(g2); g2.connect(masterGain);
                    g2.gain.setValueAtTime(0, now + 0.45); g2.gain.linearRampToValueAtTime(0.2, now + 0.5); g2.gain.linearRampToValueAtTime(0, now + 1.0);
                    o2.start(now + 0.45); o2.stop(now + 1.0);
                    break;
                case 'combat_start':
                    // War Horn
                    osc.type = 'sawtooth';
                    osc.frequency.value = 60;
                    const filter = ac.createBiquadFilter();
                    filter.type = 'lowpass';
                    filter.frequency.setValueAtTime(200, now);
                    filter.frequency.linearRampToValueAtTime(1500, now + 0.1); 
                    filter.frequency.exponentialRampToValueAtTime(200, now + 2);
                    
                    osc.connect(filter); filter.connect(gain); gain.connect(masterGain);
                    gain.gain.setValueAtTime(0, now);
                    gain.gain.linearRampToValueAtTime(0.4, now + 0.1);
                    gain.gain.exponentialRampToValueAtTime(0.001, now + 2);
                    osc.start(now); osc.stop(now + 2);
                    break;
                case 'spell':
                    // Magic Glissando
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(400, now);
                    osc.frequency.exponentialRampToValueAtTime(2000, now + 1);
                    gain.gain.setValueAtTime(0.2, now);
                    gain.gain.linearRampToValueAtTime(0, now + 1);
                    osc.connect(gain); gain.connect(masterGain);
                    osc.start(now); osc.stop(now + 1);
                    break;
                case 'mystery':
                    // Eerie Dissonance
                    const mo1 = ac.createOscillator(); const mg1 = ac.createGain();
                    mo1.type = 'sine'; mo1.frequency.value = 440;
                    mo1.connect(mg1); mg1.connect(masterGain);
                    mg1.gain.setValueAtTime(0, now); mg1.gain.linearRampToValueAtTime(0.2, now + 1); mg1.gain.linearRampToValueAtTime(0, now + 3);
                    mo1.start(now); mo1.stop(now + 3);
                    
                    const mo2 = ac.createOscillator(); const mg2 = ac.createGain();
                    mo2.type = 'sine'; mo2.frequency.value = 455; 
                    mo2.connect(mg2); mg2.connect(masterGain);
                    mg2.gain.setValueAtTime(0, now); mg2.gain.linearRampToValueAtTime(0.2, now + 1.5); mg2.gain.linearRampToValueAtTime(0, now + 3);
                    mo2.start(now); mo2.stop(now + 3);
                    break;
                case 'rest':
                    // Peaceful Chord
                    [261.63, 329.63, 392.00, 523.25].forEach(f => {
                        const o = ac.createOscillator(); const g = ac.createGain();
                        o.type = 'sine'; o.frequency.value = f;
                        o.connect(g); g.connect(masterGain);
                        g.gain.setValueAtTime(0, now);
                        g.gain.linearRampToValueAtTime(0.05, now + 1);
                        g.gain.linearRampToValueAtTime(0, now + 4);
                        o.start(now); o.stop(now + 4);
                    });
                    break;
                case 'trap':
                    // Sharp Snap
                    const n = ac.createBufferSource();
                    n.buffer = noiseBuf;
                    const f = ac.createBiquadFilter(); f.type = 'highpass'; f.frequency.value = 1000;
                    const ng = ac.createGain();
                    n.connect(f); f.connect(ng); ng.connect(masterGain);
                    ng.gain.setValueAtTime(0.6, now);
                    ng.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                    n.start(now); n.stop(now + 0.1);
                    
                    // Low thud
                    osc.type = 'square'; osc.frequency.setValueAtTime(100, now);
                    osc.frequency.exponentialRampToValueAtTime(40, now + 0.2);
                    osc.connect(gain); gain.connect(masterGain);
                    gain.gain.setValueAtTime(0.5, now);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
                    osc.start(now); osc.stop(now + 0.2);
                    break;
                case 'boss':
                    // Doom Drone
                    osc.type = 'sawtooth'; osc.frequency.setValueAtTime(55, now);
                    const bf = ac.createBiquadFilter(); bf.type='lowpass'; bf.frequency.value=150;
                    osc.connect(bf); bf.connect(gain); gain.connect(masterGain);
                    gain.gain.setValueAtTime(0, now);
                    gain.gain.linearRampToValueAtTime(0.5, now + 0.1);
                    gain.gain.exponentialRampToValueAtTime(0.001, now + 3);
                    osc.start(now); osc.stop(now + 3);
                    break;
            }
        };

        // --- Helper Functions for Soundboard ---
        function playNote(freq, t, dur, type = 'sine', vol = 0.3) {
            const o = ac.createOscillator(); const g = ac.createGain(); o.type = type; o.frequency.value = freq; 
            o.connect(g); g.connect(masterGain); 
            g.gain.setValueAtTime(vol, t); g.gain.exponentialRampToValueAtTime(0.01, t + dur); o.start(t); o.stop(t + dur);
        }
        function playDrum(type, time) {
            const osc = ac.createOscillator(); const gain = ac.createGain(); osc.connect(gain); gain.connect(masterGain);
            if (type === 'kick') { osc.frequency.setValueAtTime(150, time); osc.frequency.exponentialRampToValueAtTime(0.01, time+0.5); gain.gain.setValueAtTime(0.5, time); gain.gain.exponentialRampToValueAtTime(0.01, time+0.5); osc.start(time); osc.stop(time+0.5); }
            else if (type === 'snare') { const n = ac.createBufferSource(); n.buffer = noiseBuf; const f = ac.createBiquadFilter(); f.type = 'highpass'; f.frequency.value = 1000; n.connect(f); f.connect(gain); gain.gain.setValueAtTime(0.4, time); gain.gain.exponentialRampToValueAtTime(0.01, time+0.2); n.start(time); n.stop(time+0.2); }
            else if (type === 'hihat') { const n = ac.createBufferSource(); n.buffer = noiseBuf; const f = ac.createBiquadFilter(); f.type = 'highpass'; f.frequency.value = 5000; n.connect(f); f.connect(gain); gain.gain.setValueAtTime(0.3, time); gain.gain.exponentialRampToValueAtTime(0.01, time+0.05); n.start(time); n.stop(time+0.05); }
            else if (type === 'tom') { osc.frequency.setValueAtTime(100, time); osc.frequency.exponentialRampToValueAtTime(50, time+0.3); gain.gain.setValueAtTime(0.4, time); gain.gain.exponentialRampToValueAtTime(0.01, time+0.3); osc.start(time); osc.stop(time+0.3); }
        }
        function playLute(freq, startTime, duration) {
            const osc = ac.createOscillator(); const gain = ac.createGain(); const filter = ac.createBiquadFilter(); osc.type = 'sawtooth'; osc.frequency.setValueAtTime(freq, startTime); filter.type = 'lowpass'; filter.frequency.setValueAtTime(1000, startTime); gain.gain.setValueAtTime(0.1, startTime); gain.gain.exponentialRampToValueAtTime(0.001, startTime + duration); osc.connect(filter); filter.connect(gain); gain.connect(masterGain); osc.start(startTime); osc.stop(startTime + duration);
        }
        function playAccordion(freq, startTime, duration, vol = 0.15) {
             const osc = ac.createOscillator(); const gain = ac.createGain(); const filter = ac.createBiquadFilter(); osc.type = 'sawtooth'; osc.frequency.setValueAtTime(freq, startTime); filter.type = 'lowpass'; filter.frequency.value = 2500; osc.connect(filter); filter.connect(gain); gain.connect(masterGain); gain.gain.setValueAtTime(0, startTime); gain.gain.linearRampToValueAtTime(vol, startTime+0.1); gain.gain.setValueAtTime(vol, startTime + duration - 0.1); gain.gain.linearRampToValueAtTime(0, startTime+duration); osc.start(startTime); osc.stop(startTime + duration);
        }

        window.toggleAmbience = function(t) {
             if(ac.state==='suspended') ac.resume();
             ambNodes.forEach(n => { try{n.stop()}catch(e){} try{n.disconnect()}catch(e){} }); ambNodes=[];
             document.querySelectorAll('.sound-btn').forEach(b => b.classList.remove('active-loop'));
             if(ambType === t) { ambType = null; return; }
             ambType = t; document.getElementById(`ambience-${t}`).classList.add('active-loop');
             const now = ac.currentTime;
             
             if (t === 'village') {
                 // 1. Wind (Replaces Crowd Noise)
                 const noise = ac.createBufferSource(); noise.buffer = noiseBuf; noise.loop = true; const filter = ac.createBiquadFilter(); filter.type = 'lowpass'; filter.frequency.setValueAtTime(400, now); const lfo = ac.createOscillator(); lfo.type = 'sine'; lfo.frequency.value = 0.1; const lfoGain = ac.createGain(); lfoGain.gain.value = 200; lfo.connect(lfoGain); lfoGain.connect(filter.frequency); const gain = ac.createGain(); gain.gain.value = 0.05; noise.connect(filter); filter.connect(gain); gain.connect(masterGain); noise.start(now); lfo.start(now); ambNodes.push(noise, lfo, gain);
                 const waresInterval = setInterval(() => { if (Math.random() > 0.7) { playNote(1500 + Math.random() * 500, ac.currentTime, 0.05, 'triangle', 0.02); } }, 2000); ambNodes.push({ stop: () => clearInterval(waresInterval) });
                 const scale = [261.63, 293.66, 329.63, 392.00, 440.00, 523.25]; 
                 const musicInterval = setInterval(() => { const t = ac.currentTime; if (Math.random() > 0.3) { const pitch = scale[Math.floor(Math.random() * scale.length)]; playLute(pitch, t, 0.4); } if (Math.random() > 0.8) { playLute(196.00, t, 0.6); } }, 600); ambNodes.push({ stop: () => clearInterval(musicInterval) });
             }
             else if (t === 'city') {
                 const rumble = ac.createBufferSource(); rumble.buffer = noiseBuf; rumble.loop = true; const rumbleFilter = ac.createBiquadFilter(); rumbleFilter.type = 'lowpass'; rumbleFilter.frequency.value = 150; const rumbleGain = ac.createGain(); rumbleGain.gain.value = 0.1; rumble.connect(rumbleFilter); rumbleFilter.connect(rumbleGain); rumbleGain.connect(masterGain); rumble.start(now); ambNodes.push(rumble, rumbleGain);
                 const industryInterval = setInterval(() => { if (Math.random() > 0.6) { playNote(400 + Math.random() * 100, ac.currentTime, 0.1, 'square', 0.05); } if (Math.random() > 0.8) { playNote(80, ac.currentTime, 0.1, 'sine', 0.2); } }, 2000); ambNodes.push({ stop: () => clearInterval(industryInterval) });
                 const bellInterval = setInterval(() => { if (Math.random() > 0.85) { const t = ac.currentTime; playNote(220, t, 2.5, 'sine', 0.15); playNote(554, t, 1.5, 'sine', 0.05); } }, 8000); ambNodes.push({ stop: () => clearInterval(bellInterval) });
                 const cityScale = [293.66, 329.63, 369.99, 440.00, 493.88, 587.33]; let cityBeat = 0; const cityMusicInterval = setInterval(() => { const t = ac.currentTime; if (Math.random() > 0.2) { const note = cityScale[Math.floor(Math.random() * cityScale.length)]; playLute(note, t, 0.15); } if (cityBeat % 4 === 0 || cityBeat % 4 === 2) { playLute(146.83, t, 0.4); } cityBeat++; }, 250); ambNodes.push({ stop: () => clearInterval(cityMusicInterval) });
             }
             else if (t === 'tavern') {
                 const noise = ac.createBufferSource(); noise.buffer = noiseBuf; noise.loop = true; const filter = ac.createBiquadFilter(); filter.type = 'lowpass'; filter.frequency.value = 150; const gain = ac.createGain(); gain.gain.value = 0.25; noise.connect(filter); filter.connect(gain); gain.connect(masterGain); noise.start(now); ambNodes.push(noise, gain);
                 const clinkInterval = setInterval(() => { if (Math.random() > 0.6) { playNote(1200, ac.currentTime, 0.05, 'triangle', 0.05); } }, 2500); ambNodes.push({ stop: () => clearInterval(clinkInterval) });
                 const scale = [261.63, 293.66, 329.63, 392.00, 440.00, 523.25]; let beat = 0; const musicInterval = setInterval(() => { const t = ac.currentTime; if (beat % 4 === 0) { playLute(130.81, t, 0.8); } if (Math.random() > 0.2) { const noteIdx = Math.floor(Math.random() * scale.length); playLute(scale[noteIdx], t + 0.05, 0.4); } beat++; }, 300); ambNodes.push({ stop: () => clearInterval(musicInterval) });
             }
             else if (t === 'ocean') {
                 const drone = ac.createOscillator(); drone.type = 'sawtooth'; drone.frequency.value = 73.42; 
                 const droneFilter = ac.createBiquadFilter(); droneFilter.type = 'lowpass'; droneFilter.frequency.value = 300; 
                 const droneGain = ac.createGain(); droneGain.gain.value = 0.05; 
                 drone.connect(droneFilter); droneFilter.connect(droneGain); droneGain.connect(masterGain); 
                 drone.start(now); ambNodes.push(drone, droneGain);
                 
                 const shantyScale = [293.66, 329.63, 349.23, 392.00, 440.00, 493.88, 523.25]; let beat = 0; 
                 const iv = setInterval(() => { const t = ac.currentTime; 
                     if (beat % 2 === 0) { playDrum('kick', t); playAccordion(146.83, t, 0.4, 0.2); } 
                     else { playDrum('snare', t); playAccordion(293.66, t, 0.2, 0.05); } 
                     if (Math.random() > 0.3) { const n = shantyScale[Math.floor(Math.random()*shantyScale.length)]; playAccordion(n, t, 0.4, 0.15); } 
                     beat++; 
                 }, 600); 
                 ambNodes.push({ stop: () => clearInterval(iv) });
             }
             else if (t === 'dungeon') {
                 const drone1 = ac.createOscillator(); drone1.type = 'triangle'; drone1.frequency.value = 55; const drone2 = ac.createOscillator(); drone2.type = 'sine'; drone2.frequency.value = 58; const droneGain = ac.createGain(); droneGain.gain.value = 0.15; const filter = ac.createBiquadFilter(); filter.type = 'lowpass'; filter.frequency.value = 300; drone1.connect(filter); drone2.connect(filter); filter.connect(droneGain); droneGain.connect(masterGain); drone1.start(now); drone2.start(now); ambNodes.push(drone1, drone2, droneGain);
                 const dripInterval = setInterval(() => { if (Math.random() > 0.6) { const t = ac.currentTime; const osc = ac.createOscillator(); osc.type = 'sine'; osc.frequency.setValueAtTime(2000 + Math.random() * 500, t); const g = ac.createGain(); g.gain.setValueAtTime(0, t); g.gain.linearRampToValueAtTime(0.1, t + 0.01); g.gain.exponentialRampToValueAtTime(0.001, t + 0.15); const pan = ac.createStereoPanner(); pan.pan.value = Math.random() * 2 - 1; const delay = ac.createDelay(); delay.delayTime.value = 0.3; const delayGain = ac.createGain(); delayGain.gain.value = 0.3; osc.connect(g); g.connect(pan); pan.connect(masterGain); g.connect(delay); delay.connect(delayGain); delayGain.connect(masterGain); osc.start(t); osc.stop(t + 0.5); } }, 3000); ambNodes.push({ stop: () => clearInterval(dripInterval) });
                 const scale = [164.81, 174.61, 196.00, 220.00, 246.94, 261.63, 293.66]; const musicInterval = setInterval(() => { const t = ac.currentTime; if (Math.random() > 0.4) { const note = scale[Math.floor(Math.random() * scale.length)]; playNote(note, t, 3.5, 'triangle', 0.08); if (Math.random() > 0.7) { playNote(note / 2, t, 4, 'sine', 0.15); } } }, 4500); ambNodes.push({ stop: () => clearInterval(musicInterval) });
             }
             else if (t === 'battle_minor') {
                 // Procedural Battle Music: Driving Ostinato & War Drums
                 const bpm = 130;
                 const stepTime = (60 / bpm) / 4; // 16th note duration
                 let step = 0;
                 
                 // D Minor Ostinato pattern (D2, F2, E2)
                 const bassFreqs = [73.42, 73.42, 73.42, 73.42, 87.31, 87.31, 82.41, 82.41]; 

                 const sequencer = setInterval(() => { 
                     const t = ac.currentTime; 
                     const barStep = step % 16; // 0-15

                     // 1. Driving Bass/Cello Ostinato (8th notes)
                     if (step % 2 === 0) {
                         const noteIdx = Math.floor((step % 16) / 2) % bassFreqs.length;
                         const osc = ac.createOscillator(); 
                         osc.type = 'sawtooth'; 
                         osc.frequency.value = bassFreqs[noteIdx];
                         
                         const filter = ac.createBiquadFilter();
                         filter.type = 'lowpass';
                         filter.frequency.value = 600; // Muffle it for "string" effect

                         const gain = ac.createGain();
                         gain.gain.setValueAtTime(0.25, t);
                         gain.gain.exponentialRampToValueAtTime(0.01, t + 0.15); // Short, staccato pluck
                         
                         osc.connect(filter); filter.connect(gain); gain.connect(masterGain);
                         osc.start(t); osc.stop(t + 0.2);
                     }

                     // 2. War Drums Pattern
                     // Kick on 1, 3, and syncopation
                     if (barStep === 0 || barStep === 6 || barStep === 10) { 
                         playDrum('kick', t); 
                         if(barStep === 0) playDrum('tom', t); // Accent downbeat
                     }
                     // Snare/Hit impacts
                     if (barStep === 4 || barStep === 12) { 
                         playDrum('snare', t); 
                         
                         // Add "Brass" Stab on snares for impact
                         const bOsc = ac.createOscillator(); bOsc.type = 'sawtooth';
                         bOsc.frequency.value = 146.83; // D3
                         const bFilt = ac.createBiquadFilter(); bFilt.type = 'lowpass';
                         bFilt.frequency.setValueAtTime(500, t);
                         bFilt.frequency.linearRampToValueAtTime(2500, t + 0.05); // Brass "blare" envelope
                         const bGain = ac.createGain();
                         bGain.gain.setValueAtTime(0.1, t);
                         bGain.gain.exponentialRampToValueAtTime(0.01, t + 0.25);
                         bOsc.connect(bFilt); bFilt.connect(bGain); bGain.connect(masterGain);
                         bOsc.start(t); bOsc.stop(t + 0.3);
                     }
                     
                     // High tension clicks/hats
                     if (barStep % 2 === 0) {
                         const hOsc = ac.createOscillator(); hOsc.type = 'square';
                         hOsc.frequency.value = 800;
                         const hGain = ac.createGain();
                         hGain.gain.setValueAtTime(0.03, t);
                         hGain.gain.exponentialRampToValueAtTime(0.001, t + 0.03);
                         hOsc.connect(hGain); hGain.connect(masterGain);
                         hOsc.start(t); hOsc.stop(t + 0.05);
                     }

                     step++; 
                 }, stepTime * 1000);
                 
                 ambNodes.push({ stop: () => clearInterval(sequencer) });
             }
             else if (t === 'battle_major') {
                 const osc = ac.createOscillator(); osc.type = 'sawtooth'; osc.frequency.value = 35; const filter = ac.createBiquadFilter(); filter.type = 'lowpass'; filter.frequency.value = 200; const lfo = ac.createOscillator(); lfo.type = 'sine'; lfo.frequency.value = 0.25; const lfoGain = ac.createGain(); lfoGain.gain.value = 150; lfo.connect(lfoGain); lfoGain.connect(filter.frequency); const gain = ac.createGain(); gain.gain.value = 0.2; osc.connect(filter); filter.connect(gain); gain.connect(masterGain); osc.start(now); lfo.start(now); ambNodes.push(osc, filter, gain, lfo, lfoGain);
                 let beat = 0; const drumInterval = setInterval(() => { const t = ac.currentTime; if (beat % 4 === 0) { playDrum('kick', t); playDrum('tom', t + 0.1); } if (beat % 4 === 2) { playDrum('snare', t); playDrum('kick', t); } playDrum('hihat', t); playDrum('hihat', t + 0.21); beat++; }, 428); ambNodes.push({ stop: () => clearInterval(drumInterval) });
             }
             else if (t === 'sleep') {
                 const noise = ac.createBufferSource(); noise.buffer = noiseBuf; noise.loop = true; const filter = ac.createBiquadFilter(); filter.type = 'lowpass'; filter.frequency.value = 120; const gain = ac.createGain(); gain.gain.value = 0.3; noise.connect(filter); filter.connect(gain); gain.connect(masterGain); noise.start(now); ambNodes.push(noise, gain);
                 const crackleInterval = setInterval(() => { if (Math.random() > 0.7) { const n = ac.createBufferSource(); n.buffer = noiseBuf; const f = ac.createBiquadFilter(); f.type = 'highpass'; f.frequency.value = 2000; const g = ac.createGain(); g.gain.value = 0.1 + Math.random() * 0.1; g.gain.exponentialRampToValueAtTime(0.01, ac.currentTime + 0.05); n.connect(f); f.connect(g); g.connect(masterGain); n.start(); n.stop(ac.currentTime + 0.05); } }, 200); ambNodes.push({ stop: () => clearInterval(crackleInterval) });
                 const scale = [196.00, 220.00, 246.94, 293.66, 329.63]; const sleepMusicInterval = setInterval(() => { if (Math.random() > 0.4) { const t = ac.currentTime; const noteIdx = Math.floor(Math.random() * scale.length); playNote(scale[noteIdx], t, 4, 'sine', 0.1); if (Math.random() > 0.5) { playNote(scale[(noteIdx + 2) % scale.length], t + 0.5, 4, 'sine', 0.08); } } }, 5000); ambNodes.push({ stop: () => clearInterval(sleepMusicInterval) });
             }
        };

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            if(userApiKey) document.getElementById('user-api-key').value = userApiKey;
            window.updateApiKey(userApiKey);
            switchTab('improv');
        });
    </script>
</body>
</html>
