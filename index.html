<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aegis DM Toolkit</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #0f172a; 
            color: #f8fafc; 
            margin: 0;
            padding: 20px;
        }
        .tab-button.active { border-bottom: 3px solid #6366f1; color: #c7d2fe; }
        .sub-tab-button.active { border-bottom: 2px solid #34d399; color: #34d399; }
        .card { background-color: #1e293b; border: 1px solid #334155; }
        .input-style { background-color: #334155; border: 1px solid #475569; color: #f8fafc; }
        .glow-shadow { box-shadow: 0 0 10px rgba(99, 102, 241, 0.5); }
        .scrollable-content { max-height: 60vh; overflow-y: auto; }
        .scrollable-content::-webkit-scrollbar { width: 8px; }
        .scrollable-content::-webkit-scrollbar-track { background: #1e293b; }
        .scrollable-content::-webkit-scrollbar-thumb { background-color: #475569; border-radius: 20px; border: 2px solid #1e293b; }
        .loading-spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-top: 4px solid #fff; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .collapsible-header { cursor: pointer; display: flex; justify-content: space-between; align-items: center; padding: 10px; background-color: #334155; border-radius: 8px; }
        .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; padding: 0 10px; }
        .collapsible-content.expanded { max-height: 1000px; padding: 10px; }
        .arrow-icon { transition: transform 0.3s ease; }
        .expanded .arrow-icon { transform: rotate(90deg); }
        
        #error-console {
            display: none;
            background: #7f1d1d;
            color: #fecaca;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 0.5rem;
            border: 1px solid #ef4444;
            font-family: monospace;
            white-space: pre-wrap;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div id="error-console"></div>

    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-indigo-400 flex items-center gap-2">
                üõ°Ô∏è Aegis DM Toolkit
                <div id="db-status-indicator" class="w-3 h-3 rounded-full bg-gray-500" title="Checking Database Status..."></div>
            </h1>
            <div class="flex space-x-2">
                <button onclick="openSettingsModal()" class="flex items-center justify-center bg-gray-800 hover:bg-gray-700 border border-gray-600 p-2 rounded-lg transition duration-300" title="Settings">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-300" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" />
                    </svg>
                </button>
                <button onclick="openLoginModal()" class="flex items-center space-x-2 bg-gray-800 hover:bg-gray-700 border border-gray-600 px-4 py-2 rounded-lg transition duration-300">
                    <div class="w-3 h-3 rounded-full bg-green-500" id="auth-status-dot"></div>
                    <span id="account-name-display" class="text-sm font-semibold text-gray-300">Guest Session</span>
                </button>
            </div>
        </div>

        <!-- Navigation -->
        <div class="flex border-b border-gray-600 mb-6">
            <button class="tab-button p-3 flex-1 text-sm font-semibold transition duration-300 active" onclick="switchTab('improv')">üîÆ Prep & Improv</button>
            <button class="tab-button p-3 flex-1 text-sm font-semibold text-gray-400 transition duration-300" onclick="switchTab('combat')">‚öîÔ∏è Combat Tracker</button>
            <button class="tab-button p-3 flex-1 text-sm font-semibold text-gray-400 transition duration-300" onclick="switchTab('statblocks')">üëπ Statblocks</button>
            <button class="tab-button p-3 flex-1 text-sm font-semibold text-gray-400 transition duration-300" onclick="switchTab('monsters')">üê≤ Monsters</button>
            <button class="tab-button p-3 flex-1 text-sm font-semibold text-gray-400 transition duration-300" onclick="switchTab('notes')">üìú Rulings & Notes</button>
        </div>

        <!-- Content -->
        <div id="content-area">
            <!-- Improv Tab -->
            <div id="improv" class="tab-content">
                <div class="card p-4 rounded-lg shadow-xl mb-6">
                    <h2 class="text-xl font-semibold mb-4 text-green-300">Structured Combat NPC Stats</h2>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div><label class="block text-xs text-gray-400 mb-1">Level/CR</label><input type="text" id="npc-level" value="3" class="w-full p-2 rounded-lg input-style text-sm"></div>
                        <div><label class="block text-xs text-gray-400 mb-1">Type</label><input type="text" id="npc-type" value="Shadow Rogue" class="w-full p-2 rounded-lg input-style text-sm"></div>
                    </div>
                    <button onclick="generateCombatNpc()" id="generate-combat-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded-lg flex justify-center items-center">
                        <span id="generate-combat-text">Generate Stats</span><div id="combat-loading-spinner" class="loading-spinner ml-2 hidden"></div>
                    </button>
                </div>

                <div class="card p-4 rounded-lg shadow-xl mb-6">
                    <h2 class="text-xl font-semibold mb-4 text-indigo-300">Creative Lore & Backstory</h2>
                    <textarea id="improv-prompt" rows="3" class="w-full p-3 rounded-lg input-style resize-none mb-4" placeholder="e.g., A grumpy female blacksmith..."></textarea>
                    <button onclick="generateCreativeIdea()" id="generate-button" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 rounded-lg flex justify-center items-center">
                        <span id="generate-text">Generate Idea</span><div id="creative-loading-spinner" class="loading-spinner ml-2 hidden"></div>
                    </button>
                </div>

                <div class="card p-4 rounded-lg shadow-xl mb-6">
                    <h2 class="text-xl font-semibold mb-4 text-teal-300">Settlement Generator</h2>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div><label class="block text-xs text-gray-400 mb-1">Type</label><select id="settlement-type" class="w-full p-2 rounded-lg input-style text-sm"><option>Village</option><option>Town</option><option>City</option></select></div>
                        <div><label class="block text-xs text-gray-400 mb-1">Vibe</label><input type="text" id="settlement-vibe" value="haunted fishing village" class="w-full p-2 rounded-lg input-style text-sm"></div>
                    </div>
                    <button onclick="generateSettlement()" id="generate-settlement-button" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 rounded-lg flex justify-center items-center">
                        <span id="generate-settlement-text">Generate Settlement</span><div id="settlement-loading-spinner" class="loading-spinner ml-2 hidden"></div>
                    </button>
                </div>

                <div class="card p-4 rounded-lg shadow-xl">
                    <h2 class="text-xl font-semibold mb-4 text-indigo-300">Results</h2>
                    <div id="ai-image-output" class="mb-4 hidden rounded-lg overflow-hidden"><img id="generated-image" class="w-full h-auto object-cover bg-gray-800 min-h-[150px]"></div>
                    <div id="ai-output" class="whitespace-pre-wrap min-h-[100px] bg-gray-700/30 p-3 rounded-lg text-gray-300">Results appear here...</div>
                    <div id="save-options-creative" class="mt-4 hidden grid grid-cols-3 gap-2">
                        <button onclick="saveGeneratedContent('prepNotes')" class="bg-gray-500 text-white text-xs font-bold py-2 rounded-lg">Save to Notes</button>
                        <button onclick="saveGeneratedContent('enemyNotes')" class="bg-yellow-600 text-white text-xs font-bold py-2 rounded-lg">Save to Enemies</button>
                        <button onclick="saveGeneratedContent('npcNotes')" class="bg-blue-600 text-white text-xs font-bold py-2 rounded-lg">Save to NPCs</button>
                    </div>
                </div>
            </div>

            <!-- Combat Tab -->
            <div id="combat" class="tab-content hidden">
                <div class="card p-4 rounded-lg shadow-xl">
                    <h2 class="text-xl font-semibold mb-4 text-indigo-300">Combat Tracker</h2>
                    <div class="flex flex-wrap gap-2 mb-4">
                        <input id="combatant-name" type="text" placeholder="Name" class="flex-1 min-w-[100px] p-2 rounded-lg input-style" />
                        <input id="combatant-init" type="number" placeholder="Init" class="w-20 p-2 rounded-lg input-style text-center text-sm" />
                        <input id="combatant-ac" type="number" placeholder="AC" class="w-16 p-2 rounded-lg input-style text-center text-sm" />
                        <input id="combatant-hp" type="number" placeholder="HP" class="w-16 p-2 rounded-lg input-style text-center text-sm" />
                        <button onclick="addCombatant()" class="bg-indigo-600 text-white font-bold px-3 py-2 rounded-lg text-sm">Add</button>
                    </div>
                    <div class="card p-4 rounded-lg shadow-inner mb-4 bg-gray-800/50 flex items-center gap-2">
                        <button onclick="rollD20()" class="w-1/3 bg-green-600 text-white font-bold py-2 rounded-lg text-sm">Roll D20</button>
                        <div id="last-roll-display" class="w-1/3 text-4xl font-extrabold text-center text-yellow-400 bg-gray-900/50 p-2 rounded-lg">?</div>
                        <div class="flex-1 flex flex-col gap-2">
                            <select id="combatant-selector" class="w-full p-2 rounded-lg input-style text-sm"><option disabled selected>Target</option></select>
                            <button onclick="assignInitiativeRoll()" id="assign-roll-button" class="w-full bg-blue-600 text-white font-bold py-1 rounded-lg text-sm" disabled>Assign</button>
                        </div>
                    </div>
                    <div class="flex justify-between items-center mb-4">
                        <button onclick="sortInitiative()" class="bg-gray-600 text-white font-bold py-2 px-4 rounded-lg text-sm">Sort</button>
                        <button onclick="nextTurn()" class="bg-purple-600 text-white font-bold py-2 px-4 rounded-lg text-sm">Next Turn</button>
                        <button onclick="clearCombat()" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg text-sm">Clear</button>
                    </div>
                    <div id="initiative-list" class="scrollable-content space-y-2"><p class="text-center text-gray-500 pt-8">Empty.</p></div>
                </div>
            </div>

            <!-- Statblocks Tab -->
            <div id="statblocks" class="tab-content hidden">
                <div class="card p-4 rounded-lg shadow-xl mb-6">
                    <h2 class="text-xl font-semibold mb-4 text-indigo-300">Add Statblock</h2>
                    <div class="grid grid-cols-2 gap-2 mb-4">
                        <input id="stat-name" type="text" placeholder="Name" class="col-span-2 p-2 rounded-lg input-style" />
                        <input id="stat-hp" type="number" placeholder="HP" class="p-2 rounded-lg input-style text-center text-sm" />
                        <input id="stat-ac" type="number" placeholder="AC" class="p-2 rounded-lg input-style text-center text-sm" />
                        <input id="stat-tohit" type="number" placeholder="Hit Mod" class="p-2 rounded-lg input-style text-center text-sm" />
                        <input id="stat-init-mod" type="number" placeholder="Init Mod" class="p-2 rounded-lg input-style text-center text-sm" />
                        <input id="stat-dmg" type="text" placeholder="Damage/Actions" class="col-span-2 p-2 rounded-lg input-style" />
                    </div>
                    <button onclick="saveStatblock()" class="w-full bg-indigo-600 text-white font-bold py-2 rounded-lg">Save</button>
                    <p id="statblock-status" class="mt-2 text-sm text-center text-gray-400"></p>
                </div>
                <div class="card p-4 rounded-lg shadow-xl mb-6">
                    <h2 class="text-xl font-semibold mb-4 text-teal-300">Dice Roller</h2>
                    <div class="flex items-center gap-2 mb-4">
                        <input id="dice-num" type="number" value="1" class="w-12 p-2 rounded-lg input-style text-center text-sm">
                        <span>d</span>
                        <select id="dice-type" class="p-2 rounded-lg input-style text-sm"><option>4</option><option>6</option><option>8</option><option>10</option><option>12</option><option selected>20</option><option>100</option></select>
                        <span>+</span>
                        <input id="dice-mod" type="number" value="0" class="w-12 p-2 rounded-lg input-style text-center text-sm">
                        <button onclick="rollCustomDice()" class="flex-1 bg-teal-600 text-white font-bold py-2 rounded-lg">Roll</button>
                    </div>
                    <div id="dice-roll-result" class="text-center text-xl font-bold text-yellow-300 bg-gray-700/50 p-2 rounded-lg">Result</div>
                    <p id="dice-roll-details" class="text-center text-xs text-gray-400 mt-1"></p>
                </div>
                <div class="card p-4 rounded-lg shadow-xl">
                    <h2 class="text-xl font-semibold mb-4 text-indigo-300">Saved Statblocks</h2>
                    <div id="statblocks-list" class="scrollable-content space-y-2"><p class="text-center text-gray-500 pt-8">None saved.</p></div>
                </div>
            </div>

            <!-- Monsters Tab -->
            <div id="monsters" class="tab-content hidden">
                <div class="card p-4 rounded-lg shadow-xl mb-6">
                    <h2 class="text-xl font-semibold mb-4 text-green-300">Monster Generator</h2>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div><label class="text-xs text-gray-400">Name</label><input type="text" id="monster-name" value="Cave Troll" class="w-full p-2 rounded-lg input-style"></div>
                        <div><label class="text-xs text-gray-400">CR</label><input type="text" id="monster-cr" value="4" class="w-full p-2 rounded-lg input-style"></div>
                    </div>
                    <button onclick="generateMonsterStatblock()" id="generate-monster-button" class="w-full bg-green-600 text-white font-bold py-2 rounded-lg flex justify-center items-center">
                        <span id="generate-monster-text">Generate</span><div id="monster-loading-spinner" class="loading-spinner ml-2 hidden"></div>
                    </button>
                </div>
                <div class="card p-4 rounded-lg shadow-xl">
                    <div id="monster-output" class="min-h-[100px] bg-gray-700/30 p-3 rounded-lg text-gray-300">Result...</div>
                    <div id="save-options-monster" class="mt-4 hidden grid grid-cols-2 gap-2">
                        <button onclick="addMonsterToStatblocks()" class="bg-purple-600 text-white text-xs font-bold py-2 rounded-lg">To Statblocks</button>
                        <button onclick="saveMonsterToNotes()" class="bg-yellow-600 text-white text-xs font-bold py-2 rounded-lg">To Notes</button>
                    </div>
                </div>
            </div>

            <!-- Notes Tab -->
            <div id="notes" class="tab-content hidden">
                <div class="card p-4 rounded-lg shadow-xl">
                    <h2 class="text-xl font-semibold mb-4 text-indigo-300">Notes</h2>
                    <div class="flex border-b border-gray-700 mb-4 -mx-4 px-4">
                        <button class="sub-tab-button p-2 text-sm active" onclick="switchSubTab('prepNotes')" data-subtab="prepNotes">General</button>
                        <button class="sub-tab-button p-2 text-sm text-gray-400" onclick="switchSubTab('enemyNotes')" data-subtab="enemyNotes">Enemies</button>
                        <button class="sub-tab-button p-2 text-sm text-gray-400" onclick="switchSubTab('npcNotes')" data-subtab="npcNotes">NPCs</button>
                    </div>
                    <div id="prepNotes-sub-content" class="sub-tab-content"><div id="prepNotes-list" class="scrollable-content space-y-3"></div></div>
                    <div id="enemyNotes-sub-content" class="sub-tab-content hidden"><div id="enemyNotes-list" class="scrollable-content space-y-3"></div></div>
                    <div id="npcNotes-sub-content" class="sub-tab-content hidden"><div id="npcNotes-list" class="scrollable-content space-y-3"></div></div>
                    <button onclick="addNewNote(currentSubTab)" class="mt-4 w-full bg-indigo-600 text-white font-bold py-2 rounded-lg">+ Note</button>
                    <p id="notes-status" class="mt-2 text-sm text-center text-gray-400"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals (Settings, Login, Edit) -->
    <div id="settings-modal" class="hidden fixed inset-0 z-50 bg-black bg-opacity-80 flex items-center justify-center p-4">
        <div class="card w-full max-w-lg p-6 rounded-lg shadow-2xl border border-gray-600">
            <h3 class="text-2xl font-bold text-indigo-300 mb-4">Settings</h3>
            <label class="block text-sm font-medium text-gray-300 mb-1">Gemini API Key (Required for AI)</label>
            <input type="password" id="settings-api-key" placeholder="Paste API Key" class="w-full p-3 rounded-lg input-style mb-4">
            <div class="flex justify-end space-x-3">
                <button onclick="closeSettingsModal()" class="bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">Cancel</button>
                <button onclick="saveSettings()" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg">Save</button>
            </div>
        </div>
    </div>

    <div id="login-modal" class="hidden fixed inset-0 z-50 bg-black bg-opacity-80 flex items-center justify-center p-4">
        <div class="card w-full max-w-md p-6 rounded-lg shadow-2xl border border-indigo-500">
            <h3 class="text-2xl font-bold text-indigo-300 mb-4">Login</h3>
            <div id="login-warning" class="hidden mb-4 p-2 bg-red-900 text-red-200 text-xs rounded">DB Disconnected</div>
            <input type="text" id="login-campaign" placeholder="Campaign Name" class="w-full p-3 rounded-lg input-style mb-4">
            <input type="password" id="login-password" placeholder="Password" class="w-full p-3 rounded-lg input-style mb-6">
            <div class="flex justify-between items-center">
                <button onclick="performSignOut()" class="text-red-400 text-sm font-bold">Sign Out</button>
                <div class="flex gap-2">
                    <button onclick="closeLoginModal()" class="bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">Cancel</button>
                    <button onclick="performSignIn()" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg">Login</button>
                </div>
            </div>
        </div>
    </div>

    <div id="edit-modal" class="hidden fixed inset-0 z-50 bg-black bg-opacity-75 flex items-center justify-center p-4">
        <div class="card w-full max-w-lg p-6 rounded-lg">
            <h3 class="text-xl font-bold text-indigo-300 mb-4">Edit Note</h3>
            <input type="hidden" id="modal-note-id"><input type="hidden" id="modal-tab-name">
            <input type="text" id="modal-title" class="w-full p-3 rounded-lg input-style mb-4">
            <textarea id="modal-content" rows="6" class="w-full p-3 rounded-lg input-style mb-6"></textarea>
            <div class="flex justify-end gap-3">
                <button onclick="closeEditModal()" class="bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">Cancel</button>
                <button onclick="saveEditedNote()" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Save</button>
            </div>
        </div>
    </div>

    <div id="edit-statblock-modal" class="hidden fixed inset-0 z-50 bg-black bg-opacity-75 flex items-center justify-center p-4">
        <div class="card w-full max-w-lg p-6 rounded-lg">
            <h3 class="text-xl font-bold text-indigo-300 mb-4">Edit Statblock</h3>
            <input type="hidden" id="modal-statblock-id">
            <input type="text" id="modal-stat-name" class="w-full p-3 rounded-lg input-style mb-4">
            <div class="grid grid-cols-2 gap-4 mb-4">
                <input type="number" id="modal-stat-hp" class="p-2 rounded-lg input-style text-center">
                <input type="number" id="modal-stat-ac" class="p-2 rounded-lg input-style text-center">
                <input type="number" id="modal-stat-tohit" class="p-2 rounded-lg input-style text-center">
                <input type="number" id="modal-stat-init-mod" class="p-2 rounded-lg input-style text-center">
            </div>
            <input type="text" id="modal-stat-dmg" class="w-full p-3 rounded-lg input-style mb-6">
            <div class="flex justify-end gap-3">
                <button onclick="closeStatblockEditModal()" class="bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">Cancel</button>
                <button onclick="saveEditedStatblock()" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Save</button>
            </div>
        </div>
    </div>

    <script type="module">
        // --- 1. UI & LOGIC (Runs Immediately) ---
        
        // --- State ---
        window.currentTab = 'improv'; 
        window.currentSubTab = 'prepNotes';
        window.savedStatblocks = []; 
        window.lastGeneratedNpc = null; 
        window.lastGeneratedMonster = null;
        window.combatants = []; 
        window.currentTurnIndex = -1; 
        window.lastRoll = 0;
        window.structuredNotes = { prepNotes: [], enemyNotes: [], npcNotes: [] };
        
        // --- API Keys ---
        window.userApiKey = localStorage.getItem('aegis_gemini_api_key') || "";
        window.fallbackKey = ""; // Preview key injected by environment if available

        // --- UI Functions ---
        window.switchTab = function(id) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            document.querySelectorAll('.tab-button').forEach(b => {
                 b.classList.remove('active', 'text-gray-400');
                 if(b.getAttribute('onclick').includes(id)) b.classList.add('active'); else b.classList.add('text-gray-400');
            });
            window.currentTab = id;
            if(id === 'notes') window.renderStructuredNotes(window.currentSubTab);
        };

        window.switchSubTab = function(id) {
            window.currentSubTab = id;
            document.querySelectorAll('.sub-tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(id+'-sub-content').classList.remove('hidden');
            document.querySelectorAll('.sub-tab-button').forEach(b => {
                 b.classList.remove('active', 'text-gray-400');
                 if(b.getAttribute('data-subtab') === id) b.classList.add('active'); else b.classList.add('text-gray-400');
            });
            window.renderStructuredNotes(id);
        };

        window.rollCustomDice = function() {
             const n = parseInt(document.getElementById('dice-num').value) || 1;
             const t = parseInt(document.getElementById('dice-type').value) || 20;
             const m = parseInt(document.getElementById('dice-mod').value) || 0;
             let sum = 0; let r = [];
             for(let i=0; i<n; i++) { let v = Math.floor(Math.random()*t)+1; sum+=v; r.push(v); }
             document.getElementById('dice-roll-result').textContent = `Total: ${sum+m}`;
             document.getElementById('dice-roll-details').textContent = `Rolls: ${r.join(',')} + ${m}`;
        };
        
        window.rollD20 = function() {
             window.lastRoll = Math.floor(Math.random()*20)+1;
             const d = document.getElementById('last-roll-display');
             if(d) d.textContent = window.lastRoll;
             window.popSel();
        };
        
        window.popSel = function() {
             const sel = document.getElementById('combatant-selector');
             if(!sel) return;
             sel.innerHTML = '<option disabled selected>Target</option>';
             window.combatants.forEach((c, i) => {
                 const o = document.createElement('option'); o.value = i; o.textContent = c.name; sel.appendChild(o);
             });
             const btn = document.getElementById('assign-roll-button');
             if(btn) btn.disabled = window.combatants.length === 0;
        };

        window.openSettingsModal = function() {
            document.getElementById('settings-api-key').value = window.userApiKey;
            document.getElementById('settings-modal').classList.remove('hidden');
        };
        window.closeSettingsModal = function() { document.getElementById('settings-modal').classList.add('hidden'); };
        window.saveSettings = function() {
            const key = document.getElementById('settings-api-key').value.trim();
            window.userApiKey = key;
            localStorage.setItem('aegis_gemini_api_key', key);
            window.closeSettingsModal();
            alert("Key saved. Reloading...");
            location.reload();
        };

        // --- AI Generators ---
        const API_URL_PREVIEW = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=';
        const API_URL_PUBLIC = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=';
        const IMAGE_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-001:predict?key=';

        async function fetchAI(payload, urlBase) {
            let key = window.userApiKey;
            let url = API_URL_PUBLIC; // Default to public stable model if user has key
            
            if (!key) {
                // If no user key, try injected key (Preview Environment)
                key = window.fallbackKey; 
                url = API_URL_PREVIEW;
            }
            
            if (!key) {
                window.openSettingsModal();
                throw new Error("Please enter an API Key in Settings.");
            }
            
            // Override URL if using Image gen
            if (urlBase && urlBase.includes('imagen')) url = urlBase;

            const res = await fetch(url + key, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            
            if (!res.ok) throw new Error(`API Error: ${res.status}`);
            return await res.json();
        }

        window.generateCreativeIdea = async function() {
            const p = document.getElementById('improv-prompt').value;
            if(!p) return alert("Enter prompt");
            const spin = document.getElementById('creative-loading-spinner'); 
            spin.classList.remove('hidden');
            try {
                const data = await fetchAI({ contents: [{ parts: [{ text: "You are a D&D assistant. " + p }] }] });
                document.getElementById('ai-output').textContent = data.candidates[0].content.parts[0].text;
                document.getElementById('save-options-creative').classList.remove('hidden');
            } catch(e) { alert(e.message); }
            spin.classList.add('hidden');
        };

        window.generateSettlement = async function() {
            const type = document.getElementById('settlement-type').value;
            const vibe = document.getElementById('settlement-vibe').value;
            const spin = document.getElementById('settlement-loading-spinner');
            const output = document.getElementById('ai-output');
            const imgOut = document.getElementById('generated-image');
            
            spin.classList.remove('hidden');
            output.textContent = "Generating text...";
            imgOut.classList.add('hidden');

            // Text First
            try {
                const textData = await fetchAI({ contents: [{ parts: [{ text: `Generate D&D settlement: ${type}, ${vibe}. Include Name, Lore, Politics, Key Areas.` }] }] });
                output.textContent = textData.candidates[0].content.parts[0].text;
                document.getElementById('save-options-creative').classList.remove('hidden');
            } catch (e) { output.textContent = "Text Error: " + e.message; }

            // Image Second (Silent fail)
            try {
                const imgData = await fetchAI({ instances: [{ prompt: `Fantasy concept art, top down map of ${type}, ${vibe}` }], parameters: {sampleCount: 1} }, IMAGE_API_URL);
                if(imgData.predictions) {
                    imgOut.src = `data:image/png;base64,${imgData.predictions[0].bytesBase64Encoded}`;
                    imgOut.classList.remove('hidden');
                }
            } catch (e) { console.log("Image gen failed (likely model availability):", e); }
            
            spin.classList.add('hidden');
        };
        
        window.generateCombatNpc = async function() {
            const lvl = document.getElementById('npc-level').value;
            const type = document.getElementById('npc-type').value;
            const spin = document.getElementById('combat-loading-spinner');
            const output = document.getElementById('ai-output');
            
            spin.classList.remove('hidden');
            output.textContent = "Generating...";
            
            const schema = { type: "OBJECT", properties: { name: {type:"STRING"}, level_or_cr:{type:"STRING"}, armor_class_ac:{type:"INTEGER"}, max_hit_points:{type:"INTEGER"}, initiative_bonus:{type:"INTEGER"}, main_attack:{type:"STRING"} }, required: ["name","level_or_cr","armor_class_ac","max_hit_points","initiative_bonus","main_attack"] };
            
            try {
                const data = await fetchAI({ 
                    contents: [{ parts: [{ text: `Generate D&D 5e NPC combat stats: Level ${lvl} ${type}` }] }],
                    generationConfig: { responseMimeType: "application/json", responseSchema: schema }
                });
                const stats = JSON.parse(data.candidates[0].content.parts[0].text);
                window.lastGeneratedNpc = stats;
                
                // Render
                let html = `<div class="font-bold text-xl text-green-400">${stats.name}</div>`;
                html += `<div>CR/Lvl: ${stats.level_or_cr} | AC: ${stats.armor_class_ac} | HP: ${stats.max_hit_points}</div>`;
                html += `<div>Init: ${stats.initiative_bonus} | Atk: ${stats.main_attack}</div>`;
                html += `<button onclick="addNpcToStatblocks()" class="mt-2 bg-indigo-600 text-white p-2 rounded w-full">Save to Statblocks</button>`;
                output.innerHTML = html;
                
            } catch(e) { output.textContent = "Error: " + e.message; }
            spin.classList.add('hidden');
        };

        // --- 2. FIREBASE LOGIC (Initialized safely) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, deleteDoc, collection, query, onSnapshot, updateDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Config
        const FB_CONFIG = {
            apiKey: "AIzaSyB6lyGYJzk70t1OJvzBn5uyJN_k2_5NKYg",
            authDomain: "aegisdmtoolkit.firebaseapp.com",
            projectId: "aegisdmtoolkit",
            storageBucket: "aegisdmtoolkit.firebasestorage.app",
            messagingSenderId: "654767294266",
            appId: "1:654767294266:web:fbee20be7d458fb7d6f203",
            measurementId: "G-S0Y2NKNG7R"
        };

        // App State
        window.currentCampaignId = localStorage.getItem('aegis_cid') || 'default_session';
        window.db = null;
        window.auth = null;
        window.isAuthReady = false;

        async function initFirebase() {
            try {
                const app = initializeApp(FB_CONFIG);
                window.db = getFirestore(app);
                window.auth = getAuth(app);
                
                onAuthStateChanged(window.auth, async (user) => {
                    if (!user) {
                        await signInAnonymously(window.auth);
                    } else {
                        window.isAuthReady = true;
                        document.getElementById('db-status-indicator').classList.replace('bg-gray-500', 'bg-green-500');
                        // Start Listeners
                        setupListeners();
                    }
                });
            } catch (e) {
                console.error("Firebase Init Failed:", e);
                document.getElementById('db-status-indicator').classList.replace('bg-gray-500', 'bg-red-500');
            }
        }

        // --- Database Functions ---
        
        function getRef(pathType) {
             const id = window.currentCampaignId;
             const db = window.db;
             if (!db) return null;
             // Using simplified paths for stability
             if (pathType === 'notes') return doc(db, 'campaigns', id, 'data', 'notes');
             if (pathType === 'combatants') return collection(db, 'campaigns', id, 'combatants');
             if (pathType === 'state') return doc(db, 'campaigns', id, 'data', 'state');
             if (pathType === 'statblocks') return collection(db, 'campaigns', id, 'statblocks');
        }

        function setupListeners() {
             if(!window.db) return;
             
             // Notes Listener
             onSnapshot(getRef('notes'), (snap) => {
                 if(snap.exists()) {
                     const d = snap.data();
                     window.structuredNotes = {
                         prepNotes: d.prepNotes || [],
                         enemyNotes: d.enemyNotes || [],
                         npcNotes: d.npcNotes || []
                     };
                     if(window.currentTab === 'notes') window.renderStructuredNotes(window.currentSubTab);
                 }
             });

             // Combatant Listener
             onSnapshot(query(getRef('combatants')), (snap) => {
                 window.combatants = [];
                 snap.forEach(d => window.combatants.push({id: d.id, ...d.data()}));
                 window.combatants.sort((a,b) => (b.init||0) - (a.init||0));
                 window.renderCombatants();
             });
             
             // Statblocks Listener
             onSnapshot(query(getRef('statblocks')), (snap) => {
                 window.savedStatblocks = [];
                 snap.forEach(d => window.savedStatblocks.push({id: d.id, ...d.data()}));
                 window.renderStatblocks();
             });
        }

        // --- Window Functions for DB Actions ---
        
        // Notes
        window.addNewNote = async function(tab) {
             if(!window.db) return alert("DB not connected");
             const n = { id: crypto.randomUUID(), title: 'New Note', content: '...', timestamp: new Date().toISOString() };
             window.structuredNotes[tab].unshift(n);
             await setDoc(getRef('notes'), { [tab]: window.structuredNotes[tab] }, { merge: true });
        };
        
        window.saveGeneratedContent = async function(tab) {
             const c = document.getElementById('ai-output').textContent;
             const n = { id: crypto.randomUUID(), title: c.substring(0,30)+'...', content: c, timestamp: new Date().toISOString() };
             window.structuredNotes[tab].unshift(n);
             await setDoc(getRef('notes'), { [tab]: window.structuredNotes[tab] }, { merge: true });
             window.switchTab('notes'); window.switchSubTab(tab);
        };
        
        // Statblocks
        window.addNpcToStatblocks = async function() {
             if(!window.lastGeneratedNpc || !window.db) return;
             const s = window.lastGeneratedNpc;
             await setDoc(doc(getRef('statblocks')), {
                 name: s.name, hp: s.max_hit_points, ac: s.armor_class_ac, 
                 initMod: s.initiative_bonus, toHit: 0, dmg: s.main_attack
             });
             alert("Saved!");
        };
        
        window.saveStatblock = async function() {
             if(!window.db) return;
             const name = document.getElementById('stat-name').value;
             // ... collect other fields ...
             await setDoc(doc(getRef('statblocks')), {
                 name: name,
                 hp: parseInt(document.getElementById('stat-hp').value)||0,
                 ac: parseInt(document.getElementById('stat-ac').value)||0,
                 // ... add others
             });
             document.getElementById('stat-name').value = '';
        };

        // Combat
        window.addCombatant = async function() {
             if(!window.db) return;
             const name = document.getElementById('combatant-name').value;
             if(!name) return;
             await setDoc(doc(getRef('combatants')), {
                 name: name,
                 init: parseInt(document.getElementById('combatant-init').value)||0,
                 ac: parseInt(document.getElementById('combatant-ac').value)||10,
                 hp: parseInt(document.getElementById('combatant-hp').value)||10,
                 maxHp: parseInt(document.getElementById('combatant-hp').value)||10,
                 currentHp: parseInt(document.getElementById('combatant-hp').value)||10
             });
             document.getElementById('combatant-name').value = '';
        };

        window.clearCombat = async function() {
             if(!window.db) return;
             const batch = writeBatch(window.db);
             window.combatants.forEach(c => batch.delete(doc(getRef('combatants'), c.id)));
             await batch.commit();
        };
        
        window.removeComb = async function(idx) {
             const c = window.combatants[idx];
             if(c) await deleteDoc(doc(getRef('combatants'), c.id));
        }

        window.applyHp = async function(idx, type) {
             const c = window.combatants[idx];
             const input = document.getElementById(`dmg-${idx}`);
             const val = parseInt(input.value) || 0;
             if(c && val > 0) {
                 let newHp = c.currentHp;
                 if(type === 'dmg') newHp -= val; else newHp += val;
                 await updateDoc(doc(getRef('combatants'), c.id), { currentHp: newHp });
                 input.value = '';
             }
        }
        
        window.assignInitiativeRoll = async function() {
            const idx = document.getElementById('combatant-selector').value;
            if(idx === 'Target') return;
            const c = window.combatants[idx];
            if(c) {
                await updateDoc(doc(getRef('combatants'), c.id), { init: window.lastRoll });
            }
        }

        // Rendering Functions
        window.renderStructuredNotes = function(tab) {
             const list = document.getElementById(tab+'-list');
             if(!list) return;
             list.innerHTML = '';
             (window.structuredNotes[tab] || []).forEach(n => {
                 list.innerHTML += `<div class="card p-2 mb-2"><div class="font-bold text-indigo-300">${n.title}</div><div class="text-sm text-gray-300 whitespace-pre-wrap">${n.content}</div></div>`;
             });
        };
        
        window.renderStatblocks = function() {
             const list = document.getElementById('statblocks-list');
             if(!list) return;
             list.innerHTML = '';
             window.savedStatblocks.forEach(s => {
                 list.innerHTML += `<div class="card p-2 mb-2 flex justify-between items-center"><span>${s.name}</span> <button class="bg-purple-600 text-xs p-1 rounded" onclick="importCombat('${s.name}')">Use</button></div>`;
             });
        };
        
        window.importCombat = function(n) {
            document.getElementById('combatant-name').value = n;
            window.switchTab('combat');
        };
        
        window.renderCombatants = function() {
             const list = document.getElementById('initiative-list');
             if(!list) return;
             list.innerHTML = '';
             window.combatants.forEach((c, i) => {
                 list.innerHTML += `
                    <div class="flex items-center bg-gray-700 p-2 rounded mb-1 gap-2">
                        <div class="font-bold w-8 text-center">${c.init}</div>
                        <div class="flex-1 truncate">${c.name} <span class="text-xs text-gray-400">(${c.currentHp}/${c.maxHp})</span></div>
                        <input type="number" id="dmg-${i}" class="w-12 text-black text-center h-6 text-xs" placeholder="#">
                        <button onclick="applyHp(${i}, 'dmg')" class="bg-red-500 text-xs px-2 rounded">D</button>
                        <button onclick="applyHp(${i}, 'heal')" class="bg-green-500 text-xs px-2 rounded">H</button>
                        <button onclick="removeComb(${i})" class="bg-gray-500 text-xs px-2 rounded">X</button>
                    </div>`;
             });
             window.popSel();
        };


        // Start
        initFirebase();
        window.switchTab('improv');

    </script>
</body>
</html>
