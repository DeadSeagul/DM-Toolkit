
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aegis DM Toolkit</title>
    <!-- Dynamic Home Screen Icon Generator -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // 1. Define your Logo SVG (Shield + Sword + D20)
            const svgString = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" width="180" height="180">
                <rect width="64" height="64" fill="#1e293b"/>
                <path d="M32 4 L12 14 V30 C12 43 21 54 32 58 C43 54 52 43 52 30 V14 Z" fill="#1f2933" stroke="#f4d28b" stroke-width="2.5" stroke-linejoin="round" />
                <g>
                    <path d="M31 10 L33 10 L33 48 L32 52 L31 48 Z" fill="#cbd5e1" stroke="#94a3b8" stroke-width="1"/>
                    <path d="M24 15 L40 15 L40 18 L24 18 Z" fill="#f4d28b" stroke="#b45309" stroke-width="1"/>
                    <path d="M31 2 L33 2 L33 10 L31 10 Z" fill="#8b4513" stroke="#f4d28b" stroke-width="1"/>
                    <circle cx="32" cy="2" r="2.5" fill="#f4d28b" stroke="#b45309" stroke-width="1"/>
                </g>
                <polygon points="32,18 24,24 24,34 32,40 40,34 40,24" fill="#8b4513" stroke="#f4d28b" stroke-width="1.5" stroke-linejoin="round" />
                <text x="32" y="30" text-anchor="middle" font-size="8" fill="#f9f9f9" font-family="system-ui, sans-serif">20</text>
            </svg>`;

            // 2. Create a canvas to convert SVG -> PNG
            const canvas = document.createElement('canvas');
            canvas.width = 180;
            canvas.height = 180;
            const ctx = canvas.getContext('2d');
            const img = new Image();

            // 3. Load SVG and Draw
            img.src = 'data:image/svg+xml;base64,' + btoa(svgString);
            img.onload = function() {
                ctx.drawImage(img, 0, 0);
                
                // 4. Create the Apple Touch Icon link
                const link = document.createElement('link');
                link.rel = 'apple-touch-icon';
                link.href = canvas.toDataURL('image/png'); // Convert to PNG data string
                document.head.appendChild(link);
                
                // Also set standard favicon
                const fav = document.createElement('link');
                fav.rel = 'icon';
                fav.href = canvas.toDataURL('image/png');
                document.head.appendChild(fav);
            };
        });
    </script>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Aegis DM">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, deleteDoc, getDoc, collection, query, onSnapshot, setLogLevel, addDoc, updateDoc, orderBy, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        window.doc = doc; window.setDoc = setDoc; window.deleteDoc = deleteDoc; window.collection = collection;
        window.query = query; window.onSnapshot = onSnapshot; window.addDoc = addDoc; window.getDoc = getDoc; 
        window.updateDoc = updateDoc; window.orderBy = orderBy; window.writeBatch = writeBatch; 

        // Expose Auth functions
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
        window.signOut = signOut;

        // UI Helpers for the new Modal
        window.openLoginModal = () => {
             const modal = document.getElementById('login-modal');
             if(modal) {
                 modal.classList.remove('hidden');
                 const input = document.getElementById('session-name-input');
                 if(input) input.focus();
             }
        };
        window.closeLoginModal = () => {
             const modal = document.getElementById('login-modal');
             if(modal) modal.classList.add('hidden');
        };

        // The new Session Login Logic
        window.handleSessionLogin = async () => {
            const nameInput = document.getElementById('session-name-input');
            const passInput = document.getElementById('session-pass-input');
            const status = document.getElementById('login-status');
            
            const name = nameInput ? nameInput.value.trim() : "";
            const pass = passInput ? passInput.value.trim() : "";

            if (!name || !pass) {
                if(status) { status.textContent = "Please enter both Name and Password."; status.className = "text-red-400 text-xs mt-2"; }
                return;
            }

            if (pass.length < 6) {
                if(status) { status.textContent = "Password must be at least 6 characters."; status.className = "text-red-400 text-xs mt-2"; }
                return;
            }

            if(status) { status.textContent = "Connecting..."; status.className = "text-yellow-400 text-xs mt-2"; }

            // Convert Session Name to fake email
            const email = `${name.replace(/\s+/g, '_')}@aegis.local`;

            if (!window.auth) return;

            try {
                // Try to login first
                await signInWithEmailAndPassword(window.auth, email, pass);
                closeLoginModal();
            } catch (error) {
                // If user not found, create it (Auto-Register)
                if (error.code === 'auth/invalid-credential' || error.code === 'auth/user-not-found') {
                    try {
                        await createUserWithEmailAndPassword(window.auth, email, pass);
                        closeLoginModal();
                    } catch (createError) {
                        console.error("Registration failed:", createError);
                        if(status) {
                            if (createError.code === 'auth/operation-not-allowed') {
                                alert("SETUP REQUIRED: You must enable 'Email/Password' in your Firebase Console.");
                                status.textContent = "Auth method disabled.";
                            } else {
                                status.textContent = "Error: " + createError.message;
                            }
                            status.className = "text-red-400 text-xs mt-2";
                        }
                    }
                } else {
                    console.error("Login failed:", error);
                    if(status) {
                        status.textContent = "Error: " + error.message;
                        status.className = "text-red-400 text-xs mt-2";
                    }
                }
            }
        };

        window.logoutUser = async () => {
            if (!window.auth) return;
            try {
                await signOut(window.auth);
                window.location.reload(); // Refreshes page to clear all data
            } catch (error) {
                console.error("Logout failed:", error);
            }
        };

        window.db = null; window.auth = null; window.userId = null; window.isAuthReady = false;

        const manualFirebaseConfig = {
            apiKey: "AIzaSyB6lyGYJzk70t1OJvzBn5uyJN_k2_5NKYg",
            authDomain: "aegisdmtoolkit.firebaseapp.com",
            projectId: "aegisdmtoolkit",
            storageBucket: "aegisdmtoolkit.firebasestorage.app",
            messagingSenderId: "654767294266",
            appId: "1:654767294266:web:fbee20be7d458fb7d6f203"
        };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const envFirebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const isManualConfig = (manualFirebaseConfig.apiKey && manualFirebaseConfig.apiKey !== "PASTE_YOUR_API_KEY_HERE");
        const firebaseConfig = isManualConfig ? manualFirebaseConfig : envFirebaseConfig;

        if (firebaseConfig && Object.keys(firebaseConfig).length > 0) {
            const app = initializeApp(firebaseConfig);
            window.db = getFirestore(app);
            window.auth = getAuth(app);
            
            onAuthStateChanged(window.auth, async (user) => {
                if (!user) {
                    try {
                        if (initialAuthToken && !isManualConfig) {
                            await signInWithCustomToken(window.auth, initialAuthToken);
                        } else {
                            await signInAnonymously(window.auth);
                        }
                    } catch (error) {
                        console.warn("Auth error, using anonymous:", error);
                        try { await signInAnonymously(window.auth); } catch(e) {}
                    }
                } else {
                    try { await user.getIdToken(true); } catch (e) {}
                    window.userId = user.uid;
                    window.isAuthReady = true;
                    updateLoginUI(user);
                    if (window.setupNotesListener) window.setupNotesListener();
                    if (window.setupCombatDataListeners) window.setupCombatDataListeners();
                    if (window.setupStatblocksListener) window.setupStatblocksListener();
                }
            });
        } else { console.error("Firebase config missing."); }

        function updateLoginUI(user) {
            const loginBtn = document.getElementById('login-btn');
            const userProfile = document.getElementById('user-profile');
            const userAvatar = document.getElementById('user-avatar');
            const userName = document.getElementById('user-name');
            
            // Check if user exists and is NOT anonymous (Session Users are not anonymous in Firebase terms)
            if (user && !user.isAnonymous) {
                if(loginBtn) loginBtn.classList.add('hidden');
                if(userProfile) userProfile.classList.remove('hidden');
                
                // Generate Avatar from Session Name
                const name = user.email.split('@')[0].replace(/_/g, ' ');
                if(userAvatar) userAvatar.src = `https://ui-avatars.com/api/?name=${name}&background=6366f1&color=fff&size=128`;
                if(userName) userName.textContent = name;
            } else {
                if(loginBtn) loginBtn.classList.remove('hidden');
                if(userProfile) userProfile.classList.add('hidden');
            }
        }
    </script>
    
    <!-- 1. FIREBASE MODULE (Infrastructure) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, deleteDoc, getDoc, collection, query, onSnapshot, orderBy, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const config = { apiKey: "AIzaSyB6lyGYJzk70t1OJvzBn5uyJN_k2_5NKYg", authDomain: "aegisdmtoolkit.firebaseapp.com", projectId: "aegisdmtoolkit", storageBucket: "aegisdmtoolkit.firebasestorage.app", messagingSenderId: "654767294266", appId: "1:654767294266:web:fbee20be7d458fb7d6f203" };
        const app = initializeApp(config);
        
        // Expose to Global Scope
        window.db = getFirestore(app);
        window.auth = getAuth(app);
        window.appId = 'default-app-id';
        window.doc = doc; window.setDoc = setDoc; window.deleteDoc = deleteDoc; window.collection = collection;
        window.query = query; window.onSnapshot = onSnapshot; window.addDoc = (c, d) => setDoc(doc(c), d); 
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
        window.signOut = signOut;
        
        // Master Auth Listener
        onAuthStateChanged(window.auth, (user) => {
            if (window.handleAuthStateChange) window.handleAuthStateChange(user);
        });
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Libre+Baskerville:wght@400;700&display=swap');

        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f8fafc; transition: background-color 0.5s, color 0.5s; }
        .tab-button.active { border-bottom: 3px solid #6366f1; color: #c7d2fe; }
        .sub-tab-button.active { border-bottom: 2px solid #34d399; color: #34d399; }
        .card { background-color: #1e293b; border: 1px solid #334155; transition: background-color 0.5s, border-color 0.5s; }
        .input-style { background-color: #334155; border: 1px solid #475569; color: #f8fafc; }
        .glow-shadow { box-shadow: 0 0 10px rgba(99, 102, 241, 0.5); }
        
        /* --- CHRISTMAS THEME OVERRIDES --- */
        body.christmas-mode {
            background-color: #0b291b !important; /* Deep Forest Green */
            color: #fef3c7; /* Warm Eggshell */
        }
        body.christmas-mode .card {
            background-color: #2f0a0a; /* Dark Burgundy */
            border-color: #b45309; /* Gold Border */
            box-shadow: 0 4px 6px -1px rgba(220, 38, 38, 0.2);
            position: relative;
            overflow: visible; /* Allow candy canes to stick out */
            margin-top: 25px; /* Space for the topper */
            border-top: none; /* Snow covers the top */
        }
        
        /* The Snow Cap */
        body.christmas-mode .card::before {
            content: "";
            position: absolute;
            top: -12px;
            left: -1px;
            right: -1px;
            height: 15px;
            background-color: #f1f5f9; /* Snow White */
            border-radius: 10px 10px 4px 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 10;
            border-bottom: 2px solid #e2e8f0; /* Slight texture */
        }

        /* The Candy Canes (Peppermint Sticks) */
        body.christmas-mode .card::after {
            content: "";
            position: absolute;
            top: -25px;
            right: 20px;
            width: 10px;
            height: 25px;
            /* Peppermint Stripe Pattern */
            background: repeating-linear-gradient(
                45deg,
                #dc2626,
                #dc2626 4px,
                #ffffff 4px,
                #ffffff 8px
            );
            border-radius: 4px 4px 0 0;
            transform: rotate(15deg);
            box-shadow: -2px 2px 2px rgba(0,0,0,0.3);
            z-index: 0; /* Behind the snow cap */
            
            /* Add a second stick using box-shadow cloning for efficiency */
            box-shadow: 
                -15px 5px 0 -1px rgba(0,0,0,0.2), /* Shadow for second stick */
                -20px 2px 0 0 #ffffff; /* This creates a pseudo-second stick (white base) */
        }
        /* Note: Complex striped cloning with box-shadow is hard, so ::after is just one main stick. 
           To keep it simple and robust without adding DOM elements, we stick to one nice accent per card. */

        body.christmas-mode .input-style {
            background-color: #451a1a;
            border-color: #7f1d1d;
            color: #fef3c7;
        }
        body.christmas-mode .tab-button.active {
            border-bottom-color: #ef4444; /* Candy Red */
            color: #fca5a5;
        }
        body.christmas-mode .tab-button:not(.active) {
            color: #b45309; /* Gold for inactive */
        }
        body.christmas-mode h1, body.christmas-mode h2, body.christmas-mode h3 {
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        body.christmas-mode h1 span { /* The Shield Icon/Logo area */
            filter: hue-rotate(140deg) brightness(1.2); /* Shift to green/red */
        }
        
        /* Snow Canvas */
        #snow-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1; /* Behind everything */
        }

        .scrollable-content { max-height: 60vh; overflow-y: auto; }
        .scrollable-content::-webkit-scrollbar { width: 8px; }
        .scrollable-content::-webkit-scrollbar-track { background: #1e293b; }
        .scrollable-content::-webkit-scrollbar-thumb { background-color: #475569; border-radius: 20px; border: 2px solid #1e293b; }
        .loading-spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-top: 4px solid #fff; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .collapsible-header { cursor: pointer; display: flex; justify-content: space-between; align-items: center; padding: 10px; background-color: #334155; border-radius: 8px; }
        .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; padding: 0 10px; }
        .collapsible-content.expanded { max-height: 8000px; padding: 10px; }
        .arrow-icon { transition: transform 0.3s ease; }
        .expanded .arrow-icon { transform: rotate(90deg); }
        .sound-btn { transition: all 0.1s ease; }
        .sound-btn:active { transform: scale(0.95); }
        .sound-btn.active-loop { border-color: #34d399; background-color: #059669; box-shadow: 0 0 15px #34d399; animation: pulse-green 2s infinite; }
        @keyframes pulse-green { 0% { box-shadow: 0 0 0 0 rgba(52, 211, 153, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(52, 211, 153, 0); } 100% { box-shadow: 0 0 0 0 rgba(52, 211, 153, 0); } }
        /* Range Slider Style */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #34d399; cursor: pointer; margin-top: -6px; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #475569; border-radius: 2px; }
        
        /* D&D Statblock Styles */
        .dnd-statblock {
            background-color: #fdf1dc;
            color: #58180d;
            font-family: 'Libre Baskerville', serif;
            padding: 15px;
            border: 1px solid #d4b57e;
            box-shadow: 0 0 15px rgba(0,0,0,0.3);
            position: relative;
        }
        .dnd-statblock::before, .dnd-statblock::after {
            content: "";
            display: block;
            height: 4px;
            background: #e69a28;
            margin: 4px 0;
            border-radius: 2px;
        }
        .dnd-header {
            font-family: 'Libre Baskerville', serif;
            font-variant: small-caps;
            font-weight: 700;
            color: #58180d;
            font-size: 1.5em;
            line-height: 1.1;
        }
        .tapered-rule {
            display: block;
            height: 2px;
            background: #58180d;
            margin: 10px 0;
            border: none;
            background: linear-gradient(to right, transparent, #58180d, transparent);
        }
        .dnd-property-line {
            font-size: 0.9rem;
            line-height: 1.4;
            margin-bottom: 2px;
        }
        .dnd-property-line strong {
            color: #58180d;
        }
        .dnd-section-title {
            font-variant: small-caps;
            font-weight: bold;
            font-size: 1.2em;
            color: #58180d;
            border-bottom: 1px solid #7a200d;
            margin-top: 10px;
            margin-bottom: 5px;
        }
        .dnd-action-name {
            font-weight: bold;
            font-style: italic;
        }
        
        /* Aegis Logo Styles */
        .aegis-logo {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            color: #e2e8f0; /* Added for visibility on dark header */
        }

        .aegis-icon {
            width: 48px;   /* Increased slightly for better visibility in header */
            height: 48px;
        }

        .aegis-text {
            display: flex;
            flex-direction: column;
            line-height: 1.1;
        }

        .aegis-title {
            font-size: 1.2rem; /* Bumped up slightly */
            font-weight: 700;
            letter-spacing: 0.06em;
            text-transform: uppercase;
            color: #818cf8; /* Matches the indigo-400 theme */
        }

        .aegis-subtitle {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.16em;
            opacity: 0.8;
            color: #cbd5e1;
        }
    </style>
</head>
<body class="p-4 sm:p-8">
    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <div class="flex justify-between items-center mb-6 bg-gray-800 p-3 rounded-lg border border-gray-700 shadow-lg">
            <div class="flex items-center">
                <!-- Aegis DM Toolkit Logo -->
                <div class="aegis-logo">
                  <svg class="aegis-icon" viewBox="0 0 64 64" aria-hidden="true">
                    <!-- Shield -->
                    <path
                      d="M32 4 L12 14 V30 C12 43 21 54 32 58 C43 54 52 43 52 30 V14 Z"
                      fill="#1f2933"
                      stroke="#f4d28b"
                      stroke-width="2.5"
                      stroke-linejoin="round"
                    />
                    
                    <!-- Sword (Vertical, Behind d20) -->
                    <g>
                      <!-- Blade -->
                      <path d="M31 10 L33 10 L33 48 L32 52 L31 48 Z" fill="#cbd5e1" stroke="#94a3b8" stroke-width="1"/>
                      <!-- Crossguard -->
                      <path d="M24 15 L40 15 L40 18 L24 18 Z" fill="#f4d28b" stroke="#b45309" stroke-width="1"/>
                      <!-- Hilt -->
                      <path d="M31 2 L33 2 L33 10 L31 10 Z" fill="#8b4513" stroke="#f4d28b" stroke-width="1"/>
                      <!-- Pommel -->
                      <circle cx="32" cy="2" r="2.5" fill="#f4d28b" stroke="#b45309" stroke-width="1"/>
                    </g>

                    <!-- Simple d20 -->
                    <polygon
                      points="32,18 24,24 24,34 32,40 40,34 40,24"
                      fill="#8b4513"
                      stroke="#f4d28b"
                      stroke-width="1.5"
                      stroke-linejoin="round"
                    />
                    
                    <text
                      x="32"
                      y="30"
                      text-anchor="middle"
                      font-size="8"
                      fill="#f9f9f9"
                      font-family="system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif"
                    >
                      20
                    </text>
                  </svg>

                  <div class="aegis-text">
                    <span class="aegis-title">Aegis</span>
                    <span class="aegis-subtitle">DM Toolkit</span>
                  </div>
                </div>
            </div>

            <div class="flex items-center gap-3">
                <!-- Holiday Toggle -->
                <button onclick="toggleTheme()" class="text-xl p-2 hover:bg-gray-700 rounded transition" title="Toggle Holiday Mode">üéÑ</button>
                
                <a href="https://ko-fi.com/aegisdmtool" target="_blank" class="bg-yellow-600/20 hover:bg-yellow-600/40 text-yellow-200 border border-yellow-600/50 text-xs font-bold py-2 px-3 rounded-lg transition duration-200 flex items-center gap-2 no-underline">
                    <span>‚òï</span> <span class="hidden sm:inline">Tip</span>
                </a>
                <div>
                <button id="login-btn" onclick="window.openLoginModal()" class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg text-sm flex items-center gap-2 transition duration-200 border border-indigo-400 shadow-lg shadow-indigo-900/20">
    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
    Session Login
</button>
                    <div id="user-profile" class="hidden flex items-center gap-3">
                        <div class="text-right hidden sm:block"><div id="user-name" class="text-sm font-semibold text-white">Adventurer</div><div class="text-xs text-green-400">Online & Saving</div></div>
                        <img id="user-avatar" src="" alt="User" class="w-9 h-9 rounded-full border-2 border-indigo-500">
                        <button onclick="logoutUser()" class="bg-red-900/50 hover:bg-red-800 text-red-200 p-2 rounded-lg text-xs border border-red-800 transition duration-200">Sign Out</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Nav -->
        <div class="flex border-b border-gray-600 mb-6 overflow-x-auto">
            <button class="tab-button p-3 flex-1 text-sm font-semibold transition duration-300 active min-w-[100px]" onclick="switchTab('improv')">üîÆ Prep</button>
            <button class="tab-button p-3 flex-1 text-sm font-semibold text-gray-400 transition duration-300 min-w-[100px]" onclick="switchTab('combat')">‚öîÔ∏è Combat</button>
            <button class="tab-button p-3 flex-1 text-sm font-semibold text-gray-400 transition duration-300 min-w-[100px]" onclick="switchTab('statblocks')">üëπ Stats</button>
            <button class="tab-button p-3 flex-1 text-sm font-semibold text-gray-400 transition duration-300 min-w-[100px]" onclick="switchTab('monsters')">üê≤ Monsters</button>
            <button class="tab-button p-3 flex-1 text-sm font-semibold text-gray-400 transition duration-300 min-w-[100px]" onclick="switchTab('loot')">üí∞ Loot</button>
            <button class="tab-button p-3 flex-1 text-sm font-semibold text-gray-400 transition duration-300 min-w-[100px]" onclick="switchTab('soundboard')">üîä Sound</button>
            <button class="tab-button p-3 flex-1 text-sm font-semibold text-gray-400 transition duration-300 min-w-[100px]" onclick="switchTab('notes')">üìú Notes</button>
        </div>

        <!-- Content -->
        <div id="content-area">
            <!-- Prep Tab -->
            <div id="improv" class="tab-content">
                <!-- AI Configuration Card -->
                <div class="card p-4 rounded-lg shadow-xl mb-6 border border-indigo-500/30">
                    <h2 class="text-xl font-semibold mb-2 text-indigo-300">üîë AI Configuration</h2>
                    
                    <!-- Warning Message -->
                    <p class="text-xs text-yellow-400 mb-2 font-bold">‚ö†Ô∏è You need to provide an API Key before using AI features.</p>
                    
                    <p class="text-xs text-gray-400 mb-3">Enter your Google Gemini API Key. Saved locally. <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-indigo-400 hover:underline">Get Key Here</a>.</p>
                    <div class="flex gap-2">
                        <input type="password" id="user-api-key" placeholder="Paste API Key (AIza...)" class="flex-1 p-2 rounded-lg input-style text-sm">
                        <button onclick="window.saveApiKey()" class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg text-sm transition duration-200">Save</button>
                    </div>
                    <p id="api-key-status" class="mt-2 text-xs text-gray-500">Status: No key saved.</p>
                </div>

                <!-- Combat NPC Stats -->
                <div class="card p-4 rounded-lg shadow-xl mb-6">
                    <h2 class="text-xl font-semibold mb-4 text-green-300">Combat NPC Stats</h2>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div><label class="block text-xs font-medium text-gray-400 mb-1">Level/CR</label><input type="text" id="npc-level" value="3" class="w-full p-2 rounded-lg input-style text-sm"></div>
                        <div><label class="block text-xs font-medium text-gray-400 mb-1">NPC Type</label><input type="text" id="npc-type" value="Shadow Rogue" class="w-full p-2 rounded-lg input-style text-sm"></div>
                    </div>
                    <button onclick="window.generateCombatNpc()" id="generate-combat-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded-lg flex items-center justify-center"><span id="generate-combat-text">Generate Stats</span><div id="combat-loading-spinner" class="loading-spinner ml-2 hidden"></div></button>
                    <p id="combat-status-message" class="mt-2 text-sm text-center text-red-400 hidden"></p>
                </div>

                <!-- Creative Lore -->
                <div class="card p-4 rounded-lg shadow-xl mb-6">
                    <h2 class="text-xl font-semibold mb-4 text-indigo-300">Creative Lore</h2>
                    <textarea id="improv-prompt" rows="3" class="w-full p-3 rounded-lg input-style resize-none" placeholder="Enter a prompt..."></textarea>
                    <button onclick="window.generateCreativeIdea()" id="generate-button" class="mt-4 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 rounded-lg flex items-center justify-center"><span id="generate-text">Generate Idea</span><div id="creative-loading-spinner" class="loading-spinner ml-2 hidden"></div></button>
                </div>

                <!-- Settlement Generator -->
                <div class="card p-4 rounded-lg shadow-xl mb-6">
                    <h2 class="text-xl font-semibold mb-4 text-teal-300">Settlement Generator</h2>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div><label class="block text-xs font-medium text-gray-400 mb-1">Type</label><select id="settlement-type" class="w-full p-2 rounded-lg input-style text-sm"><option value="Village">Village</option><option value="Town">Town</option><option value="City">City</option></select></div>
                        <div><label class="block text-xs font-medium text-gray-400 mb-1">Vibe</label><input type="text" id="settlement-vibe" value="haunted fishing village" class="w-full p-2 rounded-lg input-style text-sm"></div>
                    </div>
                    <button onclick="window.generateSettlement()" id="generate-settlement-button" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 rounded-lg flex items-center justify-center"><span id="generate-settlement-text">Generate</span><div id="settlement-loading-spinner" class="loading-spinner ml-2 hidden"></div></button>
                </div>
                
                <!-- Result Display Card -->
                <div class="card p-4 rounded-lg shadow-xl">
                    <h2 class="text-xl font-semibold mb-4 text-indigo-300">Result</h2>
                    <div id="ai-image-output" class="mb-4 hidden rounded-lg overflow-hidden shadow-lg"><img id="generated-image" class="w-full h-auto object-cover bg-gray-700/30 min-h-[150px]"><p id="image-loading-status" class="text-center text-gray-400 p-3 bg-gray-800"></p></div>
                    <div id="ai-output" class="whitespace-pre-wrap min-h-[100px] bg-gray-700/30 p-3 rounded-lg text-gray-300">Results appear here.</div>
                    <p id="npc-save-status" class="mt-2 text-sm text-center hidden"></p>
                    <div id="save-options-creative" class="mt-4 hidden">
                        <p class="text-sm text-center text-gray-400 mb-2">Save to:</p>
                        <div class="grid grid-cols-3 gap-2"><button onclick="window.saveGeneratedContent('prepNotes')" class="save-notes-btn bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 rounded-lg text-xs">Notes</button><button onclick="window.saveGeneratedContent('enemyNotes')" class="save-notes-btn bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 rounded-lg text-xs">Enemies</button><button onclick="window.saveGeneratedContent('npcNotes')" class="save-notes-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg text-xs">NPCs</button></div>
                    </div>
                </div>
            </div>

            <!-- Combat Tab -->
            <div id="combat" class="tab-content hidden">
                <div class="card p-4 rounded-lg shadow-xl">
                    <h2 class="text-xl font-semibold mb-4 text-indigo-300">Tracker</h2>
                    <div class="flex justify-between items-center mb-2"><span id="db-status" class="text-xs px-2 py-1 rounded bg-gray-700 text-gray-400">Connecting...</span></div>
                    <div class="flex flex-wrap gap-2 mb-4">
                        <input id="combatant-name" type="text" placeholder="Name" class="flex-1 min-w-[100px] p-2 rounded-lg input-style">
                        <input id="combatant-init" type="number" placeholder="Init" class="w-20 p-2 rounded-lg input-style text-center text-sm">
                        <input id="combatant-ac" type="number" placeholder="AC" class="w-16 p-2 rounded-lg input-style text-center text-sm">
                        <input id="combatant-hp" type="number" placeholder="HP" class="w-16 p-2 rounded-lg input-style text-center text-sm">
                        <button onclick="addCombatant()" id="add-combatant-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold px-3 py-2 rounded-lg text-sm">Add</button>
                    </div>
                    
                    <!-- Dice Roller Card -->
                    <div class="card p-4 rounded-lg shadow-inner mb-4 bg-gray-800/50">
                        <h3 class="text-md font-semibold mb-3 text-indigo-400">Dice Roller</h3>
                        
                        <!-- Dice Color Picker -->
                        <div class="flex items-center justify-between mb-3 bg-gray-900/50 p-2 rounded-lg border border-gray-700">
                            <div class="flex items-center gap-2">
                                <span class="text-xs text-gray-400">Color:</span>
                                <input type="color" id="dice-color-picker" value="#6366f1" class="w-8 h-8 bg-transparent border-none cursor-pointer rounded">
                            </div>
                            <button onclick="window.customDiceColor = null; document.getElementById('dice-color-picker').value='#6366f1'" class="text-[10px] text-indigo-400 hover:text-white underline">Reset Color</button>
                        </div>

                        <!-- Dice Texture Uploader -->
                        <div class="flex items-center justify-between mb-3 bg-gray-900/50 p-2 rounded-lg border border-gray-700">
                            <div class="flex items-center gap-2">
                                <span class="text-xs text-gray-400">Texture:</span>
                                <input type="file" id="dice-texture-input" accept="image/*" onchange="window.uploadDiceTexture(this)" 
                                       class="text-[10px] text-gray-500 file:mr-2 file:py-1 file:px-2 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-indigo-600 file:text-white hover:file:bg-indigo-700">
                            </div>
                            <button onclick="window.resetDiceTexture()" class="text-[10px] text-red-400 hover:text-red-300 underline">Reset Image</button>
                        </div>

                        <!-- D20 Roller -->
                        <div class="flex items-center space-x-2 mb-4 pb-4 border-b border-gray-700">
                            <button onclick="window.rollD20()" class="w-1/3 bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded-lg text-sm">Init D20</button>
                            <div id="last-roll-display" class="w-1/3 text-3xl font-extrabold text-center text-yellow-400 border-2 border-yellow-400 p-1 rounded-lg bg-gray-900/50 select-none">?</div>
                            <div class="w-1/3 flex flex-col gap-1">
                                <select id="combatant-selector" class="w-full p-1 rounded-lg input-style text-xs"><option value="" disabled selected>Target</option></select>
                                <button onclick="window.assignInitiativeRoll()" id="assign-roll-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 rounded-lg text-xs disabled:opacity-50" disabled>Set Init</button>
                            </div>
                        </div>

                        <!-- Quick Dice Buttons -->
                        <div class="grid grid-cols-4 sm:grid-cols-7 gap-2 mb-4">
                            <button onclick="window.rollSimple(4)" class="bg-gray-700 hover:bg-gray-600 text-white text-xs font-bold py-2 rounded border border-gray-600">d4</button>
                            <button onclick="window.rollSimple(6)" class="bg-gray-700 hover:bg-gray-600 text-white text-xs font-bold py-2 rounded border border-gray-600">d6</button>
                            <button onclick="window.rollSimple(8)" class="bg-gray-700 hover:bg-gray-600 text-white text-xs font-bold py-2 rounded border border-gray-600">d8</button>
                            <button onclick="window.rollSimple(10)" class="bg-gray-700 hover:bg-gray-600 text-white text-xs font-bold py-2 rounded border border-gray-600">d10</button>
                            <button onclick="window.rollSimple(12)" class="bg-gray-700 hover:bg-gray-600 text-white text-xs font-bold py-2 rounded border border-gray-600">d12</button>
                            <button onclick="window.rollSimple(20)" class="bg-gray-700 hover:bg-gray-600 text-white text-xs font-bold py-2 rounded border border-gray-600">d20</button>
                            <button onclick="window.rollSimple(100)" class="bg-gray-700 hover:bg-gray-600 text-white text-xs font-bold py-2 rounded border border-gray-600 col-span-2 sm:col-span-1">d100</button>
                        </div>

                    
                        
                        <!-- Custom Roller -->
                        <div class="flex items-center gap-2 bg-gray-900/30 p-2 rounded-lg">
                            <input id="dice-num" type="number" value="1" class="w-10 p-1 text-center text-sm rounded bg-gray-700 text-white border border-gray-600" placeholder="#">
                            <span class="text-gray-400 text-xs">d</span>
                            <input id="dice-type" type="number" value="20" class="w-10 p-1 text-center text-sm rounded bg-gray-700 text-white border border-gray-600" placeholder="Type">
                            <span class="text-gray-400 text-xs">+</span>
                            <input id="dice-mod" type="number" value="0" class="w-10 p-1 text-center text-sm rounded bg-gray-700 text-white border border-gray-600" placeholder="Mod">
                            <button onclick="window.rollCustomDice()" class="flex-1 bg-purple-600 hover:bg-purple-500 text-white font-bold py-1 rounded text-sm">Roll</button>
                        </div>
                        <div class="mt-3 text-center bg-gray-900/50 rounded p-2 min-h-[3rem] flex flex-col justify-center">
                            <div id="dice-roll-result" class="text-xl font-bold text-green-400">Roll to start</div>
                            <div id="dice-roll-details" class="text-xs text-gray-500"></div>
                        </div>
                    </div>

                    <div class="flex justify-between items-center mb-4">
                        <button onclick="window.sortInitiative()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-3 rounded-lg text-sm">Sort</button>
                        <button onclick="window.nextTurn()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-3 rounded-lg text-sm">Next &raquo;</button>
                        <button onclick="window.clearCombat()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-3 rounded-lg text-sm">Clear</button>
                    </div>
                    <div id="initiative-list" class="scrollable-content space-y-2"><p class="text-center text-gray-500 pt-8">List empty.</p></div>
                </div>
            </div> 

            <!-- Statblocks Tab -->
            <div id="statblocks" class="tab-content hidden">
                <div class="card p-4 rounded-lg shadow-xl mb-6">
                    <h2 class="text-xl font-semibold mb-4 text-indigo-300">Save NPC</h2>
                    <div class="grid grid-cols-2 gap-2 mb-4">
                        <input id="stat-name" type="text" placeholder="Name" class="col-span-2 p-2 rounded-lg input-style">
                        <input id="stat-hp" type="number" placeholder="HP" class="p-2 rounded-lg input-style text-center text-sm">
                        <input id="stat-ac" type="number" placeholder="AC" class="p-2 rounded-lg input-style text-center text-sm">
                        <input id="stat-tohit" type="number" placeholder="Hit Mod" class="p-2 rounded-lg input-style text-center text-sm">
                        <input id="stat-init-mod" type="number" placeholder="Init Mod" class="p-2 rounded-lg input-style text-center text-sm">
                        <input id="stat-dmg" type="text" placeholder="Damage" class="col-span-2 p-2 rounded-lg input-style">
                    </div>
                    <button onclick="saveStatblock()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 rounded-lg">Save</button>
                    <p id="statblock-status" class="mt-2 text-sm text-center text-gray-400"></p>
                </div>
                <div class="card p-4 rounded-lg shadow-xl">
                    <h2 class="text-xl font-semibold mb-4 text-indigo-300">Saved</h2>
                    <div id="statblocks-list" class="scrollable-content space-y-2"><p class="text-center text-gray-500 pt-8">No stats saved.</p></div>
                </div>
            </div>

            <!-- Monsters Tab -->
            <div id="monsters" class="tab-content hidden">
                <div class="card p-4 rounded-lg shadow-xl mb-6">
                    <h2 class="text-xl font-semibold mb-4 text-green-300">Monster Generator</h2>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div><label class="block text-xs font-medium text-gray-400 mb-1">Name</label><input type="text" id="monster-name" value="Cave Troll" class="w-full p-2 rounded-lg input-style text-sm"></div>
                        <div><label class="block text-xs font-medium text-gray-400 mb-1">CR</label><input type="text" id="monster-cr" value="4" class="w-full p-2 rounded-lg input-style text-sm"></div>
                    </div>
                    <button onclick="generateMonsterStatblock()" id="generate-monster-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded-lg flex items-center justify-center"><span id="generate-monster-text">Generate</span><div id="monster-loading-spinner" class="loading-spinner ml-2 hidden"></div></button>
                    <p id="monster-status-message" class="mt-2 text-sm text-center text-red-400 hidden"></p>
                </div>
                <div class="card p-4 rounded-lg shadow-xl">
                    <h2 class="text-xl font-semibold mb-4 text-indigo-300">Result</h2>
                    <div id="monster-output" class="min-h-[100px] bg-gray-700/30 p-3 rounded-lg text-gray-300">Stat block will appear here.</div>
                    <p id="monster-save-status" class="mt-2 text-sm text-center hidden"></p>
                    <div id="save-options-monster" class="mt-4 hidden">
                        <div class="grid grid-cols-2 gap-2"><button onclick="addMonsterToStatblocks()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 rounded-lg text-xs">Save to Stats</button><button onclick="saveMonsterToNotes()" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 rounded-lg text-xs">Save to Notes</button></div>
                    </div>
                </div>
            </div>

            <!-- Loot Tab -->
            <div id="loot" class="tab-content hidden">
                <div class="card p-4 rounded-lg shadow-xl mb-6">
                    <h2 class="text-xl font-semibold mb-4 text-yellow-300">Loot Generator</h2>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div class="col-span-2"><label class="block text-xs font-medium text-gray-400 mb-1">Source</label>
                            <select id="loot-source" class="w-full p-2 rounded-lg input-style text-sm">
                                <option value="ai">AI Generator (Creative)</option>
                                <option value="wiki">Official Wiki (Rules)</option>
                            </select>
                        </div>
                        <div><label class="block text-xs font-medium text-gray-400 mb-1">Level/CR</label><input type="text" id="loot-level" value="3" class="w-full p-2 rounded-lg input-style text-sm"></div>
                        <div><label class="block text-xs font-medium text-gray-400 mb-1">Type</label><select id="loot-type" class="w-full p-2 rounded-lg input-style text-sm"><option value="Individual">Individual</option><option value="Hoard">Hoard</option><option value="Shop Inventory">Shop</option></select></div>
                    </div>
                    <button onclick="generateLoot()" id="generate-loot-button" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 rounded-lg flex items-center justify-center"><span id="generate-loot-text">Generate</span><div id="loot-loading-spinner" class="loading-spinner ml-2 hidden"></div></button>
                </div>
                <div class="card p-4 rounded-lg shadow-xl">
                    <h2 class="text-xl font-semibold mb-4 text-indigo-300">Result</h2>
                    <div id="loot-output" class="whitespace-pre-wrap min-h-[100px] bg-gray-700/30 p-3 rounded-lg text-gray-300">Loot appears here.</div>
                    <button onclick="saveGeneratedContent('lootNotes')" class="mt-4 w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 rounded-lg text-sm">Save to Loot Notes</button>
                </div>
                
                <!-- Gold Splitter Card -->
<div class="card p-4 rounded-lg shadow-xl mt-6 border border-yellow-700/30">
    <h2 class="text-xl font-semibold mb-4 text-yellow-400">üí∞ Loot Splitter</h2>
    <!-- Input Headers -->
    <div class="grid grid-cols-5 gap-2 mb-1 text-center text-[10px] font-bold text-gray-500 uppercase tracking-wider">
        <div>PP</div><div>GP</div><div>EP</div><div>SP</div><div>CP</div>
    </div>
    <!-- Inputs -->
    <div class="grid grid-cols-5 gap-2 mb-4">
        <input type="number" id="loot-pp" class="p-2 rounded bg-gray-800 text-white text-center border border-gray-600 focus:border-yellow-500 outline-none" placeholder="0">
        <input type="number" id="loot-gp" class="p-2 rounded bg-gray-800 text-white text-center border border-gray-600 focus:border-yellow-500 outline-none" placeholder="0">
        <input type="number" id="loot-ep" class="p-2 rounded bg-gray-800 text-white text-center border border-gray-600 focus:border-yellow-500 outline-none" placeholder="0">
        <input type="number" id="loot-sp" class="p-2 rounded bg-gray-800 text-white text-center border border-gray-600 focus:border-yellow-500 outline-none" placeholder="0">
        <input type="number" id="loot-cp" class="p-2 rounded bg-gray-800 text-white text-center border border-gray-600 focus:border-yellow-500 outline-none" placeholder="0">
    </div>
    <!-- Controls -->
    <div class="flex gap-3 items-center mb-4 bg-gray-900/30 p-2 rounded">
        <span class="text-sm text-gray-300 font-bold">Party Size:</span>
        <input type="number" id="loot-party-size" value="4" class="w-16 p-2 rounded bg-gray-800 text-white text-center border border-gray-600 font-bold">
        <button onclick="window.splitLoot()" class="flex-1 bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-2 rounded transition shadow-lg shadow-yellow-900/20">Split Loot</button>
    </div>
    <!-- Result Display -->
    <div id="loot-split-result" class="text-sm text-yellow-100 text-center min-h-[1.5em] font-mono bg-gray-800/50 p-2 rounded border border-gray-700">
        Enter amounts to split...
    </div>
</div>
            </div>
        

            <!-- Soundboard Tab -->
            <div id="soundboard" class="tab-content hidden">
                <div class="card p-4 rounded-lg shadow-xl mb-6">
                    <h2 class="text-xl font-semibold mb-4 text-pink-300">Synth Soundboard</h2>
                    
                    <!-- Volume Slider -->
                    <div class="mb-6 flex items-center gap-4 bg-gray-800 p-3 rounded-lg border border-gray-700">
                        <label for="master-volume" class="text-sm font-bold text-indigo-400">Master Volume:</label>
                        <input type="range" id="master-volume" min="0" max="1" step="0.01" value="0.5" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-green-400">
                    </div>

                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-4 mb-6">
                        <button onclick="playTone('success')" class="sound-btn bg-green-600 hover:bg-green-500 text-white font-bold py-4 rounded-lg shadow-lg border-b-4 border-green-800 flex flex-col items-center justify-center"><span class="text-2xl mb-1">‚ú®</span><span class="text-xs">Success</span></button>
                        <button onclick="playTone('critical')" class="sound-btn bg-green-700 hover:bg-green-600 text-white font-bold py-4 rounded-lg shadow-lg border-b-4 border-green-900 flex flex-col items-center justify-center"><span class="text-2xl mb-1">üéâ</span><span class="text-xs">Crit</span></button>
                        <button onclick="playTone('fail')" class="sound-btn bg-red-600 hover:bg-red-500 text-white font-bold py-4 rounded-lg shadow-lg border-b-4 border-red-800 flex flex-col items-center justify-center"><span class="text-2xl mb-1">‚ùå</span><span class="text-xs">Fail</span></button>
                        <button onclick="playTone('combat_start')" class="sound-btn bg-orange-600 hover:bg-orange-500 text-white font-bold py-4 rounded-lg shadow-lg border-b-4 border-orange-800 flex flex-col items-center justify-center"><span class="text-2xl mb-1">‚öîÔ∏è</span><span class="text-xs">Combat</span></button>
                        <button onclick="playTone('spell')" class="sound-btn bg-purple-600 hover:bg-purple-500 text-white font-bold py-4 rounded-lg shadow-lg border-b-4 border-purple-800 flex flex-col items-center justify-center"><span class="text-2xl mb-1">üîÆ</span><span class="text-xs">Spell</span></button>
                        <button onclick="playTone('mystery')" class="sound-btn bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-4 rounded-lg shadow-lg border-b-4 border-indigo-800 flex flex-col items-center justify-center"><span class="text-2xl mb-1">üëª</span><span class="text-xs">Mystery</span></button>
                        <button onclick="playTone('rest')" class="sound-btn bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-lg shadow-lg border-b-4 border-blue-800 flex flex-col items-center justify-center"><span class="text-2xl mb-1">üí§</span><span class="text-xs">Rest</span></button>
                        <button onclick="playTone('trap')" class="sound-btn bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-4 rounded-lg shadow-lg border-b-4 border-yellow-800 flex flex-col items-center justify-center"><span class="text-2xl mb-1">‚ö†Ô∏è</span><span class="text-xs">Trap</span></button>
                        <button onclick="playTone('boss')" class="sound-btn bg-gray-700 hover:bg-gray-600 text-white font-bold py-4 rounded-lg shadow-lg border-b-4 border-gray-900 flex flex-col items-center justify-center"><span class="text-2xl mb-1">üíÄ</span><span class="text-xs">Boss</span></button>
                    </div>

                    <!-- Animal Sounds Section -->
                    <h3 class="text-sm font-semibold text-gray-400 mb-2 uppercase tracking-wider border-t border-gray-700 pt-4">Creature Sounds</h3>
                    <div class="grid grid-cols-2 sm:grid-cols-5 gap-3 mb-6">
                        <button onclick="playTone('wolf')" class="sound-btn bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 rounded-lg shadow-md border-b-4 border-gray-800 flex flex-col items-center justify-center"><span class="text-xl mb-1">üê∫</span><span class="text-xs">Wolf</span></button>
                        <button onclick="playTone('bear')" class="sound-btn bg-orange-800 hover:bg-orange-700 text-white font-bold py-3 rounded-lg shadow-md border-b-4 border-orange-950 flex flex-col items-center justify-center"><span class="text-xl mb-1">üêª</span><span class="text-xs">Bear</span></button>
                        <button onclick="playTone('bird')" class="sound-btn bg-sky-600 hover:bg-sky-500 text-white font-bold py-3 rounded-lg shadow-md border-b-4 border-sky-800 flex flex-col items-center justify-center"><span class="text-xl mb-1">üê¶</span><span class="text-xs">Bird</span></button>
                        <button onclick="playTone('snake')" class="sound-btn bg-green-800 hover:bg-green-700 text-white font-bold py-3 rounded-lg shadow-md border-b-4 border-green-950 flex flex-col items-center justify-center"><span class="text-xl mb-1">üêç</span><span class="text-xs">Snake</span></button>
                        <button onclick="playTone('insect')" class="sound-btn bg-yellow-700 hover:bg-yellow-600 text-white font-bold py-3 rounded-lg shadow-md border-b-4 border-yellow-900 flex flex-col items-center justify-center"><span class="text-xl mb-1">ü¶ó</span><span class="text-xs">Insect</span></button>
                    </div>

                    <h3 class="text-sm font-semibold text-gray-400 mb-2 uppercase tracking-wider border-t border-gray-700 pt-4">Ambience Loops</h3>
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                        <button onclick="toggleAmbience('village')" id="ambience-village" class="sound-btn bg-teal-800 hover:bg-teal-700 text-white font-bold py-3 rounded-lg shadow-md border border-teal-600 flex flex-col items-center justify-center"><span class="text-xl mb-1">üèòÔ∏è</span><span class="text-xs">Village</span></button>
                        <button onclick="toggleAmbience('city')" id="ambience-city" class="sound-btn bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 rounded-lg shadow-md border border-gray-500 flex flex-col items-center justify-center"><span class="text-xl mb-1">üè∞</span><span class="text-xs">City</span></button>
                        <button onclick="toggleAmbience('tavern')" id="ambience-tavern" class="sound-btn bg-yellow-900 hover:bg-yellow-800 text-white font-bold py-3 rounded-lg shadow-md border border-yellow-700 flex flex-col items-center justify-center"><span class="text-xl mb-1">üç∫</span><span class="text-xs">Tavern</span></button>
                        <button onclick="toggleAmbience('ocean')" id="ambience-ocean" class="sound-btn bg-blue-900 hover:bg-blue-800 text-white font-bold py-3 rounded-lg shadow-md border border-blue-700 flex flex-col items-center justify-center"><span class="text-xl mb-1">‚öì</span><span class="text-xs">Sea Shanty</span></button>
                        <button onclick="toggleAmbience('dungeon')" id="ambience-dungeon" class="sound-btn bg-purple-900 hover:bg-purple-800 text-white font-bold py-3 rounded-lg shadow-md border border-purple-700 flex flex-col items-center justify-center"><span class="text-xl mb-1">‚õìÔ∏è</span><span class="text-xs">Dungeon</span></button>
                        <button onclick="toggleAmbience('battle_minor')" id="ambience-battle_minor" class="sound-btn bg-red-900 hover:bg-red-800 text-white font-bold py-3 rounded-lg shadow-md border border-red-700 flex flex-col items-center justify-center"><span class="text-xl mb-1">üõ°Ô∏è</span><span class="text-xs">Minor Battle</span></button>
                        <button onclick="toggleAmbience('battle_major')" id="ambience-battle_major" class="sound-btn bg-gray-800 hover:bg-gray-700 text-white font-bold py-3 rounded-lg shadow-md border border-gray-600 flex flex-col items-center justify-center"><span class="text-xl mb-1">üî•</span><span class="text-xs">Major Battle</span></button>
                        <button onclick="toggleAmbience('sleep')" id="ambience-sleep" class="sound-btn bg-indigo-900 hover:bg-indigo-800 text-white font-bold py-3 rounded-lg shadow-md border border-indigo-700 flex flex-col items-center justify-center"><span class="text-xl mb-1">‚õ∫</span><span class="text-xs">Rest</span></button>
                    </div>
                    <div id="ambience-status" class="mt-2 text-center text-xs text-green-400 h-4"></div>
                </div>
            </div>

            <!-- Notes Tab -->
            <div id="notes" class="tab-content hidden">
                <div class="card p-4 rounded-lg shadow-xl">
                    <h2 class="text-xl font-semibold mb-4 text-indigo-300">Notes</h2>
                    <div class="flex border-b border-gray-700 mb-4 -mx-4 px-4 overflow-x-auto">
                        <button class="sub-tab-button p-2 text-sm font-semibold transition duration-300 active" data-subtab="prepNotes" onclick="switchSubTab('prepNotes')">üìú General</button>
                        <button class="sub-tab-button p-2 text-sm font-semibold text-gray-400 transition duration-300" data-subtab="enemyNotes" onclick="switchSubTab('enemyNotes')">üíÄ Enemies</button>
                        <button class="sub-tab-button p-2 text-sm font-semibold text-gray-400 transition duration-300" data-subtab="npcNotes" onclick="switchSubTab('npcNotes')">üë• NPCs</button>
                        <button class="sub-tab-button p-2 text-sm font-semibold text-gray-400 transition duration-300" data-subtab="lootNotes" onclick="switchSubTab('lootNotes')">üí∞ Loot</button>
                    </div>
                    <div id="prepNotes-sub-content" class="sub-tab-content"><div id="prepNotes-list" class="scrollable-content space-y-3"></div></div>
                    <div id="enemyNotes-sub-content" class="sub-tab-content hidden"><div id="enemyNotes-list" class="scrollable-content space-y-3"></div></div>
                    <div id="npcNotes-sub-content" class="sub-tab-content hidden"><div id="npcNotes-list" class="scrollable-content space-y-3"></div></div>
                    <div id="lootNotes-sub-content" class="sub-tab-content hidden"><div id="lootNotes-list" class="scrollable-content space-y-3"></div></div>
                    <button onclick="addNewNote(currentSubTab)" class="mt-4 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 rounded-lg transition duration-300">+ Add Manual Note</button>
                    <p id="notes-status" class="mt-2 text-sm text-center text-gray-400"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="edit-modal" class="hidden fixed inset-0 z-50 bg-black bg-opacity-75 flex items-center justify-center p-4">
        <div class="card w-full max-w-lg p-6 rounded-lg shadow-2xl">
            <h3 class="text-xl font-bold text-indigo-300 mb-4">Edit Note</h3>
            <input type="hidden" id="modal-note-id"><input type="hidden" id="modal-tab-name">
            <label class="block text-sm font-medium text-gray-400 mb-1">Title</label><input type="text" id="modal-title" class="w-full p-3 rounded-lg input-style mb-4">
            <label class="block text-sm font-medium text-gray-400 mb-1">Content</label><textarea id="modal-content" rows="6" class="w-full p-3 rounded-lg input-style mb-6 resize-none"></textarea>
            <div class="flex justify-end space-x-3"><button onclick="closeEditModal()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Cancel</button><button onclick="saveEditedNote()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Save</button></div>
        </div>
    </div>

    <div id="edit-statblock-modal" class="hidden fixed inset-0 z-50 bg-black bg-opacity-75 flex items-center justify-center p-4">
        <div class="card w-full max-w-lg p-6 rounded-lg shadow-2xl">
            <h3 class="text-xl font-bold text-indigo-300 mb-4">Edit Statblock</h3>
            <input type="hidden" id="modal-statblock-id">
            <label class="block text-sm font-medium text-gray-400 mb-1">Name</label><input type="text" id="modal-stat-name" class="w-full p-3 rounded-lg input-style mb-4">
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-sm font-medium text-gray-400 mb-1">HP</label><input type="number" id="modal-stat-hp" class="w-full p-3 rounded-lg input-style text-center text-sm mb-4"></div>
                <div><label class="block text-sm font-medium text-gray-400 mb-1">AC</label><input type="number" id="modal-stat-ac" class="w-full p-3 rounded-lg input-style text-center text-sm mb-4"></div>
                <div><label class="block text-sm font-medium text-gray-400 mb-1">To Hit</label><input type="number" id="modal-stat-tohit" class="w-full p-3 rounded-lg input-style text-center text-sm mb-4"></div>
                <div><label class="block text-sm font-medium text-gray-400 mb-1">Init</label><input type="number" id="modal-stat-init-mod" class="w-full p-3 rounded-lg input-style text-center text-sm mb-4"></div>
            </div>
            <label class="block text-sm font-medium text-gray-400 mb-1">Damage</label><input type="text" id="modal-stat-dmg" class="w-full p-3 rounded-lg input-style mb-6">
            <div class="flex justify-end space-x-3"><button onclick="closeStatblockEditModal()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Cancel</button><button onclick="saveEditedStatblock()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Save</button></div>
        </div>
    </div>

    <!-- Dice Visuals Canvas -->
    <canvas id="dice-canvas" class="fixed inset-0 pointer-events-none z-50"></canvas>
    <!-- Snow Visuals Canvas -->
    <canvas id="snow-canvas"></canvas>

    <!-- 2. APP LOGIC (Private Session & Cloud Persistence Fix) -->
    <script>
        // --- 1. GLOBAL VARIABLES ---
        window.userId = null;
        window.isAuthReady = false;
        window.currentTab = 'improv';
        window.currentSubTab = 'prepNotes';
        window.combatants = [];
        window.currentTurnIndex = -1;
        window.structuredNotes = { prepNotes: [], enemyNotes: [], npcNotes: [], lootNotes: [], mapNotes: [] };
        window.savedStatblocks = [];
        window.userApiKey = localStorage.getItem('dm_toolkit_api_key') || "";
        window.isChristmasMode = localStorage.getItem('aegis_theme') === 'christmas';
        window.customDiceColor = null; 
        window.customDiceImage = null;
        window.lastGeneratedNpc = null;
        window.lastGeneratedMonster = null;

        // --- 2. AUTHENTICATION & DATA LOADING ---
        // This listener waits for the Session ID before loading anything
        if(window.auth) {
            window.auth.onAuthStateChanged((user) => {
                const loginBtn = document.getElementById('login-btn');
                const profile = document.getElementById('user-profile');
                
                if (user) {
                    // LOGGED IN
                    console.log("Session Active:", user.uid);
                    window.userId = user.uid;
                    window.isAuthReady = true;
                    
                    // Update UI
                    if(loginBtn) loginBtn.classList.add('hidden');
                    if(profile) profile.classList.remove('hidden');
                    document.getElementById('user-name').textContent = user.email.split('@')[0].replace(/_/g, ' ');
                    
                    // START PRIVATE LISTENERS (Loads your saved data)
                    window.setupNotesListener();
                    window.setupStatblocksListener();
                    window.setupCombatListener(); // Use Cloud for Combat
                    
                } else {
                    // LOGGED OUT
                    window.userId = null;
                    window.isAuthReady = false;
                    
                    if(loginBtn) loginBtn.classList.remove('hidden');
                    if(profile) profile.classList.add('hidden');
                    
                    // Clear Data from Screen
                    window.combatants = [];
                    window.structuredNotes = { prepNotes: [], enemyNotes: [], npcNotes: [], lootNotes: [], mapNotes: [] };
                    window.savedStatblocks = [];
                    
                    // Render Empty
                    window.renderCombatants();
                }
            });
        }

        // --- 3. PRIVATE DATABASE PATHS (The Fix) ---
        // These functions ensure data goes to users/{sessionID}/...
        window.getCol = (name) => {
            if (!window.userId) return null; 
            return window.collection(window.db, 'artifacts', window.appId, 'users', window.userId, name);
        };
        window.getSharedDoc = (name) => {
            if (!window.userId) return null;
            return window.doc(window.db, 'artifacts', window.appId, 'users', window.userId, 'session_data', name);
        };
        window.getDocRef = (col, id) => {
            if (!window.userId) return null;
            return window.doc(window.db, 'artifacts', window.appId, 'users', window.userId, col, id);
        };

        // --- 4. COMBAT TRACKER (Local Storage + Session Isolated) ---
        
        // 1. Unique Storage Key Generator
        // This ensures 'Campaign A' gets a different save slot than 'Campaign B'
        window.getCombatStorageKey = () => {
            const uid = window.userId || 'guest_session';
            return `aegis_combat_${uid}`;
        };

        // 2. Load Data (From Browser Cache)
        window.loadCombatData = () => {
            const key = window.getCombatStorageKey();
            try {
                const raw = localStorage.getItem(key);
                const data = raw ? JSON.parse(raw) : {};
                
                window.combatants = data.combatants || [];
                window.currentTurnIndex = data.currentTurnIndex || -1;
                
                // Update Status Label
                const status = document.getElementById('db-status');
                if(status) {
                    if (window.userId) {
                        status.textContent = "Ready (Private Local)";
                        status.className = "text-xs px-2 py-1 rounded bg-green-900 text-green-100 border border-green-700 font-bold";
                    } else {
                        status.textContent = "Ready (Guest Local)";
                        status.className = "text-xs px-2 py-1 rounded bg-gray-700 text-gray-300 border border-gray-600";
                    }
                }
                
                window.renderCombatants();
            } catch(e) { 
                console.error("Local Load Error:", e); 
                // Fallback reset if data is corrupt
                window.combatants = [];
                window.renderCombatants();
            }
        };

        // 3. Save Data (To Browser Cache)
        window.saveCombatData = () => {
            const key = window.getCombatStorageKey();
            const data = { 
                combatants: window.combatants, 
                currentTurnIndex: window.currentTurnIndex 
            };
            localStorage.setItem(key, JSON.stringify(data));
            window.renderCombatants();
        };

        // 4. Add Combatant
        window.addCombatant = () => {
             const nameEl = document.getElementById('combatant-name');
             const name = nameEl.value.trim();
             
             if(!name) {
                 alert("Please enter a name.");
                 return;
             }
             
             // Auto-repair list if missing
             if (!window.combatants) window.combatants = [];

             const hp = parseInt(document.getElementById('combatant-hp').value)||0;
             const init = parseInt(document.getElementById('combatant-init').value)||0;
             const ac = parseInt(document.getElementById('combatant-ac').value)||0;
             const atk = document.getElementById('combatant-atk') ? document.getElementById('combatant-atk').value : "";

             window.combatants.push({ 
                 id: crypto.randomUUID(), 
                 name, init, maxHp: hp, currentHp: hp, ac, attack: atk, conditions: [] 
             });
             
             window.saveCombatData();
             
             // Clear name only for speed
             nameEl.value = '';
             if(document.getElementById('combatant-atk')) document.getElementById('combatant-atk').value = '';
             nameEl.focus();
        };

        // 5. Render Combatants
        window.renderCombatants = () => {
            const list = document.getElementById('initiative-list');
            if(!list) return;
            
            // Helper for dropdown options
            const dndConditions = ['Blinded', 'Charmed', 'Deafened', 'Frightened', 'Grappled', 'Incapacitated', 'Invisible', 'Paralyzed', 'Petrified', 'Poisoned', 'Prone', 'Restrained', 'Stunned', 'Unconscious', 'Exhaustion', 'Concentrating'];
            const condOpts = dndConditions.map(c=>`<option value="${c}">${c}</option>`).join('');

            if (window.combatants.length === 0) {
                list.innerHTML = '<p class="text-center text-gray-500 pt-4 text-sm italic">Battlefield empty.</p>';
                return;
            }

            // Sort High -> Low
            const sorted = [...window.combatants].sort((a,b) => (b.init - a.init));

            list.innerHTML = sorted.map((c, i) => {
                const active = (i === window.currentTurnIndex) ? 'border-indigo-500 bg-indigo-900/20' : 'border-gray-600';
                const badges = (c.conditions||[]).map(con=>`<span onclick="window.removeCondition('${c.id}','${con}')" class="cursor-pointer bg-red-900 px-1 rounded text-[10px] mr-1 border border-red-700 hover:bg-red-800">${con} √ó</span>`).join('');
                const atkShow = c.attack ? `<div class="text-xs text-yellow-400 font-mono mt-1">‚öîÔ∏è ${c.attack}</div>` : '';

                return `
                <div class="flex items-start p-2 bg-gray-800 rounded mb-1 border-l-4 ${active} transition-colors duration-200">
                    <div class="w-8 font-bold text-center pt-1 text-lg">${c.init}</div>
                    <div class="flex-1 ml-2 min-w-0">
                        <div class="font-bold text-sm text-gray-200 truncate">${c.name} <span class="text-xs text-gray-400 font-normal ml-1">HP: ${c.currentHp}/${c.maxHp} | AC: ${c.ac}</span></div>
                        ${atkShow}
                        <div class="mt-1 flex flex-wrap gap-1">${badges}</div>
                        <select onchange="window.addCondition('${c.id}',this.value);this.value='';" class="mt-1 bg-gray-900 text-[10px] text-gray-400 border border-gray-600 rounded px-1 focus:border-indigo-500 outline-none"><option value="">+ Cond</option>${condOpts}</select>
                    </div>
                    <div class="flex flex-col items-end gap-1 ml-1">
                        <div class="flex items-center gap-1">
                            <input type="number" id="dmg-${i}" class="w-9 text-black text-xs rounded p-1 outline-none" placeholder="#">
                            <button onclick="window.modHp('${c.id}',${i},-1)" class="text-xs bg-red-900 hover:bg-red-700 text-white px-2 py-1 rounded font-bold border border-red-800">Dmg</button>
                            <button onclick="window.modHp('${c.id}',${i},1)" class="text-xs bg-green-900 hover:bg-green-700 text-white px-2 py-1 rounded font-bold border border-green-800">Heal</button>
                        </div>
                        <button onclick="window.delCombatant('${c.id}')" class="text-xs text-gray-500 hover:text-red-400 underline mt-1">Remove</button>
                    </div>
                </div>`;
            }).join('');
            
            // Update Roller Target List
            const sel = document.getElementById('combatant-selector');
            if(sel) sel.innerHTML = '<option value="" disabled selected>Target</option>' + sorted.map((c,i)=>`<option value="${i}">${c.name}</option>`).join('');
        };


        // --- 5. NOTES & STATBLOCKS ---
        window.setupNotesListener = () => {
            if(!window.userId) return;
            window.onSnapshot(window.getSharedDoc('shared_notes'), (doc) => {
                if (doc.exists()) {
                    const d = doc.data();
                    window.structuredNotes = {
                        prepNotes: d.structuredPrepNotes || d.prepNotes || [],
                        enemyNotes: d.structuredEnemyNotes || d.enemyNotes || [],
                        npcNotes: d.structuredNpcNotes || d.npcNotes || [],
                        lootNotes: d.structuredLootNotes || d.lootNotes || [],
                        mapNotes: d.structuredMapNotes || d.mapNotes || []
                    };
                }
                if (window.currentTab === 'notes') window.renderStructuredNotes(window.currentSubTab);
            });
        };

        window.saveStructuredNotes = async (tab, data) => {
            if(!window.isAuthReady) return;
            const field = `structured${tab.charAt(0).toUpperCase() + tab.slice(1)}`;
            try { await window.setDoc(window.getSharedDoc('shared_notes'), { [field]: data }, { merge: true }); } catch(e) { console.error(e); }
        };

        window.renderStructuredNotes = (tab) => {
            const listId = `${tab}-list`; 
            const list = document.getElementById(listId);
            if(!list) return;
            const notes = window.structuredNotes[tab] || [];
            list.innerHTML = notes.length ? notes.map(n => `
                <div class="card p-2 mb-2 bg-gray-800 border border-gray-700 rounded">
                    <div class="font-bold text-indigo-300 cursor-pointer flex justify-between p-1" onclick="this.nextElementSibling.classList.toggle('hidden')">
                        <span class="truncate">${n.title}</span><span>‚ñº</span>
                    </div>
                    <div class="hidden mt-2 pt-2 border-t border-gray-700">
                        <div class="mb-2 text-right">
                            <button onclick="window.deleteNote('${n.id}', '${tab}')" class="text-[10px] text-red-400 border border-red-900 px-2 py-1 rounded bg-red-900/20">Delete</button>
                        </div>
                        <div class="text-sm text-gray-300 whitespace-pre-wrap overflow-hidden">${n.content}</div>
                    </div>
                </div>`).join('') : '<p class="text-center text-gray-500 pt-4 text-xs">No items.</p>';
        };
        
        window.addNewNote = (tab) => {
            if(!window.structuredNotes[tab]) window.structuredNotes[tab] = [];
            window.structuredNotes[tab].unshift({id:crypto.randomUUID(), title:'Manual Note', content:'Edit me...'});
            window.saveStructuredNotes(tab, window.structuredNotes[tab]);
            window.renderStructuredNotes(tab);
        };
        window.deleteNote = async (id, tab) => {
            window.structuredNotes[tab] = window.structuredNotes[tab].filter(n => n.id !== id);
            await window.saveStructuredNotes(tab, window.structuredNotes[tab]);
            window.renderStructuredNotes(tab);
        };

        window.saveGeneratedContent = async (destinationTab) => {
            if (!window.userId) { alert('Please log in to a Session to save.'); window.openLoginModal(); return; }
            const outputDiv = document.getElementById('ai-output');
            let content = outputDiv.innerHTML.trim();
            if(window.currentTab === 'loot') {
                const loot = document.getElementById('loot-output');
                if(loot) content = loot.innerText.trim();
            }
            if(!content || content.includes("Results appear here")) return alert("Nothing to save.");
            const title = (content.replace(/<[^>]*>/g, '').split('\n')[0].substring(0, 30)) || "Generated Note";
            const newNote = { id: crypto.randomUUID(), title, content, timestamp: new Date().toISOString() };
            if (!window.structuredNotes[destinationTab]) window.structuredNotes[destinationTab] = [];
            window.structuredNotes[destinationTab].unshift(newNote);
            await window.saveStructuredNotes(destinationTab, window.structuredNotes[destinationTab]);
            window.switchTab('notes'); window.switchSubTab(destinationTab);
        };
        
        window.saveMapToNotes = async () => {
            if(!window.userId) { alert("Please log in to save maps."); window.openLoginModal(); return; }
            const canvas = document.getElementById('gen-map-canvas'); if(!canvas) return;
            const img = `<img src="${canvas.toDataURL()}" style="width:100%; border-radius:8px;">`;
            const note = { id: crypto.randomUUID(), title: `Map ${new Date().toLocaleTimeString()}`, content: img, timestamp: new Date().toISOString() };
            if(!window.structuredNotes.mapNotes) window.structuredNotes.mapNotes = [];
            window.structuredNotes.mapNotes.unshift(note);
            await window.saveStructuredNotes('mapNotes', window.structuredNotes.mapNotes);
            alert("Map Saved!"); window.switchTab('notes'); window.switchSubTab('mapNotes');
        };

        window.setupStatblocksListener = () => {
            if(!window.isAuthReady) return;
            window.onSnapshot(window.query(window.getCol('dm_toolkit_statblocks')), (snap) => {
                window.savedStatblocks = []; snap.forEach(d => window.savedStatblocks.push({id: d.id, ...d.data()}));
                window.renderStatblocks();
            });
        };
        window.renderStatblocks = () => {
             const list = document.getElementById('statblocks-list'); if(!list) return;
             list.innerHTML = window.savedStatblocks.length ? '' : '<p class="text-center text-gray-500">No stats saved.</p>';
             window.savedStatblocks.forEach(s => {
                 const div = document.createElement('div'); div.className = 'card p-2 mb-2 bg-gray-800';
                 const safeName = s.name.replace(/'/g, "\\'");
                 const safeDmg = (s.dmg || "").replace(/'/g, "\\'");
                 div.innerHTML = `<div class="flex justify-between font-bold text-indigo-300"><span>${s.name}</span><div class="gap-2 flex"><button onclick="window.delStat('${s.id}')" class="text-xs text-red-400">Del</button></div></div>
                 <div class="text-xs text-gray-300 grid grid-cols-2 gap-1 mt-1"><span>HP: ${s.hp}</span><span>AC: ${s.ac}</span></div>
                 <div class="text-xs text-yellow-500 mt-1 truncate">${s.dmg}</div>
                 <button onclick="window.importStat('${safeName}', ${s.hp}, ${s.initMod}, ${s.ac}, '${safeDmg}')" class="w-full bg-purple-900 hover:bg-purple-700 text-xs rounded mt-2 py-1 transition">Add to Tracker</button>`;
                 list.appendChild(div);
             });
        };
        window.saveStatblock = async () => {
             if (!window.userId) { alert('Please log in to save.'); return window.openLoginModal(); }
             const name = document.getElementById('stat-name').value.trim(); if(!name) return;
             await window.addDoc(window.getCol('dm_toolkit_statblocks'), {
                 name, hp: parseInt(document.getElementById('stat-hp').value)||0,
                 ac: parseInt(document.getElementById('stat-ac').value)||0,
                 toHit: parseInt(document.getElementById('stat-tohit').value)||0,
                 initMod: parseInt(document.getElementById('stat-init-mod').value)||0,
                 dmg: document.getElementById('stat-dmg').value,
                 timestamp: new Date().toISOString()
             });
             document.getElementById('stat-name').value = '';
             alert("Saved!");
        };
        window.delStat = async (id) => await window.deleteDoc(window.getDocRef('dm_toolkit_statblocks', id));
        window.importStat = (n, h, i, a, d) => {
             document.getElementById('combatant-name').value = n; document.getElementById('combatant-hp').value = h;
             document.getElementById('combatant-init').value = i; document.getElementById('combatant-ac').value = a;
             if(document.getElementById('combatant-atk')) document.getElementById('combatant-atk').value = d || "";
             window.switchTab('combat');
        };
        window.addNpcToStatblocks = async () => {
            if (!window.userId) { alert('Log in to save.'); return window.openLoginModal(); }
            const s = window.lastGeneratedNpc; if(!s) return alert("No NPC generated.");
            try { await window.addDoc(window.getCol('dm_toolkit_statblocks'), { name: s.name, hp: s.max_hit_points, ac: s.armor_class_ac, toHit: 0, initMod: s.initiative_bonus, dmg: s.main_attack, timestamp: new Date().toISOString() }); alert("Saved!"); } catch(e) { console.error(e); alert("Save Failed"); }
        };
        window.addMonsterToStatblocks = async () => {
            if (!window.userId) { alert('Log in to save.'); return window.openLoginModal(); }
            const m = window.lastGeneratedMonster; if(!m) return alert("No Monster generated.");
            try { await window.addDoc(window.getCol('dm_toolkit_statblocks'), { name: m.name, hp: m.hit_points, ac: m.armor_class, toHit: 0, initMod: 0, dmg: "Attack", timestamp: new Date().toISOString() }); alert("Saved!"); } catch(e) { console.error(e); alert("Save Failed"); }
        };
        window.saveMonsterToNotes = async () => window.saveGeneratedContent('enemyNotes');
        window.saveCombatNpcToNotes = async (tab) => window.saveGeneratedContent(tab);

        // --- 6. UI HELPERS & INIT ---
        window.switchTab = (t) => {
            window.currentTab = t; document.querySelectorAll('.tab-content').forEach(e => e.classList.add('hidden'));
            document.getElementById(t).classList.remove('hidden');
            if(t === 'notes') window.renderStructuredNotes(window.currentSubTab);
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active', 'text-indigo-400', 'border-indigo-500');
                btn.classList.add('text-gray-400', 'border-transparent');
                const txt = btn.textContent.toLowerCase();
                if ((t==='improv' && txt.includes('prep')) || (t==='statblocks' && txt.includes('stats')) || (t==='soundboard' && txt.includes('sound')) || txt.includes(t)) {
                    btn.classList.add('active'); btn.classList.remove('text-gray-400');
                }
            });
        };
        window.switchSubTab = (t) => { 
            window.currentSubTab=t; 
            document.querySelectorAll('.sub-tab-content').forEach(e => e.classList.add('hidden'));
            document.getElementById(`${t}-sub-content`).classList.remove('hidden');
            document.querySelectorAll('.sub-tab-button').forEach(btn => {
                btn.classList.remove('active', 'text-gray-400');
                if (btn.dataset.subtab === t) btn.classList.add('active');
                else btn.classList.add('text-gray-400');
            });
            window.renderStructuredNotes(t);
        };
        window.openLoginModal = () => document.getElementById('login-modal').classList.remove('hidden');
        window.closeLoginModal = () => document.getElementById('login-modal').classList.add('hidden');
        window.updateApiKey = (val) => { window.userApiKey = val.trim(); localStorage.setItem('dm_toolkit_api_key', window.userApiKey); document.getElementById('api-key-status').textContent="Key Saved!"; };
        window.saveApiKey = () => window.updateApiKey(document.getElementById('user-api-key').value);
        window.toggleTheme = () => { window.isChristmasMode = !window.isChristmasMode; localStorage.setItem('aegis_theme', window.isChristmasMode ? 'christmas' : 'default'); applyTheme(); };
        function applyTheme() { if(window.isChristmasMode) { document.body.classList.add('christmas-mode'); startSnow(); } else { document.body.classList.remove('christmas-mode'); stopSnow(); } }
        window.handleSessionLogin = async () => {
            const name = document.getElementById('session-name-input').value.trim();
            const pass = document.getElementById('session-pass-input').value.trim();
            if(!name || !pass) return alert("Enter Name & Password");
            const email = `${name.replace(/\s+/g, '_')}@aegis.local`;
            try { await window.signInWithEmailAndPassword(window.auth, email, pass); window.closeLoginModal(); }
            catch(e) {
                if(e.code.includes('user-not-found') || e.code.includes('invalid-credential')) {
                    try { await window.createUserWithEmailAndPassword(window.auth, email, pass); window.closeLoginModal(); }
                    catch(regErr) { alert(regErr.message); }
                } else { alert(e.message); }
            }
        };

        // --- 7. GENERATORS & EXTRAS ---
        const API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent';
        const combatSchema = { type: "OBJECT", properties: { name: { "type": "STRING" }, level_or_cr: { "type": "STRING" }, armor_class_ac: { "type": "INTEGER" }, max_hit_points: { "type": "INTEGER" }, initiative_bonus: { "type": "INTEGER" }, main_attack: { "type": "STRING" } }, required: ["name", "level_or_cr", "armor_class_ac", "max_hit_points", "initiative_bonus", "main_attack"] };
        const monsterSchema = { type: "OBJECT", properties: { name: { type: "STRING" }, size: { type: "STRING" }, type: { type: "STRING" }, alignment: { type: "STRING" }, armor_class: { type: "INTEGER" }, ac_type: { type: "STRING" }, hit_points: { type: "INTEGER" }, hit_dice: { type: "STRING" }, speed: { type: "STRING" }, ability_scores: { type: "OBJECT", properties: { STR: {type:"INTEGER"}, DEX: {type:"INTEGER"}, CON: {type:"INTEGER"}, INT: {type:"INTEGER"}, WIS: {type:"INTEGER"}, CHA: {type:"INTEGER"} }, required: ["STR","DEX","CON","INT","WIS","CHA"] }, saving_throws: {type:"ARRAY", items:{type:"STRING"}}, skills: {type:"ARRAY", items:{type:"STRING"}}, damage_vulnerabilities: {type:"ARRAY", items:{type:"STRING"}}, damage_resistances: {type:"ARRAY", items:{type:"STRING"}}, damage_immunities: {type:"ARRAY", items:{type:"STRING"}}, condition_immunities: {type:"ARRAY", items:{type:"STRING"}}, senses: {type:"STRING"}, languages: {type:"STRING"}, challenge_rating: {type:"STRING"}, xp: {type:"INTEGER"}, abilities: { type: "ARRAY", items: { type: "OBJECT", properties: { name: {type:"STRING"}, description: {type:"STRING"} }, required: ["name", "description"] } }, actions: { type: "ARRAY", items: { type: "OBJECT", properties: { name: {type:"STRING"}, description: {type:"STRING"} }, required: ["name", "description"] } }, legendary_actions: { type: "ARRAY", items: { type: "OBJECT", properties: { name: {type:"STRING"}, description: {type:"STRING"} } } } }, required: ["name", "size", "type", "alignment", "armor_class", "hit_points", "hit_dice", "speed", "ability_scores", "senses", "languages", "challenge_rating", "xp", "actions"] };

        async function callAI(payload) {
            let key = window.userApiKey || document.getElementById('user-api-key')?.value.trim();
            if (!key) { alert("Please enter API Key in Prep tab"); throw new Error("No API Key"); }
            const res = await fetch(`${API_URL}?key=${key}`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
            if (res.ok) return await res.json();
            throw new Error("API Error");
        }

        window.generateCombatNpc = async () => {
            const btn = document.getElementById('generate-combat-button'); const out = document.getElementById('ai-output');
            if(btn) btn.disabled = true; if(out) out.textContent = "Generating...";
            try {
                const txt = document.getElementById('npc-type').value; const lvl = document.getElementById('npc-level').value;
                const data = await callAI({ contents: [{ parts: [{ text: `Generate D&D 5e combat NPC (Level ${lvl}, ${txt}) in JSON with keys: name, armor_class_ac, max_hit_points, initiative_bonus, main_attack.` }] }], generationConfig: { responseMimeType: "application/json", responseSchema: combatSchema } });
                const stats = JSON.parse(data.candidates[0].content.parts[0].text); window.lastGeneratedNpc = stats;
                out.innerHTML = `<div class="text-2xl font-bold text-green-400 mb-2">${stats.name}</div><div class="text-sm">AC: ${stats.armor_class_ac} | HP: ${stats.max_hit_points} | Init: ${stats.initiative_bonus}</div><div class="mt-2 font-medium">${stats.main_attack}</div><button onclick="window.addNpcToStatblocks()" class="mt-4 w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 rounded-lg">Save to Stats</button>`;
            } catch(e) { if(out) out.textContent = "Error: " + e.message; } finally { if(btn) btn.disabled = false; }
        };

        window.generateMonsterStatblock = async () => {
             const btn = document.getElementById('generate-monster-button'); const output = document.getElementById('monster-output');
             btn.disabled = true; output.textContent = "Generating...";
             try {
                 const name = document.getElementById('monster-name').value; const cr = document.getElementById('monster-cr').value;
                 const data = await callAI({ contents: [{ parts: [{ text: `Generate D&D 5e monster "${name}" (CR ${cr}) JSON.` }] }], generationConfig: { responseMimeType: "application/json", responseSchema: monsterSchema } });
                 const stats = JSON.parse(data.candidates[0].content.parts[0].text); window.lastGeneratedMonster = stats;
                 output.innerHTML = `<div class="dnd-statblock text-left"><div class="dnd-header">${stats.name}</div><div class="italic text-black text-sm">${stats.size} ${stats.type}</div><div class="text-sm text-red-900"><p><strong>AC</strong> ${stats.armor_class}</p><p><strong>HP</strong> ${stats.hit_points}</p></div></div>`;
                 document.getElementById('save-options-monster').classList.remove('hidden');
             } catch(e) { output.textContent = "Error: " + e.message; } finally { btn.disabled = false; }
        };
        window.generateSettlement = async () => {
             const btn = document.getElementById('generate-settlement-button'); const outputDiv = document.getElementById('ai-output');
             btn.disabled = true; outputDiv.textContent = "Generating...";
             try {
                 const type = document.getElementById('settlement-type').value; const vibe = document.getElementById('settlement-vibe').value;
                 const data = await callAI({ contents: [{ parts: [{ text: `Generate D&D ${type}: ${vibe}. Markdown format.` }] }] });
                 outputDiv.innerHTML = data.candidates[0].content.parts[0].text.replace(/\n/g, '<br>');
                 document.getElementById('save-options-creative').classList.remove('hidden');
             } catch(e) { outputDiv.textContent = "Error: " + e.message; } finally { btn.disabled = false; }
        };
        window.generateCreativeIdea = async () => {
             const btn = document.getElementById('generate-button'); const outputDiv = document.getElementById('ai-output');
             btn.disabled = true; outputDiv.textContent = "Generating...";
             try {
                 const p = document.getElementById('improv-prompt').value;
                 const data = await callAI({ contents: [{ parts: [{ text: `Generate creative D&D idea: ${p}` }] }] });
                 outputDiv.innerHTML = data.candidates[0].content.parts[0].text.replace(/\n/g, '<br>');
                 document.getElementById('save-options-creative').classList.remove('hidden');
             } catch(e) { outputDiv.textContent = "Error: " + e.message; } finally { btn.disabled = false; }
        };
        window.generateLoot = async () => {
             const source = document.getElementById('loot-source').value; const btn = document.getElementById('generate-loot-button'); const outputDiv = document.getElementById('loot-output');
             btn.disabled = true;
             if (source === 'wiki') {
                 const wikiLootTable = [{ name: "Bag of Holding", url: "https://dnd5e.wikidot.com/wondrous-items:bag-of-holding" }, { name: "Potion of Healing", url: "https://dnd5e.wikidot.com/wondrous-items:potion-of-healing" }];
                 let html = "<ul class='list-disc list-inside'>";
                 for(let i=0; i<5; i++) { const item = wikiLootTable[Math.floor(Math.random()*wikiLootTable.length)]; html += `<li><a href="${item.url}" target="_blank" class="text-blue-400 font-bold hover:underline">${item.name}</a></li>`; }
                 outputDiv.innerHTML = html + "</ul>"; btn.disabled = false; return;
             }
             outputDiv.textContent = "Generating...";
             try {
                 const lvl = document.getElementById('loot-level').value; const type = document.getElementById('loot-type').value;
                 const data = await callAI({ contents: [{ parts: [{ text: `Generate D&D loot list for Level ${lvl} ${type}.` }] }] });
                 outputDiv.innerText = data.candidates[0].content.parts[0].text;
             } catch(e) { outputDiv.innerText = "Error: " + e.message; } finally { btn.disabled = false; }
        };
        window.generateDetailedMap = () => {
            const canvas = document.getElementById('gen-map-canvas'); if(!canvas) return; const ctx = canvas.getContext('2d');
            const w=canvas.width, h=canvas.height; ctx.fillStyle='#0f172a'; ctx.fillRect(0,0,w,h);
            for(let i=0;i<5;i++){ ctx.fillStyle='#374151'; ctx.fillRect(Math.random()*(w-100), Math.random()*(h-100), 80, 80); }
        };
        window.splitLoot = () => {
            const pp=parseInt(document.getElementById('loot-pp').value)||0; const gp=parseInt(document.getElementById('loot-gp').value)||0; const ep=parseInt(document.getElementById('loot-ep').value)||0; const sp=parseInt(document.getElementById('loot-sp').value)||0; const cp=parseInt(document.getElementById('loot-cp').value)||0; const n=parseInt(document.getElementById('loot-party-size').value)||1;
            const totalCp = (pp*1000) + (gp*100) + (ep*50) + (sp*10) + cp;
            const share = Math.floor(totalCp/n); const rem = totalCp%n;
            document.getElementById('loot-split-result').innerHTML = `Each: ${Math.floor(share/100)}gp, ${(share%100)}cp ${rem>0?`(${rem}cp left)`:''}`;
        };

        // --- Soundboard & Visuals ---
        const ac = new (window.AudioContext||window.webkitAudioContext)();
        const masterGain = ac.createGain(); masterGain.connect(ac.destination); masterGain.gain.value = 0.5;
        const unlockAudio = () => { if (ac.state === 'suspended') ac.resume(); };
        document.addEventListener('click', unlockAudio); document.addEventListener('touchstart', unlockAudio);
        window.playTone = (type) => { 
            if(ac.state==='suspended') ac.resume();
            const o=ac.createOscillator(); const g=ac.createGain(); o.connect(g); g.connect(masterGain);
            if(type==='wolf') { o.frequency.value=400; o.start(); o.stop(ac.currentTime+2); } else { o.frequency.value=440; o.start(); o.stop(ac.currentTime+0.2); }
        };
        window.toggleAmbience = (t) => { if(ac.state==='suspended') ac.resume(); };
        
        window.uploadDiceTexture = (input) => { if(input.files[0]) { const r = new FileReader(); r.onload = (e) => { const i = new Image(); i.onload=()=>window.customDiceImage=i; i.src=e.target.result; }; r.readAsDataURL(input.files[0]); } };
        window.resetDiceTexture = () => { window.customDiceImage = null; document.getElementById('dice-texture-input').value=''; };
        
        (function() {
            const canvas = document.getElementById('dice-canvas'); if(!canvas) return; const ctx = canvas.getContext('2d'); let dice=[];
            function resize(){canvas.width=window.innerWidth;canvas.height=window.innerHeight;} window.addEventListener('resize', resize); resize();
            function animate() { ctx.clearRect(0,0,canvas.width,canvas.height); dice.forEach(d=>{ d.y+=d.vy; d.x+=d.vx; d.vy+=1; if(d.y>canvas.height-50) { d.y=canvas.height-50; d.vy*=-0.6; d.vx*=0.9; if(Math.abs(d.vx)<0.5 && Math.abs(d.vy)<1) d.vAngle=0; } d.angle+=d.vAngle; ctx.save(); ctx.translate(d.x,d.y); ctx.rotate(d.angle); ctx.fillStyle=d.color; ctx.beginPath(); if(d.type===4){ctx.moveTo(0,-20);ctx.lineTo(20,15);ctx.lineTo(-20,15);} else if(d.type===6){ctx.rect(-15,-15,30,30);} else {ctx.arc(0,0,20,0,Math.PI*2);} ctx.closePath(); if(window.customDiceImage){ctx.save();ctx.clip();ctx.drawImage(window.customDiceImage,-25,-25,50,50);ctx.restore();}else{ctx.fill();} ctx.stroke(); ctx.fillStyle='white'; ctx.fillText(d.val, -4, 4); ctx.restore(); }); requestAnimationFrame(animate); }
            animate();
            window.throwDiceVisuals = (rolls, type) => { const color = document.getElementById('dice-color-picker').value; dice = rolls.map(r => ({val:r, type, x:canvas.width/2, y:canvas.height+30, vx:(Math.random()-0.5)*20, vy:-25, color, angle:0, vAngle:0.2})); setTimeout(()=>dice=[], 3500); };
        })();
        window.rollD20 = () => { window.lastRoll = Math.floor(Math.random()*20)+1; document.getElementById('last-roll-display').textContent = window.lastRoll; window.throwDiceVisuals([window.lastRoll], 20); };
        window.rollSimple = (s) => { window.throwDiceVisuals([Math.floor(Math.random()*s)+1], s); };
        window.rollCustomDice = () => { const n=parseInt(document.getElementById('dice-num').value); const t=parseInt(document.getElementById('dice-type').value); let r=[]; for(let i=0;i<n;i++) r.push(Math.floor(Math.random()*t)+1); document.getElementById('dice-roll-result').textContent = r.reduce((a,b)=>a+b,0); window.throwDiceVisuals(r, t); };
        window.assignInitiativeRoll = () => { const idx=parseInt(document.getElementById('combatant-selector').value); if(!isNaN(idx) && window.combatants[idx]) { window.combatants[idx].init = window.lastRoll; window.saveCombatData(); } };

        document.addEventListener('DOMContentLoaded', () => {
            if(window.userApiKey) document.getElementById('user-api-key').value = window.userApiKey;
            applyTheme();
            window.switchTab('improv');
        });
        
        let snowInterval; const snowCanvas = document.getElementById('snow-canvas'); const sCtx = snowCanvas ? snowCanvas.getContext('2d') : null;
        function startSnow() { if(!snowCanvas) return; snowCanvas.width=window.innerWidth; snowCanvas.height=window.innerHeight; let flakes=Array(100).fill().map(()=>({x:Math.random()*snowCanvas.width,y:Math.random()*snowCanvas.height,s:Math.random()+0.5})); snowInterval=setInterval(()=>{ sCtx.clearRect(0,0,snowCanvas.width,snowCanvas.height); sCtx.fillStyle='rgba(255,255,255,0.5)'; sCtx.beginPath(); flakes.forEach(f=>{sCtx.moveTo(f.x,f.y);sCtx.arc(f.x,f.y,2,0,Math.PI*2); f.y+=f.s; if(f.y>snowCanvas.height)f.y=0;}); sCtx.fill(); }, 50); }
        function stopSnow() { clearInterval(snowInterval); if(sCtx) sCtx.clearRect(0,0,snowCanvas.width,snowCanvas.height); }
    </script>

    <!-- Login Modal -->
<div id="login-modal" class="hidden fixed inset-0 z-[100] bg-black bg-opacity-80 flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="card w-full max-w-md p-8 rounded-xl shadow-2xl border border-gray-600">
        <h3 class="text-2xl font-bold text-indigo-300 mb-2 text-center">üõ°Ô∏è Open Session</h3>
        <p class="text-gray-400 text-sm mb-6 text-center">Enter a Session Name and Password to create or load a shared room.</p>
        
        <div class="space-y-4">
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Session Name</label>
                <input type="text" id="session-name-input" class="w-full p-3 rounded-lg input-style border-2 border-indigo-900/50 focus:border-indigo-500 outline-none transition" placeholder="e.g. Campaign1">
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Password</label>
                <input type="password" id="session-pass-input" class="w-full p-3 rounded-lg input-style border-2 border-indigo-900/50 focus:border-indigo-500 outline-none transition" placeholder="******">
            </div>
        </div>
        
        <div id="login-status" class="h-6 text-red-400 text-xs mt-2"></div>
        
        <div class="flex gap-3 mt-4">
            <button onclick="closeLoginModal()" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 rounded-lg transition">Cancel</button>
            <button onclick="handleSessionLogin()" class="flex-1 bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 rounded-lg transition shadow-lg shadow-indigo-900/50">Connect</button>
        </div>
    </div>
</div>

</body>
</html>