<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aegis DM Toolkit</title>
    <!-- Dynamic Home Screen Icon Generator -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // 1. Define your Logo SVG (Shield + Sword + D20)
            const svgString = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" width="180" height="180">
                <rect width="64" height="64" fill="#1e293b"/>
                <path d="M32 4 L12 14 V30 C12 43 21 54 32 58 C43 54 52 43 52 30 V14 Z" fill="#1f2933" stroke="#f4d28b" stroke-width="2.5" stroke-linejoin="round" />
                <g>
                    <path d="M31 10 L33 10 L33 48 L32 52 L31 48 Z" fill="#cbd5e1" stroke="#94a3b8" stroke-width="1"/>
                    <path d="M24 15 L40 15 L40 18 L24 18 Z" fill="#f4d28b" stroke="#b45309" stroke-width="1"/>
                    <path d="M31 2 L33 2 L33 10 L31 10 Z" fill="#8b4513" stroke="#f4d28b" stroke-width="1"/>
                    <circle cx="32" cy="2" r="2.5" fill="#f4d28b" stroke="#b45309" stroke-width="1"/>
                </g>
                <polygon points="32,18 24,24 24,34 32,40 40,34 40,24" fill="#8b4513" stroke="#f4d28b" stroke-width="1.5" stroke-linejoin="round" />
                <text x="32" y="30" text-anchor="middle" font-size="8" fill="#f9f9f9" font-family="system-ui, sans-serif">20</text>
            </svg>`;

            // 2. Create a canvas to convert SVG -> PNG
            const canvas = document.createElement('canvas');
            canvas.width = 180;
            canvas.height = 180;
            const ctx = canvas.getContext('2d');
            const img = new Image();

            // 3. Load SVG and Draw
            img.src = 'data:image/svg+xml;base64,' + btoa(svgString);
            img.onload = function() {
                ctx.drawImage(img, 0, 0);
                
                // 4. Create the Apple Touch Icon link
                const link = document.createElement('link');
                link.rel = 'apple-touch-icon';
                link.href = canvas.toDataURL('image/png'); // Convert to PNG data string
                document.head.appendChild(link);
                
                // Also set standard favicon
                const fav = document.createElement('link');
                fav.rel = 'icon';
                fav.href = canvas.toDataURL('image/png');
                document.head.appendChild(fav);
            };
        });
    </script>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Aegis DM">
    <script src="https://cdn.tailwindcss.com"></script>

    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Libre+Baskerville:wght@400;700&display=swap');

        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f8fafc; transition: background-color 0.5s, color 0.5s; }
        .tab-button.active { border-bottom: 3px solid #6366f1; color: #c7d2fe; }
        .sub-tab-button.active { border-bottom: 2px solid #34d399; color: #34d399; }
        .card { background-color: #1e293b; border: 1px solid #334155; transition: background-color 0.5s, border-color 0.5s; }
        .input-style { background-color: #334155; border: 1px solid #475569; color: #f8fafc; }
        .glow-shadow { box-shadow: 0 0 10px rgba(99, 102, 241, 0.5); }
        
        /* --- CHRISTMAS THEME OVERRIDES --- */
        body.christmas-mode {
            background-color: #0b291b !important; /* Deep Forest Green */
            color: #fef3c7; /* Warm Eggshell */
        }
        body.christmas-mode .card {
            background-color: #2f0a0a; /* Dark Burgundy */
            border-color: #b45309; /* Gold Border */
            box-shadow: 0 4px 6px -1px rgba(220, 38, 38, 0.2);
            position: relative;
            overflow: visible; /* Allow candy canes to stick out */
            margin-top: 25px; /* Space for the topper */
            border-top: none; /* Snow covers the top */
        }
        
        /* The Snow Cap */
        body.christmas-mode .card::before {
            content: "";
            position: absolute;
            top: -12px;
            left: -1px;
            right: -1px;
            height: 15px;
            background-color: #f1f5f9; /* Snow White */
            border-radius: 10px 10px 4px 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 10;
            border-bottom: 2px solid #e2e8f0; /* Slight texture */
        }

        /* The Candy Canes (Peppermint Sticks) */
        body.christmas-mode .card::after {
            content: "";
            position: absolute;
            top: -25px;
            right: 20px;
            width: 10px;
            height: 25px;
            /* Peppermint Stripe Pattern */
            background: repeating-linear-gradient(
                45deg,
                #dc2626,
                #dc2626 4px,
                #ffffff 4px,
                #ffffff 8px
            );
            border-radius: 4px 4px 0 0;
            transform: rotate(15deg);
            box-shadow: -2px 2px 2px rgba(0,0,0,0.3);
            z-index: 0; /* Behind the snow cap */
            
            /* Add a second stick using box-shadow cloning for efficiency */
            box-shadow: 
                -15px 5px 0 -1px rgba(0,0,0,0.2), /* Shadow for second stick */
                -20px 2px 0 0 #ffffff; /* This creates a pseudo-second stick (white base) */
        }
        /* Note: Complex striped cloning with box-shadow is hard, so ::after is just one main stick. 
           To keep it simple and robust without adding DOM elements, we stick to one nice accent per card. */

        body.christmas-mode .input-style {
            background-color: #451a1a;
            border-color: #7f1d1d;
            color: #fef3c7;
        }
        body.christmas-mode .tab-button.active {
            border-bottom-color: #ef4444; /* Candy Red */
            color: #fca5a5;
        }
        body.christmas-mode .tab-button:not(.active) {
            color: #b45309; /* Gold for inactive */
        }
        body.christmas-mode h1, body.christmas-mode h2, body.christmas-mode h3 {
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        body.christmas-mode h1 span { /* The Shield Icon/Logo area */
            filter: hue-rotate(140deg) brightness(1.2); /* Shift to green/red */
        }
        
        /* Snow Canvas */
        #snow-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1; /* Behind everything */
        }

        .scrollable-content { max-height: 60vh; overflow-y: auto; }
        .scrollable-content::-webkit-scrollbar { width: 8px; }
        .scrollable-content::-webkit-scrollbar-track { background: #1e293b; }
        .scrollable-content::-webkit-scrollbar-thumb { background-color: #475569; border-radius: 20px; border: 2px solid #1e293b; }
        .loading-spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-top: 4px solid #fff; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .collapsible-header { cursor: pointer; display: flex; justify-content: space-between; align-items: center; padding: 10px; background-color: #334155; border-radius: 8px; }
        .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; padding: 0 10px; }
        .collapsible-content.expanded { max-height: 8000px; padding: 10px; }
        .arrow-icon { transition: transform 0.3s ease; }
        .expanded .arrow-icon { transform: rotate(90deg); }
        .sound-btn { transition: all 0.1s ease; }
        .sound-btn:active { transform: scale(0.95); }
        .sound-btn.active-loop { border-color: #34d399; background-color: #059669; box-shadow: 0 0 15px #34d399; animation: pulse-green 2s infinite; }
        @keyframes pulse-green { 0% { box-shadow: 0 0 0 0 rgba(52, 211, 153, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(52, 211, 153, 0); } 100% { box-shadow: 0 0 0 0 rgba(52, 211, 153, 0); } }
        /* Range Slider Style */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #34d399; cursor: pointer; margin-top: -6px; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #475569; border-radius: 2px; }
        
        /* D&D Statblock Styles */
        .dnd-statblock {
            background-color: #fdf1dc;
            color: #58180d;
            font-family: 'Libre Baskerville', serif;
            padding: 15px;
            border: 1px solid #d4b57e;
            box-shadow: 0 0 15px rgba(0,0,0,0.3);
            position: relative;
        }
        .dnd-statblock::before, .dnd-statblock::after {
            content: "";
            display: block;
            height: 4px;
            background: #e69a28;
            margin: 4px 0;
            border-radius: 2px;
        }
        .dnd-header {
            font-family: 'Libre Baskerville', serif;
            font-variant: small-caps;
            font-weight: 700;
            color: #58180d;
            font-size: 1.5em;
            line-height: 1.1;
        }
        .tapered-rule {
            display: block;
            height: 2px;
            background: #58180d;
            margin: 10px 0;
            border: none;
            background: linear-gradient(to right, transparent, #58180d, transparent);
        }
        .dnd-property-line {
            font-size: 0.9rem;
            line-height: 1.4;
            margin-bottom: 2px;
        }
        .dnd-property-line strong {
            color: #58180d;
        }
        .dnd-section-title {
            font-variant: small-caps;
            font-weight: bold;
            font-size: 1.2em;
            color: #58180d;
            border-bottom: 1px solid #7a200d;
            margin-top: 10px;
            margin-bottom: 5px;
        }
        .dnd-action-name {
            font-weight: bold;
            font-style: italic;
        }
        
        /* Aegis Logo Styles */
        .aegis-logo {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            color: #e2e8f0; /* Added for visibility on dark header */
        }

        .aegis-icon {
            width: 48px;   /* Increased slightly for better visibility in header */
            height: 48px;
        }

        .aegis-text {
            display: flex;
            flex-direction: column;
            line-height: 1.1;
        }

        .aegis-title {
            font-size: 1.2rem; /* Bumped up slightly */
            font-weight: 700;
            letter-spacing: 0.06em;
            text-transform: uppercase;
            color: #818cf8; /* Matches the indigo-400 theme */
        }

        .aegis-subtitle {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.16em;
            opacity: 0.8;
            color: #cbd5e1;
        }
    </style>
</head>
<body class="p-4 sm:p-8">
    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <div class="flex justify-between items-center mb-6 bg-gray-800 p-3 rounded-lg border border-gray-700 shadow-lg">
            <div class="flex items-center">
                <!-- Aegis DM Toolkit Logo -->
                <div class="aegis-logo">
                  <svg class="aegis-icon" viewBox="0 0 64 64" aria-hidden="true">
                    <!-- Shield -->
                    <path
                      d="M32 4 L12 14 V30 C12 43 21 54 32 58 C43 54 52 43 52 30 V14 Z"
                      fill="#1f2933"
                      stroke="#f4d28b"
                      stroke-width="2.5"
                      stroke-linejoin="round"
                    />
                    
                    <!-- Sword (Vertical, Behind d20) -->
                    <g>
                      <!-- Blade -->
                      <path d="M31 10 L33 10 L33 48 L32 52 L31 48 Z" fill="#cbd5e1" stroke="#94a3b8" stroke-width="1"/>
                      <!-- Crossguard -->
                      <path d="M24 15 L40 15 L40 18 L24 18 Z" fill="#f4d28b" stroke="#b45309" stroke-width="1"/>
                      <!-- Hilt -->
                      <path d="M31 2 L33 2 L33 10 L31 10 Z" fill="#8b4513" stroke="#f4d28b" stroke-width="1"/>
                      <!-- Pommel -->
                      <circle cx="32" cy="2" r="2.5" fill="#f4d28b" stroke="#b45309" stroke-width="1"/>
                    </g>

                    <!-- Simple d20 -->
                    <polygon
                      points="32,18 24,24 24,34 32,40 40,34 40,24"
                      fill="#8b4513"
                      stroke="#f4d28b"
                      stroke-width="1.5"
                      stroke-linejoin="round"
                    />
                    
                    <text
                      x="32"
                      y="30"
                      text-anchor="middle"
                      font-size="8"
                      fill="#f9f9f9"
                      font-family="system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif"
                    >
                      20
                    </text>
                  </svg>

                  <div class="aegis-text">
                    <span class="aegis-title">Aegis</span>
                    <span class="aegis-subtitle">DM Toolkit</span>
                  </div>
                </div>
            </div>

            <div class="flex items-center gap-3">
                <!-- Holiday Toggle -->
                <button onclick="toggleTheme()" class="text-xl p-2 hover:bg-gray-700 rounded transition" title="Toggle Holiday Mode">üéÑ</button>
                
                <a href="https://ko-fi.com/aegisdmtool" target="_blank" class="bg-yellow-600/20 hover:bg-yellow-600/40 text-yellow-200 border border-yellow-600/50 text-xs font-bold py-2 px-3 rounded-lg transition duration-200 flex items-center gap-2 no-underline">
                    <span>‚òï</span> <span class="hidden sm:inline">Tip</span>
                </a>
                <div>
                <button id="login-btn" onclick="window.openLoginModal()" class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg text-sm flex items-center gap-2 transition duration-200 border border-indigo-400 shadow-lg shadow-indigo-900/20">
    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
    Session Login
</button>
                    <div id="user-profile" class="hidden flex items-center gap-3">
                        <div class="text-right hidden sm:block"><div id="user-name" class="text-sm font-semibold text-white">Adventurer</div><div class="text-xs text-green-400">Online & Saving</div></div>
                        <img id="user-avatar" src="" alt="User" class="w-9 h-9 rounded-full border-2 border-indigo-500">
                        <button onclick="logoutUser()" class="bg-red-900/50 hover:bg-red-800 text-red-200 p-2 rounded-lg text-xs border border-red-800 transition duration-200">Sign Out</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Nav -->
        <div class="flex border-b border-gray-600 mb-6 overflow-x-auto">
            <button class="tab-button p-3 flex-1 text-sm font-semibold transition duration-300 active min-w-[100px]" onclick="switchTab('improv')">üîÆ Prep</button>
            <button class="tab-button p-3 flex-1 text-sm font-semibold text-gray-400 transition duration-300 min-w-[100px]" onclick="switchTab('combat')">‚öîÔ∏è Combat</button>
            <button class="tab-button p-3 flex-1 text-sm font-semibold text-gray-400 transition duration-300 min-w-[100px]" onclick="switchTab('statblocks')">üëπ Stats</button>
            <button class="tab-button p-3 flex-1 text-sm font-semibold text-gray-400 transition duration-300 min-w-[100px]" onclick="switchTab('monsters')">üê≤ Monsters</button>
            <button class="tab-button p-3 flex-1 text-sm font-semibold text-gray-400 transition duration-300 min-w-[100px]" onclick="switchTab('loot')">üí∞ Loot</button>
            <button class="tab-button p-3 flex-1 text-sm font-semibold text-gray-400 transition duration-300 min-w-[100px]" onclick="switchTab('soundboard')">üîä Sound</button>
            <button class="tab-button p-3 flex-1 text-sm font-semibold text-gray-400 transition duration-300 min-w-[100px]" onclick="switchTab('notes')">üìú Notes</button>
            <button class="tab-button p-3 flex-1 text-sm font-semibold transition duration-300 active min-w-[100px]" onclick="switchTab('homebrew')">üç∫ Homebrew</button>
            <button class="tab-button p-3 flex-1 text-sm font-semibold text-gray-400 transition duration-300 min-w-[100px]" onclick="switchTab('rules')">üìñ Rules</button>
            <button class="tab-button p-3 flex-1 text-sm font-semibold text-gray-400 transition duration-300 min-w-[100px]" onclick="switchTab('help')">‚ùì Help</button>
        </div>

        <!-- Content -->
        <div id="content-area">
            <!-- Prep Tab -->
            <div id="improv" class="tab-content">
                <!-- AI Configuration Card -->
                <div class="card p-4 rounded-lg shadow-xl mb-6 border border-indigo-500/30">
                    <h2 class="text-xl font-semibold mb-2 text-indigo-300">üîë AI Configuration</h2>
                    
                    <!-- Warning Message -->
                    <p class="text-xs text-yellow-400 mb-2 font-bold">‚ö†Ô∏è You need to provide an API Key before using AI features.</p>
                    
                    <p class="text-xs text-gray-400 mb-3">Enter your Google Gemini API Key. Saved locally. <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-indigo-400 hover:underline">Get Key Here</a>.</p>
                    <div class="flex gap-2">
                        <input type="password" id="user-api-key" placeholder="Paste API Key (AIza...)" class="flex-1 p-2 rounded-lg input-style text-sm">
                        <button onclick="window.saveApiKey()" class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg text-sm transition duration-200">Save</button>
                    </div>
                    <p id="api-key-status" class="mt-2 text-xs text-gray-500">Status: No key saved.</p>
                </div>

                <!-- Combat NPC Stats -->
                <div class="card p-4 rounded-lg shadow-xl mb-6">
                    <h2 class="text-xl font-semibold mb-4 text-green-300">Combat NPC Stats</h2>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div><label class="block text-xs font-medium text-gray-400 mb-1">Level/CR</label><input type="text" id="npc-level" value="3" class="w-full p-2 rounded-lg input-style text-sm"></div>
                        <div><label class="block text-xs font-medium text-gray-400 mb-1">NPC Type</label><input type="text" id="npc-type" value="Shadow Rogue" class="w-full p-2 rounded-lg input-style text-sm"></div>
                    </div>
                    <button onclick="window.generateCombatNpc()" id="generate-combat-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded-lg flex items-center justify-center"><span id="generate-combat-text">Generate Stats</span><div id="combat-loading-spinner" class="loading-spinner ml-2 hidden"></div></button>
                    <p id="combat-status-message" class="mt-2 text-sm text-center text-red-400 hidden"></p>
                </div>
                
                <!-- Name Generator -->
                <div class="card p-4 rounded-lg shadow-xl mb-6">
                    <h2 class="text-xl font-semibold mb-4 text-pink-300">Name Generator</h2>
                    <div class="flex gap-2 mb-4">
                       <select id="name-race" class="flex-1 p-2 rounded-lg input-style text-sm">
                            <option value="Human">Human</option>
                            <option value="Elf">Elf</option>
                            <option value="Dwarf">Dwarf</option>
                            <option value="Orc">Orc/Half-Orc</option>
                            <option value="Halfling">Halfling</option>
                            <option value="Tiefling">Tiefling</option>
                            <option value="Dragonborn">Dragonborn</option>
                            <option value="Gnome">Gnome</option>
                            <option value="Goblin">Goblin</option>
                            <option value="Tabaxi">Tabaxi (Catfolk)</option>
                            <option value="Kenku">Kenku</option>
                            <option value="Genasi">Genasi</option>
                        </select>
                        <select id="name-gender" class="w-24 p-2 rounded-lg input-style text-sm">
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                        </select>
                        <button onclick="window.generateNames()" class="bg-pink-700 hover:bg-pink-600 text-white font-bold px-4 rounded-lg text-sm">Generate</button>
                    </div>
                    <div id="name-output" class="text-gray-300 text-sm min-h-[2rem] flex flex-col gap-1">
                        <p class="text-gray-500 text-xs italic">Select options to generate names.</p>
                    </div>
                </div>

                <!-- Creative Lore -->
                <div class="card p-4 rounded-lg shadow-xl mb-6">
                    <h2 class="text-xl font-semibold mb-4 text-indigo-300">Creative Lore</h2>
                    <textarea id="improv-prompt" rows="3" class="w-full p-3 rounded-lg input-style resize-none" placeholder="Enter a prompt..."></textarea>
                    <button onclick="window.generateCreativeIdea()" id="generate-button" class="mt-4 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 rounded-lg flex items-center justify-center"><span id="generate-text">Generate Idea</span><div id="creative-loading-spinner" class="loading-spinner ml-2 hidden"></div></button>
                </div>

                <!-- Settlement Generator -->
                <div class="card p-4 rounded-lg shadow-xl mb-6">
                    <h2 class="text-xl font-semibold mb-4 text-teal-300">Settlement Generator</h2>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div><label class="block text-xs font-medium text-gray-400 mb-1">Type</label><select id="settlement-type" class="w-full p-2 rounded-lg input-style text-sm"><option value="Village">Village</option><option value="Town">Town</option><option value="City">City</option></select></div>
                        <div><label class="block text-xs font-medium text-gray-400 mb-1">Vibe</label><input type="text" id="settlement-vibe" value="haunted fishing village" class="w-full p-2 rounded-lg input-style text-sm"></div>
                    </div>
                    <button onclick="window.generateSettlement()" id="generate-settlement-button" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 rounded-lg flex items-center justify-center"><span id="generate-settlement-text">Generate</span><div id="settlement-loading-spinner" class="loading-spinner ml-2 hidden"></div></button>
                </div>
                
                <!-- Result Display Card -->
                <div class="card p-4 rounded-lg shadow-xl">
                    <h2 class="text-xl font-semibold mb-4 text-indigo-300">Result</h2>
                    <div id="ai-image-output" class="mb-4 hidden rounded-lg overflow-hidden shadow-lg"><img id="generated-image" class="w-full h-auto object-cover bg-gray-700/30 min-h-[150px]"><p id="image-loading-status" class="text-center text-gray-400 p-3 bg-gray-800"></p></div>
                    <div id="ai-output" class="whitespace-pre-wrap min-h-[100px] bg-gray-700/30 p-3 rounded-lg text-gray-300">Results appear here.</div>
                    <p id="npc-save-status" class="mt-2 text-sm text-center hidden"></p>
                    <div id="save-options-creative" class="mt-4 hidden">
                        <p class="text-sm text-center text-gray-400 mb-2">Save to:</p>
                        <div class="grid grid-cols-3 gap-2"><button onclick="window.saveGeneratedContent('prepNotes')" class="save-notes-btn bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 rounded-lg text-xs">Notes</button><button onclick="window.saveGeneratedContent('enemyNotes')" class="save-notes-btn bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 rounded-lg text-xs">Enemies</button><button onclick="window.saveGeneratedContent('npcNotes')" class="save-notes-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg text-xs">NPCs</button></div>
                    </div>
                </div>
            </div>

            <!-- Combat Tab -->
            <div id="combat" class="tab-content hidden">
                <div class="card p-4 rounded-lg shadow-xl">
                    
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-indigo-300">Tracker</h2>
                        
                        <div class="flex items-center gap-1 bg-gray-900 px-2 py-1 rounded-lg border border-gray-700 shadow-inner">
                            <input type="number" id="timer-min" value="00" min="0" max="99" class="w-12 bg-transparent text-red-400 font-mono font-bold text-lg text-center outline-none p-0 border-none focus:ring-0 placeholder-red-400/50 appearance-none" onfocus="this.select()">
                            <span class="text-red-400 font-bold">:</span>
                            <input type="number" id="timer-sec" value="00" min="0" max="59" class="w-12 bg-transparent text-red-400 font-mono font-bold text-lg text-center outline-none p-0 border-none focus:ring-0 placeholder-red-400/50 appearance-none" onfocus="this.select()">
                            
                            <button onclick="window.toggleTimer()" id="btn-timer-toggle" class="ml-2 text-xs bg-green-700 hover:bg-green-600 text-white px-2 py-1 rounded font-bold transition">‚ñ∂</button>
                            <button onclick="window.resetTimer()" class="text-xs bg-gray-600 hover:bg-gray-500 text-white px-2 py-1 rounded font-bold transition">‚Ü∫</button>
                        </div>
                    </div>

                    <div class="flex justify-between items-center mb-2"><span id="db-status" class="text-xs px-2 py-1 rounded bg-gray-700 text-gray-400">Connecting...</span></div>
                    
                    <div class="flex flex-wrap gap-2 mb-4">
                        <input id="combatant-name" type="text" placeholder="Name" class="flex-1 min-w-[100px] p-2 rounded-lg input-style">
                        <input id="combatant-init" type="number" placeholder="Init" class="w-20 p-2 rounded-lg input-style text-center text-sm">
                        <input id="combatant-ac" type="number" placeholder="AC" class="w-16 p-2 rounded-lg input-style text-center text-sm">
                        <input id="combatant-hp" type="number" placeholder="HP" class="w-16 p-2 rounded-lg input-style text-center text-sm">
                        <button onclick="addCombatant()" id="add-combatant-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold px-3 py-2 rounded-lg text-sm">Add</button>
                    </div>
                    
                    <div class="card p-4 rounded-lg shadow-inner mb-4 bg-gray-800/50">
                        <h3 class="text-md font-semibold mb-3 text-indigo-400">Dice Roller</h3>
                        
                        <div class="flex flex-wrap gap-2 mb-3">
                            <div class="flex items-center gap-2 bg-gray-900/50 p-2 rounded-lg border border-gray-700 flex-1">
                                <span class="text-xs text-gray-400">Color:</span>
                                <input type="color" id="dice-color-picker" value="#6366f1" class="w-6 h-6 bg-transparent border-none cursor-pointer rounded">
                                <button onclick="window.customDiceColor = null; document.getElementById('dice-color-picker').value='#6366f1'" class="text-[10px] text-indigo-400 hover:text-white underline ml-auto">Reset</button>
                            </div>
                            <div class="flex items-center gap-2 bg-gray-900/50 p-2 rounded-lg border border-gray-700 flex-[2]">
                                <span class="text-xs text-gray-400">Texture:</span>
                                <input type="file" id="dice-texture-input" accept="image/*" onchange="window.uploadDiceTexture(this)" class="text-[10px] text-gray-500 file:py-1 file:px-2 file:rounded-full file:border-0 file:text-xs file:bg-indigo-600 file:text-white hover:file:bg-indigo-700 w-full">
                                <button onclick="window.resetDiceTexture()" class="text-[10px] text-red-400 hover:text-red-300 underline ml-auto">Reset</button>
                            </div>
                        </div>

                        <div class="flex items-center space-x-2 mb-4 pb-4 border-b border-gray-700">
                            <button onclick="window.rollD20()" class="w-1/3 bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded-lg text-sm">Init D20</button>
                            <div id="last-roll-display" class="w-1/3 text-3xl font-extrabold text-center text-yellow-400 border-2 border-yellow-400 p-1 rounded-lg bg-gray-900/50 select-none">?</div>
                            <div class="w-1/3 flex flex-col gap-1">
                                <select id="combatant-selector" class="w-full p-1 rounded-lg input-style text-xs"><option value="" disabled selected>Target</option></select>
                                <button onclick="window.assignInitiativeRoll()" id="assign-roll-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 rounded-lg text-xs disabled:opacity-50" disabled>Set Init</button>
                            </div>
                        </div>

                        <div class="grid grid-cols-4 sm:grid-cols-7 gap-2 mb-4">
                            <button onclick="window.rollSimple(4)" class="bg-gray-700 hover:bg-gray-600 text-white text-xs font-bold py-2 rounded border border-gray-600">d4</button>
                            <button onclick="window.rollSimple(6)" class="bg-gray-700 hover:bg-gray-600 text-white text-xs font-bold py-2 rounded border border-gray-600">d6</button>
                            <button onclick="window.rollSimple(8)" class="bg-gray-700 hover:bg-gray-600 text-white text-xs font-bold py-2 rounded border border-gray-600">d8</button>
                            <button onclick="window.rollSimple(10)" class="bg-gray-700 hover:bg-gray-600 text-white text-xs font-bold py-2 rounded border border-gray-600">d10</button>
                            <button onclick="window.rollSimple(12)" class="bg-gray-700 hover:bg-gray-600 text-white text-xs font-bold py-2 rounded border border-gray-600">d12</button>
                            <button onclick="window.rollSimple(20)" class="bg-gray-700 hover:bg-gray-600 text-white text-xs font-bold py-2 rounded border border-gray-600">d20</button>
                            <button onclick="window.rollSimple(100)" class="bg-gray-700 hover:bg-gray-600 text-white text-xs font-bold py-2 rounded border border-gray-600 col-span-2 sm:col-span-1">d100</button>
                        </div>
                        
                        <div class="flex items-center gap-2 bg-gray-900/30 p-2 rounded-lg">
                            <input id="dice-num" type="number" value="1" class="w-10 p-1 text-center text-sm rounded bg-gray-700 text-white border border-gray-600" placeholder="#">
                            <span class="text-gray-400 text-xs">d</span>
                            <input id="dice-type" type="number" value="20" class="w-10 p-1 text-center text-sm rounded bg-gray-700 text-white border border-gray-600" placeholder="Type">
                            <span class="text-gray-400 text-xs">+</span>
                            <input id="dice-mod" type="number" value="0" class="w-10 p-1 text-center text-sm rounded bg-gray-700 text-white border border-gray-600" placeholder="Mod">
                            <button onclick="window.rollCustomDice()" class="flex-1 bg-purple-600 hover:bg-purple-500 text-white font-bold py-1 rounded text-sm">Roll</button>
                        </div>
                        <div class="mt-3 text-center bg-gray-900/50 rounded p-2 min-h-[3rem] flex flex-col justify-center">
                            <div id="dice-roll-result" class="text-xl font-bold text-green-400">Roll to start</div>
                            <div id="dice-roll-details" class="text-xs text-gray-500"></div>
                        </div>
                    </div>

                    <div class="flex justify-between items-center mb-4">
                        <button onclick="window.sortInitiative()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-3 rounded-lg text-sm">Sort</button>
                        <button onclick="window.nextTurn()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-3 rounded-lg text-sm">Next &raquo;</button>
                        <button onclick="window.clearCombat()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-3 rounded-lg text-sm">Clear</button>
                    </div>
                    
                    <div id="initiative-list" class="scrollable-content space-y-2"><p class="text-center text-gray-500 pt-8">List empty.</p></div>
                </div>
            </div>


            <!-- Statblocks Tab -->
            <div id="statblocks" class="tab-content hidden">
                <div class="card p-4 rounded-lg shadow-xl mb-6">
                    <h2 class="text-xl font-semibold mb-4 text-indigo-300">Save NPC</h2>
                    <div class="grid grid-cols-2 gap-2 mb-4">
                        <input id="stat-name" type="text" placeholder="Name" class="col-span-2 p-2 rounded-lg input-style">
                        <input id="stat-hp" type="number" placeholder="HP" class="p-2 rounded-lg input-style text-center text-sm">
                        <input id="stat-ac" type="number" placeholder="AC" class="p-2 rounded-lg input-style text-center text-sm">
                        <input id="stat-tohit" type="number" placeholder="Hit Mod" class="p-2 rounded-lg input-style text-center text-sm">
                        <input id="stat-init-mod" type="number" placeholder="Init Mod" class="p-2 rounded-lg input-style text-center text-sm">
                        <input id="stat-dmg" type="text" placeholder="Damage" class="col-span-2 p-2 rounded-lg input-style">
                    </div>
                    <button onclick="saveStatblock()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 rounded-lg">Save</button>
                    <p id="statblock-status" class="mt-2 text-sm text-center text-gray-400"></p>
                </div>
                <div class="card p-4 rounded-lg shadow-xl">
                    <h2 class="text-xl font-semibold mb-4 text-indigo-300">Saved</h2>
                    <div id="statblocks-list" class="scrollable-content space-y-2"><p class="text-center text-gray-500 pt-8">No stats saved.</p></div>
                </div>
            </div>

            <!-- Monsters Tab -->
            <div id="monsters" class="tab-content hidden">
                
                <div class="card p-4 rounded-lg shadow-xl mb-6 border border-blue-500/30">
                    <h2 class="text-xl font-semibold mb-4 text-blue-300">üìö SRD Compendium</h2>
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="compendium-search" placeholder="Name..." class="flex-1 p-2 rounded-lg input-style text-sm" onkeypress="if(event.key==='Enter') window.searchCompendium()">
                        <select id="compendium-cr" class="w-24 p-2 rounded-lg input-style text-sm font-bold text-center" onchange="window.searchCompendium()">
                            <option value="">Any CR</option><option value="0">0</option><option value="1/8">1/8</option><option value="1/4">1/4</option><option value="1/2">1/2</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option><option value="11">11</option><option value="12">12</option><option value="13">13</option><option value="14">14</option><option value="15">15</option><option value="16">16</option><option value="17">17</option><option value="18">18</option><option value="19">19</option><option value="20">20</option><option value="21">21</option><option value="22">22</option><option value="23">23</option><option value="24">24</option><option value="30">30</option>
                        </select>
                        <button onclick="window.searchCompendium()" class="bg-blue-600 hover:bg-blue-500 text-white font-bold px-3 rounded-lg text-sm">üîç</button>
                    </div>
                    <div id="compendium-results" class="scrollable-content space-y-2 max-h-[500px]">
    <p class="text-center text-gray-500 text-xs">Search by Name or CR.</p>
</div>

               </div> <div class="card p-4 rounded-lg shadow-xl mb-6 border border-red-500/30">
                    <h2 class="text-xl font-semibold mb-4 text-red-300">‚öñÔ∏è Encounter Calculator</h2>
                    <div class="grid grid-cols-2 gap-4 mb-4 pb-4 border-b border-gray-700">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Party Size</label>
                            <input type="number" id="calc-party-size" value="4" min="1" class="w-full p-2 rounded-lg input-style text-center font-bold" onchange="window.calcEncounter()">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Avg Level</label>
                            <input type="number" id="calc-party-level" value="3" min="1" max="20" class="w-full p-2 rounded-lg input-style text-center font-bold" onchange="window.calcEncounter()">
                        </div>
                    </div>
                    <div class="flex gap-2 mb-4">
                        <select id="calc-cr" class="flex-1 p-2 rounded-lg input-style text-sm">
                            <option value="10">CR 0</option><option value="25">CR 1/8</option><option value="50">CR 1/4</option><option value="100">CR 1/2</option>
                            <option value="200">CR 1</option><option value="450">CR 2</option><option value="700">CR 3</option><option value="1100">CR 4</option>
                            <option value="1800">CR 5</option><option value="2300">CR 6</option><option value="2900">CR 7</option><option value="3900">CR 8</option>
                            <option value="5000">CR 9</option><option value="5900">CR 10</option><option value="7200">CR 11</option><option value="8400">CR 12</option>
                            <option value="10000">CR 13</option><option value="11500">CR 14</option><option value="13000">CR 15</option><option value="15000">CR 16</option>
                            <option value="18000">CR 17</option><option value="20000">CR 18</option><option value="22000">CR 19</option><option value="25000">CR 20</option>
                        </select>
                        <input type="number" id="calc-count" value="1" min="1" class="w-16 p-2 rounded-lg input-style text-center font-bold" placeholder="#">
                        <button onclick="window.addCalcMonster()" class="bg-red-700 hover:bg-red-600 text-white font-bold px-4 rounded-lg shadow-lg">+</button>
                    </div>
                    <div id="calc-monster-list" class="flex flex-wrap gap-2 mb-4 min-h-[2rem]"></div>
                    <div id="calc-result" class="bg-gray-900 p-4 rounded-lg text-center border border-gray-700 transition duration-300">
                        <div class="text-gray-500 text-xs uppercase tracking-widest mb-1">Difficulty</div>
                        <div id="calc-difficulty-text" class="text-2xl font-bold text-gray-500">Add Monsters...</div>
                        <div id="calc-xp-details" class="text-[10px] text-gray-500 mt-1"></div>
                    </div>
                    <button onclick="window.clearCalc()" class="mt-2 text-xs text-red-400 underline w-full text-center">Reset Calculator</button>
                    <details class="mt-4 pt-2 border-t border-gray-700 text-xs text-gray-400 select-none group">
                        <summary class="cursor-pointer hover:text-indigo-300 transition font-bold list-none flex items-center gap-2"><span>‚ÑπÔ∏è What is Daily Budget?</span></summary>
                        <div class="mt-2 pl-3 border-l-2 border-indigo-500 bg-gray-800/50 p-2 rounded">
                            <p class="mb-2">The <strong>Daily Budget</strong> is the total XP a party can handle before a <strong>Long Rest</strong>.</p>
                            <ul class="list-disc list-inside space-y-1"><li><strong>33%</strong>: Safe (~2 more fights).</li><li><strong>50%</strong>: Taxing.</li><li><strong>100%+</strong>: <span class="text-red-400">NOVA (Rest needed).</span></li></ul>
                        </div>
                    </details>
                </div>

                <div class="card p-4 rounded-lg shadow-xl mb-6">
                    <h2 class="text-xl font-semibold mb-4 text-green-300">Monster Generator</h2>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div><label class="block text-xs font-medium text-gray-400 mb-1">Name</label><input type="text" id="monster-name" value="Cave Troll" class="w-full p-2 rounded-lg input-style text-sm"></div>
                        <div><label class="block text-xs font-medium text-gray-400 mb-1">CR</label><input type="text" id="monster-cr" value="4" class="w-full p-2 rounded-lg input-style text-sm"></div>
                    </div>
                    <button onclick="generateMonsterStatblock()" id="generate-monster-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded-lg flex items-center justify-center"><span id="generate-monster-text">Generate</span><div id="monster-loading-spinner" class="loading-spinner ml-2 hidden"></div></button>
                    <p id="monster-status-message" class="mt-2 text-sm text-center text-red-400 hidden"></p>
                </div>

                <div class="card p-4 rounded-lg shadow-xl">
                    <h2 class="text-xl font-semibold mb-4 text-indigo-300">Result</h2>
                    <div id="monster-output" class="min-h-[100px] bg-gray-700/30 p-3 rounded-lg text-gray-300">Stat block will appear here.</div>
                    <p id="monster-save-status" class="mt-2 text-sm text-center hidden"></p>
                    <div id="save-options-monster" class="mt-4 hidden">
                        <div class="grid grid-cols-2 gap-2"><button onclick="addMonsterToStatblocks()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 rounded-lg text-xs">Save to Stats</button><button onclick="saveMonsterToNotes()" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 rounded-lg text-xs">Save to Notes</button></div>
                    </div>
                </div>
            </div>
            
            <!-- Loot Tab -->
            <div id="loot" class="tab-content hidden">
                <div class="card p-4 rounded-lg shadow-xl mb-6">
                    <h2 class="text-xl font-semibold mb-4 text-yellow-300">Loot Generator</h2>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div class="col-span-2"><label class="block text-xs font-medium text-gray-400 mb-1">Source</label>
                            <select id="loot-source" class="w-full p-2 rounded-lg input-style text-sm">
                                <option value="ai">AI Generator (Creative)</option>
                                <option value="wiki">Official Wiki (Rules)</option>
                            </select>
                        </div>
                        <div><label class="block text-xs font-medium text-gray-400 mb-1">Level/CR</label><input type="text" id="loot-level" value="3" class="w-full p-2 rounded-lg input-style text-sm"></div>
                        <div><label class="block text-xs font-medium text-gray-400 mb-1">Type</label><select id="loot-type" class="w-full p-2 rounded-lg input-style text-sm"><option value="Individual">Individual</option><option value="Hoard">Hoard</option><option value="Shop Inventory">Shop</option></select></div>
                    </div>
                    <button onclick="generateLoot()" id="generate-loot-button" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 rounded-lg flex items-center justify-center"><span id="generate-loot-text">Generate</span><div id="loot-loading-spinner" class="loading-spinner ml-2 hidden"></div></button>
                </div>
                <div class="card p-4 rounded-lg shadow-xl mb-6">
                    <h2 class="text-xl font-semibold mb-4 text-indigo-300">Result</h2>
                    <div id="loot-output" class="whitespace-pre-wrap min-h-[100px] bg-gray-700/30 p-3 rounded-lg text-gray-300">Loot appears here.</div>
                    <button onclick="saveGeneratedContent('lootNotes')" class="mt-4 w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 rounded-lg text-sm">Save to Loot Notes</button>
                </div>
                
                <div class="card p-4 rounded-lg shadow-xl mt-6 border border-yellow-700/30">
                    <h2 class="text-xl font-semibold mb-4 text-yellow-400">üí∞ Loot Splitter</h2>
                    <div class="grid grid-cols-5 gap-2 mb-1 text-center text-[10px] font-bold text-gray-500 uppercase tracking-wider"><div>PP</div><div>GP</div><div>EP</div><div>SP</div><div>CP</div></div>
                    <div class="grid grid-cols-5 gap-2 mb-4">
                        <input type="number" id="loot-pp" class="p-2 rounded bg-gray-800 text-white text-center border border-gray-600 focus:border-yellow-500 outline-none" placeholder="0">
                        <input type="number" id="loot-gp" class="p-2 rounded bg-gray-800 text-white text-center border border-gray-600 focus:border-yellow-500 outline-none" placeholder="0">
                        <input type="number" id="loot-ep" class="p-2 rounded bg-gray-800 text-white text-center border border-gray-600 focus:border-yellow-500 outline-none" placeholder="0">
                        <input type="number" id="loot-sp" class="p-2 rounded bg-gray-800 text-white text-center border border-gray-600 focus:border-yellow-500 outline-none" placeholder="0">
                        <input type="number" id="loot-cp" class="p-2 rounded bg-gray-800 text-white text-center border border-gray-600 focus:border-yellow-500 outline-none" placeholder="0">
                    </div>
                    <div class="flex gap-3 items-center mb-4 bg-gray-900/30 p-2 rounded">
                        <span class="text-sm text-gray-300 font-bold">Party Size:</span>
                        <input type="number" id="loot-party-size" value="4" class="w-16 p-2 rounded bg-gray-800 text-white text-center border border-gray-600 font-bold">
                        <button onclick="window.splitLoot()" class="flex-1 bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-2 rounded transition shadow-lg shadow-yellow-900/20">Split Loot</button>
                    </div>
                    <div id="loot-split-result" class="text-sm text-yellow-100 text-center min-h-[1.5em] font-mono bg-gray-800/50 p-2 rounded border border-gray-700">Enter amounts to split...</div>
                </div>
            </div>

            <div id="soundboard" class="tab-content hidden">
                <div class="card p-4 rounded-lg shadow-xl mb-6">
                    <h2 class="text-xl font-semibold mb-4 text-pink-300">Synth Soundboard</h2>
                    <div class="mb-6 flex items-center gap-4 bg-gray-800 p-3 rounded-lg border border-gray-700">
                        <label for="master-volume" class="text-sm font-bold text-indigo-400">Master Volume:</label>
                        <input type="range" id="master-volume" min="0" max="1" step="0.01" value="0.5" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-green-400">
                    </div>
                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-4 mb-6">
                        <button onclick="playTone('success')" class="sound-btn bg-green-600 hover:bg-green-500 text-white font-bold py-4 rounded-lg shadow-lg border-b-4 border-green-800 flex flex-col items-center justify-center"><span class="text-2xl mb-1">‚ú®</span><span class="text-xs">Success</span></button>
                        <button onclick="playTone('critical')" class="sound-btn bg-green-700 hover:bg-green-600 text-white font-bold py-4 rounded-lg shadow-lg border-b-4 border-green-900 flex flex-col items-center justify-center"><span class="text-2xl mb-1">üéâ</span><span class="text-xs">Crit</span></button>
                        <button onclick="playTone('fail')" class="sound-btn bg-red-600 hover:bg-red-500 text-white font-bold py-4 rounded-lg shadow-lg border-b-4 border-red-800 flex flex-col items-center justify-center"><span class="text-2xl mb-1">‚ùå</span><span class="text-xs">Fail</span></button>
                        <button onclick="playTone('combat_start')" class="sound-btn bg-orange-600 hover:bg-orange-500 text-white font-bold py-4 rounded-lg shadow-lg border-b-4 border-orange-800 flex flex-col items-center justify-center"><span class="text-2xl mb-1">‚öîÔ∏è</span><span class="text-xs">Combat</span></button>
                        <button onclick="playTone('spell')" class="sound-btn bg-purple-600 hover:bg-purple-500 text-white font-bold py-4 rounded-lg shadow-lg border-b-4 border-purple-800 flex flex-col items-center justify-center"><span class="text-2xl mb-1">üîÆ</span><span class="text-xs">Spell</span></button>
                        <button onclick="playTone('mystery')" class="sound-btn bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-4 rounded-lg shadow-lg border-b-4 border-indigo-800 flex flex-col items-center justify-center"><span class="text-2xl mb-1">üëª</span><span class="text-xs">Mystery</span></button>
                        <button onclick="playTone('rest')" class="sound-btn bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-lg shadow-lg border-b-4 border-blue-800 flex flex-col items-center justify-center"><span class="text-2xl mb-1">üí§</span><span class="text-xs">Rest</span></button>
                        <button onclick="playTone('trap')" class="sound-btn bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-4 rounded-lg shadow-lg border-b-4 border-yellow-800 flex flex-col items-center justify-center"><span class="text-2xl mb-1">‚ö†Ô∏è</span><span class="text-xs">Trap</span></button>
                        <button onclick="playTone('boss')" class="sound-btn bg-gray-700 hover:bg-gray-600 text-white font-bold py-4 rounded-lg shadow-lg border-b-4 border-gray-900 flex flex-col items-center justify-center"><span class="text-2xl mb-1">üíÄ</span><span class="text-xs">Boss</span></button>
                    </div>
                    <h3 class="text-sm font-semibold text-gray-400 mb-2 uppercase tracking-wider border-t border-gray-700 pt-4">Creature Sounds</h3>
                    <div class="grid grid-cols-2 sm:grid-cols-5 gap-3 mb-6">
                        <button onclick="playTone('wolf')" class="sound-btn bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 rounded-lg shadow-md border-b-4 border-gray-800 flex flex-col items-center justify-center"><span class="text-xl mb-1">üê∫</span><span class="text-xs">Wolf</span></button>
                        <button onclick="playTone('bear')" class="sound-btn bg-orange-800 hover:bg-orange-700 text-white font-bold py-3 rounded-lg shadow-md border-b-4 border-orange-950 flex flex-col items-center justify-center"><span class="text-xl mb-1">üêª</span><span class="text-xs">Bear</span></button>
                        <button onclick="playTone('bird')" class="sound-btn bg-sky-600 hover:bg-sky-500 text-white font-bold py-3 rounded-lg shadow-md border-b-4 border-sky-800 flex flex-col items-center justify-center"><span class="text-xl mb-1">üê¶</span><span class="text-xs">Bird</span></button>
                        <button onclick="playTone('snake')" class="sound-btn bg-green-800 hover:bg-green-700 text-white font-bold py-3 rounded-lg shadow-md border-b-4 border-green-950 flex flex-col items-center justify-center"><span class="text-xl mb-1">üêç</span><span class="text-xs">Snake</span></button>
                        <button onclick="playTone('insect')" class="sound-btn bg-yellow-700 hover:bg-yellow-600 text-white font-bold py-3 rounded-lg shadow-md border-b-4 border-yellow-900 flex flex-col items-center justify-center"><span class="text-xl mb-1">ü¶ó</span><span class="text-xs">Insect</span></button>
                    </div>
                    <h3 class="text-sm font-semibold text-gray-400 mb-2 uppercase tracking-wider border-t border-gray-700 pt-4">Ambience Loops</h3>
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                        <button onclick="toggleAmbience('village')" id="ambience-village" class="sound-btn bg-teal-800 hover:bg-teal-700 text-white font-bold py-3 rounded-lg shadow-md border border-teal-600 flex flex-col items-center justify-center"><span class="text-xl mb-1">üèòÔ∏è</span><span class="text-xs">Village</span></button>
                        <button onclick="toggleAmbience('city')" id="ambience-city" class="sound-btn bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 rounded-lg shadow-md border border-gray-500 flex flex-col items-center justify-center"><span class="text-xl mb-1">üè∞</span><span class="text-xs">City</span></button>
                        <button onclick="toggleAmbience('tavern')" id="ambience-tavern" class="sound-btn bg-yellow-900 hover:bg-yellow-800 text-white font-bold py-3 rounded-lg shadow-md border border-yellow-700 flex flex-col items-center justify-center"><span class="text-xl mb-1">üç∫</span><span class="text-xs">Tavern</span></button>
                        <button onclick="toggleAmbience('ocean')" id="ambience-ocean" class="sound-btn bg-blue-900 hover:bg-blue-800 text-white font-bold py-3 rounded-lg shadow-md border border-blue-700 flex flex-col items-center justify-center"><span class="text-xl mb-1">‚öì</span><span class="text-xs">Sea Shanty</span></button>
                        <button onclick="toggleAmbience('dungeon')" id="ambience-dungeon" class="sound-btn bg-purple-900 hover:bg-purple-800 text-white font-bold py-3 rounded-lg shadow-md border border-purple-700 flex flex-col items-center justify-center"><span class="text-xl mb-1">‚õìÔ∏è</span><span class="text-xs">Dungeon</span></button>
                        <button onclick="toggleAmbience('battle_minor')" id="ambience-battle_minor" class="sound-btn bg-red-900 hover:bg-red-800 text-white font-bold py-3 rounded-lg shadow-md border border-red-700 flex flex-col items-center justify-center"><span class="text-xl mb-1">üõ°Ô∏è</span><span class="text-xs">Minor Battle</span></button>
                        <button onclick="toggleAmbience('battle_major')" id="ambience-battle_major" class="sound-btn bg-gray-800 hover:bg-gray-700 text-white font-bold py-3 rounded-lg shadow-md border border-gray-600 flex flex-col items-center justify-center"><span class="text-xl mb-1">üî•</span><span class="text-xs">Major Battle</span></button>
                        <button onclick="toggleAmbience('sleep')" id="ambience-sleep" class="sound-btn bg-indigo-900 hover:bg-indigo-800 text-white font-bold py-3 rounded-lg shadow-md border border-indigo-700 flex flex-col items-center justify-center"><span class="text-xl mb-1">‚õ∫</span><span class="text-xs">Rest</span></button>
                    </div>
                    <div id="ambience-status" class="mt-2 text-center text-xs text-green-400 h-4"></div>
                </div>
            </div>

            <div id="notes" class="tab-content hidden">
                <div class="card p-4 rounded-lg shadow-xl">
                    <h2 class="text-xl font-semibold mb-4 text-indigo-300">Notes</h2>
                    <div class="flex border-b border-gray-700 mb-4 -mx-4 px-4 overflow-x-auto">
                        <button class="sub-tab-button p-2 text-sm font-semibold transition duration-300 active" data-subtab="prepNotes" onclick="switchSubTab('prepNotes')">üìú General</button>
                        <button class="sub-tab-button p-2 text-sm font-semibold text-gray-400 transition duration-300" data-subtab="enemyNotes" onclick="switchSubTab('enemyNotes')">üíÄ Enemies</button>
                        <button class="sub-tab-button p-2 text-sm font-semibold text-gray-400 transition duration-300" data-subtab="npcNotes" onclick="switchSubTab('npcNotes')">üë• NPCs</button>
                        <button class="sub-tab-button p-2 text-sm font-semibold text-gray-400 transition duration-300" data-subtab="lootNotes" onclick="switchSubTab('lootNotes')">üí∞ Loot</button>
                    </div>
                <div class="flex gap-2 mb-4">
                        <input type="text" id="notes-search" placeholder="Search notes..." class="flex-1 p-2 rounded-lg input-style text-sm focus:ring-2 focus:ring-indigo-500 outline-none" onkeypress="if(event.key==='Enter') window.renderStructuredNotes(window.currentSubTab)">
                        <button onclick="window.renderStructuredNotes(window.currentSubTab)" class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold px-4 rounded-lg text-sm">Search</button>
                    </div>
                    
                    <div id="prepNotes-sub-content" class="sub-tab-content"><div id="prepNotes-list" class="scrollable-content space-y-3"></div></div>
                    <div id="enemyNotes-sub-content" class="sub-tab-content hidden"><div id="enemyNotes-list" class="scrollable-content space-y-3"></div></div>
                    <div id="npcNotes-sub-content" class="sub-tab-content hidden"><div id="npcNotes-list" class="scrollable-content space-y-3"></div></div>
                    <div id="lootNotes-sub-content" class="sub-tab-content hidden"><div id="lootNotes-list" class="scrollable-content space-y-3"></div></div>
                    <button onclick="addNewNote(window.currentSubTab)" class="mt-4 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 rounded-lg transition duration-300">+ Add Manual Note</button>
                    <p id="notes-status" class="mt-2 text-sm text-center text-gray-400"></p>
                </div>
            </div>

            <div id="homebrew" class="tab-content hidden">
                <div class="card p-4 rounded-lg shadow-xl border border-orange-500/30">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-orange-300">üç∫ Homebrew Workshop</h2>
                        <div class="flex bg-gray-800 rounded-lg p-1 gap-1">
                            <button class="brew-sub-tab active px-3 py-1 text-xs font-bold rounded bg-orange-600 text-white transition" onclick="switchBrewMode('monster', this)">Monster</button>
                            <button class="brew-sub-tab px-3 py-1 text-xs font-bold rounded text-gray-400 hover:text-white transition" onclick="switchBrewMode('weapon', this)">Weapon</button>
                            <button class="brew-sub-tab px-3 py-1 text-xs font-bold rounded text-gray-400 hover:text-white transition" onclick="switchBrewMode('magic', this)">Item</button>
                            <div class="w-[1px] bg-gray-600 mx-1"></div>
                            <button class="brew-sub-tab px-3 py-1 text-xs font-bold rounded text-blue-300 hover:text-white hover:bg-blue-700 transition" onclick="switchBrewMode('community', this)">üåé Community</button>
                        </div>
                    </div>

                    <div id="brew-monster-area" class="animate-fade-in">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div class="space-y-2">
                                <label class="block text-xs text-gray-500 uppercase">Name & Type</label>
                                <input type="text" id="hb-mon-name" placeholder="Name (e.g. Void Stalker)" class="w-full p-2 rounded input-style text-sm font-bold mb-1">
                                <input type="text" id="hb-mon-type" placeholder="Type (e.g. Medium Undead)" class="w-full p-2 rounded input-style text-xs">

                                <div class="grid grid-cols-3 gap-2">
                                    <div><label class="block text-[10px] text-gray-500 uppercase">AC</label><input type="number" id="hb-mon-ac" placeholder="15" class="w-full p-2 rounded input-style text-sm text-center"></div>
                                    <div><label class="block text-[10px] text-gray-500 uppercase">HP</label><input type="number" id="hb-mon-hp" placeholder="45" class="w-full p-2 rounded input-style text-sm text-center"></div>
                                    <div><label class="block text-[10px] text-gray-500 uppercase">Spd</label><input type="text" id="hb-mon-spd" placeholder="30 ft." class="w-full p-2 rounded input-style text-sm text-center"></div>
                                </div>

                                <label class="block text-xs text-gray-500 uppercase mt-2">Ability Scores</label>
                                <div class="grid grid-cols-6 gap-1">
                                    <input type="number" id="hb-mon-str" placeholder="10" class="p-1 rounded input-style text-xs text-center" title="STR">
                                    <input type="number" id="hb-mon-dex" placeholder="10" class="p-1 rounded input-style text-xs text-center" title="DEX">
                                    <input type="number" id="hb-mon-con" placeholder="10" class="p-1 rounded input-style text-xs text-center" title="CON">
                                    <input type="number" id="hb-mon-int" placeholder="10" class="p-1 rounded input-style text-xs text-center" title="INT">
                                    <input type="number" id="hb-mon-wis" placeholder="10" class="p-1 rounded input-style text-xs text-center" title="WIS">
                                    <input type="number" id="hb-mon-cha" placeholder="10" class="p-1 rounded input-style text-xs text-center" title="CHA">
                                </div>
                            </div>

                            <div class="space-y-2">
                                <label class="block text-xs text-gray-500 uppercase">Combat Stats</label>
                                <div class="grid grid-cols-2 gap-2">
                                    <input type="number" id="hb-mon-init" placeholder="Init Mod (+2)" class="w-full p-2 rounded input-style text-sm">
                                    <input type="number" id="hb-mon-tohit" placeholder="Hit Bonus (+5)" class="w-full p-2 rounded input-style text-sm">
                                </div>
                                
                                <label class="block text-xs text-gray-500 uppercase">Main Attack</label>
                                <input type="text" id="hb-mon-atkname" placeholder="Attack Name (e.g. Claw)" class="w-full p-2 rounded input-style text-sm">
                                <input type="text" id="hb-mon-dmg" placeholder="Damage (e.g. 1d6 + 3 slashing)" class="w-full p-2 rounded input-style text-sm">
                                
                                <label class="block text-xs text-gray-500 uppercase">Abilities / Actions (Text)</label>
                                <textarea id="hb-mon-desc" rows="2" class="w-full p-2 rounded input-style text-sm resize-none" placeholder="Multiattack. The monster makes two attacks..."></textarea>
                            </div>
                        </div>

                        <button onclick="window.previewHomebrewMonster()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 rounded-lg mb-4 transition">üëÅÔ∏è Generate Statblock Preview</button>

                        <div id="hb-monster-preview" class="hidden mb-4 border border-yellow-700/50 rounded-lg overflow-hidden shadow-inner">
                            </div>

                        <div class="flex gap-2">
                            <button onclick="window.saveHomebrewMonster()" class="flex-1 bg-orange-700 hover:bg-orange-600 text-white font-bold py-3 rounded-lg shadow-lg transition">üíæ Save to Stats</button>
                            <button onclick="window.saveHomebrewToNotes('monster')" class="flex-1 bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 rounded-lg shadow-lg transition">üìú Save Note</button>
                        </div>
                    </div>

                    <div id="brew-weapon-area" class="hidden animate-fade-in">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div class="space-y-2">
                                <label class="block text-xs text-gray-500 uppercase">Weapon Name</label>
                                <input type="text" id="hb-wep-name" placeholder="e.g. Blade of Embers" class="w-full p-2 rounded input-style text-sm font-bold">
                                <div class="grid grid-cols-2 gap-2">
                                    <div><label class="block text-xs text-gray-500 uppercase">Damage</label><input type="text" id="hb-wep-dmg" placeholder="1d8" class="w-full p-2 rounded input-style text-sm"></div>
                                    <div><label class="block text-xs text-gray-500 uppercase">Type</label><input type="text" id="hb-wep-type" placeholder="Fire" class="w-full p-2 rounded input-style text-sm"></div>
                                </div>
                            </div>
                            <div class="space-y-2">
                                <label class="block text-xs text-gray-500 uppercase">Properties / Lore</label>
                                <textarea id="hb-wep-props" rows="3" class="w-full p-2 rounded input-style text-sm resize-none" placeholder="Finesse, Light..."></textarea>
                                <div class="flex gap-2">
                                    <button onclick="window.saveHomebrewWeapon()" class="flex-1 bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 rounded-lg shadow-lg transition">Save Weapon</button>
                                    <button onclick="window.saveHomebrewToNotes('weapon')" class="flex-1 bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 rounded-lg shadow-lg transition">üìú Save Note</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="brew-magic-area" class="hidden animate-fade-in">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div class="space-y-2">
                                <label class="block text-xs text-gray-500 uppercase">Item Name</label>
                                <input type="text" id="hb-item-name" placeholder="e.g. Ring of Jumping" class="w-full p-2 rounded input-style text-sm font-bold">
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="block text-xs text-gray-500 uppercase">Rarity</label>
                                        <select id="hb-item-rarity" class="w-full p-2 rounded input-style text-sm">
                                            <option value="Common">Common</option><option value="Uncommon">Uncommon</option>
                                            <option value="Rare">Rare</option><option value="Very Rare">Very Rare</option>
                                            <option value="Legendary">Legendary</option><option value="Artifact">Artifact</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-500 uppercase">Type</label>
                                        <select id="hb-item-type" class="w-full p-2 rounded input-style text-sm">
                                            <option value="Wondrous Item">Wondrous</option><option value="Ring">Ring</option>
                                            <option value="Wand">Wand</option><option value="Potion">Potion</option>
                                            <option value="Scroll">Scroll</option><option value="Staff">Staff</option>
                                            <option value="Armor">Armor</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2 pt-2">
                                    <input type="checkbox" id="hb-item-attune" class="w-4 h-4 accent-indigo-500">
                                    <label for="hb-item-attune" class="text-sm text-gray-300">Requires Attunement</label>
                                </div>
                            </div>
                            <div class="space-y-2">
                                <label class="block text-xs text-gray-500 uppercase">Description / Effect</label>
                                <textarea id="hb-item-desc" rows="3" class="w-full p-2 rounded input-style text-sm resize-none" placeholder="While wearing this ring..."></textarea>
                                <div class="flex gap-2">
                                    <button onclick="window.saveHomebrewMagicItem()" class="flex-1 bg-pink-700 hover:bg-pink-600 text-white font-bold py-2 rounded-lg shadow-lg transition">Save Item</button>
                                    <button onclick="window.saveHomebrewToNotes('item')" class="flex-1 bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 rounded-lg shadow-lg transition">üìú Save Note</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="brew-community-area" class="hidden animate-fade-in">
                        <div class="bg-blue-900/20 p-3 rounded-lg border border-blue-500/30 mb-4 text-center">
                            <h3 class="text-sm font-bold text-blue-200">üåé Community Creations</h3>
                            <p class="text-[10px] text-gray-400">Items shared by other DMs. Click 'Save' to add them to your inventory.</p>
                        </div>
                        <div id="community-list" class="space-y-2 max-h-80 overflow-y-auto">
                            <p class="text-center text-gray-500 text-xs pt-4">Loading community items...</p>
                        </div>
                    </div>
                    
                    <div id="my-inventory-container">
                        <hr class="border-gray-700 my-4">
                        <h3 class="text-sm font-bold text-indigo-300 mb-2">My Inventory</h3>
                        <div id="homebrew-weapon-list" class="space-y-2 max-h-60 overflow-y-auto">
                            <p class="text-center text-gray-500 text-xs">No items saved.</p>
                        </div>
                    </div>
                </div>
            </div>
        
        <!-- Rules Tab -->
        
        <div id="rules" class="tab-content hidden">
                <div class="card p-4 rounded-lg shadow-xl border border-purple-500/30">
                    <h2 class="text-xl font-semibold mb-4 text-purple-300">üßô‚Äç‚ôÇÔ∏è Grand Library</h2>
                    
                    <div class="flex border-b border-gray-700 mb-4 justify-center gap-2 overflow-x-auto">
                        <button class="rule-sub-tab active border-b-2 border-purple-400 pb-2 font-bold text-purple-300 transition px-2 text-sm" onclick="switchRuleMode('spells', this)">‚ú® Spells</button>
                        <button class="rule-sub-tab text-gray-400 pb-2 font-semibold transition hover:text-gray-200 px-2 text-sm" onclick="switchRuleMode('weapons', this)">‚öîÔ∏è Weapons</button>
                        <button class="rule-sub-tab text-gray-400 pb-2 font-semibold transition hover:text-gray-200 px-2 text-sm" onclick="switchRuleMode('sections', this)">üìú Rules</button>
                    </div>

                    <div class="flex gap-2 mb-4">
                        <input type="text" id="library-search" placeholder="Search..." class="flex-1 p-2 rounded-lg input-style text-sm" onkeypress="if(event.key==='Enter') window.searchLibrary()">
                        <button onclick="window.searchLibrary()" class="bg-purple-700 hover:bg-purple-600 text-white font-bold px-4 rounded-lg text-sm">Search</button>
                    </div>

                    <div id="library-results" class="scrollable-content space-y-2 max-h-[500px]">
                        <p class="text-center text-gray-500 text-xs">Select a category and search.</p>
                    </div>
                </div>
            </div>
        
        <!-- Help Tab -->
        
        <div id="help" class="tab-content hidden">
                <div class="card p-6 rounded-lg shadow-xl border border-indigo-500/30">
                    <h2 class="text-2xl font-bold mb-4 text-indigo-300">How to set up your AI Tools</h2>
                    <p class="text-gray-300 mb-6">This toolkit uses Google's Gemini AI to generate monsters, loot, and lore. It is free to use, but you need to get your own "Key" from Google.</p>

                    <div class="space-y-8">
                        
                        <div class="bg-gray-800/50 p-4 rounded-lg border border-gray-700">
                            <h3 class="text-lg font-bold text-white mb-2">Step 1: Go to Google AI Studio</h3>
                            <p class="text-sm text-gray-400 mb-3">Click the "Get Key" link in the Prep tab, or go to <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-400 underline">aistudio.google.com</a>. Click <strong>Create API Key</strong>.</p>
                            <img src="IMG_0192.jpg" class="w-full rounded-lg border border-gray-600 shadow-lg" alt="Step 1">
                        </div>

                        <div class="bg-gray-800/50 p-4 rounded-lg border border-gray-700">
                            <h3 class="text-lg font-bold text-white mb-2">Step 2: Create a Project</h3>
                            <p class="text-sm text-gray-400 mb-3">Click the dropdown and select <strong>Create project</strong>.</p>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                                <img src="IMG_0194.jpeg" class="w-full rounded-lg border border-gray-600 shadow-lg" alt="Step 2a">
                                <img src="IMG_0195.jpeg" class="w-full rounded-lg border border-gray-600 shadow-lg" alt="Step 2b">
                            </div>
                        </div>

                        <div class="bg-gray-800/50 p-4 rounded-lg border border-gray-700">
                            <h3 class="text-lg font-bold text-white mb-2">Step 3: Name & Generate</h3>
                            <p class="text-sm text-gray-400 mb-3">Give your key a name (like "DM Tool") and click <strong>Create key</strong>.</p>
                            <img src="IMG_0196.jpeg" class="w-full rounded-lg border border-gray-600 shadow-lg" alt="Step 3">
                        </div>

                        <div class="bg-gray-800/50 p-4 rounded-lg border border-gray-700">
                            <h3 class="text-lg font-bold text-white mb-2">Step 4: Copy the Key</h3>
                            <p class="text-sm text-gray-400 mb-3">Copy the long code starting with <code>AIza...</code>.</p>
                            <img src="IMG_0197.jpeg" class="w-full rounded-lg border border-gray-600 shadow-lg" alt="Step 4">
                        </div>

                        <div class="bg-gray-800/50 p-4 rounded-lg border border-gray-700">
                            <h3 class="text-lg font-bold text-white mb-2">Step 5: Paste & Save</h3>
                            <p class="text-sm text-gray-400 mb-3">Go back to the <strong>Prep</strong> tab, paste the key into the box, and click <strong>Save</strong>.</p>
                            <img src="IMG_0198.jpg" class="w-full rounded-lg border border-gray-600 shadow-lg" alt="Step 5">
                        </div>

                    </div>
                </div>
            </div>
        
    </div>
 <!-- Modals -->
    <div id="edit-modal" class="hidden fixed inset-0 z-50 bg-black bg-opacity-75 flex items-center justify-center p-4">
        <div class="card w-full max-w-lg p-6 rounded-lg shadow-2xl">
            <h3 class="text-xl font-bold text-indigo-300 mb-4">Edit Note</h3>
            <input type="hidden" id="modal-note-id"><input type="hidden" id="modal-tab-name">
            <label class="block text-sm font-medium text-gray-400 mb-1">Title</label><input type="text" id="modal-title" class="w-full p-3 rounded-lg input-style mb-4">
            <label class="block text-sm font-medium text-gray-400 mb-1">Content</label><textarea id="modal-content" rows="6" class="w-full p-3 rounded-lg input-style mb-6 resize-none"></textarea>
            <div class="flex justify-end space-x-3"><button onclick="closeEditModal()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Cancel</button><button onclick="saveEditedNote()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Save</button></div>
        </div>
    </div>

    <div id="edit-statblock-modal" class="hidden fixed inset-0 z-50 bg-black bg-opacity-75 flex items-center justify-center p-4">
        <div class="card w-full max-w-lg p-6 rounded-lg shadow-2xl">
            <h3 class="text-xl font-bold text-indigo-300 mb-4">Edit Statblock</h3>
            <input type="hidden" id="modal-statblock-id">
            <label class="block text-sm font-medium text-gray-400 mb-1">Name</label><input type="text" id="modal-stat-name" class="w-full p-3 rounded-lg input-style mb-4">
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-sm font-medium text-gray-400 mb-1">HP</label><input type="number" id="modal-stat-hp" class="w-full p-3 rounded-lg input-style text-center text-sm mb-4"></div>
                <div><label class="block text-sm font-medium text-gray-400 mb-1">AC</label><input type="number" id="modal-stat-ac" class="w-full p-3 rounded-lg input-style text-center text-sm mb-4"></div>
                <div><label class="block text-sm font-medium text-gray-400 mb-1">To Hit</label><input type="number" id="modal-stat-tohit" class="w-full p-3 rounded-lg input-style text-center text-sm mb-4"></div>
                <div><label class="block text-sm font-medium text-gray-400 mb-1">Init</label><input type="number" id="modal-stat-init-mod" class="w-full p-3 rounded-lg input-style text-center text-sm mb-4"></div>
            </div>
            <label class="block text-sm font-medium text-gray-400 mb-1">Damage</label><input type="text" id="modal-stat-dmg" class="w-full p-3 rounded-lg input-style mb-6">
            <div class="flex justify-end space-x-3"><button onclick="closeStatblockEditModal()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Cancel</button><button onclick="saveEditedStatblock()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Save</button></div>
        </div>
    </div>

    <!-- Dice Visuals Canvas -->
    <canvas id="dice-canvas" class="fixed inset-0 pointer-events-none z-50"></canvas>
    <!-- Snow Visuals Canvas -->
    <canvas id="snow-canvas"></canvas>

    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, deleteDoc, getDoc, collection, query, onSnapshot, addDoc, updateDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- 1. FIREBASE CONFIG ---
    const manualFirebaseConfig = {
        apiKey: "AIzaSyB6lyGYJzk70t1OJvzBn5uyJN_k2_5NKYg",
        authDomain: "aegisdmtoolkit.firebaseapp.com",
        projectId: "aegisdmtoolkit",
        storageBucket: "aegisdmtoolkit.firebasestorage.app",
        messagingSenderId: "654767294266",
        appId: "1:654767294266:web:fbee20be7d458fb7d6f203"
    };
    const app = initializeApp(manualFirebaseConfig);
    window.db = getFirestore(app);
    window.auth = getAuth(app);
    window.userId = null; 
    window.isAuthReady = false;

    // Expose Functions
    window.doc = doc; window.setDoc = setDoc; window.deleteDoc = deleteDoc; window.collection = collection;
    window.query = query; window.onSnapshot = onSnapshot; window.addDoc = addDoc; window.updateDoc = updateDoc; window.writeBatch = writeBatch;
    window.signInWithEmailAndPassword = signInWithEmailAndPassword;
    window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
    window.signOut = signOut;

    // --- 2. GLOBAL VARIABLES ---
    // We attach these to 'window' so the HTML buttons can see them!
    window.currentTab = 'improv'; 
    window.currentSubTab = 'prepNotes';
    
    let savedStatblocks = [], combatants = [], currentTurnIndex = -1;
    let structuredNotes = { prepNotes: [], enemyNotes: [], npcNotes: [], lootNotes: [] };
    let userApiKey = localStorage.getItem('dm_toolkit_api_key') || "";
    let isChristmasMode = localStorage.getItem('aegis_theme') === 'christmas';
    let lastGeneratedNpc = null, lastGeneratedMonster = null, lastRoll = 0;

// --- 2.5 THEME & SNOW ENGINE (RESTORED) ---
    window.toggleTheme = function() {
        isChristmasMode = !isChristmasMode;
        localStorage.setItem('aegis_theme', isChristmasMode ? 'christmas' : 'default');
        applyTheme();
    };

    function applyTheme() {
        if (isChristmasMode) {
            document.body.classList.add('christmas-mode');
            startSnow();
        } else {
            document.body.classList.remove('christmas-mode');
            stopSnow();
        }
    }

    // Snow Logic
    let snowInterval;
    const snowCanvas = document.getElementById('snow-canvas');
    const snowCtx = snowCanvas ? snowCanvas.getContext('2d') : null;
    let snowflakes = [];

    function startSnow() {
        if (!snowCanvas || snowInterval) return;
        snowCanvas.width = window.innerWidth;
        snowCanvas.height = window.innerHeight;
        snowflakes = [];
        for (let i = 0; i < 100; i++) {
            snowflakes.push({
                x: Math.random() * snowCanvas.width,
                y: Math.random() * snowCanvas.height,
                r: Math.random() * 3 + 1,
                speed: Math.random() * 0.5 + 0.2
            });
        }
        snowInterval = setInterval(drawSnow, 50);
    }

    function stopSnow() {
        if (snowInterval) { clearInterval(snowInterval); snowInterval = null; }
        if (snowCtx) snowCtx.clearRect(0, 0, snowCanvas.width, snowCanvas.height);
    }

    function drawSnow() {
        if (!snowCtx) return;
        snowCtx.clearRect(0, 0, snowCanvas.width, snowCanvas.height);
        snowCtx.fillStyle = "rgba(255, 255, 255, 0.6)";
        snowCtx.beginPath();
        for (let i = 0; i < snowflakes.length; i++) {
            let f = snowflakes[i];
            snowCtx.moveTo(f.x, f.y);
            snowCtx.arc(f.x, f.y, f.r, 0, Math.PI * 2, true);
        }
        snowCtx.fill();
        moveSnow();
    }

    let angle = 0;
    function moveSnow() {
        angle += 0.005;
        for (let i = 0; i < snowflakes.length; i++) {
            let f = snowflakes[i];
            f.y += f.speed;
            f.x += Math.sin(angle + f.y/50) * 0.2;
            if (f.y > snowCanvas.height) { f.y = -10; f.x = Math.random() * snowCanvas.width; }
            if (f.x > snowCanvas.width + 5) f.x = -5;
            if (f.x < -5) f.x = snowCanvas.width + 5;
        }
    }

    // --- 3. PRIVATE SESSION HELPERS (FIXED PATHS) ---
    const getDataPath = () => {
        if (window.userId) return ['sessions', window.userId];
        return ['public', 'default']; 
    };

    // Helper for Lists (Combatants, Statblocks)
    // Path: artifacts/default/{sessions}/{userId}/{collectionName}
    const getCol = (name) => {
        const path = getDataPath();
        return window.collection(window.db, 'artifacts', 'default', path[0], path[1], name);
    };

    // Helper for Specific Items in Lists
    // Path: artifacts/default/{sessions}/{userId}/{collectionName}/{docId}
    const getDocRef = (col, id) => {
        const path = getDataPath();
        return window.doc(window.db, 'artifacts', 'default', path[0], path[1], col, id);
    };

    // Helper for Shared Single Docs (Notes, Turn State)
    // Path: artifacts/default/{sessions}/{userId}/singles/{docName}
    // We use a 'singles' collection to hold these standalone documents cleanly
    const getSharedDoc = (name) => {
        const path = getDataPath();
        return window.doc(window.db, 'artifacts', 'default', path[0], path[1], 'singles', name);
    };

    window.saveStructuredNotes = async (tab, data) => {
        if(!window.isAuthReady) return;
        const field = `structured${tab.charAt(0).toUpperCase() + tab.slice(1)}`;
        try { await window.setDoc(getSharedDoc('shared_notes'), { [field]: data }, { merge: true }); } catch(e) { console.error(e); }
    };

    // --- 4. AUTH UI ---
    window.openLoginModal = () => { document.getElementById('login-modal').classList.remove('hidden'); document.getElementById('session-name-input').focus(); };
    window.closeLoginModal = () => { document.getElementById('login-modal').classList.add('hidden'); };
    
    window.handleSessionLogin = async () => {
        const name = document.getElementById('session-name-input').value.trim();
        const pass = document.getElementById('session-pass-input').value.trim();
        const status = document.getElementById('login-status');
        if (!name || !pass) { status.textContent = "Enter Name & Password"; return; }
        if (pass.length < 6) { status.textContent = "Password too short (6+ chars)"; return; }
        status.textContent = "Connecting...";
        const email = `${name.replace(/\s+/g, '_')}@aegis.local`;
        try {
            await signInWithEmailAndPassword(window.auth, email, pass);
            closeLoginModal();
        } catch (error) {
            if (error.code === 'auth/invalid-credential' || error.code === 'auth/user-not-found') {
                try {
                    await createUserWithEmailAndPassword(window.auth, email, pass);
                    closeLoginModal();
                } catch (e) { status.textContent = "Error: " + e.message; }
            } else { status.textContent = "Error: " + error.message; }
        }
    };

    window.logoutUser = async () => {
        await signOut(window.auth);
        window.location.reload();
    };

    function updateLoginUI(user) {
        const loginBtn = document.getElementById('login-btn');
        const userProfile = document.getElementById('user-profile');
        const userName = document.getElementById('user-name');
        const userAvatar = document.getElementById('user-avatar');
        if (user && !user.isAnonymous) {
            if(loginBtn) loginBtn.classList.add('hidden');
            if(userProfile) userProfile.classList.remove('hidden');
            const rawName = user.email.split('@')[0];
            const displayName = rawName.replace(/_/g, ' '); 
            if(userName) {
                userName.innerHTML = `<span class="text-indigo-300 font-bold">${displayName}</span>`;
                userName.innerHTML += `<div class="text-[10px] text-green-400">‚óè Private Session</div>`;
            }
            if(userAvatar) userAvatar.src = `https://ui-avatars.com/api/?name=${rawName}&background=6366f1&color=fff&size=128`;
        } else {
            if(loginBtn) loginBtn.classList.remove('hidden');
            if(userProfile) userProfile.classList.add('hidden');
        }
    }

    // --- 5. ROBUST DATA LISTENERS ---
    window.unsubNotes = null; window.unsubCombat = null; window.unsubStats = null; window.unsubTurn = null;

    window.setupNotesListener = () => {
        if(!window.isAuthReady) return;
        if (window.unsubNotes) window.unsubNotes();
        window.unsubNotes = window.onSnapshot(getSharedDoc('shared_notes'), (doc) => {
            if(doc.exists()) {
                const d = doc.data();
                structuredNotes.prepNotes = d.structuredPrepNotes || [];
                structuredNotes.enemyNotes = d.structuredEnemyNotes || [];
                structuredNotes.npcNotes = d.structuredNpcNotes || [];
                structuredNotes.lootNotes = d.structuredLootNotes || [];
            } else {
                structuredNotes = { prepNotes: [], enemyNotes: [], npcNotes: [], lootNotes: [] };
            }
            if(currentTab==='notes') renderStructuredNotes(currentSubTab);
        });
    };

    window.setupCombatDataListeners = () => {
        if(!window.isAuthReady) return;
        const status = document.getElementById('db-status');
        if (window.unsubCombat) window.unsubCombat();
        if (window.unsubTurn) window.unsubTurn();

        // Note: 'shared_combatants' is now a top-level collection in the session folder
        window.unsubCombat = window.onSnapshot(window.query(getCol('shared_combatants')), (snap) => {
            combatants = []; 
            snap.forEach(d => combatants.push({id: d.id, ...d.data()}));
            combatants.sort((a,b) => (b.init||0) - (a.init||0));
            renderCombatants();
            if(status) { status.textContent = "Connected"; status.className = "text-xs px-2 py-1 rounded bg-gray-700 text-green-400"; }
        });

        window.unsubTurn = window.onSnapshot(getSharedDoc('shared_combat_state'), (doc) => {
            currentTurnIndex = doc.exists() ? (doc.data().currentTurnIndex || 0) : -1;
            renderCombatants();
        });
    };

    window.setupStatblocksListener = () => {
        if(!window.isAuthReady) return;
        if (window.unsubStats) window.unsubStats();
        window.unsubStats = window.onSnapshot(window.query(getCol('dm_toolkit_statblocks')), (snap) => {
            savedStatblocks = []; 
            snap.forEach(d => savedStatblocks.push({id: d.id, ...d.data()}));
            savedStatblocks.sort((a,b) => a.name.localeCompare(b.name));
            renderStatblocks();
        });
    };



    // --- 6. CORE FUNCTIONS ---
    window.switchTab = function(tabId) {
        window.currentTab = tabId;
        document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
        document.getElementById(tabId).classList.remove('hidden');
        
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.remove('active', 'text-indigo-400', 'border-indigo-500');
            btn.classList.add('text-gray-400', 'border-transparent');
            
            const text = btn.textContent.toLowerCase();
            
            // THE FIX: Add specific checks for Stats and Sound
            if (
                text.includes(tabId) || 
                (tabId === 'improv' && text.includes('prep')) ||
                (tabId === 'statblocks' && text.includes('stats')) ||
                (tabId === 'soundboard' && text.includes('sound'))
            ) {
                btn.classList.add('active'); 
                btn.classList.remove('text-gray-400');
            }
        });
        
        if (tabId === 'notes') window.switchSubTab(window.currentSubTab);
    };

    window.switchSubTab = function(tabId) {
        window.currentSubTab = tabId;
        
        // Clear search box when switching tabs
        const searchInput = document.getElementById('notes-search');
        if(searchInput) searchInput.value = "";

        document.querySelectorAll('.sub-tab-content').forEach(el => el.classList.add('hidden'));
        document.getElementById(`${tabId}-sub-content`).classList.remove('hidden');
        document.querySelectorAll('.sub-tab-button').forEach(btn => {
            btn.classList.remove('active', 'text-gray-400');
            if (btn.dataset.subtab === tabId) btn.classList.add('active');
            else btn.classList.add('text-gray-400');
        });
        renderStructuredNotes(window.currentSubTab);
    };

    // --- EXPOSED RENDER FUNCTION (Fixes Search Button) ---
    window.renderStructuredNotes = function(tab) {
        const list = document.getElementById(`${tab}-list`);
        if(!list) return;

        // 1. GET SEARCH QUERY
        const searchInput = document.getElementById('notes-search');
        const query = searchInput ? searchInput.value.toLowerCase().trim() : "";
        
        // 2. GET NOTES
        // We use the global structuredNotes variable
        const allNotes = structuredNotes[tab] || [];
        
        // 3. FILTER NOTES
        // If query is empty, filter returns true (shows all). 
        // If not, it checks Title OR Content.
        const filteredNotes = allNotes.filter(n => 
            n.title.toLowerCase().includes(query) || 
            n.content.toLowerCase().includes(query)
        );

        // 4. RENDER RESULTS
        list.innerHTML = filteredNotes.length ? '' : '<p class="text-center text-gray-500 pt-8">No matching notes found.</p>';
        
        filteredNotes.forEach(n => {
            const div = document.createElement('div'); 
            div.className = 'note-item card p-0 rounded-lg shadow-md'; 
            div.id = `note-${n.id}`;
            
            div.innerHTML = `
            <div class="collapsible-header hover:bg-gray-600/50 transition" onclick="toggleCollapse('${n.id}')">
                <span class="font-bold text-indigo-300 truncate">${n.title}</span>
                <span class="text-gray-400">‚ñº</span>
            </div>
            <div class="collapsible-content" id="content-${n.id}">
                <div class="flex justify-end p-2 gap-2 border-b border-gray-700 mb-2">
                    <button onclick="editNote('${n.id}', '${tab}')" class="text-xs bg-blue-600 hover:bg-blue-500 px-3 py-1 rounded font-semibold">Edit</button>
                    <button onclick="deleteNote('${n.id}', '${tab}')" class="text-xs bg-red-600 hover:bg-red-500 px-3 py-1 rounded font-semibold">Delete</button>
                </div>
                <div class="p-3 whitespace-pre-wrap text-sm text-gray-300">${n.content}</div>
            </div>`;
            
            list.appendChild(div);
        });
    };

    window.toggleCollapse = (id) => { const el = document.getElementById(`content-${id}`); if(el) { el.classList.toggle('expanded'); el.style.maxHeight = el.classList.contains('expanded') ? el.scrollHeight + "px" : null; } };
    window.addNewNote = (tab) => { structuredNotes[tab].unshift({ id: crypto.randomUUID(), title: 'New Note', content: 'Details...' }); window.saveStructuredNotes(tab, structuredNotes[tab]); };
    window.deleteNote = (id, tab) => { structuredNotes[tab] = structuredNotes[tab].filter(n => n.id !== id); window.saveStructuredNotes(tab, structuredNotes[tab]); };
    window.editNote = (id, tab) => {
        const n = structuredNotes[tab].find(x => x.id === id); if(!n) return;
        document.getElementById('modal-note-id').value = id; document.getElementById('modal-tab-name').value = tab;
        document.getElementById('modal-title').value = n.title;
        const tempDiv = document.createElement('div'); tempDiv.innerHTML = n.content;
        document.getElementById('modal-content').value = tempDiv.textContent.trim();
        document.getElementById('edit-modal').classList.remove('hidden');
    };
    window.saveEditedNote = () => {
        const id = document.getElementById('modal-note-id').value, tab = document.getElementById('modal-tab-name').value;
        const idx = structuredNotes[tab].findIndex(x => x.id === id);
        if(idx > -1) {
            structuredNotes[tab][idx].title = document.getElementById('modal-title').value;
            structuredNotes[tab][idx].content = document.getElementById('modal-content').value;
            window.saveStructuredNotes(tab, structuredNotes[tab]);
        }
        document.getElementById('edit-modal').classList.add('hidden');
    };
    window.closeEditModal = () => document.getElementById('edit-modal').classList.add('hidden');

    window.updateApiKey = function(val) { userApiKey = val.trim(); localStorage.setItem('dm_toolkit_api_key', userApiKey); const status = document.getElementById('api-key-status'); if(userApiKey.length > 5) { status.textContent = "Key saved!"; status.className="mt-2 text-xs text-green-400"; } else { status.textContent = "Key empty"; status.className="mt-2 text-xs text-red-400"; } };
    window.saveApiKey = function() { window.updateApiKey(document.getElementById('user-api-key').value); };

    // --- 7. COMBAT & STATBLOCKS ---
    window.addCombatant = async () => { const name = document.getElementById('combatant-name').value.trim(); if(!name) return; const init = parseInt(document.getElementById('combatant-init').value)||0; const hp = parseInt(document.getElementById('combatant-hp').value)||0; const ac = parseInt(document.getElementById('combatant-ac').value)||0; await window.addDoc(getCol('shared_combatants'), { name, init, maxHp: hp, currentHp: hp, ac, initModifier: init }); document.getElementById('combatant-name').value = ''; };
    window.modHp = async (id, idx, mul) => { const val = parseInt(document.getElementById(`dmg-${idx}`).value); if(isNaN(val)) return; const c = combatants[idx]; const newHp = Math.max(0, Math.min(c.maxHp, c.currentHp + (val * mul))); await window.updateDoc(getDocRef('shared_combatants', id), { currentHp: newHp }); document.getElementById(`dmg-${idx}`).value = ''; };
    window.delCombatant = async (id) => await window.deleteDoc(getDocRef('shared_combatants', id));
    window.clearCombat = async () => { const batch = window.writeBatch(window.db); combatants.forEach(c => batch.delete(getDocRef('shared_combatants', c.id))); batch.delete(getSharedDoc('shared_combat_state')); await batch.commit(); };
    window.nextTurn = async () => { if(!combatants.length) return; const next = (currentTurnIndex + 1) % combatants.length; await window.setDoc(getSharedDoc('shared_combat_state'), { currentTurnIndex: next }); };
    window.sortInitiative = async () => { await window.setDoc(getSharedDoc('shared_combat_state'), { currentTurnIndex: 0 }); };
    window.saveStatblock = async () => { const name = document.getElementById('stat-name').value.trim(); if(!name) return; await window.addDoc(getCol('dm_toolkit_statblocks'), { name, hp: parseInt(document.getElementById('stat-hp').value)||0, ac: parseInt(document.getElementById('stat-ac').value)||0, toHit: parseInt(document.getElementById('stat-tohit').value)||0, initMod: parseInt(document.getElementById('stat-init-mod').value)||0, dmg: document.getElementById('stat-dmg').value, timestamp: new Date().toISOString() }); document.getElementById('stat-name').value = ''; };
    window.delStat = async (id) => await window.deleteDoc(getDocRef('dm_toolkit_statblocks', id));
    window.importStat = (n, h, i, a) => { document.getElementById('combatant-name').value = n; document.getElementById('combatant-hp').value = h; document.getElementById('combatant-init').value = i; document.getElementById('combatant-ac').value = a; window.switchTab('combat'); };
    
    // Conditions Logic
    const dndConditions = ['Blinded', 'Charmed', 'Deafened', 'Frightened', 'Grappled', 'Incapacitated', 'Invisible', 'Paralyzed', 'Petrified', 'Poisoned', 'Prone', 'Restrained', 'Stunned', 'Unconscious', 'Exhaustion', 'Concentrating'];
    window.addCondition = async (id, cond) => { if (!cond) return; const c = combatants.find(x => x.id === id); if (!c) return; const current = c.conditions || []; if (current.includes(cond)) return; const updated = [...current, cond]; await window.updateDoc(getDocRef('shared_combatants', id), { conditions: updated }); };
    window.removeCondition = async (id, cond) => { const c = combatants.find(x => x.id === id); if (!c) return; const current = c.conditions || []; const updated = current.filter(x => x !== cond); await window.updateDoc(getDocRef('shared_combatants', id), { conditions: updated }); };

    function renderCombatants() { 
        const list = document.getElementById('initiative-list'); if(!list) return; 
        list.innerHTML = combatants.length ? '' : '<p class="text-center text-gray-500 pt-8">No combatants.</p>'; 
        
        const conditionOptions = dndConditions.map(cond => `<option value="${cond}">${cond}</option>`).join('');
        
        combatants.forEach((c, idx) => { 
            const active = idx === currentTurnIndex ? 'bg-indigo-700 glow-shadow' : 'bg-gray-700'; 
            
            // 1. Format the Modifier (e.g. "+3" or "-1")
            // We use (c.initModifier || 0) to ensure it doesn't break if undefined
            const modVal = parseInt(c.initModifier) || 0;
            const modStr = (modVal >= 0 ? '+' : '') + modVal;

            // Condition Badges
            const conditionBadges = (c.conditions || []).map(cond => `<span onclick="removeCondition('${c.id}', '${cond}')" class="inline-block cursor-pointer bg-red-900/80 hover:bg-red-800 text-red-100 text-[10px] px-1.5 py-0.5 rounded border border-red-700 mr-1 mb-1 select-none">${cond} &times;</span>`).join('');
            
            const div = document.createElement('div'); div.className = `flex items-start space-x-2 p-3 rounded-lg transition ${active}`; 
            
            div.innerHTML = `
                <div class="flex flex-col items-center justify-center w-12 mr-1 pt-1">
                    <div class="text-xl font-bold text-white leading-none">${c.init}</div>
                    <div class="text-[10px] text-gray-400 font-mono mt-1" title="Dex Modifier">(${modStr})</div>
                </div>

                <div class="flex-1 min-w-0">
                    <div class="font-semibold text-sm text-white truncate">${c.name}</div>
                    <div class="text-xs text-gray-300">HP: ${c.currentHp}/${c.maxHp} | AC: ${c.ac}</div>
                    <div class="mt-2">
                        <div class="flex flex-wrap gap-1 mb-1">${conditionBadges}</div>
                        <select onchange="addCondition('${c.id}', this.value); this.value='';" class="bg-gray-800 text-[10px] text-gray-400 border border-gray-600 rounded px-1 py-0.5"><option value="">+ Condition</option>${conditionOptions}</select>
                    </div>
                </div>
                
                <div class="flex flex-col items-end gap-2">
                    <div class="flex items-center gap-1">
                        <input type="number" id="dmg-${idx}" class="w-10 p-1 text-xs rounded text-black" placeholder="Amt">
                        <button onclick="modHp('${c.id}', ${idx}, 1)" class="bg-green-600 hover:bg-green-500 px-2 py-1 rounded text-xs font-bold">Heal</button>
                        <button onclick="modHp('${c.id}', ${idx}, -1)" class="bg-red-600 hover:bg-red-500 px-2 py-1 rounded text-xs font-bold">Dmg</button>
                    </div>
                    <button onclick="delCombatant('${c.id}')" class="text-gray-400 hover:text-red-400 text-xs underline">Remove</button>
                </div>`; 
            list.appendChild(div); 
        }); 
        
        const sel = document.getElementById('combatant-selector');
        if(sel) { sel.innerHTML = '<option value="" disabled selected>Target</option>'; combatants.forEach((c,i) => sel.innerHTML += `<option value="${i}">${c.name}</option>`); }
        const btn = document.getElementById('assign-roll-button'); if(btn) btn.disabled = combatants.length === 0 || lastRoll === 0;
    }
    
    function renderStatblocks() { const list = document.getElementById('statblocks-list'); if(!list) return; list.innerHTML = savedStatblocks.length ? '' : '<p class="text-center text-gray-500">No stats.</p>'; savedStatblocks.forEach(s => { const div = document.createElement('div'); div.className = 'card p-2 mb-2 bg-gray-800'; const safeName = s.name.replace(/'/g, "\\'"); div.innerHTML = `<div class="flex justify-between font-bold text-indigo-300"><span>${s.name}</span><div class="gap-2 flex"><button onclick="editStatblock('${s.id}')" class="text-xs text-blue-400">Edit</button><button onclick="delStat('${s.id}')" class="text-xs text-red-400">Del</button></div></div><div class="text-xs text-gray-300 grid grid-cols-2 gap-1 mt-1"><span>HP: ${s.hp}</span><span>AC: ${s.ac}</span><span>Hit: ${s.toHit}</span><span>Init: ${s.initMod}</span></div><div class="text-xs text-yellow-500 mt-1 truncate">${s.dmg}</div><button onclick="importStat('${safeName}', ${s.hp}, ${s.initMod}, ${s.ac})" class="w-full bg-purple-900 text-xs rounded mt-2 py-1">Add to Tracker</button>`; list.appendChild(div); }); }

    // --- 8. STATBLOCK EDIT MODAL ---
    window.editStatblock = (id) => {
        const s = savedStatblocks.find(x => x.id === id); if (!s) return;
        document.getElementById('modal-statblock-id').value = id;
        document.getElementById('modal-stat-name').value = s.name;
        document.getElementById('modal-stat-hp').value = s.hp;
        document.getElementById('modal-stat-ac').value = s.ac;
        document.getElementById('modal-stat-tohit').value = s.toHit;
        document.getElementById('modal-stat-init-mod').value = s.initMod;
        document.getElementById('modal-stat-dmg').value = s.dmg;
        document.getElementById('edit-statblock-modal').classList.remove('hidden');
    };
    window.closeStatblockEditModal = () => document.getElementById('edit-statblock-modal').classList.add('hidden');
    window.saveEditedStatblock = async () => {
        const id = document.getElementById('modal-statblock-id').value; if (!id) return;
        try {
            await window.updateDoc(getDocRef('dm_toolkit_statblocks', id), {
                name: document.getElementById('modal-stat-name').value.trim(),
                hp: parseInt(document.getElementById('modal-stat-hp').value) || 0,
                ac: parseInt(document.getElementById('modal-stat-ac').value) || 0,
                toHit: parseInt(document.getElementById('modal-stat-tohit').value) || 0,
                initMod: parseInt(document.getElementById('modal-stat-init-mod').value) || 0,
                dmg: document.getElementById('modal-stat-dmg').value.trim(),
            });
            closeStatblockEditModal();
        } catch (error) { console.error("Error updating statblock:", error); }
    };

    // --- 9. DICE LOGIC ---
    window.rollD20 = function() { lastRoll = Math.floor(Math.random() * 20) + 1; document.getElementById('last-roll-display').textContent = lastRoll; const btn = document.getElementById('assign-roll-button'); if(btn) btn.disabled = combatants.length === 0 || lastRoll === 0; };
    window.assignInitiativeRoll = async function() { const selector = document.getElementById('combatant-selector'); const selectedIndex = parseInt(selector.value, 10); if (isNaN(selectedIndex) || selectedIndex < 0 || lastRoll === 0) return; const c = combatants[selectedIndex]; const modifier = c.initModifier || 0; const newInitiative = lastRoll + modifier; try { await window.updateDoc(getDocRef('shared_combatants', c.id), { init: newInitiative }); } catch (error) { console.error(error); } lastRoll = 0; document.getElementById('last-roll-display').textContent = '?'; selector.value = ''; document.getElementById('assign-roll-button').disabled = true; };
    window.rollSimple = function(sides) { document.getElementById('dice-num').value = 1; document.getElementById('dice-type').value = sides; document.getElementById('dice-mod').value = 0; window.rollCustomDice(); };
    window.rollCustomDice = function() {
        const numDice = parseInt(document.getElementById('dice-num').value, 10) || 1;
        const diceType = parseInt(document.getElementById('dice-type').value, 10) || 20;
        const modifier = parseInt(document.getElementById('dice-mod').value, 10) || 0;
        if (numDice <= 0) return;
        let totalRoll = 0; const rolls = [];
        for (let i = 0; i < numDice; i++) { const roll = Math.floor(Math.random() * diceType) + 1; rolls.push(roll); totalRoll += roll; }
        const finalTotal = totalRoll + modifier;
        const modString = modifier > 0 ? `+${modifier}` : (modifier < 0 ? `${modifier}` : '');
        const resultDisplay = document.getElementById('dice-roll-result');
        resultDisplay.textContent = finalTotal; resultDisplay.className = "text-2xl font-bold text-white animate-pulse"; setTimeout(() => { resultDisplay.className = "text-2xl font-bold text-white"; }, 200);
        let detailsText = `[${rolls.join(', ')}]`; if (modifier !== 0) detailsText += ` ${modString}`;
        document.getElementById('dice-roll-details').textContent = `${numDice}d${diceType}${modString}: ${detailsText}`;
        if (window.throwDiceVisuals) window.throwDiceVisuals(rolls, diceType);
    };

    // --- 10. AI & GENERATORS (Fully Restored) ---
    const API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent';
    const combatSchema = { type: "OBJECT", properties: { name: { type: "STRING" }, level_or_cr: { type: "STRING" }, armor_class_ac: { type: "INTEGER" }, max_hit_points: { type: "INTEGER" }, initiative_bonus: { type: "INTEGER" }, main_attack: { type: "STRING" } }, required: ["name", "level_or_cr", "armor_class_ac", "max_hit_points", "initiative_bonus", "main_attack"] };
    const monsterSchema = { type: "OBJECT", properties: { name: { type: "STRING" }, size: { type: "STRING" }, type: { type: "STRING" }, alignment: { type: "STRING" }, armor_class: { type: "INTEGER" }, ac_type: { type: "STRING" }, hit_points: { type: "INTEGER" }, hit_dice: { type: "STRING" }, speed: { type: "STRING" }, ability_scores: { type: "OBJECT", properties: { STR: { type: "INTEGER" }, DEX: { type: "INTEGER" }, CON: { type: "INTEGER" }, INT: { type: "INTEGER" }, WIS: { type: "INTEGER" }, CHA: { type: "INTEGER" } }, required: ["STR", "DEX", "CON", "INT", "WIS", "CHA"] }, saving_throws: { type: "ARRAY", items: { type: "STRING" } }, skills: { type: "ARRAY", items: { type: "STRING" } }, damage_vulnerabilities: { type: "ARRAY", items: { type: "STRING" } }, damage_resistances: { type: "ARRAY", items: { type: "STRING" } }, damage_immunities: { type: "ARRAY", items: { type: "STRING" } }, condition_immunities: { type: "ARRAY", items: { type: "STRING" } }, senses: { type: "STRING" }, languages: { type: "STRING" }, challenge_rating: { type: "STRING" }, xp: { type: "INTEGER" }, abilities: { type: "ARRAY", items: { type: "OBJECT", properties: { name: { type: "STRING" }, description: { type: "STRING" } } } }, actions: { type: "ARRAY", items: { type: "OBJECT", properties: { name: { type: "STRING" }, description: { type: "STRING" } } } }, legendary_actions: { type: "ARRAY", items: { type: "OBJECT", properties: { name: { type: "STRING" }, description: { type: "STRING" } } } } } };

    async function callAI(url, payload) {
        let key = userApiKey;
        if (!key || key === "") { const inputEl = document.getElementById('user-api-key'); if (inputEl && inputEl.value) { key = inputEl.value.trim(); userApiKey = key; localStorage.setItem('dm_toolkit_api_key', key); } }
        if(!key) throw new Error("No Key");
        const res = await fetch(`${url}?key=${key}`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
        if (res.ok) return await res.json();
        throw new Error(await res.text());
    }

    // Helper Function for Title Generation
    function generateTitleFromContent(content) {
        const htmlTitleMatch = content.match(/<div class="dnd-header">(.*?)<\/div>/);
        if (htmlTitleMatch) { return htmlTitleMatch[1].trim(); }
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = content;
        tempDiv.querySelectorAll('br').forEach(br => br.replaceWith('\n'));
        tempDiv.querySelectorAll('div, p').forEach(block => block.after('\n')); 
        const textContent = tempDiv.textContent || "";
        const headerMatch = textContent.match(/^#+\s*(.*?)$/m);
        if (headerMatch) { return headerMatch[1].trim(); }
        const firstLine = textContent.split('\n').find(line => line.trim().length > 0) || "";
        const cleanLine = firstLine.replace(/^[#*>\s]+/, '').trim(); 
        const shortTitle = cleanLine.substring(0, 50);
        return (shortTitle + (cleanLine.length > 50 ? '...' : '')) || 'Untitled Generated Note';
    }

    window.generateCombatNpc = async () => {
        const btn = document.getElementById('generate-combat-button'); btn.disabled = true;
        const outputDiv = document.getElementById('ai-output'); outputDiv.textContent = "Generating combat stats...";
        try {
            const txt = document.getElementById('npc-type').value, lvl = document.getElementById('npc-level').value;
            const data = await callAI(API_URL, { contents: [{ parts: [{ text: `Generate a D&D 5e combat NPC (Level ${lvl}, ${txt}). Return strictly JSON.` }] }], generationConfig: { responseMimeType: "application/json", responseSchema: combatSchema } });
            lastGeneratedNpc = JSON.parse(data.candidates[0].content.parts[0].text);
            outputDiv.innerHTML = `<div class="text-2xl font-bold text-green-400 mb-2">${lastGeneratedNpc.name}</div><div class="text-gray-300 text-sm mb-4">Level/CR: ${lastGeneratedNpc.level_or_cr}</div><div class="grid grid-cols-2 gap-3 mb-4"><div class="p-3 bg-gray-700 rounded-lg border border-gray-600"><div class="text-xs text-gray-400 uppercase">Armor Class</div><div class="font-bold text-2xl text-blue-300">${lastGeneratedNpc.armor_class_ac}</div></div><div class="p-3 bg-gray-700 rounded-lg border border-gray-600"><div class="text-xs text-gray-400 uppercase">Hit Points</div><div class="font-bold text-2xl text-green-300">${lastGeneratedNpc.max_hit_points}</div></div><div class="p-3 bg-gray-700 rounded-lg col-span-2 border border-gray-600"><div class="text-xs text-gray-400 uppercase">Initiative</div><div class="font-bold text-xl text-yellow-300">${lastGeneratedNpc.initiative_bonus >= 0 ? '+' : ''}${lastGeneratedNpc.initiative_bonus}</div></div><div class="p-3 bg-gray-700 rounded-lg col-span-2 border border-gray-600"><div class="text-xs text-gray-400 uppercase">Main Attack</div><div class="font-medium text-white mt-1">${lastGeneratedNpc.main_attack}</div></div></div><button onclick="addNpcToStatblocks()" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 rounded-lg mb-2">üíæ Add to Statblocks</button><div class="grid grid-cols-3 gap-2"><button onclick="saveCombatNpcToNotes('prepNotes')" class="bg-gray-600 py-1 rounded text-xs">Note</button><button onclick="saveCombatNpcToNotes('enemyNotes')" class="bg-yellow-800 py-1 rounded text-xs">Enemy</button><button onclick="saveCombatNpcToNotes('npcNotes')" class="bg-blue-800 py-1 rounded text-xs">NPC</button></div>`;
        } catch(e) { outputDiv.textContent = "Error: " + e.message; }
        finally { document.getElementById('combat-loading-spinner').classList.add('hidden'); btn.disabled = false; }
    };

    window.addNpcToStatblocks = async function() {
        if (!window.isAuthReady || !lastGeneratedNpc) return;
        const match = lastGeneratedNpc.main_attack.match(/(\+|\-)\d+/);
        const toHit = match ? parseInt(match[0], 10) : (lastGeneratedNpc.initiative_bonus || 0);
        await window.addDoc(getCol('dm_toolkit_statblocks'), { name: lastGeneratedNpc.name, hp: lastGeneratedNpc.max_hit_points, ac: lastGeneratedNpc.armor_class_ac, toHit: toHit, initMod: lastGeneratedNpc.initiative_bonus, dmg: lastGeneratedNpc.main_attack || "Attack", timestamp: new Date().toISOString() });
    }

    window.saveCombatNpcToNotes = async function(tab) {
        if (!window.isAuthReady || !lastGeneratedNpc) return;
        const newNote = { id: crypto.randomUUID(), title: `${lastGeneratedNpc.name} (CR ${lastGeneratedNpc.level_or_cr})`, content: document.getElementById('ai-output').innerHTML, timestamp: new Date().toISOString() };
        structuredNotes[tab].unshift(newNote); await window.saveStructuredNotes(tab, structuredNotes[tab]);
        window.switchTab('notes'); window.switchSubTab(tab);
    }

    window.generateMonsterStatblock = async () => {
        const btn = document.getElementById('generate-monster-button'); btn.disabled = true;
        const output = document.getElementById('monster-output'); output.textContent = "Generating...";
        try {
            const name = document.getElementById('monster-name').value, cr = document.getElementById('monster-cr').value;
            const data = await callAI(API_URL, { contents: [{ parts: [{ text: `Generate 5e monster statblock for "${name}" CR "${cr}". Return strictly JSON.` }] }], generationConfig: { responseMimeType: "application/json", responseSchema: monsterSchema } });
            lastGeneratedMonster = JSON.parse(data.candidates[0].content.parts[0].text);
            const stats = lastGeneratedMonster;
            output.innerHTML = `<div class="dnd-statblock text-left"><div class="dnd-header">${stats.name}</div><div class="italic text-black text-sm">${stats.size} ${stats.type}, ${stats.alignment}</div><div class="tapered-rule"></div><div class="text-sm text-red-900"><p><strong>AC</strong> ${stats.armor_class}</p><p><strong>HP</strong> ${stats.hit_points}</p><p><strong>Spd</strong> ${stats.speed}</p></div><div class="tapered-rule"></div><div class="grid grid-cols-6 text-center text-red-900 text-xs font-bold"><div>STR ${stats.ability_scores.STR}</div><div>DEX ${stats.ability_scores.DEX}</div><div>CON ${stats.ability_scores.CON}</div><div>INT ${stats.ability_scores.INT}</div><div>WIS ${stats.ability_scores.WIS}</div><div>CHA ${stats.ability_scores.CHA}</div></div><div class="tapered-rule"></div><div class="text-sm text-black space-y-2 mt-2">${stats.actions.map(a=>`<div><strong>${a.name}.</strong> ${a.description}</div>`).join('')}</div></div>`;
            document.getElementById('save-options-monster').classList.remove('hidden');
        } catch(e) { output.textContent = "Error: " + e.message; }
        finally { document.getElementById('monster-loading-spinner').classList.add('hidden'); btn.disabled = false; }
    };

    window.addMonsterToStatblocks = async function() {
        if (!window.isAuthReady || !lastGeneratedMonster) return;
        const m = lastGeneratedMonster;
        let toHit = 0; const atk = m.actions[0]; if(atk) { const h = atk.description.match(/\+(\d+)/); if(h) toHit = parseInt(h[1]); }
        await window.addDoc(getCol('dm_toolkit_statblocks'), { name: m.name, hp: m.hit_points, ac: m.armor_class, toHit: toHit, initMod: Math.floor((m.ability_scores.DEX-10)/2), dmg: atk ? atk.name : "Attack", timestamp: new Date().toISOString() });
    }

    window.saveMonsterToNotes = async function() {
        if (!window.isAuthReady || !lastGeneratedMonster) return;
        const newNote = { id: crypto.randomUUID(), title: lastGeneratedMonster.name, content: document.getElementById('monster-output').innerHTML, timestamp: new Date().toISOString() };
        structuredNotes['enemyNotes'].unshift(newNote); await window.saveStructuredNotes('enemyNotes', structuredNotes['enemyNotes']);
        window.switchTab('notes'); window.switchSubTab('enemyNotes');
    }

    window.generateLoot = async () => {
        const btn = document.getElementById('generate-loot-button'); btn.disabled = true;
        const output = document.getElementById('loot-output'); output.textContent = "Generating...";
        try {
            const prompt = `Generate D&D 5e loot for Level ${document.getElementById('loot-level').value} ${document.getElementById('loot-type').value}.`;
            const data = await callAI(API_URL, { contents: [{ parts: [{ text: prompt }] }] });
            output.innerText = data.candidates[0].content.parts[0].text;
        } catch(e) { output.textContent = "Error"; }
        finally { document.getElementById('loot-loading-spinner').classList.add('hidden'); btn.disabled = false; }
    };

    window.generateCreativeIdea = async () => {
        const btn = document.getElementById('generate-button'); btn.disabled = true;
        const output = document.getElementById('ai-output'); output.textContent = "Generating...";
        try {
            const data = await callAI(API_URL, { contents: [{ parts: [{ text: `Generate D&D idea: ${document.getElementById('improv-prompt').value}` }] }] });
            output.innerHTML = data.candidates[0].content.parts[0].text.replace(/\n/g, '<br>');
            document.getElementById('save-options-creative').classList.remove('hidden');
        } catch(e) { output.textContent = "Error"; }
        finally { document.getElementById('creative-loading-spinner').classList.add('hidden'); btn.disabled = false; }
    };
    
    window.generateSettlement = async () => {
        const btn = document.getElementById('generate-settlement-button'); 
        const spinner = document.getElementById('settlement-loading-spinner');
        const outputDiv = document.getElementById('ai-output'); 
        btn.disabled = true; spinner.classList.remove('hidden'); outputDiv.textContent = "Generating settlement details...";
        try {
            const type = document.getElementById('settlement-type').value, vibe = document.getElementById('settlement-vibe').value;
            const prompt = `Generate details for a D&D ${type}: ${vibe}. Include sections for Ruler/Leader, Key Locations, and Current Conflict/Quests. Use clear markdown headers.`;
            const data = await callAI(API_URL, { contents: [{ parts: [{ text: prompt }] }] });
            outputDiv.innerHTML = data.candidates[0].content.parts[0].text.replace(/\n/g, '<br>'); 
            document.getElementById('save-options-creative').classList.remove('hidden'); 
        } catch(e) { outputDiv.textContent = "Error: " + e.message; }
        finally { btn.disabled = false; spinner.classList.add('hidden'); }
    };

    window.saveGeneratedContent = async function(destinationTab) {
        if (!window.isAuthReady) return;
        let content = document.getElementById('ai-output').innerHTML;
        if (currentTab === 'loot') content = document.getElementById('loot-output').innerText;
        
        // Generate title dynamically
        const title = generateTitleFromContent(content);
        
        structuredNotes[destinationTab].unshift({ id: crypto.randomUUID(), title: title, content: content, timestamp: new Date().toISOString() });
        await window.saveStructuredNotes(destinationTab, structuredNotes[destinationTab]);
        window.switchTab('notes'); window.switchSubTab(destinationTab);
    };

    // --- 11. STARTUP & AUTH LISTENER ---
    onAuthStateChanged(window.auth, async (user) => {
        // Force Clear Data to ensure privacy on switch/refresh
        combatants = []; 
        savedStatblocks = []; 
        structuredNotes = { prepNotes: [], enemyNotes: [], npcNotes: [], lootNotes: [] };
        
        // Re-render empty state
        if(typeof renderCombatants === 'function') renderCombatants();
        if(typeof renderStatblocks === 'function') renderStatblocks();
        if(typeof renderStructuredNotes === 'function') renderStructuredNotes(currentSubTab);

        if (user) {
            console.log("‚úÖ User connected:", user.uid);
            window.userId = user.uid;
            window.isAuthReady = true;
            updateLoginUI(user);
            
            // Connect listeners for new user
            if(window.setupNotesListener) window.setupNotesListener();
            if(window.setupCombatDataListeners) window.setupCombatDataListeners();
            if(window.setupStatblocksListener) window.setupStatblocksListener();
            if(window.setupHomebrewListener) window.setupHomebrewListener();
        } else {
            console.log("‚ö†Ô∏è No user, signing in anonymously...");
            try { await signInAnonymously(window.auth); } catch(e) {}
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
        if(userApiKey) { document.getElementById('user-api-key').value = userApiKey; window.updateApiKey(userApiKey); }
        if(isChristmasMode) document.body.classList.add('christmas-mode');
        window.switchTab('improv');
        // --- DICE VISUALS (Colors, Textures & Reset Fixed) ---
        (function() {
            const canvas = document.getElementById('dice-canvas'); 
            if(!canvas) return; 
            const ctx = canvas.getContext('2d'); 
            let dice = []; 
            window.customDiceImage = null; // Global variable for the image

            window.uploadDiceTexture = function(input) { 
                if (input.files && input.files[0]) { 
                    const reader = new FileReader(); 
                    reader.onload = function(e) { 
                        const img = new Image(); 
                        img.onload = function() { window.customDiceImage = img; }; 
                        img.src = e.target.result; 
                    }; 
                    reader.readAsDataURL(input.files[0]); 
                } 
            };

            // --- THE MISSING FUNCTION ---
            window.resetDiceTexture = function() {
                // 1. Clear the image from the visualizer
                window.customDiceImage = null;
                // 2. Clear the input so you can re-upload the same file if needed
                const input = document.getElementById('dice-texture-input');
                if(input) input.value = "";
            };

            function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; } 
            window.addEventListener('resize', resize); resize();

            class VisualDie { 
                constructor(val, type) { 
                    this.val = val; this.type = type; 
                    this.x = canvas.width/2; this.y = canvas.height + 30; 
                    this.vx = (Math.random()-0.5)*20; this.vy = -(Math.random() * 15 + 20); 
                    this.angle = 0; this.vAngle = 0.2; 
                    const picker = document.getElementById('dice-color-picker'); 
                    this.color = picker ? picker.value : '#6366f1'; 
                } 
                update() { 
                    this.vy += 1; this.x += this.vx; this.y += this.vy; this.angle += this.vAngle; 
                    if(this.y > canvas.height - 50) { 
                        this.y = canvas.height - 50; this.vy *= -0.6; this.vx *= 0.9; 
                        if(Math.abs(this.vx) < 0.5 && Math.abs(this.vy) < 1) { this.vAngle = 0; } 
                    } 
                    if(this.x < 20 || this.x > canvas.width - 20) this.vx *= -0.8; 
                } 
                draw() { 
                    ctx.save(); ctx.translate(this.x, this.y); ctx.rotate(this.angle); ctx.beginPath(); 
                    if(this.type === 4) { ctx.moveTo(0,-20); ctx.lineTo(20,15); ctx.lineTo(-20,15); } 
                    else if(this.type === 6) { ctx.rect(-15,-15,30,30); } 
                    else if(this.type === 8 || this.type === 10) { ctx.moveTo(0,-25); ctx.lineTo(15,0); ctx.lineTo(0,25); ctx.lineTo(-15,0); } 
                    else if(this.type === 12) { for(let i=0;i<5;i++) ctx.lineTo(22*Math.cos(i*2*Math.PI/5-Math.PI/2), 22*Math.sin(i*2*Math.PI/5-Math.PI/2)); } 
                    else { for(let i=0;i<6;i++) ctx.lineTo(22*Math.cos(i*2*Math.PI/6), 22*Math.sin(i*2*Math.PI/6)); } 
                    ctx.closePath(); 
                    
                    // Draw Image or Color
                    if (window.customDiceImage) { 
                        ctx.save(); ctx.clip(); ctx.drawImage(window.customDiceImage, -25, -25, 50, 50); ctx.restore(); 
                    } else { 
                        ctx.fillStyle = this.color; ctx.fill(); 
                    } 
                    
                    ctx.strokeStyle = 'white'; ctx.lineWidth = 2; ctx.stroke(); 
                    ctx.fillStyle = 'white'; ctx.shadowColor = 'black'; ctx.shadowBlur = 4; 
                    ctx.font = 'bold 14px Arial'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; 
                    ctx.fillText(this.val, 0, 2); ctx.restore(); 
                } 
            }

            function animate() { 
                ctx.clearRect(0,0,canvas.width,canvas.height); 
                dice.forEach(d => { d.update(); d.draw(); }); 
                requestAnimationFrame(animate); 
            } 
            animate();

            window.throwDiceVisuals = (rolls, type) => { 
                dice = rolls.map(r => new VisualDie(r, type)); 
                setTimeout(() => { dice = []; ctx.clearRect(0, 0, canvas.width, canvas.height); }, 3500); 
            };
        })();
// --- FULL SOUNDBOARD LOGIC ---
        const ac = new (window.AudioContext||window.webkitAudioContext)();
        const masterGain = ac.createGain(); masterGain.connect(ac.destination); masterGain.gain.value = 0.5;
        let ambNodes = []; let ambType = null;
        const noiseBuf = ac.createBuffer(1, ac.sampleRate*2, ac.sampleRate);
        for(let i=0; i<noiseBuf.length; i++) noiseBuf.getChannelData(0)[i] = Math.random()*2-1;

        // Volume Slider
        const volSlider = document.getElementById('master-volume');
        if(volSlider) volSlider.addEventListener('input', (e) => masterGain.gain.setTargetAtTime(parseFloat(e.target.value), ac.currentTime, 0.01));

        // Audio Unlocker for Mobile
        const unlockMobileAudio = () => {
            if (ac.state === 'suspended') ac.resume();
            const buffer = ac.createBuffer(1, 1, 22050); const source = ac.createBufferSource();
            source.buffer = buffer; source.connect(ac.destination); source.start(0);
            document.removeEventListener('touchstart', unlockMobileAudio); document.removeEventListener('click', unlockMobileAudio);
        };
        document.addEventListener('touchstart', unlockMobileAudio); document.addEventListener('click', unlockMobileAudio);

        // Helper Sound Functions
        const playNote = (freq, t, dur, type = 'sine', vol = 0.3) => {
            const o = ac.createOscillator(); const g = ac.createGain(); o.type = type; o.frequency.value = freq; 
            o.connect(g); g.connect(masterGain); 
            g.gain.setValueAtTime(vol, t); g.gain.exponentialRampToValueAtTime(0.01, t + dur); o.start(t); o.stop(t + dur);
        };
        const playDrum = (type, time) => {
            const osc = ac.createOscillator(); const gain = ac.createGain(); osc.connect(gain); gain.connect(masterGain);
            if (type === 'kick') { osc.frequency.setValueAtTime(150, time); osc.frequency.exponentialRampToValueAtTime(0.01, time+0.5); gain.gain.setValueAtTime(0.5, time); gain.gain.exponentialRampToValueAtTime(0.01, time+0.5); osc.start(time); osc.stop(time+0.5); }
            else if (type === 'snare') { const n = ac.createBufferSource(); n.buffer = noiseBuf; const f = ac.createBiquadFilter(); f.type = 'highpass'; f.frequency.value = 1000; n.connect(f); f.connect(gain); gain.gain.setValueAtTime(0.4, time); gain.gain.exponentialRampToValueAtTime(0.01, time+0.2); n.start(time); n.stop(time+0.2); }
            else if (type === 'hihat') { const n = ac.createBufferSource(); n.buffer = noiseBuf; const f = ac.createBiquadFilter(); f.type = 'highpass'; f.frequency.value = 5000; n.connect(f); f.connect(gain); gain.gain.setValueAtTime(0.3, time); gain.gain.exponentialRampToValueAtTime(0.01, time+0.05); n.start(time); n.stop(time+0.05); }
            else if (type === 'tom') { osc.frequency.setValueAtTime(100, time); osc.frequency.exponentialRampToValueAtTime(50, time+0.3); gain.gain.setValueAtTime(0.4, time); gain.gain.exponentialRampToValueAtTime(0.01, time+0.3); osc.start(time); osc.stop(time+0.3); }
        };
        const playLute = (freq, startTime, duration) => {
            const osc = ac.createOscillator(); const gain = ac.createGain(); const filter = ac.createBiquadFilter(); osc.type = 'sawtooth'; osc.frequency.setValueAtTime(freq, startTime); filter.type = 'lowpass'; filter.frequency.setValueAtTime(1000, startTime); gain.gain.setValueAtTime(0.1, startTime); gain.gain.exponentialRampToValueAtTime(0.001, startTime + duration); osc.connect(filter); filter.connect(gain); gain.connect(masterGain); osc.start(startTime); osc.stop(startTime + duration);
        };
        const playAccordion = (freq, startTime, duration, vol = 0.15) => {
             const osc = ac.createOscillator(); const gain = ac.createGain(); const filter = ac.createBiquadFilter(); osc.type = 'sawtooth'; osc.frequency.setValueAtTime(freq, startTime); filter.type = 'lowpass'; filter.frequency.value = 2500; osc.connect(filter); filter.connect(gain); gain.connect(masterGain); gain.gain.setValueAtTime(0, startTime); gain.gain.linearRampToValueAtTime(vol, startTime+0.1); gain.gain.setValueAtTime(vol, startTime + duration - 0.1); gain.gain.linearRampToValueAtTime(0, startTime+duration); osc.start(startTime); osc.stop(startTime + duration);
        };

        // Main Play Tone Function
        window.playTone = function(type) {
            if (ac.state === 'suspended') ac.resume();
            const now = ac.currentTime;
            const osc = ac.createOscillator(); const gain = ac.createGain();
            
            switch (type) {
                case 'success': [523.25, 659.25, 783.99].forEach((freq, i) => { const o = ac.createOscillator(); const g = ac.createGain(); o.type = 'triangle'; o.frequency.value = freq; o.connect(g); g.connect(masterGain); g.gain.setValueAtTime(0, now); g.gain.linearRampToValueAtTime(0.1, now + i*0.1 + 0.05); g.gain.exponentialRampToValueAtTime(0.001, now + 1.0); o.start(now + i*0.1); o.stop(now + 1.0); }); break;
                case 'critical': [523.25, 1046.50, 1318.51].forEach((freq, i) => { const o = ac.createOscillator(); const g = ac.createGain(); o.type = 'square'; o.frequency.value = freq; o.connect(g); g.connect(masterGain); g.gain.setValueAtTime(0, now); g.gain.linearRampToValueAtTime(0.1, now + 0.05); g.gain.exponentialRampToValueAtTime(0.001, now + 1.5); o.start(now); o.stop(now + 1.5); }); break;
                case 'fail': { const o1 = ac.createOscillator(); const g1 = ac.createGain(); o1.type = 'sawtooth'; o1.frequency.setValueAtTime(196.00, now); o1.frequency.linearRampToValueAtTime(185.00, now + 0.4); o1.connect(g1); g1.connect(masterGain); g1.gain.setValueAtTime(0.2, now); g1.gain.linearRampToValueAtTime(0, now + 0.4); o1.start(now); o1.stop(now+0.4); const o2 = ac.createOscillator(); const g2 = ac.createGain(); o2.type = 'sawtooth'; o2.frequency.setValueAtTime(174.61, now + 0.45); o2.frequency.linearRampToValueAtTime(155.56, now + 1.0); o2.connect(g2); g2.connect(masterGain); g2.gain.setValueAtTime(0, now + 0.45); g2.gain.linearRampToValueAtTime(0.2, now + 0.5); g2.gain.linearRampToValueAtTime(0, now + 1.0); o2.start(now + 0.45); o2.stop(now + 1.0); } break;
                case 'combat_start': { osc.type = 'sawtooth'; osc.frequency.value = 60; const filter = ac.createBiquadFilter(); filter.type = 'lowpass'; filter.frequency.setValueAtTime(200, now); filter.frequency.linearRampToValueAtTime(1500, now + 0.1); filter.frequency.exponentialRampToValueAtTime(200, now + 2); osc.connect(filter); filter.connect(gain); gain.connect(masterGain); gain.gain.setValueAtTime(0, now); gain.gain.linearRampToValueAtTime(0.4, now + 0.1); gain.gain.exponentialRampToValueAtTime(0.001, now + 2); osc.start(now); osc.stop(now + 2); } break;
                case 'spell': { osc.type = 'sine'; osc.frequency.setValueAtTime(400, now); osc.frequency.exponentialRampToValueAtTime(2000, now + 1); gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0, now + 1); osc.connect(gain); gain.connect(masterGain); osc.start(now); osc.stop(now + 1); } break;
                case 'mystery': { const mo1 = ac.createOscillator(); const mg1 = ac.createGain(); mo1.type = 'sine'; mo1.frequency.value = 440; mo1.connect(mg1); mg1.connect(masterGain); mg1.gain.setValueAtTime(0, now); mg1.gain.linearRampToValueAtTime(0.2, now + 1); mg1.gain.linearRampToValueAtTime(0, now + 3); mo1.start(now); mo1.stop(now + 3); const mo2 = ac.createOscillator(); const mg2 = ac.createGain(); mo2.type = 'sine'; mo2.frequency.value = 455; mo2.connect(mg2); mg2.connect(masterGain); mg2.gain.setValueAtTime(0, now); mg2.gain.linearRampToValueAtTime(0.2, now + 1.5); mg2.gain.linearRampToValueAtTime(0, now + 3); mo2.start(now); mo2.stop(now + 3); } break;
                case 'rest': { [261.63, 329.63, 392.00, 523.25].forEach(f => { const o = ac.createOscillator(); const g = ac.createGain(); o.type = 'sine'; o.frequency.value = f; o.connect(g); g.connect(masterGain); g.gain.setValueAtTime(0, now); g.gain.linearRampToValueAtTime(0.05, now + 1); g.gain.linearRampToValueAtTime(0, now + 4); o.start(now); o.stop(now + 4); }); } break;
                case 'trap': { const n = ac.createBufferSource(); n.buffer = noiseBuf; const f = ac.createBiquadFilter(); f.type = 'highpass'; f.frequency.value = 1000; const ng = ac.createGain(); n.connect(f); f.connect(ng); ng.connect(masterGain); ng.gain.setValueAtTime(0.6, now); ng.gain.exponentialRampToValueAtTime(0.01, now + 0.1); n.start(now); n.stop(now + 0.1); osc.type = 'square'; osc.frequency.setValueAtTime(100, now); osc.frequency.exponentialRampToValueAtTime(40, now + 0.2); osc.connect(gain); gain.connect(masterGain); gain.gain.setValueAtTime(0.5, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.2); osc.start(now); osc.stop(now + 0.2); } break;
                case 'boss': { osc.type = 'sawtooth'; osc.frequency.setValueAtTime(55, now); const bf = ac.createBiquadFilter(); bf.type='lowpass'; bf.frequency.value=150; osc.connect(bf); bf.connect(gain); gain.connect(masterGain); gain.gain.setValueAtTime(0, now); gain.gain.linearRampToValueAtTime(0.5, now + 0.1); gain.gain.exponentialRampToValueAtTime(0.001, now + 3); osc.start(now); osc.stop(now + 3); } break;
                case 'wolf': { osc.type = 'triangle'; osc.frequency.setValueAtTime(400, now); osc.frequency.linearRampToValueAtTime(600, now + 0.5); osc.frequency.linearRampToValueAtTime(300, now + 2.5); gain.gain.setValueAtTime(0, now); gain.gain.linearRampToValueAtTime(0.2, now + 0.5); gain.gain.linearRampToValueAtTime(0, now + 2.5); osc.connect(gain); gain.connect(masterGain); osc.start(now); osc.stop(now + 2.5); } break;
                case 'bear': { osc.type = 'sawtooth'; osc.frequency.value = 50; const bearF = ac.createBiquadFilter(); bearF.type = 'lowpass'; bearF.frequency.setValueAtTime(100, now); bearF.frequency.linearRampToValueAtTime(600, now + 0.2); bearF.frequency.linearRampToValueAtTime(100, now + 1.0); osc.connect(bearF); bearF.connect(gain); gain.connect(masterGain); gain.gain.setValueAtTime(0, now); gain.gain.linearRampToValueAtTime(0.4, now + 0.1); gain.gain.linearRampToValueAtTime(0, now + 1.0); osc.start(now); osc.stop(now + 1.0); } break;
                case 'bird': { osc.type = 'sine'; osc.frequency.setValueAtTime(2000, now); osc.frequency.exponentialRampToValueAtTime(1000, now + 0.1); gain.gain.setValueAtTime(0, now); gain.gain.linearRampToValueAtTime(0.1, now + 0.01); gain.gain.linearRampToValueAtTime(0, now + 0.1); osc.connect(gain); gain.connect(masterGain); osc.start(now); osc.stop(now + 0.1); setTimeout(() => { const o2 = ac.createOscillator(); const g2 = ac.createGain(); o2.type = 'sine'; o2.frequency.setValueAtTime(2500, ac.currentTime); o2.frequency.exponentialRampToValueAtTime(1200, ac.currentTime + 0.1); g2.gain.setValueAtTime(0, ac.currentTime); g2.gain.linearRampToValueAtTime(0.1, ac.currentTime + 0.01); g2.gain.linearRampToValueAtTime(0, ac.currentTime + 0.1); o2.connect(g2); g2.connect(masterGain); o2.start(ac.currentTime); o2.stop(ac.currentTime + 0.1); }, 150); } break;
                case 'snake': { const n = ac.createBufferSource(); n.buffer = noiseBuf; const f = ac.createBiquadFilter(); f.type = 'highpass'; f.frequency.value = 3000; n.connect(f); f.connect(gain); gain.connect(masterGain); gain.gain.setValueAtTime(0, now); gain.gain.linearRampToValueAtTime(0.15, now + 0.5); gain.gain.linearRampToValueAtTime(0, now + 2.0); n.start(now); n.stop(now + 2.0); } break;
                case 'insect': { 
                    const playPulse = (t) => { const osc = ac.createOscillator(); osc.type = 'sawtooth'; osc.frequency.value = 4500; const filter = ac.createBiquadFilter(); filter.type = 'bandpass'; filter.frequency.value = 4500; filter.Q.value = 10; const g = ac.createGain(); osc.connect(filter); filter.connect(g); g.connect(masterGain); g.gain.setValueAtTime(0, t); g.gain.linearRampToValueAtTime(0.2, t + 0.002); g.gain.exponentialRampToValueAtTime(0.001, t + 0.02); osc.start(t); osc.stop(t + 0.03); };
                    const playChirp = (t) => { for(let i=0; i<4; i++) playPulse(t + (i * 0.018)); };
                    playChirp(now); playChirp(now + 0.3); playChirp(now + 0.6); 
                } break;
            }
        };

        window.toggleAmbience = function(t) {
            if(ac.state==='suspended') ac.resume();
            ambNodes.forEach(n => { try{n.stop()}catch(e){} try{n.disconnect()}catch(e){} }); ambNodes=[];
            document.querySelectorAll('.sound-btn').forEach(b => b.classList.remove('active-loop'));
            if(ambType === t) { ambType = null; document.getElementById('ambience-status').innerText = ""; return; }
            ambType = t; 
            const btn = document.getElementById(`ambience-${t}`);
            if(btn) btn.classList.add('active-loop');
            document.getElementById('ambience-status').innerText = "Playing: " + t.toUpperCase();
            const now = ac.currentTime;
            
            if (t === 'village') {
                const noise = ac.createBufferSource(); noise.buffer = noiseBuf; noise.loop = true; const filter = ac.createBiquadFilter(); filter.type = 'lowpass'; filter.frequency.setValueAtTime(400, now); const lfo = ac.createOscillator(); lfo.type = 'sine'; lfo.frequency.value = 0.1; const lfoGain = ac.createGain(); lfoGain.gain.value = 200; lfo.connect(lfoGain); lfoGain.connect(filter.frequency); const gain = ac.createGain(); gain.gain.value = 0.05; noise.connect(filter); filter.connect(gain); gain.connect(masterGain); noise.start(now); lfo.start(now); ambNodes.push(noise, lfo, gain);
                const iv1 = setInterval(() => { if (Math.random() > 0.7) { playNote(1500 + Math.random() * 500, ac.currentTime, 0.05, 'triangle', 0.02); } }, 2000);
                const scale = [261.63, 293.66, 329.63, 392.00, 440.00, 523.25]; 
                const iv2 = setInterval(() => { const t = ac.currentTime; if (Math.random() > 0.3) { const pitch = scale[Math.floor(Math.random() * scale.length)]; playLute(pitch, t, 0.4); } }, 600);
                ambNodes.push({ stop: () => { clearInterval(iv1); clearInterval(iv2); } });
            }
            else if (t === 'city') {
                // 1. Background Crowd Noise (Pink Noise Filtered)
                const noise = ac.createBufferSource(); noise.buffer = noiseBuf; noise.loop = true; 
                const filter = ac.createBiquadFilter(); filter.type = 'lowpass'; filter.frequency.value = 200; // Higher freq for "chatter"
                const gain = ac.createGain(); gain.gain.value = 0.08;
                noise.connect(filter); filter.connect(gain); gain.connect(masterGain); 
                noise.start(now); ambNodes.push(noise, gain);

                // 2. Street Musician (Procedural Lute Music)
                // Scale: D Dorian (Folk/Medieval feel) - D, E, F, G, A, B, C
                const scale = [146.83, 164.81, 174.61, 196.00, 220.00, 246.94, 261.63, 293.66];
                let beat = 0;
                
                const musicIv = setInterval(() => {
                    const t = ac.currentTime;
                    
                    // Steady Bass Line (Walking rhythm)
                    if (beat % 4 === 0) playLute(scale[0], t, 0.8); // Root (D)
                    if (beat % 4 === 2) playLute(scale[4], t, 0.6); // Fifth (A)

                    // Improvised Melody (High Octave)
                    if (Math.random() > 0.4) {
                        const noteIdx = Math.floor(Math.random() * scale.length);
                        const note = scale[noteIdx] * 2; // Up one octave
                        const timing = t + (Math.random() * 0.05); // Humanize timing slightly
                        playLute(note, timing, 0.3);
                    }

                    // Occasional Strum (Chord)
                    if (beat % 8 === 0 && Math.random() > 0.6) {
                        playLute(scale[0], t + 0.05, 0.5);
                        playLute(scale[2], t + 0.10, 0.5);
                        playLute(scale[4], t + 0.15, 0.5);
                    }
                    beat++;
                }, 350); // Tempo: approx 170bpm (Walking pace)

                // 3. Distant Town Sounds (Bells, shouts)
                const sfxIv = setInterval(() => {
                     if (Math.random() > 0.95) {
                         // Distant Church Bell
                         const bellT = ac.currentTime;
                         playNote(523.25, bellT, 2.0, 'sine', 0.1);
                         playNote(261.63, bellT, 2.0, 'triangle', 0.05);
                     }
                }, 2000);

                ambNodes.push({ stop: () => { clearInterval(musicIv); clearInterval(sfxIv); } });
            }
            else if (t === 'tavern') {
                const noise = ac.createBufferSource(); noise.buffer = noiseBuf; noise.loop = true; const filter = ac.createBiquadFilter(); filter.type = 'lowpass'; filter.frequency.value = 150; const gain = ac.createGain(); gain.gain.value = 0.25; noise.connect(filter); filter.connect(gain); gain.connect(masterGain); noise.start(now); ambNodes.push(noise, gain);
                const iv1 = setInterval(() => { if (Math.random() > 0.6) { playNote(1200, ac.currentTime, 0.05, 'triangle', 0.05); } }, 2500);
                const scale = [261.63, 293.66, 329.63, 392.00, 440.00, 523.25]; let beat = 0; 
                const iv2 = setInterval(() => { const t = ac.currentTime; if (beat % 4 === 0) { playLute(130.81, t, 0.8); } if (Math.random() > 0.2) { playLute(scale[Math.floor(Math.random() * scale.length)], t + 0.05, 0.4); } beat++; }, 300);
                ambNodes.push({ stop: () => { clearInterval(iv1); clearInterval(iv2); } });
            }
            else if (t === 'ocean') {
                const drone = ac.createOscillator(); drone.type = 'sawtooth'; drone.frequency.value = 73.42; const df = ac.createBiquadFilter(); df.type = 'lowpass'; df.frequency.value = 300; const dg = ac.createGain(); dg.gain.value = 0.05; drone.connect(df); df.connect(dg); dg.connect(masterGain); drone.start(now); ambNodes.push(drone, dg);
                const shanty = [293.66, 329.63, 349.23, 392.00, 440.00, 493.88, 523.25]; let beat = 0;
                const iv = setInterval(() => { const t = ac.currentTime; if (beat % 2 === 0) { playDrum('kick', t); playAccordion(146.83, t, 0.4, 0.2); } else { playDrum('snare', t); playAccordion(293.66, t, 0.2, 0.05); } if (Math.random() > 0.3) { playAccordion(shanty[Math.floor(Math.random()*shanty.length)], t, 0.4, 0.15); } beat++; }, 600);
                ambNodes.push({ stop: () => clearInterval(iv) });
            }
            else if (t === 'dungeon') {
                const d1 = ac.createOscillator(); d1.type = 'triangle'; d1.frequency.value = 55; const d2 = ac.createOscillator(); d2.type = 'sine'; d2.frequency.value = 58; const dg = ac.createGain(); dg.gain.value = 0.15; const f = ac.createBiquadFilter(); f.type = 'lowpass'; f.frequency.value = 300; d1.connect(f); d2.connect(f); f.connect(dg); dg.connect(masterGain); d1.start(now); d2.start(now); ambNodes.push(d1, d2, dg);
                const iv1 = setInterval(() => { if (Math.random() > 0.6) { const t = ac.currentTime; const o = ac.createOscillator(); o.type = 'sine'; o.frequency.setValueAtTime(2000 + Math.random() * 500, t); const g = ac.createGain(); g.gain.setValueAtTime(0, t); g.gain.linearRampToValueAtTime(0.1, t + 0.01); g.gain.exponentialRampToValueAtTime(0.001, t + 0.15); o.connect(g); g.connect(masterGain); o.start(t); o.stop(t + 0.5); } }, 3000);
                ambNodes.push({ stop: () => clearInterval(iv1) });
            }
            else if (t === 'battle_minor') {
                const bpm = 130; const stepTime = (60 / bpm) / 4; let step = 0; const bassFreqs = [73.42, 73.42, 73.42, 73.42, 87.31, 87.31, 82.41, 82.41]; 
                const iv = setInterval(() => { 
                    const t = ac.currentTime; const barStep = step % 16; 
                    if (step % 2 === 0) { const osc = ac.createOscillator(); osc.type = 'sawtooth'; osc.frequency.value = bassFreqs[Math.floor((step % 16) / 2) % bassFreqs.length]; const f = ac.createBiquadFilter(); f.type = 'lowpass'; f.frequency.value = 600; const g = ac.createGain(); g.gain.setValueAtTime(0.25, t); g.gain.exponentialRampToValueAtTime(0.01, t + 0.15); osc.connect(f); f.connect(g); g.connect(masterGain); osc.start(t); osc.stop(t + 0.2); }
                    if (barStep === 0 || barStep === 6 || barStep === 10) { playDrum('kick', t); if(barStep === 0) playDrum('tom', t); }
                    if (barStep === 4 || barStep === 12) { playDrum('snare', t); }
                    if (barStep % 2 === 0) { const hOsc = ac.createOscillator(); hOsc.type = 'square'; hOsc.frequency.value = 800; const hG = ac.createGain(); hG.gain.setValueAtTime(0.03, t); hG.gain.exponentialRampToValueAtTime(0.001, t + 0.03); hOsc.connect(hG); hG.connect(masterGain); hOsc.start(t); hOsc.stop(t + 0.05); }
                    step++; 
                }, stepTime * 1000);
                ambNodes.push({ stop: () => clearInterval(iv) });
            }
            else if (t === 'battle_major') {
                const osc = ac.createOscillator(); osc.type = 'sawtooth'; osc.frequency.value = 35; const f = ac.createBiquadFilter(); f.type = 'lowpass'; f.frequency.value = 200; const lfo = ac.createOscillator(); lfo.type = 'sine'; lfo.frequency.value = 0.25; const lG = ac.createGain(); lG.gain.value = 150; lfo.connect(lG); lG.connect(f.frequency); const g = ac.createGain(); g.gain.value = 0.2; osc.connect(f); f.connect(g); g.connect(masterGain); osc.start(now); lfo.start(now); ambNodes.push(osc, f, g, lfo, lG);
                let beat = 0; const iv = setInterval(() => { const t = ac.currentTime; if (beat % 4 === 0) { playDrum('kick', t); playDrum('tom', t + 0.1); } if (beat % 4 === 2) { playDrum('snare', t); playDrum('kick', t); } playDrum('hihat', t); playDrum('hihat', t + 0.21); beat++; }, 428);
                ambNodes.push({ stop: () => clearInterval(iv) });
            }
            else if (t === 'sleep') {
                const noise = ac.createBufferSource(); noise.buffer = noiseBuf; noise.loop = true; const f = ac.createBiquadFilter(); f.type = 'lowpass'; f.frequency.value = 120; const g = ac.createGain(); g.gain.value = 0.3; noise.connect(f); f.connect(g); g.connect(masterGain); noise.start(now); ambNodes.push(noise, g);
                const iv1 = setInterval(() => { if (Math.random() > 0.7) { const n = ac.createBufferSource(); n.buffer = noiseBuf; const f2 = ac.createBiquadFilter(); f2.type = 'highpass'; f2.frequency.value = 2000; const g2 = ac.createGain(); g2.gain.value = 0.1 + Math.random() * 0.1; g2.gain.exponentialRampToValueAtTime(0.01, ac.currentTime + 0.05); n.connect(f2); f2.connect(g2); g2.connect(masterGain); n.start(); n.stop(ac.currentTime + 0.05); } }, 200);
                const scale = [196.00, 220.00, 246.94, 293.66, 329.63]; 
                const iv2 = setInterval(() => { if (Math.random() > 0.4) { const t = ac.currentTime; const noteIdx = Math.floor(Math.random() * scale.length); playNote(scale[noteIdx], t, 4, 'sine', 0.1); } }, 5000);
                ambNodes.push({ stop: () => { clearInterval(iv1); clearInterval(iv2); } });
            }
        };
        
        
        // --- END OF SOUNDBOARD LOGIC ---

        window.splitLoot = function() {
            const pp = parseInt(document.getElementById('loot-pp').value) || 0;
            const gp = parseInt(document.getElementById('loot-gp').value) || 0;
            const ep = parseInt(document.getElementById('loot-ep').value) || 0;
            const sp = parseInt(document.getElementById('loot-sp').value) || 0;
            const cp = parseInt(document.getElementById('loot-cp').value) || 0;
            const count = parseInt(document.getElementById('loot-party-size').value) || 1;

            if (count < 1) return;

            // Convert everything to copper to divide evenly
            const totalCopper = cp + (sp * 10) + (ep * 50) + (gp * 100) + (pp * 1000);
            const shareCopper = Math.floor(totalCopper / count);
            const remainder = totalCopper % count;

            // Convert the share back up to highest denominations
            let rest = shareCopper;
            const rPP = Math.floor(rest / 1000); rest %= 1000;
            const rGP = Math.floor(rest / 100); rest %= 100;
            const rEP = Math.floor(rest / 50); rest %= 50;
            const rSP = Math.floor(rest / 10); rest %= 10;
            const rCP = rest;

            let result = [];
            if(rPP) result.push(`${rPP}pp`);
            if(rGP) result.push(`${rGP}gp`);
            if(rEP) result.push(`${rEP}ep`);
            if(rSP) result.push(`${rSP}sp`);
            if(rCP) result.push(`${rCP}cp`);
            
            const resultText = result.length > 0 ? "Each gets: " + result.join(", ") : "Nothing to split.";
            const remainderText = remainder > 0 ? ` <span class='text-red-400'>(${remainder}cp left)</span>` : "";

            document.getElementById('loot-split-result').innerHTML = resultText + remainderText;
        };
    });
    
// --- 12. MONSTER COMPENDIUM (Strict CR Filtering) ---

    // Helpers
    const getMod = (s) => Math.floor((s - 10) / 2);
    const fmtMod = (s) => { const m = getMod(s); return m >= 0 ? `+${m}` : m; };
    const fmtSpeed = (s) => {
        if (!s) return '30 ft.';
        if (typeof s === 'object') return Object.entries(s).map(([k, v]) => `${k} ${v} ft.`).join(', ');
        return s;
    };

    window.searchCompendium = async () => {
        const rawQuery = document.getElementById('compendium-search').value.trim();
        const cr = document.getElementById('compendium-cr').value; 
        const list = document.getElementById('compendium-results');
        
        if (!rawQuery && !cr) {
             list.innerHTML = '<p class="text-center text-gray-500 text-xs">Search by Name or CR.</p>';
             return;
        }
        
        list.innerHTML = '<div class="loading-spinner mx-auto"></div>';
        
        try {
            // 1. Build API URL
            // We ask for 100 results to ensure we get a good pool of monsters to filter through
            let url = `https://api.open5e.com/monsters/?limit=100`; 
            if (rawQuery) url += `&search=${rawQuery}`;
            if (cr) url += `&challenge_rating=${cr}`; 

            const res = await fetch(url);
            const data = await res.json();
            
            // 2. STRICT FILTERING (The Fix)
            // Even if the API returns a "close match", we delete it if the CR is wrong.
            let results = data.results;
            
            if (cr) {
                results = results.filter(m => m.challenge_rating == cr);
            }

            if (results.length === 0) {
                list.innerHTML = '<p class="text-center text-gray-500 text-xs">No monsters found.</p>';
                return;
            }

            // 3. SORTING (Alphabetical or Relevance)
            if (rawQuery) {
                const query = rawQuery.toLowerCase();
                results.sort((a, b) => {
                    const nameA = a.name.toLowerCase();
                    const nameB = b.name.toLowerCase();
                    if (nameA === query && nameB !== query) return -1;
                    if (nameB === query && nameA !== query) return 1;
                    const startA = nameA.startsWith(query);
                    const startB = nameB.startsWith(query);
                    if (startA && !startB) return -1;
                    if (!startA && startB) return 1;
                    return nameA.length - nameB.length;
                });
            } else {
                // If looking up by CR only, just sort A-Z
                results.sort((a, b) => a.name.localeCompare(b.name));
            }

            list.innerHTML = '';

            // 4. RENDER
            results.forEach((m, index) => {
                const initMod = getMod(m.dexterity || 10);
                const hp = m.hit_points || 10;
                const ac = m.armor_class || 10;
                const safeName = m.name.replace(/'/g, "\\'");
                const uniqueId = `monster-${index}`;

                const div = document.createElement('div');
                div.className = 'bg-gray-800 rounded border border-gray-700 overflow-hidden mb-2';
                
                div.innerHTML = `
                    <div class="p-3 flex justify-between items-center cursor-pointer hover:bg-gray-700 transition select-none" onclick="document.getElementById('${uniqueId}').classList.toggle('hidden')">
                        <div>
                            <div class="font-bold text-blue-200 text-sm flex items-center gap-2">
                                <span>${m.name}</span>
                                <span class="text-[10px] text-gray-500">‚ñº</span>
                            </div>
                            <div class="text-[10px] text-gray-400">
                                CR ${m.challenge_rating} ‚Ä¢ AC ${ac} ‚Ä¢ HP ${hp} ‚Ä¢ Init ${initMod >= 0 ? '+'+initMod : initMod}
                            </div>
                        </div>
                        <button onclick="event.stopPropagation(); window.importCompendiumMonster('${safeName}', ${hp}, ${ac}, ${initMod})" class="bg-green-700 hover:bg-green-600 text-white text-xs font-bold py-1 px-3 rounded transition shadow-lg border border-green-500">
                            + Add
                        </button>
                    </div>

                    <div id="${uniqueId}" class="hidden border-t border-gray-600">
                        <div class="dnd-statblock text-left text-xs sm:text-sm">
                            <div class="dnd-property-line"><strong>Speed</strong> ${fmtSpeed(m.speed)}</div>
                            <div class="dnd-property-line"><strong>Senses</strong> ${m.senses || '-'}</div>
                            <div class="dnd-property-line"><strong>Languages</strong> ${m.languages || '-'}</div>
                            <div class="dnd-property-line"><strong>Stats</strong> 
                                STR ${m.strength} (${fmtMod(m.strength)}), 
                                DEX ${m.dexterity} (${fmtMod(m.dexterity)}), 
                                CON ${m.constitution} (${fmtMod(m.constitution)}), 
                                INT ${m.intelligence} (${fmtMod(m.intelligence)}), 
                                WIS ${m.wisdom} (${fmtMod(m.wisdom)}), 
                                CHA ${m.charisma} (${fmtMod(m.charisma)})
                            </div>
                            ${m.special_abilities ? m.special_abilities.map(a => `<div class="mt-2 leading-snug"><strong class="italic text-red-900">${a.name}.</strong> <span class="text-black">${a.desc}</span></div>`).join('') : ''}
                            ${m.actions ? `<div class="dnd-section-title mt-2">Actions</div>${m.actions.map(a => `<div class="mb-1 leading-snug"><strong class="dnd-action-name text-red-900">${a.name}.</strong> <span class="text-black">${a.desc}</span></div>`).join('')}` : ''}
                            ${m.legendary_actions ? `<div class="dnd-section-title mt-2">Legendary Actions</div>${m.legendary_actions.map(a => `<div class="mb-1 leading-snug"><strong class="dnd-action-name text-red-900">${a.name}.</strong> <span class="text-black">${a.desc}</span></div>`).join('')}` : ''}
                        </div>
                    </div>
                `;
                list.appendChild(div);
            });
            
        } catch (error) {
            console.error(error);
            list.innerHTML = '<p class="text-center text-red-400 text-xs">Error fetching data.</p>';
        }
    };
        // --- THE MISSING IMPORT FUNCTION ---
    window.importCompendiumMonster = async (name, hp, ac, initMod) => {
        // 1. Check if logged in
        if(!window.isAuthReady) { 
            alert("Please log in to a session first."); 
            return; 
        }
        
        // 2. Save to Private Database
        try {
            await window.addDoc(getCol('shared_combatants'), { 
                name: name, 
                init: 0, 
                maxHp: hp, 
                currentHp: hp, 
                ac: ac, 
                initModifier: parseInt(initMod) || 0 // Save the Dex Mod for initiative rolling
            });
            
            // 3. Switch to Combat Tab to show the user
            window.switchTab('combat');
            
        } catch (error) {
            console.error("Error importing monster:", error);
            alert("Failed to add monster. Check console for details.");
        }
    };
    
    // --- 13. ENCOUNTER BALANCER ---
    let calcMonsters = [];
    
    // XP Thresholds per Character Level [Level, Easy, Med, Hard, Deadly]
    const xpThresholds = {
        1: [25, 50, 75, 100], 2: [50, 100, 150, 200], 3: [75, 150, 225, 400], 4: [125, 250, 375, 500],
        5: [250, 500, 750, 1100], 6: [300, 600, 900, 1400], 7: [350, 750, 1100, 1700], 8: [450, 900, 1400, 2100],
        9: [550, 1100, 1600, 2400], 10: [600, 1200, 1900, 2800], 11: [800, 1600, 2400, 3600], 12: [1000, 2000, 3000, 4500],
        13: [1100, 2200, 3400, 5100], 14: [1250, 2500, 3800, 5700], 15: [1400, 2800, 4300, 6400], 16: [1600, 3200, 4800, 7200],
        17: [2000, 3900, 5900, 8800], 18: [2100, 4200, 6300, 9500], 19: [2400, 4900, 7300, 10900], 20: [2800, 5700, 8500, 12700]
    };

    window.addCalcMonster = () => {
        const select = document.getElementById('calc-cr');
        const xp = parseInt(select.value);
        const count = parseInt(document.getElementById('calc-count').value) || 1;
        const label = select.options[select.selectedIndex].text;
        
        for(let i=0; i<count; i++) calcMonsters.push(xp);
        window.calcEncounter();
    };

    window.removeCalcMonster = (index) => {
        calcMonsters.splice(index, 1);
        window.calcEncounter();
    };

    window.clearCalc = () => {
        calcMonsters = [];
        window.calcEncounter();
    };

    window.calcEncounter = () => {
        const list = document.getElementById('calc-monster-list');
        const resultBox = document.getElementById('calc-result');
        const diffText = document.getElementById('calc-difficulty-text');
        const xpDetail = document.getElementById('calc-xp-details');
        
        // 1. Render List
        list.innerHTML = '';
        calcMonsters.forEach((xp, idx) => {
            const tag = document.createElement('span');
            tag.className = 'bg-gray-700 text-gray-200 text-xs px-2 py-1 rounded cursor-pointer hover:bg-red-900';
            tag.innerHTML = `${xp} XP &times;`;
            tag.onclick = () => window.removeCalcMonster(idx);
            list.appendChild(tag);
        });

        if (calcMonsters.length === 0) {
            diffText.textContent = "Add Monsters...";
            diffText.className = "text-2xl font-bold text-gray-500";
            resultBox.className = "bg-gray-900 p-4 rounded-lg text-center border border-gray-700";
            xpDetail.textContent = "";
            return;
        }

        // 2. Calculate Math
        const partySize = parseInt(document.getElementById('calc-party-size').value) || 4;
        const level = parseInt(document.getElementById('calc-party-level').value) || 1;
        
        // Total Raw XP
        const totalXP = calcMonsters.reduce((a, b) => a + b, 0);
        
        // Multiplier based on count (DMG p.82)
        let mult = 1;
        const n = calcMonsters.length;
        if (n === 2) mult = 1.5;
        else if (n >= 3 && n <= 6) mult = 2;
        else if (n >= 7 && n <= 10) mult = 2.5;
        else if (n >= 11 && n <= 14) mult = 3;
        else if (n >= 15) mult = 4;

        // Adjusted XP for Difficulty
        const adjustedXP = totalXP * mult;

        // Party Thresholds
        const thresholds = xpThresholds[level] || xpThresholds[1];
        const partyEasy = thresholds[0] * partySize;
        const partyMed = thresholds[1] * partySize;
        const partyHard = thresholds[2] * partySize;
        const partyDeadly = thresholds[3] * partySize;

        // Determine Rating
        let rating = "Trivial";
        let colorClass = "text-gray-400 border-gray-600";

        if (adjustedXP >= partyDeadly) { rating = "üíÄ Deadly"; colorClass = "text-red-500 border-red-500 shadow-[0_0_15px_rgba(239,68,68,0.4)]"; }
        else if (adjustedXP >= partyHard) { rating = "Hard"; colorClass = "text-orange-400 border-orange-400"; }
        else if (adjustedXP >= partyMed) { rating = "Medium"; colorClass = "text-yellow-300 border-yellow-300"; }
        else if (adjustedXP >= partyEasy) { rating = "Easy"; colorClass = "text-green-400 border-green-400"; }

        diffText.textContent = rating;
        resultBox.className = `bg-gray-900 p-4 rounded-lg text-center border-2 transition duration-300 ${colorClass}`;
        xpDetail.textContent = `Adjusted XP: ${adjustedXP} (Daily Budget: ${Math.round((adjustedXP / (partyDeadly*3))*100)}%)`;
    };
    
    // --- 14. RULES, SPELLS & WEAPONS ENGINE ---
    let currentRuleMode = 'spells'; // 'spells', 'weapons', or 'sections'

    window.switchRuleMode = (mode, btn) => {
        currentRuleMode = mode;
        // 1. Update UI Styles
        document.querySelectorAll('.rule-sub-tab').forEach(b => {
            b.classList.remove('active', 'border-b-2', 'border-purple-400', 'text-purple-300');
            b.classList.add('text-gray-400');
        });
        btn.classList.add('active', 'border-b-2', 'border-purple-400', 'text-purple-300');
        btn.classList.remove('text-gray-400');
        
        // 2. Clear & Update Placeholder
        const input = document.getElementById('library-search');
        input.value = "";
        if(mode === 'spells') input.placeholder = "Search spells (e.g. Fireball)...";
        else if(mode === 'weapons') input.placeholder = "Search weapons (e.g. Dagger)...";
        else input.placeholder = "Search rules (e.g. Cover)...";

        // 3. Trigger Search Logic (Auto-load if Rules or Weapons)
        window.searchLibrary();
    };

    window.searchLibrary = async () => {
        const rawQuery = document.getElementById('library-search').value.trim();
        const list = document.getElementById('library-results');
        
        // Auto-load logic: Only require typing for Spells (to save data)
        // Weapons and Rules are small lists, so we can auto-load them if search is empty.
        if (!rawQuery && currentRuleMode === 'spells') {
             list.innerHTML = '<p class="text-center text-gray-500 text-xs">Type a spell name to search...</p>';
             return;
        }

        list.innerHTML = '<div class="loading-spinner mx-auto"></div>';

        try {
            // 1. Build URL
            let url = `https://api.open5e.com/${currentRuleMode}/?limit=${currentRuleMode === 'spells' ? 20 : 100}`;
            
            if (rawQuery) {
                url += `&search=${rawQuery}`;
            } else if (currentRuleMode !== 'spells') {
                // If empty search for weapons/rules, get everything sorted A-Z
                url += `&ordering=name`; 
            }

            const res = await fetch(url);
            const data = await res.json();
            let results = data.results;

            if (results.length === 0) {
                list.innerHTML = '<p class="text-center text-gray-500 text-xs">No results found.</p>';
                return;
            }

            // 2. SMART SORTING
            if (rawQuery) {
                const query = rawQuery.toLowerCase();
                results.sort((a, b) => {
                    const nameA = a.name.toLowerCase();
                    const nameB = b.name.toLowerCase();
                    if (nameA === query && nameB !== query) return -1;
                    if (nameB === query && nameA !== query) return 1;
                    const startA = nameA.startsWith(query);
                    const startB = nameB.startsWith(query);
                    if (startA && !startB) return -1;
                    if (!startA && startB) return 1;
                    return nameA.length - nameB.length;
                });
            } else {
                results.sort((a, b) => a.name.localeCompare(b.name));
            }

            list.innerHTML = '';

            // 3. RENDER
            results.forEach((item, index) => {
                const uniqueId = `lib-${index}`;
                const div = document.createElement('div');
                div.className = 'bg-gray-800 rounded border border-gray-700 overflow-hidden mb-2';

                if (currentRuleMode === 'spells') {
                    // --- SPELL ---
                    div.innerHTML = `
                        <div class="p-3 flex justify-between items-center cursor-pointer hover:bg-gray-700 transition select-none" onclick="document.getElementById('${uniqueId}').classList.toggle('hidden')">
                            <div><div class="font-bold text-purple-300 text-sm">${item.name}</div><div class="text-[10px] text-gray-400">${item.level} ‚Ä¢ ${item.school}</div></div>
                            <span class="text-[10px] text-gray-500">‚ñº</span>
                        </div>
                        <div id="${uniqueId}" class="hidden bg-gray-900/50 p-3 border-t border-gray-600 text-xs text-gray-300 leading-relaxed">
                            <p class="mb-2"><strong class="text-purple-400">Range:</strong> ${item.range} | <strong class="text-purple-400">Comp:</strong> ${item.components} | <strong class="text-purple-400">Dur:</strong> ${item.duration}</p>
                            <div class="whitespace-pre-wrap">${item.desc}</div>
                        </div>`;
                } 
                else if (currentRuleMode === 'weapons') {
                    // --- WEAPON ---
                    // Format properties array if it exists
                    const props = item.properties ? item.properties.map(p => p.name || p).join(', ') : '-';
                    div.innerHTML = `
                        <div class="p-3 flex justify-between items-center cursor-pointer hover:bg-gray-700 transition select-none" onclick="document.getElementById('${uniqueId}').classList.toggle('hidden')">
                            <div class="flex items-center gap-3">
                                <div class="font-bold text-red-300 text-sm">${item.name}</div>
                                <div class="text-xs font-mono bg-gray-700 px-2 py-0.5 rounded text-white">${item.damage_dice || '-'} ${item.damage_type || ''}</div>
                            </div>
                            <span class="text-[10px] text-gray-500">‚ñº</span>
                        </div>
                        <div id="${uniqueId}" class="hidden bg-gray-900/50 p-3 border-t border-gray-600 text-xs text-gray-300 leading-relaxed grid grid-cols-2 gap-2">
                            <div><strong class="text-red-400">Category:</strong> ${item.category}</div>
                            <div><strong class="text-red-400">Cost:</strong> ${item.cost}</div>
                            <div><strong class="text-red-400">Weight:</strong> ${item.weight}</div>
                            <div class="col-span-2"><strong class="text-red-400">Properties:</strong> ${props}</div>
                        </div>`;
                } 
                else {
                    // --- RULE (SRD) ---
                    div.innerHTML = `
                        <div class="p-3 flex justify-between items-center cursor-pointer hover:bg-gray-700 transition select-none" onclick="document.getElementById('${uniqueId}').classList.toggle('hidden')">
                            <div class="font-bold text-yellow-200 text-sm">${item.name}</div>
                            <span class="text-[10px] text-gray-500">‚ñº</span>
                        </div>
                        <div id="${uniqueId}" class="hidden bg-gray-900/50 p-3 border-t border-gray-600 text-xs text-gray-300 leading-relaxed whitespace-pre-wrap">${item.desc}</div>`;
                }
                list.appendChild(div);
            });

        } catch (error) {
            console.error(error);
            list.innerHTML = '<p class="text-center text-red-400 text-xs">Error fetching data.</p>';
        }
    };

// --- 15. NAME GENERATOR (Expanded & Gendered) ---
    const nameDatabase = {
        "Human": { 
            male: ["Alaric", "Bram", "Dorian", "Garret", "Ivo", "Kael", "Niles", "Orin", "Silas", "Vane", "Alden", "Roric", "Ewan", "Gareth", "Lucian", "Torian", "Victor", "Xander", "Hollis", "Jareth"], 
            female: ["Celia", "Elara", "Fiora", "Halia", "Jessa", "Lora", "Maren", "Petra", "Ria", "Tamsin", "Veda", "Lyra", "Amara", "Brenna", "Dalia", "Elena", "Kiera", "Nora", "Ophelia", "Serena"], 
            last: ["Stormwind", "Blackwood", "Thorne", "Rivera", "Crowley", "Falconer", "Weaver", "Dunn", "Hart", "Mercer", "Ashford", "Brightwood", "Drake", "Fletcher", "Grimm", "Hawthorne", "Ironwood", "Sterling", "Vance", "Whitmore"] 
        },
        "Elf": { 
            male: ["Adran", "Carric", "Erdan", "Galin", "Himo", "Ivellios", "Mindartis", "Paelias", "Riardon", "Thamior", "Aramil", "Aust", "Enialis", "Heian", "Laucian", "Quarion", "Soveliss", "Tharivol", "Varis"], 
            female: ["Bylia", "Deara", "Faen", "Lia", "Naivara", "Quillathe", "Silaqui", "Thia", "Vadania", "Valanthe", "Adrie", "Althaea", "Anastrianna", "Andraste", "Bethrynna", "Caelynn", "Drusilia", "Ielenia", "Jelenneth", "Keyleth", "Leshanna", "Meriele", "Mialee", "Theirastra"], 
            last: ["Amakiir", "Caerdonel", "Galanodel", "Holimion", "Ilphelkiir", "Liadon", "Meliamne", "Nailo", "Siannodel", "Xiloscient", "Gemflower", "Moonwhisper", "Oakwalker", "Nightbreeze", "Starflower", "Silverfrond"] 
        },
        "Dwarf": { 
            male: ["Adrik", "Baern", "Brottor", "Dain", "Darrak", "Eberk", "Fargrim", "Gardain", "Harbek", "Kildrak", "Morgran", "Orsik", "Rangrim", "Thoradin", "Tordek", "Travok", "Ulfgar", "Veit", "Vondal"], 
            female: ["Amber", "Artin", "Audhild", "Bardryn", "Dagnal", "Diesa", "Eldeth", "Falkrunn", "Finellen", "Gunnloda", "Gurdis", "Helja", "Hlin", "Kathra", "Kristryd", "Ilde", "Liftrasa", "Mardred", "Riswynn", "Torbera", "Vistra"], 
            last: ["Battlehammer", "Brawnanvil", "Fireforge", "Frostbeard", "Gorunn", "Ironfist", "Loderr", "Strakeln", "Torunn", "Ungart", "Balderk", "Dankil", "Holderhek", "Loderr", "Lutgehr", "Rumnaheim", "Strakeln", "Torunn"] 
        },
        "Orc": { 
            male: ["Dench", "Feng", "Gell", "Henk", "Holg", "Imsh", "Keth", "Krusk", "Mhurren", "Ront", "Shump", "Thokk", "Grom", "Horgar", "Drago", "Rath", "Sark", "Varg"], 
            female: ["Baggi", "Emen", "Engong", "Kansif", "Myev", "Neega", "Ovak", "Ownka", "Shautha", "Sutha", "Vola", "Volen", "Grel", "Mog", "Nargol", "Urzoth"], 
            last: ["Ironhide", "Bonebreaker", "Doomhammer", "Skullcrusher", "Fist of Grumsh", "The Vile", "Bloodaxe", "Stormcaller", "Eye-Gouger", "Rot-Tooth", "Darkblood", "Deathblade", "Hell-Scream", "Iron-Tusk", "Red-Eye", "Steel-Jaw"] 
        },
        "Halfling": { 
            male: ["Alton", "Ander", "Cade", "Corrin", "Eldon", "Errich", "Finnan", "Garret", "Lindal", "Lyle", "Merric", "Milo", "Osborn", "Perrin", "Reed", "Roscoe", "Wellby"], 
            female: ["Andry", "Bree", "Callie", "Cora", "Euphemia", "Jillian", "Kithri", "Lavinia", "Lidda", "Merla", "Nedda", "Paela", "Portia", "Seraphina", "Shaena", "Trym", "Vani", "Verna"], 
            last: ["Brushgather", "Goodbarrel", "Greenbottle", "High-hill", "Hilltopple", "Leagallow", "Tealeaf", "Thorngage", "Tosscobble", "Underbough", "Alderleaf", "Blackberry", "Bramblefoot", "Cherrycheeks", "Elderberry", "Kettlewhistle", "Nimblefingers"] 
        },
        "Tiefling": { 
            male: ["Akmenos", "Amnon", "Barakas", "Damakos", "Ekemon", "Iados", "Kairon", "Leucis", "Melech", "Mordai", "Morthos", "Pelaios", "Skamos", "Therai"], 
            female: ["Akta", "Bryseis", "Damaia", "Ea", "Kallista", "Lerissa", "Makaria", "Nemeia", "Orianna", "Phelaia", "Rieta", "Levidia", "Mehetabel", "Nezznar", "Ophelia"], 
            last: ["Art", "Carrion", "Chant", "Creed", "Despair", "Excellence", "Fear", "Glory", "Hope", "Ideal", "Music", "Nowhere", "Open", "Poetry", "Quest", "Random", "Reverence", "Sorrow", "Temerity", "Torment", "Weary", "Zeal"] 
        },
        "Dragonborn": {
             male: ["Arjhan", "Balasar", "Bharash", "Donaar", "Ghesh", "Heskan", "Kriv", "Medrash", "Mehen", "Nadarr", "Pandjed", "Patrin", "Rhogar", "Shamash", "Shedinn", "Tarhun", "Torinn"],
             female: ["Akra", "Biri", "Daar", "Farideh", "Harann", "Havilar", "Jheri", "Kava", "Korinn", "Mishann", "Nala", "Perra", "Raiann", "Sora", "Surina", "Thava", "Uadjit"],
             last: ["Clethtinthiallor", "Daardendrian", "Delmirev", "Drachedandion", "Fenkenkabradon", "Kepeshkmolik", "Kerrhylon", "Kimbatuul", "Linxakasendalor", "Myistan", "Nemmonis", "Norixius", "Ophinshtalajiir", "Prexijandilin", "Shestendeliath", "Turnuroth", "Verthisathurgiesh", "Yarjerit"]
        },
        "Gnome": {
             male: ["Boddynock", "Dimble", "Fonkin", "Gimble", "Glim", "Gerbo", "Jebeddo", "Namfoodle", "Roondar", "Seebo", "Zook"],
             female: ["Bimpnottin", "Breena", "Caramip", "Carlin", "Donella", "Duvamil", "Ella", "Ellyjobell", "Ellywick", "Lilli", "Loopmottin", "Lorilla", "Mardnab", "Nissa", "Nyx", "Oda"],
             last: ["Beren", "Daergel", "Folkor", "Garrick", "Nackle", "Murnig", "Ningel", "Raulnor", "Scheppen", "Timbers", "Turen"]
        },
        "Goblin": {
             male: ["Griz", "Raz", "Tark", "Vig", "Zog", "Bok", "Nark", "Rik", "Snik", "Grob", "Krag", "Mok"],
             female: ["Gree", "Mee", "Vola", "Yig", "Zeka", "Bree", "Nola", "Rika", "Sola", "Tika", "Vika", "Zola"],
             last: ["Mudfoot", "Red-Eye", "Ear-Biter", "Rat-Catcher", "Toad-Licker", "Worm-Eater", "Sneak-Thief", "Back-Stabber", "Gold-Stealer", "Sharp-Tooth"]
        },
        "Tabaxi": {
             male: ["Cloud", "Rain", "Storm", "Thunder", "River", "Smoke", "Shadow", "Midnight", "Flicker", "Sprint", "Claw", "Fang"],
             female: ["Mist", "Ember", "Dawn", "Dusk", "Star", "Moon", "Sun", "Sky", "Leaf", "Flower", "Berry", "Root"],
             last: ["of the Mountains", "on the Water", "in the Wind", "under the Stars", "walking softly", "running fast", "hiding in shadows", "singing loudly", "dancing wildly", "sleeping soundly"]
        },
        "Kenku": {
             male: ["Click", "Clack", "Snap", "Pop", "Whistle", "Hoot", "Caw", "Screech", "Chirp", "Rustle", "Thump", "Crash"],
             female: ["Ring", "Chime", "Echo", "Whisper", "Murmur", "Hum", "Song", "Melody", "Harmony", "Rhythm", "Beat", "Tune"],
             last: ["Sounder", "Mimic", "Copycat", "Repeater", "Echoer", "Parrot", "Mocker", "Imitator", "Simulator", "Replicator"]
        },
        "Genasi": {
             male: ["Ignis", "Aqua", "Terra", "Aero", "Pyro", "Hydro", "Geo", "Zephyr", "Blaze", "Tide", "Stone", "Gale"],
             female: ["Ember", "River", "Gem", "Bree", "Ash", "Rain", "Jade", "Skye", "Flame", "Mist", "Crystal", "Cloud"],
             last: ["Fireborn", "Waterwalker", "Earthshaker", "Windrider", "Stormcaller", "Tidemaker", "Stoneforger", "Skywatcher", "Flamekeeper", "Wavebreaker"]
        }
    };

    window.generateNames = () => {
        const race = document.getElementById('name-race').value;
        const gender = document.getElementById('name-gender').value; // Get gender
        const data = nameDatabase[race];
        const output = document.getElementById('name-output');
        
        if (!data) return;
        
        // Select the correct list based on gender
        const firstNames = data[gender];
        const lastNames = data.last;

        let html = '';
        for (let i = 0; i < 5; i++) {
            const f = firstNames[Math.floor(Math.random() * firstNames.length)];
            const l = lastNames[Math.floor(Math.random() * lastNames.length)];
            html += `<div class="flex justify-between items-center bg-gray-800 px-2 py-1 rounded border border-gray-700">
                        <span class="text-pink-100 font-medium">${f} ${l}</span>
                        <button onclick="navigator.clipboard.writeText('${f} ${l}')" class="text-[10px] text-gray-500 hover:text-white uppercase tracking-wider">Copy</button>
                     </div>`;
        }
        output.innerHTML = html;
    };

    // --- 16. HOMEBREW ENGINE (Safe Sharing Mode) ---
    
    // 1. Helper for PUBLIC Collection (Using the Deep Path to ensure it works)
    const getPublicBrewCol = () => window.collection(window.db, 'artifacts', 'default', 'public', 'default', 'data', 'community_homebrew');
    
    const calcMod = (score) => { const m = Math.floor(((parseInt(score)||10) - 10) / 2); return m >= 0 ? `+${m}` : m; };

    // UI Switcher
    window.switchBrewMode = (mode, btn) => {
        document.querySelectorAll('.brew-sub-tab').forEach(b => {
            b.classList.remove('bg-orange-600', 'text-white', 'bg-blue-600');
            b.classList.add('text-gray-400');
        });
        btn.classList.remove('text-gray-400');
        if(mode === 'community') btn.classList.add('bg-blue-600', 'text-white');
        else btn.classList.add('bg-orange-600', 'text-white');

        document.getElementById('brew-monster-area').classList.add('hidden');
        document.getElementById('brew-weapon-area').classList.add('hidden');
        document.getElementById('brew-magic-area').classList.add('hidden');
        document.getElementById('brew-community-area').classList.add('hidden');
        document.getElementById(`brew-${mode}-area`).classList.remove('hidden');
        
        const inv = document.getElementById('my-inventory-container');
        if(mode === 'community') {
            if(inv) inv.classList.add('hidden');
            window.loadCommunityItems(); 
        } else {
            if(inv) inv.classList.remove('hidden');
        }
    };

    // --- 1. MONSTER PREVIEW ---
    window.previewHomebrewMonster = () => {
        const name = document.getElementById('hb-mon-name').value || "Unknown Monster";
        const type = document.getElementById('hb-mon-type').value || "Medium Beast, Unaligned";
        const ac = document.getElementById('hb-mon-ac').value || 10;
        const hp = document.getElementById('hb-mon-hp').value || 10;
        const spd = document.getElementById('hb-mon-spd').value || "30 ft.";
        const str = document.getElementById('hb-mon-str').value || 10;
        const dex = document.getElementById('hb-mon-dex').value || 10;
        const con = document.getElementById('hb-mon-con').value || 10;
        const int = document.getElementById('hb-mon-int').value || 10;
        const wis = document.getElementById('hb-mon-wis').value || 10;
        const cha = document.getElementById('hb-mon-cha').value || 10;
        const init = document.getElementById('hb-mon-init').value || 0;
        const toHit = document.getElementById('hb-mon-tohit').value || 0;
        const atkName = document.getElementById('hb-mon-atkname').value || "Attack";
        const dmg = document.getElementById('hb-mon-dmg').value || "1d4";
        const desc = document.getElementById('hb-mon-desc').value || "";

        const preview = document.getElementById('hb-monster-preview');
        if(!preview) return;
        preview.classList.remove('hidden');
        
        preview.innerHTML = `
            <div class="dnd-statblock text-left text-sm">
                <div class="dnd-header">${name}</div>
                <div class="italic text-black text-xs mb-2">${type}</div>
                <div class="tapered-rule"></div>
                <div class="text-red-900 font-serif">
                    <p><strong>Armor Class</strong> ${ac}</p>
                    <p><strong>Hit Points</strong> ${hp}</p>
                    <p><strong>Speed</strong> ${spd}</p>
                </div>
                <div class="tapered-rule"></div>
                <div class="grid grid-cols-6 text-center text-red-900 text-xs font-bold">
                    <div>STR<br>${str} (${calcMod(str)})</div><div>DEX<br>${dex} (${calcMod(dex)})</div>
                    <div>CON<br>${con} (${calcMod(con)})</div><div>INT<br>${int} (${calcMod(int)})</div>
                    <div>WIS<br>${wis} (${calcMod(wis)})</div><div>CHA<br>${cha} (${calcMod(cha)})</div>
                </div>
                <div class="tapered-rule"></div>
                <div class="text-black mt-2 space-y-2">
                    ${desc ? `<p>${desc.replace(/\n/g, '<br>')}</p>` : ''}
                    <div class="dnd-section-title border-b border-red-900 text-red-900 font-bold mt-2">Actions</div>
                    <p><strong class="italic font-bold text-black">${atkName}.</strong> <span class="text-black"><em>Melee Weapon Attack:</em> +${toHit} to hit, one target. <em>Hit:</em> ${dmg} damage.</span></p>
                </div>
            </div>`;
    };

    // --- 2. SAVING (Private) ---
    window.saveHomebrewMonster = async () => {
        const name = document.getElementById('hb-mon-name').value.trim();
        if (!name) { alert("Name required!"); return; }
        const hp = parseInt(document.getElementById('hb-mon-hp').value)||10;
        const ac = parseInt(document.getElementById('hb-mon-ac').value)||10;
        const init = parseInt(document.getElementById('hb-mon-init').value)||0;
        const tohit = parseInt(document.getElementById('hb-mon-tohit').value)||0;
        const fullDmgStr = `${document.getElementById('hb-mon-atkname').value}: ${document.getElementById('hb-mon-dmg').value}`;
        if(!window.isAuthReady) { alert("Login required."); return; }
        try {
            await window.addDoc(getCol('dm_toolkit_statblocks'), { name, hp, ac, toHit: tohit, initMod: init, dmg: fullDmgStr, timestamp: new Date().toISOString() });
            alert(`Saved ${name} to Stats!`);
            document.getElementById('hb-mon-name').value = '';
        } catch (e) { console.error(e); }
    };

    window.saveHomebrewWeapon = async () => {
        const name = document.getElementById('hb-wep-name').value.trim();
        if (!name) return;
        try {
            await window.addDoc(getCol('dm_toolkit_homebrew_items'), {
                name, dmg: document.getElementById('hb-wep-dmg').value, type: document.getElementById('hb-wep-type').value, props: document.getElementById('hb-wep-props').value, timestamp: new Date().toISOString()
            });
            document.getElementById('hb-wep-name').value = ''; 
        } catch (e) { console.error(e); }
    };

    window.saveHomebrewMagicItem = async () => {
        const name = document.getElementById('hb-item-name').value.trim();
        if (!name) return;
        const fullProps = `${document.getElementById('hb-item-attune').checked ? "(Attunement)" : ""} ${document.getElementById('hb-item-desc').value}`;
        try {
            await window.addDoc(getCol('dm_toolkit_homebrew_items'), {
                name, dmg: document.getElementById('hb-item-rarity').value, type: document.getElementById('hb-item-type').value, props: fullProps, timestamp: new Date().toISOString()
            });
            document.getElementById('hb-item-name').value = ''; 
        } catch (e) { console.error(e); }
    };

    // --- 3. NOTES INTEGRATION ---
    window.saveHomebrewToNotes = async (type) => {
        if (!window.isAuthReady) { alert("Login required."); return; }
        let title, content, tab;
        const id = crypto.randomUUID();
        
        if (type === 'monster') {
            window.previewHomebrewMonster();
            const previewHTML = document.getElementById('hb-monster-preview').innerHTML;
            title = (document.getElementById('hb-mon-name').value || "Monster") + " (Homebrew)";
            content = previewHTML;
            tab = 'enemyNotes';
        } else if (type === 'weapon') {
            title = document.getElementById('hb-wep-name').value;
            content = `Type: Weapon\nDamage: ${document.getElementById('hb-wep-dmg').value}\nProps: ${document.getElementById('hb-wep-props').value}`;
            tab = 'lootNotes';
        } else {
            title = document.getElementById('hb-item-name').value;
            content = `${document.getElementById('hb-item-rarity').value} ${document.getElementById('hb-item-type').value}\n\n${document.getElementById('hb-item-desc').value}`;
            tab = 'lootNotes';
        }
        structuredNotes[tab].unshift({ id, title, content, timestamp: new Date().toISOString() });
        await window.saveStructuredNotes(tab, structuredNotes[tab]);
        if(confirm("Saved! Go to notes?")) { window.switchTab('notes'); window.switchSubTab(tab); }
    };

    // --- 4. COMMUNITY SHARING (FIXED) ---
    
    // A. SHARE (SAFER METHOD)
    // Instead of passing strings, we pass the ID. JS fetches the data, cleans it, and sends it.
    window.shareHomebrewItem = async (id) => {
        if(!window.isAuthReady) { alert("Login required."); return; }

        try {
            // 1. Fetch the Item from PRIVATE DB first to ensure clean data
            const docRef = getDocRef('dm_toolkit_homebrew_items', id);
            const snapshot = await window.getDoc(docRef);
            
            if (!snapshot.exists()) {
                alert("Item not found in your inventory!");
                return;
            }
            
            const item = snapshot.data();
            if(!confirm(`Publish "${item.name}" to the Community?`)) return;

            // 2. Write to PUBLIC DB
            await window.addDoc(getPublicBrewCol(), {
                name: item.name, 
                dmg: item.dmg || "", 
                type: item.type || "", 
                props: item.props || "",
                sharedBy: "Fellow DM",
                timestamp: new Date().toISOString()
            });
            
            alert("Published! Check the Community tab.");
            
        } catch(e) { 
            console.error("Publish Error:", e); 
            alert("Error publishing: " + e.message); 
        }
    };

    // B. IMPORT
    window.importCommunityItem = async (name, dmg, type, props) => {
        try {
            await window.addDoc(getCol('dm_toolkit_homebrew_items'), {
                name, dmg, type, props, timestamp: new Date().toISOString()
            });
            alert(`Imported ${name} to your inventory!`);
        } catch(e) { console.error(e); }
    };

    // C. LOAD
    window.loadCommunityItems = () => {
        const list = document.getElementById('community-list');
        const q = window.query(getPublicBrewCol(), window.orderBy('timestamp', 'desc'), window.limit(20));
        
        window.onSnapshot(q, (snap) => {
            if(snap.empty) { list.innerHTML = '<p class="text-center text-gray-500 text-xs">No community items yet.</p>'; return; }
            list.innerHTML = '';
            snap.forEach(d => {
                const item = d.data();
                const safeName = (item.name || "").replace(/'/g, "\\'");
                const safeDmg = (item.dmg || "").replace(/'/g, "\\'");
                const safeType = (item.type || "").replace(/'/g, "\\'");
                const safeProps = (item.props || "").replace(/'/g, "\\'").replace(/\n/g, " ");
                
                const div = document.createElement('div');
                div.className = 'bg-blue-900/20 p-2 rounded border border-blue-500/30 flex justify-between items-center mb-2';
                div.innerHTML = `
                    <div class="overflow-hidden">
                        <div class="font-bold text-blue-200 text-sm truncate">${item.name}</div>
                        <div class="text-[10px] text-gray-400">${item.dmg || ""} ${item.type || ""}</div>
                        <div class="text-[10px] text-gray-500 truncate pr-2">${item.props || ""}</div>
                    </div>
                    <button onclick="window.importCommunityItem('${safeName}', '${safeDmg}', '${safeType}', '${safeProps}')" class="bg-blue-700 hover:bg-blue-600 text-white text-xs font-bold px-3 py-1 rounded shadow transition">Save</button>
                `;
                list.appendChild(div);
            });
        });
    };

    // 5. INVENTORY LISTENER (With Safe Share Button)
    window.deleteHomebrewWeapon = async (id) => {
        if(!confirm("Delete?")) return;
        await window.deleteDoc(getDocRef('dm_toolkit_homebrew_items', id));
    };

    window.setupHomebrewListener = () => {
        if(!window.isAuthReady) return;
        window.onSnapshot(window.query(getCol('dm_toolkit_homebrew_items')), (snap) => {
            const list = document.getElementById('homebrew-weapon-list');
            if(!list) return;
            const items = [];
            snap.forEach(d => items.push({id: d.id, ...d.data()}));
            if(items.length === 0) { list.innerHTML = '<p class="text-center text-gray-500 text-xs">No items saved.</p>'; return; }
            
            items.sort((a,b) => a.name.localeCompare(b.name));
            list.innerHTML = '';
            items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'bg-gray-900 p-2 rounded border border-gray-700 flex justify-between items-center mb-1';
                // SHARE BUTTON NOW ONLY SENDS ID (Fixing the syntax error)
                div.innerHTML = `
                    <div class="overflow-hidden">
                        <div class="font-bold text-orange-200 text-sm truncate">${item.name}</div>
                        <div class="text-[10px] text-gray-400">${item.dmg} ${item.type}</div>
                    </div>
                    <div class="flex gap-2 shrink-0">
                        <button onclick="window.shareHomebrewItem('${item.id}')" class="text-blue-400 hover:text-blue-300 text-xs" title="Share to Community">üåç</button>
                        <button onclick="window.deleteHomebrewWeapon('${item.id}')" class="text-red-500 hover:text-red-400 text-xs font-bold">√ó</button>
                    </div>
                `;
                list.appendChild(div);
            });
        });
    };

        // --- 17. DUAL COMBAT TIMER (Stopwatch & Countdown) ---
    let timerInterval = null;
    let timerMode = null; // 'countup' or 'countdown'

    window.toggleTimer = () => {
        const btn = document.getElementById('btn-timer-toggle');
        const minInput = document.getElementById('timer-min');
        const secInput = document.getElementById('timer-sec');
        
        if (timerInterval) {
            // PAUSE
            clearInterval(timerInterval);
            timerInterval = null;
            btn.textContent = "‚ñ∂";
            btn.classList.replace('bg-red-700', 'bg-green-700');
            btn.classList.replace('hover:bg-red-600', 'hover:bg-green-600');
        } else {
            // START
            let m = parseInt(minInput.value) || 0;
            let s = parseInt(secInput.value) || 0;
            let total = m * 60 + s;

            // Determine Mode (Only if starting fresh)
            if (!timerMode) {
                if (total > 0) timerMode = 'countdown';
                else timerMode = 'countup';
            }

            timerInterval = setInterval(() => {
                if (timerMode === 'countdown') {
                    if (total <= 0) {
                        // TIME'S UP!
                        clearInterval(timerInterval);
                        timerInterval = null;
                        timerMode = null; // Reset mode
                        btn.textContent = "‚ñ∂";
                        btn.classList.replace('bg-red-700', 'bg-green-700');
                        // Play Sound if available
                        if(window.playTone) window.playTone('trap'); 
                        alert("‚è∞ Time is up!");
                        return;
                    }
                    total--;
                } else {
                    // Stopwatch
                    total++;
                }

                // Update UI
                const nm = Math.floor(total / 60).toString().padStart(2, '0');
                const ns = (total % 60).toString().padStart(2, '0');
                minInput.value = nm;
                secInput.value = ns;
            }, 1000);

            btn.textContent = "‚è∏";
            btn.classList.replace('bg-green-700', 'bg-red-700');
            btn.classList.replace('hover:bg-green-600', 'hover:bg-red-600');
        }
    };

    window.resetTimer = () => {
        if(timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }
        timerMode = null; // Clear mode so next click decides fresh
        
        // UI Reset
        document.getElementById('btn-timer-toggle').textContent = "‚ñ∂";
        document.getElementById('btn-timer-toggle').classList.replace('bg-red-700', 'bg-green-700');
        document.getElementById('timer-min').value = "00";
        document.getElementById('timer-sec').value = "00";
    };
    
</script>

    <!-- Login Modal -->
<div id="login-modal" class="hidden fixed inset-0 z-[100] bg-black bg-opacity-80 flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="card w-full max-w-md p-8 rounded-xl shadow-2xl border border-gray-600">
        <h3 class="text-2xl font-bold text-indigo-300 mb-2 text-center">üõ°Ô∏è Open Session</h3>
        <p class="text-gray-400 text-sm mb-6 text-center">Enter a Session Name and Password to create or load a shared room.</p>
        
        <div class="space-y-4">
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Session Name</label>
                <input type="text" id="session-name-input" class="w-full p-3 rounded-lg input-style border-2 border-indigo-900/50 focus:border-indigo-500 outline-none transition" placeholder="e.g. Campaign1">
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Password</label>
                <input type="password" id="session-pass-input" class="w-full p-3 rounded-lg input-style border-2 border-indigo-900/50 focus:border-indigo-500 outline-none transition" placeholder="******">
            </div>
        </div>
        
        <div id="login-status" class="h-6 text-red-400 text-xs mt-2"></div>
        
        <div class="flex gap-3 mt-4">
            <button onclick="closeLoginModal()" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 rounded-lg transition">Cancel</button>
            <button onclick="handleSessionLogin()" class="flex-1 bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 rounded-lg transition shadow-lg shadow-indigo-900/50">Connect</button>
        </div>
    </div>
</div>

</body>
</html>
